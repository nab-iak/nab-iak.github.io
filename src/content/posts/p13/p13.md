---
title: 'ã€mlr3ã€‘4.ç®¡é“'
published: 2025-07-19
image: './p13_cover.jpg'
description: 'mlr3ç®¡é“'
category: 'Machine Learning'
tags: [mlr3,R,ZH-CN]
draft: false 
lang: 'en'
---
> - Cover Pic by [@Rafa](https://www.pixiv.net/artworks/126490750)  

> [Applied Machine Learning Using mlr3 in R](https://mlr3book.mlr-org.com/)

## é¡ºåºç®¡é“

### ç®€ä»‹

- `mlr3pipelines`åŒ…å°†æ¨¡å—åŒ–æ¨è¿›å¾—æ›´å¤šï¼Œ  
  ä½¿å¾—åŒ…æ‹¬åœ¨æ•°æ®é¢„å¤„ç†ï¼Œæ„å»ºåŸºå±‚æ¨¡å‹ç”šè‡³æ›´å¤æ‚çš„å…ƒæ¨¡å‹æ›´åŠ æµç¨‹åŒ–
- mlr3pipelines ä½¿å¾—åˆ©ç”¨æ„å»ºæ¨¡å—åœ¨ `Learner` ä¸­æ„å»ºå„ä¸ªæ­¥éª¤æˆä¸ºå¯èƒ½ï¼Œ  
  è¿™äº›æ„å»ºæ¨¡å—ç»§æ‰¿è‡ª `PipeOp` ç±»
  - `PipeOp` å¯ä»¥ä½¿ç”¨æœ‰å‘è¾¹è¿æ¥èµ·æ¥ï¼Œå½¢æˆè¡¨ç¤ºæ“ä½œä¹‹é—´çš„æ•°æ®æµ `Graph` æˆ– `pipeline`
  - åœ¨æ¨¡å‹è®­ç»ƒæœŸé—´ï¼Œ`Graph` ä¸­çš„ `PipeOp` ä¼šè½¬æ¢ç»™å®šçš„ `Task`ï¼Œ  
   åç»­çš„ `PipeOp` ä¼šæ¥æ”¶è½¬æ¢åçš„ `Task` ä½œä¸ºè¾“å…¥
  - é™¤äº†è½¬æ¢æ•°æ®ï¼Œ`PipeOp` è¿˜ä¼šç”Ÿæˆä¸€ä¸ª çŠ¶æ€
    - è¯¥çŠ¶æ€ç”¨äºåœ¨é¢„æµ‹æœŸé—´æŒ‡å¯¼ PipeOp çš„æ“ä½œï¼Œ  
    è¿™ç±»ä¼¼äºå­¦ä¹ å™¨åœ¨è®­ç»ƒæœŸé—´å­¦ä¹ å¹¶å­˜å‚¨æ¨¡å‹å‚æ•°/æƒé‡ï¼Œ  
    ä»¥æŒ‡å¯¼æ¨¡å‹é¢„æµ‹
- ä¸‹å›¾ä¸­ï¼Œé€šè¿‡ *ç¼©æ”¾* `PipeOp` è¿›è¡Œäº†å¯è§†åŒ–å±•ç¤º
  - è¯¥æ“ä½œç¬¦åœ¨è®­ç»ƒæœŸé—´å¯¹ç‰¹å¾è¿›è¡Œç¼©æ”¾ï¼Œ  
   å¹¶å°†ç¼©æ”¾å› å­ä¿å­˜ä¸ºä¸€ç§çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨é¢„æµ‹ä¸­ä½¿ç”¨

![image_1](./image_1.png)

- ç§ç±»
  - **é¡ºåºç®¡é“**
    - æŒ‡æ•°æ®åœ¨ç®¡é“ä¸­ä»ä¸€ä¸ª`PipeOp`ç›´æ¥ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªï¼Œä»å¤´åˆ°å°¾ä¾æ¬¡è¿›è¡Œ
  - **éé¡ºåºç®¡é“**
    - æ•°æ®æ˜¯é€šè¿‡å¯èƒ½æœ‰å¤šä¸ªè¾“å…¥å’Œ/æˆ–è¾“å‡ºçš„`PipeOp`è¿›è¡Œå¤„ç†çš„
    - éé¡ºåºç®¡é“çš„ç‰¹ç‚¹æ˜¯æœ‰å¤šä¸ªåˆ†æ”¯ï¼Œ  
    å› æ­¤æ•°æ®å¯èƒ½åœ¨ä¸åŒæ—¶é—´ç”±ä¸åŒçš„`PipeOp`è¿›è¡Œå¤„ç†

### `PipeOp`ï¼šç®¡é“æ“ä½œç¬¦

- `PipeOp`æ˜¯`mlr3pipelines`çš„åŸºæœ¬ç±»
  - è¡¨ç¤ºå¯¹è¾“å…¥ï¼ˆä¾‹å¦‚ï¼Œè®­ç»ƒ`Task`ï¼‰çš„è½¬æ¢æ“ä½œï¼Œäº§ç”Ÿä¸€äº›è¾“å‡º
  - ä¸å­¦ä¹ å™¨ç±»ä¼¼ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ª`$train()`å’Œä¸€ä¸ª`$predict()`æ–¹æ³•
    - è®­ç»ƒé˜¶æ®µé€šå¸¸ä¼šç”Ÿæˆæ•°æ®çš„ç‰¹å®šæ¨¡å‹ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸ºå†…éƒ¨çŠ¶æ€
    - é¢„æµ‹é˜¶æ®µ`PipeOp`ä½¿ç”¨ä¿å­˜çŠ¶æ€ä¸­çš„ä¿¡æ¯å¯¹é¢„æµ‹`Task`
  - ä¸å­¦ä¹ å™¨ä¸€æ ·ï¼ŒPipeOpå…·æœ‰ç»è¿‡è®­ç»ƒçš„å‚æ•°ï¼ˆå³**çŠ¶æ€**ï¼‰
  - é™¤äº†å‚æ•°ä¹‹å¤–ï¼ŒPipeOpè¿˜å…·æœ‰è¶…å‚æ•°ï¼Œ  
   ç”¨æˆ·å¯ä»¥åœ¨æ„é€ `PipeOp`æ—¶æˆ–é€šè¿‡è®¿é—®å…¶`PipeOp$param_set`æ¥è®¾ç½®è¶…å‚æ•°
  - `PipeOp`å¯ä»¥ä½¿ç”¨ä¾¿æ·å‡½æ•°`po()`è¿›è¡Œæ„é€ ï¼Œ  
   å¯¹äºå¤šä¸ª`PipeOp`å¯ä»¥ä½¿ç”¨`pos()`
    - å¹¶ä¸”æ‰€æœ‰å¯ç”¨çš„`PipeOp`éƒ½å¯åœ¨å­—å…¸`mlr_pipeops`ä¸­æ‰¾åˆ°

- çœ‹çœ‹æœ‰å“ªäº›ç®¡é“æ“ä½œç¬¦

```r
mlr_pipeops %>% as.data.table()
```

<table class='dataframe'>
<caption>A data.table: 174 x 11</caption>
<thead>
 <tr><th scope=col>key</th><th scope=col>label</th><th scope=col>packages</th><th scope=col>tags</th><th scope=col>feature_types</th><th scope=col>input.num</th><th scope=col>output.num</th><th scope=col>input.type.train</th><th scope=col>input.type.predict</th><th scope=col>output.type.train</th><th scope=col>output.type.predict</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;list&gt;</th></tr>
</thead>
<tbody>
 <tr><td>adas                          </td><td>ADAS Balancing                                                                           </td><td>mlr3pipelines, smotefamily  </td><td>imbalanced data, data transform </td><td>logical    , integer    , numeric    , character  , factor     , ordered    , POSIXct    , Date       , lazy_tensor</td><td> 1</td><td> 1</td><td>TaskClassif</td><td>TaskClassif</td><td>TaskClassif</td><td>TaskClassif</td></tr>
 <tr><td>augment_center_crop           </td><td>Center Crop Augmentation                                                                 </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_color_jitter          </td><td>Color Jitter Augmentation                                                                </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_crop                  </td><td>Crop Augmentation                                                                        </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_hflip                 </td><td>Horizontal Flip Augmentation                                                             </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_random_affine         </td><td>Random Affine Augmentation                                                               </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_random_choice         </td><td>Random Choice Augmentation                                                               </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_random_crop           </td><td>Random Crop Augmentation                                                                 </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_random_horizontal_flip</td><td>Random Horizontal Flip Augmentation                                                      </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_random_order          </td><td>Random Order Augmentation                                                                </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_random_resized_crop   </td><td>Random Resized Crop Augmentation                                                         </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_random_vertical_flip  </td><td>Random Vertical Flip Augmentation                                                        </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_resized_crop          </td><td>Resized Crop Augmentation                                                                </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_rotate                </td><td>Rotate Augmentation                                                                      </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>augment_vflip                 </td><td>Vertical Flip Augmentation                                                               </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>blsmote                       </td><td>BLSMOTE Balancing                                                                        </td><td>mlr3pipelines, smotefamily  </td><td>imbalanced data, data transform </td><td>logical    , integer    , numeric    , character  , factor     , ordered    , POSIXct    , Date       , lazy_tensor</td><td> 1</td><td> 1</td><td>TaskClassif</td><td>TaskClassif</td><td>TaskClassif</td><td>TaskClassif</td></tr>
 <tr><td>boxcox                        </td><td>Box-Cox Transformation of Numeric Features                                               </td><td>mlr3pipelines, bestNormalize</td><td>data transform</td><td>numeric, integer</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>branch                        </td><td>Path Branching                                                                           </td><td>mlr3pipelines</td><td>meta</td><td>NA</td><td> 1</td><td>NA</td><td>*</td><td>*</td><td>*</td><td>*</td></tr>
 <tr><td>breslowcompose                </td><td>Wrap a learner into a PipeOp with survival predictions estimated by the Breslow estimator</td><td>mlr3pipelines, mlr3         , mlr3proba    </td><td>abstract</td><td>NA</td><td> 1</td><td> 1</td><td>TaskSurv</td><td>TaskSurv</td><td>NULL</td><td>PredictionSurv</td></tr>
 <tr><td>chunk                         </td><td>Chunk Input into Multiple Outputs                                                        </td><td>mlr3pipelines</td><td>meta</td><td>NA</td><td> 1</td><td>NA</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>classbalancing                </td><td>Class Balancing                                                                          </td><td>mlr3pipelines</td><td>imbalanced data, data transform </td><td>logical    , integer    , numeric    , character  , factor     , ordered    , POSIXct    , Date       , lazy_tensor</td><td> 1</td><td> 1</td><td>TaskClassif</td><td>TaskClassif</td><td>TaskClassif</td><td>TaskClassif</td></tr>
 <tr><td>classifavg                    </td><td>Majority Vote Prediction                                                                 </td><td>mlr3pipelines, stats        </td><td>ensemble</td><td>NA</td><td>NA</td><td> 1</td><td>NULL</td><td>PredictionClassif</td><td>NULL</td><td>PredictionClassif</td></tr>
 <tr><td>classweights                  </td><td>Class Weights for Sample Weighting                                                       </td><td>mlr3pipelines</td><td>imbalanced data, data transform </td><td>logical    , integer    , numeric    , character  , factor     , ordered    , POSIXct    , Date       , lazy_tensor</td><td> 1</td><td> 1</td><td>TaskClassif</td><td>TaskClassif</td><td>TaskClassif</td><td>TaskClassif</td></tr>
 <tr><td>colapply                      </td><td>Apply a Function to each Column of a Task                                                </td><td>mlr3pipelines</td><td>data transform</td><td>logical    , integer    , numeric    , character  , factor     , ordered    , POSIXct    , Date       , lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>collapsefactors               </td><td>Collapse Factors                                                                         </td><td>mlr3pipelines</td><td>data transform</td><td>factor , ordered</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>colroles                      </td><td>Change Column Roles of a Task                                                            </td><td>mlr3pipelines</td><td>data transform</td><td>logical    , integer    , numeric    , character  , factor     , ordered    , POSIXct    , Date       , lazy_tensor</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>compose_probregr              </td><td>PipeOpProbregr                                                                           </td><td>mlr3pipelines, mlr3proba    , distr6       </td><td>abstract</td><td>NA</td><td> 2</td><td> 1</td><td>NULL, NULL</td><td>PredictionRegr, PredictionRegr</td><td>NULL</td><td>PredictionRegr</td></tr>
 <tr><td>copy                          </td><td>Copy Input Multiple Times                                                                </td><td>mlr3pipelines</td><td>meta</td><td>NA</td><td> 1</td><td>NA</td><td>*</td><td>*</td><td>*</td><td>*</td></tr>
 <tr><td>crankcompose                  </td><td>PipeOpCrankCompositor                                                                    </td><td>mlr3pipelines, mlr3proba    </td><td>abstract</td><td>NA</td><td> 1</td><td> 1</td><td>NULL</td><td>PredictionSurv</td><td>NULL</td><td>PredictionSurv</td></tr>
 <tr><td>datefeatures                  </td><td>Preprocess Date Features                                                                 </td><td>mlr3pipelines</td><td>data transform</td><td>POSIXct</td><td> 1</td><td> 1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
 <tr><td>tomek                         </td><td>Tomek Down-Sampling                              </td><td>mlr3pipelines, themis       </td><td>imbalanced data, data transform </td><td>logical    , integer    , numeric    , character  , factor     , ordered    , POSIXct    , Date       , lazy_tensor</td><td> 1</td><td>1</td><td>TaskClassif</td><td>TaskClassif</td><td>TaskClassif</td><td>TaskClassif</td></tr>
 <tr><td>torch_callbacks               </td><td>Callback Configuration                           </td><td>mlr3pipelines</td><td>abstract</td><td>NA</td><td> 1</td><td>1</td><td>ModelDescriptor</td><td>Task</td><td>ModelDescriptor</td><td>Task</td></tr>
 <tr><td>torch_ingress_categ           </td><td>Torch Entry Point for Categorical Features       </td><td>mlr3pipelines, mlr3torch    </td><td>abstract</td><td>factor , ordered, logical</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>ModelDescriptor</td><td>Task</td></tr>
 <tr><td>torch_ingress_ltnsr           </td><td>Ingress for Lazy Tensor                          </td><td>mlr3pipelines, mlr3torch    </td><td>abstract</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>ModelDescriptor</td><td>Task</td></tr>
 <tr><td>torch_ingress_num             </td><td>Torch Entry Point for Numeric Features           </td><td>mlr3pipelines, mlr3torch    </td><td>abstract</td><td>numeric, integer</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>ModelDescriptor</td><td>Task</td></tr>
 <tr><td>torch_loss                    </td><td>Loss Configuration                               </td><td>mlr3pipelines, torch        , mlr3torch    </td><td>abstract</td><td>NA</td><td> 1</td><td>1</td><td>ModelDescriptor</td><td>Task</td><td>ModelDescriptor</td><td>Task</td></tr>
 <tr><td>torch_model_classif           </td><td>PipeOp Torch Classifier                          </td><td>mlr3pipelines, mlr3         , mlr3torch    </td><td>learner</td><td>NA</td><td> 1</td><td>1</td><td>ModelDescriptor</td><td>TaskClassif</td><td>NULL</td><td>PredictionClassif</td></tr>
 <tr><td>torch_model_regr              </td><td>Torch Regression Model                           </td><td>mlr3pipelines, mlr3         , mlr3torch    </td><td>learner</td><td>NA</td><td> 1</td><td>1</td><td>ModelDescriptor</td><td>TaskRegr</td><td>NULL</td><td>PredictionRegr</td></tr>
 <tr><td>torch_optimizer               </td><td>Optimizer Configuration                          </td><td>mlr3pipelines, torch        , mlr3torch    </td><td>abstract</td><td>NA</td><td> 1</td><td>1</td><td>ModelDescriptor</td><td>Task</td><td>ModelDescriptor</td><td>Task</td></tr>
 <tr><td>trafo_adjust_brightness       </td><td>Adjust Brightness Transformation                 </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafo_adjust_gamma            </td><td>Adjust Gamma Transformation                      </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafo_adjust_hue              </td><td>Adjust Hue Transformation                        </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafo_adjust_saturation       </td><td>Adjust Saturation Transformation                 </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafo_grayscale               </td><td>Grayscale Transformation                         </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafo_nop                     </td><td>No Transformation                                </td><td>mlr3pipelines, mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafo_normalize               </td><td>Normalization Transformation                     </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafo_pad                     </td><td>Padding Transformation                           </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafo_reshape                 </td><td>Reshaping Transformation                         </td><td>mlr3pipelines, mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafo_resize                  </td><td>Resizing Transformation                          </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafo_rgb_to_grayscale        </td><td>RGB to Grayscale Transformation                  </td><td>mlr3pipelines, torchvision  , mlr3torch    </td><td>torch         , data transform</td><td>lazy_tensor</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
 <tr><td>trafopred_classifsurv_IPCW    </td><td>PipeOpPredClassifSurvIPCW                        </td><td>mlr3pipelines</td><td>abstract</td><td>NA</td><td> 2</td><td>1</td><td>NULL, NULL</td><td>PredictionClassif, list             </td><td>NULL</td><td>PredictionSurv</td></tr>
 <tr><td>trafopred_classifsurv_disctime</td><td>PipeOpPredClassifSurvDiscTime                    </td><td>mlr3pipelines</td><td>abstract</td><td>NA</td><td> 2</td><td>1</td><td>NULL      , data.table</td><td>PredictionClassif, data.table       </td><td>NULL</td><td>PredictionSurv</td></tr>
 <tr><td>trafopred_regrsurv_pem        </td><td>PipeOpPredRegrSurvPEM                            </td><td>mlr3pipelines</td><td>abstract</td><td>NA</td><td> 2</td><td>1</td><td>NULL      , data.table</td><td>PredictionRegr, data.table    </td><td>NULL</td><td>PredictionSurv</td></tr>
 <tr><td>trafotask_survclassif_IPCW    </td><td>PipeOpTaskSurvClassifIPCW                        </td><td>mlr3pipelines</td><td>abstract</td><td>NA</td><td> 1</td><td>2</td><td>TaskSurv</td><td>TaskSurv</td><td>TaskClassif, NULL       </td><td>TaskClassif, list       </td></tr>
 <tr><td>trafotask_survclassif_disctime</td><td>PipeOpTaskSurvClassifDiscTime                    </td><td>mlr3pipelines, pammtools    </td><td>abstract</td><td>NA</td><td> 1</td><td>2</td><td>TaskSurv</td><td>TaskSurv</td><td>TaskClassif, data.table </td><td>TaskClassif, data.table </td></tr>
 <tr><td>trafotask_survregr_pem        </td><td>PipeOpTaskSurvRegrPEM                            </td><td>mlr3pipelines, pammtools    </td><td>abstract</td><td>NA</td><td> 1</td><td>2</td><td>TaskSurv</td><td>TaskSurv</td><td>TaskRegr  , data.table</td><td>TaskRegr  , data.table</td></tr>
 <tr><td>tunethreshold                 </td><td>Tune the Threshold of a Classification Prediction</td><td>mlr3pipelines, bbotk        </td><td>target transform</td><td>NA</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>NULL</td><td>Prediction</td></tr>
 <tr><td>unbranch                      </td><td>Unbranch Different Paths                         </td><td>mlr3pipelines</td><td>meta</td><td>NA</td><td>NA</td><td>1</td><td>*</td><td>*</td><td>*</td><td>*</td></tr>
 <tr><td>vtreat                        </td><td>Interface to the vtreat Package                  </td><td>mlr3pipelines, vtreat       </td><td>encode        , missings      , data transform</td><td>logical    , integer    , numeric    , character  , factor     , ordered    , POSIXct    , Date       , lazy_tensor</td><td> 1</td><td>1</td><td>TaskSupervised</td><td>TaskSupervised</td><td>TaskSupervised</td><td>TaskSupervised</td></tr>
 <tr><td>yeojohnson                    </td><td>Yeo-Johnson Transformation of Numeric Features   </td><td>mlr3pipelines, bestNormalize</td><td>data transform</td><td>numeric, integer</td><td> 1</td><td>1</td><td>Task</td><td>Task</td><td>Task</td><td>Task</td></tr>
</tbody>
</table>

- ä¸‹é¢æ„å»ºå¹¶æŸ¥çœ‹ä¸€ä¸ªPCAç®¡é“
- åœ¨è¾“å‡ºä¸­
  - `not trained`ï¼šæ¨¡å‹å°šæœªè¢«è®­ç»ƒ
  - `Input channels`çš„`input [Task,Task]`ï¼š  
   è®­ç»ƒå’Œé¢„æµ‹éƒ½æ¥å—`Task`çš„è¾“å…¥
  - `Output channels`çš„`outnput [Task,Task]`ï¼š  
   è®­ç»ƒå’Œé¢„æµ‹éƒ½è¾“å‡ºä¸º`Task`
- ä¸`Learner`ç±»ä¸åŒçš„æ˜¯ï¼Œ`PipeOp`å¯ä»¥åœ¨è®­ç»ƒé˜¶æ®µåè¿”å›ç»“æœ

```r
# åŠ è½½RåŒ…
# library(mlr3pipelines)

# é€‰æ‹©'pca'ç®¡é“
po_pca <- po('pca', center = TRUE)
po_pca
```

```js
PipeOp: <pca> (not trained)
values: <center=TRUE>
Input channels <name [train type, predict type]>:
  input [Task,Task]
Output channels <name [train type, predict type]>:
  output [Task,Task]
```

- ä¸‹é¢å¯¹`penguins_simple`ä»»åŠ¡çš„ç¼©å°ç‰ˆè¿›è¡ŒPCAåˆ†æ

```r
# åˆ›å»ºä»»åŠ¡
tsk_small <- tsk('penguins')
# é€‰æ‹©æ²¡æœ‰ç¼ºå¤±å€¼çš„æ•°æ®
tsk_small$filter(
    tsk_small$
        row_ids[complete.cases(tsk_small$data())]
)

# æ”¾åˆ°listé‡Œï¼ˆå¿…é¡»ï¼‰
poin <- list(tsk_small)
# ä¼ é€’ç»™`PipeOpPCA`è®­ç»ƒ
poout <- po_pca$train(poin)
# æŸ¥çœ‹ç»“æœ
poout
```

```js
$output

[36m--[39m [1m[34m<TaskClassif>[39m (333x8): Palmer Penguins[22m [36m--------------------------------------[39m
* Target: species
* Target classes: Adelie (44%), Gentoo (36%), Chinstrap (20%)
* Properties: multiclass
* Features (7):
  * dbl (5): PC1, PC2, PC3, PC4, PC5
  * fct (2): island, sex
```

- æŸ¥çœ‹PCAçš„ç»“æœ

```r
# è°ƒå–å¼€å¤´5ä¸ªæ ·æœ¬PCAç»“æœ
poout[[1]]$head()

# æŸ¥çœ‹å…¨éƒ¨æ ·æœ¬çš„PCAç»“æœ
# poout[[1]]$data()
```

- è®­ç»ƒå¾—åˆ°çš„æ—‹è½¬çŸ©é˜µä¹Ÿä¼šä¿å­˜åœ¨å†…éƒ¨Â `$state`Â å­—æ®µ

```r
po_pca$state
```

```js
Standard deviations (1, .., p=5):
[1] 805.3157531   7.1258611   4.0205105   1.5392977   0.7748449

Rotation (n x k) = (5 x 5):
                         PC1         PC2          PC3           PC4
bill_depth     -1.154327e-03 -0.08678513  0.144143265  0.9837576340
bill_length     4.003162e-03  0.31883248  0.941332235 -0.1084192852
body_mass       9.998759e-01 -0.01571143  0.001020094 -0.0003315664
flipper_length  1.519455e-02  0.94325408 -0.304144443  0.1250176180
year            2.210512e-05  0.02896694 -0.024727723  0.0695461097
                         PC5
bill_depth     -0.0625351521
bill_length     0.0216496177
body_mass       0.0004828135
flipper_length -0.0436763258
year            0.9968514404
```

- ä¹‹åå¯ä»¥ä¼ é€’ç»™`PipeOpPCA$predict()`ï¼Œè·å–é¢„æµ‹ç»“æœ

```r
# æŒ‘ä¸€ä¸ªæ ·æœ¬ç”¨äºé¢„æµ‹ç»“æœ
# æ³¨æ„ä½¿ç”¨`$clone()`ï¼Œå› ä¸º`filter()`æ˜¯å°±åœ°ä¿®æ”¹
tsk_onepenguin <- tsk_small$clone()$filter(42)
# åŒæ ·éœ€è¦ä¼ å…¥`list`
poin <- list(tsk_onepenguin)
# é¢„æµ‹
poout <- po_pca$predict(poin)
# æŸ¥çœ‹é¢„æµ‹ç»“æœ
poout[[1]]$data()
```

<table class='dataframe'>
<caption>A data.table: 1 x 8</caption>
<thead>
 <tr><th scope=col>species</th><th scope=col>island</th><th scope=col>sex</th><th scope=col>PC1</th><th scope=col>PC2</th><th scope=col>PC3</th><th scope=col>PC4</th><th scope=col>PC5</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>Adelie</td><td>Dream</td><td>male</td><td>-307.1238</td><td>-1.959404</td><td>-1.300082</td><td>0.8445978</td><td>-1.072759</td></tr>
</tbody>
</table>

### Graphï¼šPipeOpç½‘ç»œ

- `PipeOp`ä»£è¡¨æœºå™¨å­¦ä¹ ç®¡é“ä¸­çš„å„ä¸ªè®¡ç®—æ­¥éª¤ï¼Œ  
  è¿™äº›ç®¡é“æœ¬èº«ç”±Â `Graph`Â å¯¹è±¡å®šä¹‰
  - `Graph`Â æ˜¯Â `PipeOp`Â çš„é›†åˆï¼Œå¸¦æœ‰å¼•å¯¼æ•°æ®æµçš„ **è¾¹**ï¼ˆedgeï¼‰
- æ„å»º`Graph`æœ€ä¾¿æ·çš„æ–¹å¼æ˜¯ä½¿ç”¨`%>>%`è¿ç®—ç¬¦ï¼ˆè¯»ä½œâ€œåŒç®­å¤´â€ï¼‰è¿æ¥ä¸€ç³»åˆ—`PipeOp`
  - ç»™å®šä¸¤ä¸ª`PipeOp`æ—¶ï¼Œè¯¥è¿ç®—ç¬¦ä¼šåˆ›å»ºä¸€ä¸ª`Graph`ï¼Œ  
   å…ˆæ‰§è¡Œå·¦è¾¹çš„`PipeOp`ï¼Œå†æ‰§è¡Œå³è¾¹çš„
  - è¿˜å¯ç”¨äºè¿æ¥`Graph`ä¸`PipeOp`ï¼Œæˆ–è¿æ¥å¦ä¸€ä¸ª`Graph`

- ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨`po('mutate')`ä¸ºä»»åŠ¡æ·»åŠ ä¸€ä¸ªæ–°ç‰¹å¾ï¼Œ  
  ç„¶åä½¿ç”¨`po('scale')`å¯¹æ‰€æœ‰æ•°å€¼ç‰¹å¾è¿›è¡Œç¼©æ”¾å’Œä¸­å¿ƒåŒ–

```r
# æ„å»º`PipeOpMutate`
po_mutate <- po(
 'mutate',
 mutation = list(bill_ratio = ~ bill_length / bill_depth)
)
# æ„å»º`PipeOpScale`
po_scale <- po('scale')
# è¿æ¥ä¸¤ä¸ª`PipeOp`æ„å»º`Graph`
graph <- po_mutate %>>% po_scale
# æŸ¥çœ‹`Graph`
graph
```

```js
Graph with 2 PipeOps:
     ID         State sccssors prdcssors
 <char>        <char>   <char>    <char>
 mutate <<UNTRAINED>>    scale          
  scale <<UNTRAINED>>             mutate
```

- `Graph$plot()`å¯ä»¥è¿›è¡Œç®¡é“å¯è§†åŒ–

```r
graph$plot(horizontal = TRUE)
```

![image_2](./image_2.png)

- `Graph$plot()`æ‰“å°ç»„æˆçš„`PipeOp`çš„è¯¦æƒ…

```r
graph$pipeops
```

```js
$mutate
PipeOp: <mutate> (not trained)
values: <mutation=<list>, delete_originals=FALSE>
Input channels <name [train type, predict type]>:
  input [Task,Task]
Output channels <name [train type, predict type]>:
  output [Task,Task]

$scale
PipeOp: <scale> (not trained)
values: <robust=FALSE>
Input channels <name [train type, predict type]>:
  input [Task,Task]
Output channels <name [train type, predict type]>:
  output [Task,Task]
```

- `Graph$edges`å­—æ®µå¯ç”¨äºè®¿é—®è¾¹
  - å®ƒè¿”å›ä¸€ä¸ª`data.table`ï¼Œ  
   åˆ—å‡ºäº†æ²¿æ¯æ¡è¾¹æµåŠ¨çš„æ•°æ®çš„ **æº**ï¼ˆ`src_id`ï¼Œ`src_channel`ï¼‰å’Œ  
    **ç›®æ ‡**ï¼ˆ`dst_id`ï¼Œ`dst_channel`ï¼‰

```r
graph$edges
```

<table class='dataframe'>
<caption>A data.table: 1 x 4</caption>
<thead>
 <tr><th scope=col>src_id</th><th scope=col>src_channel</th><th scope=col>dst_id</th><th scope=col>dst_channel</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
 <tr><td>mutate</td><td>output</td><td>scale</td><td>input</td></tr>
</tbody>
</table>

- é™¤äº†ä½¿ç”¨Â `%>>%`ï¼Œè¿˜å¯ä»¥ä½¿ç”¨Â `$add_pipeop()`Â å’ŒÂ `$add_edge()`Â æ–¹æ³•  
  æ˜¾å¼åˆ›å»ºä¸€ä¸ªÂ `Graph`ï¼Œä»¥åˆ›å»ºÂ `PipeOp`Â ä»¥åŠè¿æ¥å®ƒä»¬çš„è¾¹

```r
graph <- Graph$new()$
 add_pipeop(po_mutate)$
 add_pipeop(po_scale)$
 add_edge('mutate', 'scale')
graph
```

```js
Graph with 2 PipeOps:
     ID         State sccssors prdcssors
 <char>        <char>   <char>    <char>
 mutate <<UNTRAINED>>    scale          
  scale <<UNTRAINED>>             mutate
```

- æ„å»ºå®Œæˆåï¼Œ`Graph` å¯ä»¥åƒ `Learner` ä¸€æ ·ï¼Œ  
  é€šè¿‡è°ƒç”¨ `$train()` å’Œ `$predict()` æ¥ä½¿ç”¨
  - ä¸è¿‡åœ¨è®­ç»ƒå’Œé¢„æµ‹è¿‡ç¨‹ä¸­ï¼Œå®ƒä»ç„¶è¾“å‡ºä¸€ä¸ª `list`

```r
result <- graph$train(tsk_small)
result
```

```js
$scale.output

[36m--[39m [1m[34m<TaskClassif>[39m (333x9): Palmer Penguins[22m [36m--------------------------------------[39m
* Target: species
* Target classes: Adelie (44%), Gentoo (36%), Chinstrap (20%)
* Properties: multiclass
* Features (8):
  * dbl (6): bill_depth, bill_length, bill_ratio, body_mass, flipper_length,
  year
  * fct (2): island, sex
```

```r
result[[1]]$data()[1:3]
```

<table class='dataframe'>
<caption>A data.table: 3 x 9</caption>
<thead>
 <tr><th scope=col>species</th><th scope=col>island</th><th scope=col>sex</th><th scope=col>bill_depth</th><th scope=col>bill_length</th><th scope=col>bill_ratio</th><th scope=col>body_mass</th><th scope=col>flipper_length</th><th scope=col>year</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>Adelie</td><td>Torgersen</td><td>male  </td><td>0.7795590</td><td>-0.8946955</td><td>-1.0421499</td><td>-0.5676206</td><td>-1.4246077</td><td>-1.281813</td></tr>
 <tr><td>Adelie</td><td>Torgersen</td><td>female</td><td>0.1194043</td><td>-0.8215515</td><td>-0.6804365</td><td>-0.5055254</td><td>-1.0678666</td><td>-1.281813</td></tr>
 <tr><td>Adelie</td><td>Torgersen</td><td>female</td><td>0.4240910</td><td>-0.6752636</td><td>-0.7434640</td><td>-1.1885721</td><td>-0.4257325</td><td>-1.281813</td></tr>
</tbody>
</table>

```r
result <- graph$predict(tsk_onepenguin)
result[[1]]$head()
```

<table class='dataframe'>
<caption>A data.table: 1 x 9</caption>
<thead>
 <tr><th scope=col>species</th><th scope=col>island</th><th scope=col>sex</th><th scope=col>bill_depth</th><th scope=col>bill_length</th><th scope=col>bill_ratio</th><th scope=col>body_mass</th><th scope=col>flipper_length</th><th scope=col>year</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>Adelie</td><td>Dream</td><td>male</td><td>0.6272156</td><td>-0.5838337</td><td>-0.7868552</td><td>-0.3813351</td><td>-0.4257325</td><td>-1.281813</td></tr>
</tbody>
</table>

### é¡ºåºå­¦ä¹ å™¨ç®¡é“

#### ç®€ä»‹

- `mlr3pipelines`æœ€å¸¸è§çš„åº”ç”¨æ˜¯ç”¨å®ƒæ¥æ‰§è¡Œé¢„å¤„ç†ä»»åŠ¡ï¼Œ  
  å¦‚ç¼ºå¤±å€¼æ’è¡¥æˆ–å› å­ç¼–ç ï¼Œ  
  ç„¶åå°†å¤„ç†åçš„æ•°æ®è¾“å…¥åˆ°`Learner`ä¸­
- æ­¤å·¥ä½œæµç¨‹çš„`Graph`åœ¨è®­ç»ƒæœŸé—´å¯¹æ•°æ®è¿›è¡Œæ“ä½œå¹¶æ‹Ÿåˆ`Learner`æ¨¡å‹ï¼Œ  
  ä»¥ç¡®ä¿åœ¨é¢„æµ‹é˜¶æ®µä»¥ç›¸åŒçš„æ–¹å¼å¤„ç†æ•°æ®
- ä¸‹å›¾è¡¨ç¤ºé¡ºåºå­¦ä¹ å™¨ç®¡é“å†…è®­ç»ƒå’Œé¢„æµ‹è¿‡ç¨‹çš„æ¦‚å¿µåŒ–
  - åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼ˆé¡¶è¡Œï¼‰ï¼Œæ•°æ®é€šè¿‡é¢„å¤„ç†ç®—å­ï¼Œ  
   æ¯ä¸ªç®—å­éƒ½ä¼šä¿®æ”¹æ•°æ®å¹¶åˆ›å»ºä¸€ä¸ª`$state`ï¼Œ  
   æœ€åï¼Œå­¦ä¹ å™¨æ¥æ”¶æ•°æ®å¹¶åˆ›å»ºä¸€ä¸ªæ¨¡å‹
  - åœ¨é¢„æµ‹è¿‡ç¨‹ä¸­ï¼ˆåº•è¡Œï¼‰ï¼Œæ•°æ®åŒæ ·ç”±é¢„å¤„ç†ç®—å­è¿›è¡Œè½¬æ¢ï¼Œ  
   åœ¨æ­¤è¿‡ç¨‹ä¸­ä½¿ç”¨å®ƒä»¬å„è‡ªçš„`$state`ï¼ˆç°è‰²æ¡†ï¼‰ä¿¡æ¯ï¼›  
   ç„¶åï¼Œå­¦ä¹ å™¨æ¥æ”¶ä¸è®­ç»ƒæœŸé—´æ‰€è§æ•°æ®æ ¼å¼ç›¸åŒçš„æ•°æ®ï¼Œå¹¶è¿›è¡Œé¢„æµ‹

![image_3](./image_3.png)

#### å°†`Learner`è½¬æ¢ä¸º`PipeOp`ï¼Œå°†`Graph`è½¬æ¢ä¸º`Learner`

- `Learner`å¯ä»¥é€šè¿‡`as_pipeop()`è½¬æ¢ä¸º`PipeOp`
- ä½¿ç”¨`%>>%`æ—¶æ— éœ€æ‰‹åŠ¨è½¬æ¢ï¼Œ  
  ä»…å½“éœ€è¦æŠŠå•ç‹¬çš„`Learner`è½¬æ¢ä¸º`Graph`æ—¶ï¼Œ  
  éœ€è¦äº‹å…ˆè½¬æ¢æˆ`PipeOp`è¿‡æ¸¡
  - è§ä¸‹æ–¹ä¾‹å­ï¼š

```r
# Learnerè¢«ä¸²èµ·æ¥çš„ä¾‹å­
lrn_logreg <- lrn('classif.log_reg')
graph <- po('imputesample') %>>% lrn_logreg
graph$plot(horizontal = TRUE)
```

![image_4](./image_4.png)

- è‹¥è¦å°†`Graph`ä½œä¸ºå…·æœ‰ç›¸åŒæ¥å£çš„`Learner`ä½¿ç”¨ï¼Œ  
  å¯ä»¥ä½¿ç”¨`as_learner()`å°†å…¶åŒ…è£…åœ¨ä¸€ä¸ª`GraphLearner`å¯¹è±¡ä¸­ï¼Œ  
  ç„¶åï¼Œè¯¥`Graph`å°±å¯ä»¥åƒå…¶ä»–ä»»ä½•`Learner`ä¸€æ ·ä½¿ç”¨
- ä¸‹é¢ä¾‹å­ä¸­åˆ†åˆ«å»ºç«‹ä¸¤ç§`Graph`å¹¶è¿›è¡Œbenchmarkæ¯”è¾ƒ
  - é‡é‡‡æ ·æ’è¡¥çš„`glrn_sample`
  - ä¼—æ•°æ’è¡¥çš„`glrn_mode`

```r
# å°†ä¸¤ä¸ª`Graph`è½¬æ¢ä¸º`Learner`
glrn_sample <- as_learner(graph)
glrn_mode <- as_learner(po('imputemode') %>>% lrn_logreg)
```

- å³ä½¿è½¬æ¢æˆäº†`GraphLearner`ç±»ï¼Œ  
  ä¾ç„¶å¯ä»¥ä½¿ç”¨`GraphLearner$plot(horizontal = TRUE)`  
  å¯¹`Graph`å¯è§†åŒ–

```r
glrn_mode$plot(horizontal = TRUE)
```

![image_5](./image_5.png)

- è½¬åŒ–ä¸º`GraphLearner`åå¯ä»¥å’Œæ™®é€šçš„`Learner`ä¸€æ ·  
  ä¼ é€’åˆ°`benchmark()`ä¸­è¿›è¡Œæ¯”è¾ƒ
  - åœ¨ä¸‹ä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼š

```r
# åˆ›å»ºä¸€ä¸ªbenchmarkçŸ©é˜µ
design <- benchmark_grid(
 tsk('pima'), 
 list(glrn_sample, glrn_mode),
 rsmp('cv', folds = 3)
)
# æ‰§è¡Œbenchmarkæ¯”è¾ƒ
bmr <- benchmark(design)
# å‚¨å­˜èšåˆç»“æœ
aggr <- bmr$aggregate()[, .(learner_id, classif.ce)]
# æŸ¥çœ‹ç»“æœ
aggr
```

<table class='dataframe'>
<caption>A bmr_aggregate: 2 x 2</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>classif.ce</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>imputesample.classif.log_reg</td><td>0.2330729</td></tr>
 <tr><td>imputemode.classif.log_reg  </td><td>0.2278646</td></tr>
</tbody>
</table>

#### æ£€æŸ¥`Graph`

- å¦‚æœç›¸æ£€æŸ¥ç®¡é“å’Œæ•°æ®æµä»¥è¿›ä¸€æ­¥äº†è§£ä½ çš„ç®¡é“æˆ–å¯¹å…¶è¿›è¡Œè°ƒè¯•
  - é¦–å…ˆéœ€è¦å°†Â `$keep_results`Â æ ‡ç­¾è®¾ç½®ä¸ºÂ `TRUE`ï¼Œ  
   ä»¥ä¾¿ä¿ç•™ä¸­é—´ç»“æœï¼Œé»˜è®¤æƒ…å†µä¸‹è¯¥æ ‡å¿—æ˜¯å…³é—­çš„ï¼Œä»¥èŠ‚çœå†…å­˜

```r
# å¯ä»¥åœ¨`as_learner()`å‰è®¾å®š
graph$keep_results <- TRUE
glrn_sample$graph_model$keep_results <- TRUE
glrn_sample$train(tsk('pima'))
```

- `GraphLearner`ä¸­çš„`$graph_model`å­—æ®µåŒ…å«äº†`Graph`
  - å› æ­¤å¯ä»¥å¯¹`GraphLearner$graph_model`è¿›è¡Œæ‰€æœ‰å’Œ`Graph`ç›¸åŒçš„æ“ä½œ

- ä¸‹åˆ—ä¾‹å­ä¸­å¯ä»¥æŸ¥çœ‹å…¨éƒ¨ä¸­é—´ç»“æœ
-

```r
imputesample_output <- glrn_sample$
 graph_model$
 pipeops$
 imputesample$
 .result
imputesample_output[[1]]$missings()
```

```js
diabetes      age pedigree pregnant  glucose  insulin     mass pressure 
       0        0        0        0        0        0        0        0 
 triceps 
       0 
```

- å¯ä»¥é€šè¿‡`Graph$$pipeops`è®¿é—®åº•å±‚`Learner`
  - ä¸‹é¢åˆ†åˆ«æ˜¾ç¤ºäº†æ¯ä¸€çº§çš„**ç±»**ï¼Œæ–¹ä¾¿äº†è§£è¿™äº›åŒ…è£…å…³ç³»

```r
pipeop_logreg <- glrn_sample$ # GraphLearner
 graph_model$ # Graph
 pipeops$ # PipeOp
 classif.log_reg # PipeOpLearner
learner_logreg <- pipeop_logreg$learner_model # LearnerClassifLogReg
learner_logreg
```

- åˆ°è¿™é‡Œä¸å¦¨æˆ‘ä»¬å†é‡æ–°æŒ‰é¡ºåºæ„å»ºä¸€éï¼Œ  
  å¹¶çœ‹çœ‹å®ƒä»¬çš„ç±»

```r
# 1
lrn('classif.log_reg') %>% class()
# 2
lrn('classif.log_reg') %>% po() %>% class()
# 3
po('imputesample') %>>% {lrn('classif.log_reg') %>% po()} %>% class()
# 4
po('imputesample') %>>% {lrn('classif.log_reg') %>% po()} %>% as_learner() %>% class()
```

```js
'LearnerClassifLogReg''LearnerClassif''Learner''R6'

'PipeOpLearner''PipeOp''R6'

'Graph''R6'

'GraphLearner''Learner''R6'
```

#### é…ç½®ç®¡é“è¶…å‚æ•°

- `PipeOp`çš„è¶…å‚æ•°é›†ä¸­æ”¶é›†åœ¨å›¾çš„Â `$param_set`Â ä¸­
- å¯ä»¥ä½¿ç”¨å®Œå…¨ä¸€æ ·çš„`PipeOp`ï¼Œå‰ææ˜¯è®¾ç½®`id`ï¼Œä»¥é¿å…å‚æ•°åå†²çª

```r
graph <- po('scale', center = FALSE, scale = TRUE, id = 'scale') %>>%
  po('scale', center = TRUE, scale = FALSE, id = 'center') %>>%
  lrn('classif.rpart', cp = 1)
graph$param_set$values
```

- **æ³¨æ„**ï¼š
  - å¦‚æœä½ éœ€è¦æ›´æ”¹ `Graph` ä¸­`PipeOp`çš„IDï¼Œ  
   åˆ™ä½¿ç”¨`Graph`ç±»ä¸­çš„`$set_names`æ–¹æ³•
    - `some_graph$set_names(old = 'old_name', new = 'new_name')`
- ä¸å¯é€šè¿‡  
  `graph$pipeops$<old_id>$id <- <new_id>`æ›´æ”¹`PipeOp`çš„ID
  - å› ä¸ºè¿™åªä¼šæ›´æ”¹`PipeOp`å¯¹è‡ªèº«IDçš„è®°å½•ï¼Œè€Œä¸ä¼šæ›´æ”¹`Graph`çš„è®°å½•ï¼Œè¿™å°†å¯¼è‡´é”™è¯¯

```r
$scale.center
FALSE
$scale.scale
TRUE
$scale.robust
FALSE
$center.center
TRUE
$center.scale
FALSE
$center.robust
FALSE
$classif.rpart.cp
1
$classif.rpart.xval
0
```

- æ— è®ºå°†ç®¡é“è§†ä¸º`Graph`è¿˜æ˜¯`GraphLearner`ï¼Œè¶…å‚æ•°çš„æ›´æ–°å’Œè®¿é—®æ–¹å¼éƒ½æ˜¯ç›¸åŒçš„

```r
# `Graph`ä¸¤ç§æ–¹æ³•
graph$param_set$values$classif.rpart.maxdepth <- 6
graph$param_set$values
graph$param_set$set_values(classif.rpart.maxdepth = 1)
graph$param_set$values

# è½¬æ¢æˆ`GraphLearner`
graph_learner <- as_learner(graph)

# `GraphLearner`ä¾ç„¶ä¸¤ç§æ–¹æ³•
graph_learner$param_set$values$classif.rpart.maxdepth <- 3
graph_learner$param_set$values
graph_learner$param_set$set_values(classif.rpart.maxdepth = 2)
graph_learner$param_set$values
```

## éé¡ºåºç®¡é“åŠè°ƒä¼˜

### ç®€å•æ¼”ç¤º

- `%>>%`èƒ½å¤Ÿå°†`PipeOp`æ’åˆ—æˆçº¿æ€§çš„`Graph`
- `gunion()`åˆ™å¯ä»¥å°†  
  `PipeOP`ï¼Œ`Graph`æˆ–å®ƒä»¬çš„ç»„åˆ  
  æ‹¼æ¥æˆå¯ä»¥å¹¶è¡Œçš„`Graph`

```r
# library(mlr3pipelines)

# ç®€å•çš„å¹¶è”
# é¦–å…ˆç”¨scaleå¼€å¤´
graph <- po('scale', center = TRUE, scale = FALSE) %>>%
    # `gunion()`æ¥å—`list`çš„ä¼ é€’
    gunion(
     # `list`å†…éƒ¨åˆ™æ˜¯è¦å¹¶è”çš„ç®¡é“å…ƒä»¶
        list(
         # è¾¨åˆ«æŸç‰¹å¾æ˜¯å¦å­˜åœ¨ç¼ºå¤±å€¼
            po('missind'), 
            # å¯¹ç¼ºå¤±å€¼ç”¨ä¸­ä½æ•°å¡«å……
            po('imputemedian') 
        )
    ) %>>%
    # æœ€åå†ä¸²è”ä¸€ä¸ªç®¡é“å…ƒä»¶
    # åˆå¹¶åˆ†æ”¯è¾“å‡ºçš„ç»“æœ
    po('featureunion')

graph$plot(horizontal = TRUE)
```

![image_6](./image_6.png)

- `Graph$edges`ä¾ç„¶å¯ä»¥æŸ¥çœ‹è¾“å…¥ä¸è¾“å‡ºçš„è¡¨æ ¼

```r
graph$edges
```

<table class='dataframe'>
<caption>A data.table: 4 x 4</caption>
<thead>
 <tr><th scope=col>src_id</th><th scope=col>src_channel</th><th scope=col>dst_id</th><th scope=col>dst_channel</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
 <tr><td>scale       </td><td>output</td><td>missind     </td><td>input</td></tr>
 <tr><td>scale       </td><td>output</td><td>imputemedian</td><td>input</td></tr>
 <tr><td>missind     </td><td>output</td><td>featureunion</td><td>...  </td></tr>
 <tr><td>imputemedian</td><td>output</td><td>featureunion</td><td>...  </td></tr>
</tbody>
</table>

- ç”¨åˆšåˆšæ„å»ºçš„`graph`ä½œç”¨äº`tsk('pima')`çš„å‰ä¸‰è¡Œï¼Œ  
  å¯ä»¥çœ‹åˆ°å®ƒå¦‚ä½•ä¼°ç®—ç¼ºå¤±æ•°æ®ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªåˆ—æ¥æŒ‡ç¤ºå“ªäº›å€¼æ˜¯ç¼ºå¤±çš„

```r
tsk_pima_head <- tsk('pima')$filter(1:3)
tsk_pima_head$data(cols = c('diabetes', 'insulin', 'triceps'))

result <- graph$train(tsk_pima_head)[[1]]
result$data(
 cols = c(
  'diabetes', 
  'insulin', 
  'missing_insulin', 
  'triceps',
  'missing_triceps'
  )
)
```

<table class='dataframe'>
<caption>A data.table: 3 x 3</caption>
<thead>
 <tr><th scope=col>diabetes</th><th scope=col>insulin</th><th scope=col>triceps</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>pos</td><td>NA</td><td>35</td></tr>
 <tr><td>neg</td><td>NA</td><td>29</td></tr>
 <tr><td>pos</td><td>NA</td><td>NA</td></tr>
</tbody>
</table>

<table class='dataframe'>
<caption>A data.table: 3 x 5</caption>
<thead>
 <tr><th scope=col>diabetes</th><th scope=col>insulin</th><th scope=col>missing_insulin</th><th scope=col>triceps</th><th scope=col>missing_triceps</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;fct&gt;</th></tr>
</thead>
<tbody>
 <tr><td>pos</td><td>0</td><td>missing</td><td> 3</td><td>present</td></tr>
 <tr><td>neg</td><td>0</td><td>missing</td><td>-3</td><td>present</td></tr>
 <tr><td>pos</td><td>0</td><td>missing</td><td> 0</td><td>missing</td></tr>
</tbody>
</table>

### é€‰æ‹©å™¨ä¸å¹¶è¡Œç®¡é“

- ä¸‹å›¾å±•ç°äº†ä¸¤ç§æ“ä½œæ€è·¯ï¼š
  - ç¬¬ä¸€ä¸ªï¼šå…ˆå¯¹ä¸€éƒ¨åˆ†åˆ—è¿›è¡Œæ“ä½œ1ï¼Œå†å¯¹å‰©ä½™éƒ¨åˆ†è¿›è¡Œæ“ä½œ2
  - ç¬¬äºŒä¸ªï¼šå¯¹ä¸€éƒ¨åˆ†åˆ—è¿›è¡Œæ“ä½œ1å’Œå¯¹å‰©ä½™éƒ¨åˆ†è¿›è¡Œæ“ä½œ2æ˜¯å¹¶è¡Œçš„ï¼Œ  
   æœ€åç”¨`po('featureunion')`è¿›è¡Œæ•´åˆ

![image_7](./image_7.png)
![image_8](./image_8.png)
  
- ä¸Šè¿°ç”¨äº†`Selector`ç³»åˆ—çš„é€‰æ‹©å™¨å‡½æ•°
  - `selector_grep()`ï¼š  
   æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ—
  - `selector_name`ï¼š  
   é€‰æ‹©å’Œåå­—å®Œå…¨åŒ¹é…çš„åˆ—
  - `selector_type()`ï¼š  
   åˆ—ç±»å‹åŒ¹é…åˆ—
  - `selector_intersect`ï¼š  
   é€‰æ‹©äº¤é›†
  - `selector_union()`ï¼š  
   é€‰æ‹©å¹¶é›†
  - `selector_setdiff()`ï¼š  
   é€‰æ‹©å·®é›†
  - `selector_invert()`ï¼š  
   é€‰æ‹©è¡¥é›†
  - `selector_missing()`ï¼š  
   é€‰æ‹©æœ‰ç¼ºå¤±å€¼çš„åˆ—
  - `selector_cardinality_greater_than()`ï¼š  
   é€‰æ‹©åŸºæ•°å¤§é›¨ç»™å®šé˜ˆå€¼çš„**åˆ†ç±»ç‰¹å¾**
  - `selector_all()`ï¼š  
   é€‰æ‹©æ‰€æœ‰åˆ—
  - `selector_none()`ï¼š  
   ä¸é€‰æ‹©ä»»ä½•åˆ—

- ä¸‹é¢æ˜¯ä¸ä½¿ç”¨`Task$select()`ï¼Œ  
  è€Œæ˜¯`select_grep()`å’Œ`select_invert()`çš„æ–¹ä¾¿æ“ä½œ

```r
# tsk('penguins_simple')åœ¨`mlr3data`åŒ…ä¸­
# library(mlr3data)

# å»ºç«‹ä¸¤ä¸ªé€‰æ‹©å™¨ï¼š
# æ‰€æœ‰å¼€å¤´ä¸º`bill`
sel_bill <- selector_grep('^bill')
# ä¸Šé¢é€‰æ‹©å™¨çš„è¡¥é›†
sel_not_bill <- selector_invert(sel_bill)

# å»ºç«‹ä¸€ä¸ª`Graph`ï¼š
# å…ˆå¯¹å¼€å¤´ä¸ä¸º`bill`çš„åˆ—ç¼©æ”¾
graph <- po('scale', affect_columns = sel_not_bill) %>>% 
 # å†å¯¹å¼€å¤´ä¸º`bill`çš„åˆ—è¿›è¡ŒPCA
 po('pca', affect_columns = sel_bill)

# å¯¹`Task`è¿è¡Œ`Graph`
result <- graph$train(tsk('penguins'))

# æŸ¥çœ‹å‰ä¸‰è¡Œç»“æœ
result[[1]]$data()[1:3, ]
```

<table class='dataframe'>
<caption>A data.table: 3 x 11</caption>
<thead>
 <tr><th scope=col>species</th><th scope=col>PC1</th><th scope=col>PC2</th><th scope=col>body_mass</th><th scope=col>flipper_length</th><th scope=col>island.Biscoe</th><th scope=col>island.Dream</th><th scope=col>island.Torgersen</th><th scope=col>sex.female</th><th scope=col>sex.male</th><th scope=col>year</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>Adelie</td><td>-5.014734</td><td> 1.0716828</td><td>-0.5676206</td><td>-1.4246077</td><td>-0.977724</td><td>-0.7641697</td><td>2.463094</td><td>-0.9895421</td><td> 0.9895421</td><td>-1.281813</td></tr>
 <tr><td>Adelie</td><td>-4.495124</td><td>-0.1852998</td><td>-0.5055254</td><td>-1.0678666</td><td>-0.977724</td><td>-0.7641697</td><td>2.463094</td><td> 1.0075337</td><td>-1.0075337</td><td>-1.281813</td></tr>
 <tr><td>Adelie</td><td>-3.754628</td><td> 0.4867612</td><td>-1.1885721</td><td>-0.4257325</td><td>-0.977724</td><td>-0.7641697</td><td>2.463094</td><td> 1.0075337</td><td>-1.0075337</td><td>-1.281813</td></tr>
</tbody>
</table>

- å¯¹äºä¸Šé¢çš„ä¸²è”`Graph`è€Œè¨€ï¼Œå¦‚æœé¡ºåº å¼„æ··ï¼Œåˆ™ä¼šå¯¼è‡´ç»“æœå‡ºç°é‡å¤§é”™è¯¯
- ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œæ›´å¥½çš„æ˜¯å»ºç«‹ä¸€ä¸ªå¹¶è”`Graph`

```r
po_select_bill <- po(
 'select', 
 id = 's_bill', 
 selector = sel_bill
)
po_select_not_bill <- po(
 'select', 
 id = 's_notbill',
 selector = sel_not_bill
)

path_pca <-  po_select_bill %>>% po('pca')
path_scale <- po_select_not_bill %>>% po('scale')

graph <- gunion(list(path_pca, path_scale)) %>>% po('featureunion')

# å¯è§†åŒ–`Graph`æµç¨‹
graph$plot(horizontal = TRUE)
```

![image_9](./image_9.png)

- ä½¿ç”¨`po('nop')`è¡¨ç¤ºä¸è¿›è¡Œä»»ä½•æ“ä½œ

```r
graph <- gunion(list(
 po_select_bill %>>% po('scale'),
 po_select_not_bill %>>% po('nop')
)) %>>% po('featureunion')

graph$plot(horizontal = TRUE)
```

![image_10](./image_10.png)

```r
graph$train(tsk('penguins_simple'))[[1]]$data()[1:3,]
```

<table class='dataframe'>
<caption>A data.table: 3 x 11</caption>
<thead>
 <tr><th scope=col>species</th><th scope=col>bill_depth</th><th scope=col>bill_length</th><th scope=col>body_mass</th><th scope=col>flipper_length</th><th scope=col>island.Biscoe</th><th scope=col>island.Dream</th><th scope=col>island.Torgersen</th><th scope=col>sex.female</th><th scope=col>sex.male</th><th scope=col>year</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
 <tr><td>Adelie</td><td>0.7795590</td><td>-0.8946955</td><td>3750</td><td>181</td><td>0</td><td>0</td><td>1</td><td>0</td><td>1</td><td>2007</td></tr>
 <tr><td>Adelie</td><td>0.1194043</td><td>-0.8215515</td><td>3800</td><td>186</td><td>0</td><td>0</td><td>1</td><td>1</td><td>0</td><td>2007</td></tr>
 <tr><td>Adelie</td><td>0.4240910</td><td>-0.6752636</td><td>3250</td><td>195</td><td>0</td><td>0</td><td>1</td><td>1</td><td>0</td><td>2007</td></tr>
</tbody>
</table>

### å¸¸è§æ¨¡å¼ä¸`ppl()`

- ç”±äºå¤§éƒ¨åˆ†çš„æœºå™¨å­¦ä¹ çš„ä¸€äº›å¤„ç†æ˜¯å…±åŒçš„ï¼Œ  
  `mlr3`é¢„è®¾äº†ä¸€äº›ç®¡é“
  - `ppl()`å¯ä»¥å¿«é€Ÿè°ƒç”¨

- å‡ ç§å¸¸ç”¨çš„
  - `ppl('bagging', graph)`ï¼šè£…è¢‹  
    - åœ¨`mlr3pipelines`ä¸­ï¼Œ  
    è£…è¢‹æ˜¯æŒ‡åœ¨ä¸åŒçš„æ•°æ®æ ·æœ¬ä¸Šå¤šæ¬¡è¿è¡Œ`graph`ï¼Œ  
    ç„¶åå¯¹ç»“æœå–å¹³å‡å€¼çš„è¿‡ç¨‹
  - `ppl('branch', graphs)`ï¼š  
    - ä½¿ç”¨Â `PipeOpBranch`Â ä»ç»™å®šçš„Â `graphs`Â ä¸­åˆ›å»ºä¸åŒçš„è·¯å¾„åˆ†æ”¯ï¼Œ  
    å…¶ä¸­åªæœ‰ä¸€ä¸ªåˆ†æ”¯ä¼šè¢«æ±‚å€¼
  - `ppl('greplicate', graph, n)`ï¼š
    - åˆ›å»ºä¸€ä¸ªÂ `Graph`ï¼Œè¯¥å›¾å°†Â `graph`ï¼ˆä¹Ÿå¯ä»¥æ˜¯å•ä¸ªÂ `PipeOp`ï¼‰å¤åˆ¶Â `n`Â æ¬¡
    - è¯¥ç®¡é“é€šè¿‡å‘æ¯ä¸ªÂ `PipeOp`Â æ·»åŠ åç¼€æ¥é¿å…IDå†²çª
  - `ppl('ovr', graph)`ï¼šä¸€å¯¹å¤šåˆ†ç±»  
    - ç”¨äºå°†å¤šåˆ†ç±»ä»»åŠ¡è½¬æ¢ä¸ºå¤šä¸ªäºŒåˆ†ç±»ä»»åŠ¡ï¼Œ  
    æ¯ä¸ªä»»åŠ¡å¯¹åº”åŸå§‹ä»»åŠ¡ä¸­çš„ä¸€ä¸ªç±»åˆ«
    - ç„¶åï¼Œè¿™äº›ä»»åŠ¡ç”±ç»™å®šçš„Â `graph`Â è¿›è¡Œè¯„ä¼°ï¼Œ  
    `graph` åº”è¯¥æ˜¯ä¸€ä¸ªå­¦ä¹ å™¨  
    ï¼ˆæˆ–åŒ…å«ä¸€ä¸ªèƒ½ç”Ÿæˆé¢„æµ‹ç»“æœçš„å­¦ä¹ å™¨çš„ç®¡é“ï¼‰
    - å¯¹äºŒåˆ†ç±»ä»»åŠ¡æ‰€åšçš„é¢„æµ‹å°†åˆå¹¶ä¸ºåŸå§‹ä»»åŠ¡æ‰€éœ€çš„å¤šåˆ†ç±»é¢„æµ‹
  - `ppl('robustify')`ï¼š
    - æ‰§è¡Œå¸¸è§çš„é¢„å¤„ç†æ­¥éª¤ï¼Œ  
    ä½¿ä»»ä½•Â `Task`Â éƒ½èƒ½ä¸ç»™å®šçš„Â `Learner`Â å…¼å®¹
  - `ppl('stacking', base_learners, super_learner)`ï¼šå †å æ³•
    - æ˜¯æŒ‡å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å‹ï¼ˆ`base_learners`ï¼‰çš„é¢„æµ‹ç»“æœ  
    ä½œä¸ºåç»­æ¨¡å‹ï¼ˆ`super_learner`ï¼‰çš„ç‰¹å¾çš„è¿‡ç¨‹
  - `ppl('targettrafo', graph)`ï¼š
    - åˆ›å»ºä¸€ä¸ª`Graph`ï¼Œè¯¥`Graph`è½¬æ¢`Task`çš„é¢„æµ‹ç›®æ ‡ï¼Œ  
    å¹¶ç¡®ä¿åœ¨è®­ç»ƒæœŸé—´åº”ç”¨çš„ä»»ä½•å˜æ¢  
    ï¼ˆä½¿ç”¨ä¼ é€’ç»™`targetmutate.trafo`è¶…å‚æ•°çš„å‡½æ•°ï¼‰  
    åœ¨æœ€ç»ˆé¢„æµ‹ä¸­è¢«åè½¬  
    ï¼ˆä½¿ç”¨ä¼ é€’ç»™`targetmutate.inverter`è¶…å‚æ•°çš„å‡½æ•°ï¼‰

### ä¾‹å­

#### ä½¿ç”¨`greplicate`å’Œ`subsample`è¿›è¡Œè£…è¢‹ï¼ˆBaggingï¼‰

- **è£…è¢‹æ³•**ï¼ˆæºäºâ€œè‡ªåŠ©èšé›†â€ï¼ˆ**b**ootstrappÂ **agg**regat**ing**ï¼‰ï¼‰
  - åŸºæœ¬æ€æƒ³å³æŠŠå¤šä¸ªé¢„æµ‹å™¨èšåˆæˆä¸€ä¸ªæ›´å¼ºæœ‰åŠ›çš„å•ä¸€é¢„æµ‹å™¨
  - å¯¹äºå›å½’ä»»åŠ¡ï¼Œé¢„æµ‹ç»“æœé€šå¸¸é€šè¿‡ç®—æœ¯å¹³å‡è¿›è¡Œèšåˆï¼›  
   å¯¹äºåˆ†ç±»ä»»åŠ¡ï¼Œåˆ™é€šè¿‡å¤šæ•°è¡¨å†³è¿›è¡Œèšåˆ
  - è£…è¢‹æ³•èƒŒåçš„æ½œåœ¨ç›´è§‰æ˜¯ï¼Œ  
   å¯¹ä¸€ç»„ä¸ç¨³å®šä¸”å¤šæ ·ï¼ˆå³ä»…å¼±ç›¸å…³ï¼‰çš„é¢„æµ‹å™¨è¿›è¡Œå¹³å‡ï¼Œ  
   å¯ä»¥é™ä½æ€»ä½“é¢„æµ‹çš„æ–¹å·®
  - æ¯ä¸ªå­¦ä¹ å™¨éƒ½åœ¨åŸå§‹æ•°æ®çš„ä¸åŒéšæœºæ ·æœ¬ä¸Šè¿›è¡Œè®­ç»ƒ
- ä¸‹å›¾è¡¨ç¤ºäº†åŸºæœ¬åŸç†ï¼š  
  - é€šè¿‡å¯¹æ•°æ®è¿›è¡Œç‹¬ç«‹å­é‡‡æ ·å¹¶æ‹Ÿåˆå•ä¸ªå†³ç­–æ ‘å­¦ä¹ å™¨æ¥æ‰§è¡Œè£…è¢‹æ³•çš„å›¾
  - æœ€ç»ˆçš„é¢„æµ‹ç»“æœç”±å¤šæ•°æŠ•ç¥¨ `PipeOp` æ±‡æ€»å¾—å‡º

![image_11](./image_11.png)

- ä¸‹é¢**æ‰‹åŠ¨æ„å»º**ä¸€ä¸ªbaggingçš„`Graph`

```r
# å»ºç«‹ä¸€ä¸ª`Graph`ï¼š
# ä»æ ·æœ¬ä¸­è¿›è¡Œ0.7æ¯”ä¾‹çš„æ— æ”¾å›é‡‡æ ·
# ç”¨é‡‡æ ·åçš„æ ·æœ¬è®­ç»ƒrpart
gr_single_pred <- po('subsample', frac = 0.7) %>>% lrn('classif.rpart')

# å°†`Graph``gr_single_pred`é‡å¤10æ¬¡
gr_pred_set <- ppl('greplicate', graph = gr_single_pred, n = 10)

# å°†`Graph``gr_pred_set`ä¼ é€’ç»™`po('classifavg')
# å¹¶è¾“å…¥`innum = 10`ä»¥ä¼ è¾“é‡å¤10æ¬¡çš„ä¿¡æ¯
gr_bagging <- gr_pred_set %>>% po('classifavg', innum = 10)

# å¯¹æœ€ç»ˆçš„`Graph`å¯è§†åŒ–
gr_bagging$plot()
```

![image_12](./image_12.png)

- å°†åˆšæ„å»ºçš„bagging`Graph`ç”¨äº`tsk('sonar')
  - å¯ä»¥çœ‹å‡ºbaggingæ¯”å†³ç­–æ ‘æ•ˆæœå¥½ï¼Œ  
   ä½†æ˜¯å·®äºéšæœºæ£®æ—

```r
# å°†`Graph`è½¬æ¢æˆ`GraphLearner`
glrn_bagging <- as_learner(gr_bagging)
glrn_bagging$id <- 'bagging'

lrn_rpart <- lrn('classif.rpart')
# å°†`glrn_bagging`ï¼Œ`lrn_rpart`, 
# ä»¥åŠ`lrn('classif.ranger')`è¿›è¡Œbenchmarkæ¯”è¾ƒ
learners <- c(glrn_bagging, lrn_rpart, lrn('classif.ranger'))

# è¿›è¡Œbenchmarkæ¯”è¾ƒ
bmr <- benchmark(
 benchmark_grid(
  tsk('sonar'), 
  learners,
  rsmp('cv', folds = 3)
 )
)

# æŸ¥çœ‹æ•´åˆåçš„å­¦ä¹ å™¨ç»“æœ
bmr$aggregate()[, .(learner_id, classif.ce)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 3 x 2</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>classif.ce</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>bagging       </td><td>0.2404417</td></tr>
 <tr><td>classif.rpart </td><td>0.2979986</td></tr>
 <tr><td>classif.ranger</td><td>0.1878537</td></tr>
</tbody>
</table>

- å¯¹äºä¸Šé¢çš„bagging `Graph` æ›´ç®€å•çš„**è‡ªåŠ¨æ„å»º**æ–¹æ³•æ˜¯ç”¨`ppl('bagging', ...)`
  - `collect_multiplicity`ï¼šæ˜¯å¦æ”¶é›†è·¨è·¯å¾„é¢„æµ‹ç»“æœ

```r
ppl(
 'bagging', 
 rn('classif.rpart'),
 iterations = 10, frac = 0.7,
 averager = po(
  'classifavg', 
  collect_multiplicity = TRUE
 )
)
```

- éšæœºæ£®æ—ç®—æ³•è¿›è¡Œäº†ç‰¹å¾å˜é‡çš„å­é‡‡æ ·
  - ä¸ºäº†æ¨¡æ‹Ÿè¿™ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹ç®¡é“è®¾å®š

```r
# åˆ›å»ºä¸€ä¸ªé‡‡æ ·å™¨
# è¿™é‡Œçš„é‡‡æ ·å™¨åªæ˜¯ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼š
# ä»`Task`ä¸­ç‰¹å¾å˜é‡ä¸­ï¼Œ
# éšæœºæŒ‘é€‰ç‰¹å¾å˜é‡æ•°é‡çš„ç®—æœ¯å¹³æ–¹æ ¹ä¸ªå˜é‡
selector_subsample <- function(task) {
 sample(
  task$feature_names, 
  sqrt(length(task$feature_names))
 )
}

# åˆ›å»ºä¸€ä¸ªbagging `Graph`
gr_bagging_quasi_rf <- ppl(
 'bagging',
 graph = po('select', selector = selector_subsample) %>>%
     lrn('classif.rpart', minsplit = 1),
 # è¿­ä»£100æ¬¡
 iterations = 100,
 # è®¾ç½®ç»“æœçš„æ•´åˆæ–¹å¼
 averager = po('classifavg', collect_multiplicity = TRUE)
)

# å°†é‡é‡‡æ ·æ˜¯å¦è¿”å›è®¾å®šä¸ºTRUE
# å› æ­¤å˜æˆäº†è‡ªåŠ©æ³•é‡é‡‡æ ·
gr_bagging_quasi_rf$
 param_set$
 values$
 subsample.replace <- TRUE

# å°†`Graph`è½¬å˜ä¸º`GraphLearner`
glrn_quasi_rf <- as_learner(gr_bagging_quasi_rf)
# è®¾ç½®ä¸€ä¸ªå”¯ä¸€ID
glrn_quasi_rf$id <- 'quasi.rf'

# è¿›è¡Œbenchmarkæ¯”è¾ƒ
design <- benchmark_grid(
 tsks('sonar'),
 c(
  glrn_quasi_rf, 
  lrn('classif.ranger', num.trees = 100)
 ),
 rsmp('cv', folds = 5)
)
bmr <- benchmark(design)

# æŸ¥çœ‹èšåˆç»“æœ
bmr$aggregate()[, .(learner_id, classif.ce)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 2 x 2</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>classif.ce</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>quasi.rf      </td><td>0.1732869</td></tr>
 <tr><td>classif.ranger</td><td>0.1681765</td></tr>
</tbody>
</table>

#### ä½¿ç”¨`po(â€œlearner_cvâ€)`è¿›è¡Œå †å 

- å †å 
  - å°†å¤šä¸ªæ¨¡å‹ï¼ˆé€šå¸¸ç§°ä¸º0å±‚æ¨¡å‹ï¼‰çš„é¢„æµ‹ç»“æœä½œä¸ºåç»­æ¨¡å‹ï¼ˆ1å±‚æ¨¡å‹ï¼‰çš„ç‰¹å¾ï¼Œ  
   è€Œ1å±‚æ¨¡å‹åˆä¼šç»“åˆè¿™äº›é¢„æµ‹ç»“æœ
- ä¸€ç§ç®€å•çš„ç»„åˆæ–¹å¼å¯ä»¥æ˜¯çº¿æ€§æ¨¡å‹ï¼ˆå¦‚æœæœ‰è®¸å¤š0å±‚æ¨¡å‹ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œæ­£åˆ™åŒ–ï¼‰ï¼Œ  
   å› ä¸º0å±‚æ¨¡å‹çš„åŠ æƒå’Œé€šå¸¸æ˜¯åˆç†ä¸”è¶³å¤Ÿå¥½çš„
- ä¸è¿‡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨éçº¿æ€§çš„1å±‚æ¨¡å‹ï¼Œ  
  å¹¶ä¸”1å±‚æ¨¡å‹ä¹Ÿæœ‰å¯èƒ½åŒæ—¶è®¿é—®è¾“å…¥ç‰¹å¾å’Œ0å±‚æ¨¡å‹çš„é¢„æµ‹ç»“æœ
- ä»æ¦‚å¿µä¸Šè®²ï¼Œåœ¨`mlr3`ä¸­ä¹Ÿå¯ä»¥æ„å»ºè¶…è¿‡ä¸¤å±‚çš„å †å ç»“æ„ï¼Œ  
  ä½†åœ¨è¿™é‡Œåªå±€é™äºè¿™ç§æ›´ç®€å•çš„è®¾ç½®ï¼Œå› ä¸ºå®ƒåœ¨å®é™…åº”ç”¨ä¸­é€šå¸¸ä¹Ÿè¡¨ç°è‰¯å¥½

![image_13](./image_13.png)

- è¿™é‡Œåˆ›å»ºäº†3ä¸ªå­¦ä¹ å™¨ï¼Œå¹¶ä¸”é€šè¿‡è¿æ¥CVé‡é‡‡æ ·å„è‡ªå½¢æˆ3ä¸ª`Graph`

```r
lrn_rpart <- lrn('classif.rpart', predict_type = 'prob')
po_rpart_cv <- po(
 'learner_cv', 
 learner = lrn_rpart,
 resampling.folds = 2, 
 id = 'rpart_cv'
)

lrn_knn <- lrn('classif.kknn', predict_type = 'prob')
po_knn_cv <- po(
 'learner_cv',
 learner = lrn_knn,
 resampling.folds = 2, 
 id = 'knn_cv'
)

lrn_glmnet <- lrn('classif.glmnet', predict_type = 'prob')
po_glmnet_cv <- po(
 'learner_cv',
 learner = lrn_glmnet,
 resampling.folds = 2, 
 id = 'glmnet_cv'
)
```

- å°†ä¸Šè¿°3ä¸ª`Graph`å¹¶è”ï¼Œå¹¶è¿æ¥ä¸€ä¸ªæ•´åˆç»“æœçš„`PipeOp`
- å°†è¿™ä¸ªæ„æˆçš„`Graph`è®­ç»ƒ`tsk('sonar')`å¹¶æŸ¥çœ‹ç»“æœ

```r
gr_level_0 <- gunion(list(po_rpart_cv, po_knn_cv, po_glmnet_cv))
gr_combined <- gr_level_0 %>>% po('featureunion')

# ç”±äº`GraphLearner`æ¥å—å’Œè¾“å‡ºéƒ½æ˜¯`list`
# å¯¹äºåªæœ‰ä¸€ä¸ªèµ·ç‚¹çš„è¾“å…¥è€Œè¨€è¾“å‡ºä¹Ÿæ˜¯åªåŒ…å«ä¸€ä¸ªå…ƒç´ çš„`list`
# å› æ­¤ç”¨`list[[1]]`æ¥è°ƒå–
gr_combined$train(tsk('sonar'))[[1]]$head()
```

<table class='dataframe'>
<caption>A data.table: 6 x 7</caption>
<thead>
 <tr><th scope=col>Class</th><th scope=col>rpart_cv.prob.M</th><th scope=col>rpart_cv.prob.R</th><th scope=col>knn_cv.prob.M</th><th scope=col>knn_cv.prob.R</th><th scope=col>glmnet_cv.prob.M</th><th scope=col>glmnet_cv.prob.R</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>R</td><td>0.05555556</td><td>0.94444444</td><td>0.42308735</td><td>0.5769126</td><td>0.77722963</td><td>0.2227703659</td></tr>
 <tr><td>R</td><td>0.93333333</td><td>0.06666667</td><td>0.72902464</td><td>0.2709754</td><td>0.57270947</td><td>0.4272905324</td></tr>
 <tr><td>R</td><td>0.89473684</td><td>0.10526316</td><td>0.52294416</td><td>0.4770558</td><td>0.99908407</td><td>0.0009159289</td></tr>
 <tr><td>R</td><td>0.58333333</td><td>0.41666667</td><td>0.32588147</td><td>0.6741185</td><td>0.46964796</td><td>0.5303520359</td></tr>
 <tr><td>R</td><td>0.41666667</td><td>0.58333333</td><td>0.58797952</td><td>0.4120205</td><td>0.39418320</td><td>0.6058167974</td></tr>
 <tr><td>R</td><td>0.41666667</td><td>0.58333333</td><td>0.07610223</td><td>0.9238978</td><td>0.02457426</td><td>0.9754257401</td></tr>
</tbody>
</table>

- ç”±äºè¿™æ˜¯ä¸€ä¸ªäºŒå…ƒåˆ†ç±»çš„é—®é¢˜ï¼Œåªéœ€è¦é€‰æ‹©é¢„æµ‹`M`æˆ–`R`å³å¯
  - è¿™é‡Œåªé€‰æ‹©é¢„æµ‹`M`çš„æ¦‚ç‡ä»¥åŠç»“æœ

```r
gr_stack <- gr_combined %>>%
  po('select', selector = selector_grep('\\.M$'))
```

- è¿æ¥1çº§å­¦ä¹ å™¨`lrn('classif.log_reg')}`ï¼Œ  
  å¹¶å¯¹`Graph`å¯è§†åŒ–

```r
gr_stack <- gr_stack %>>% po('learner', lrn('classif.log_reg'))
gr_stack$plot(horizontal = TRUE)
```

![image_14](./image_14.png)

- `Graph`è½¬æ¢ä¸º`GraphLearner`ï¼Œå¹¶ç”¨äºè®­ç»ƒ`tsk('sonar')`ï¼Œ  
  å†é€šè¿‡æŸ¥çœ‹æœ€ç»ˆè®­ç»ƒå¥½çš„æ¨¡å‹æ¥æ£€æŸ¥0çº§å­¦ä¹ å™¨çš„æƒé‡
  - æ¨¡å‹æƒé‡è¡¨æ˜ï¼ŒKè¿‘é‚»ç®—æ³•ï¼ˆKNNï¼‰ä»¥æœ€å¤§çš„ç³»æ•°å¯¹é¢„æµ‹ç»“æœå½±å“æœ€å¤§

```r
glrn_stack <- as_learner(gr_stack)
glrn_stack$train(tsk('sonar'))
glrn_stack$base_learner()$model
```

```js
Call:  stats::glm(formula = form, family = 'binomial', data = data, 
    model = FALSE)

Coefficients:
     (Intercept)   rpart_cv.prob.M     knn_cv.prob.M  glmnet_cv.prob.M  
          -4.863             1.423             6.058             1.095  

Degrees of Freedom: 207 Total (i.e. Null);  204 Residual
Null Deviance:     287.4 
Residual Deviance: 144  AIC: 152
```

- å°†å„ä¸ªæ¨¡å‹ä¸å †å ç®¡é“ä¸€èµ·è¿›è¡ŒåŸºå‡†æµ‹è¯•ä»¥éªŒè¯0çº§å­¦ä¹ å™¨ä¸­KNNçš„æ•ˆæœæœ€ä½³

```r
glrn_stack$id <- 'stacking'

design <- benchmark_grid(
 tsk('sonar'),
 list(lrn_rpart, lrn_knn, lrn_glmnet, glrn_stack), 
 rsmp('repeated_cv')
)
bmr <- benchmark(design)

bmr$aggregate()[, .(learner_id, classif.ce)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 4 x 2</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>classif.ce</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>classif.rpart </td><td>0.2884048</td></tr>
 <tr><td>classif.kknn  </td><td>0.1413095</td></tr>
 <tr><td>classif.glmnet</td><td>0.2471429</td></tr>
 <tr><td>stacking      </td><td>0.1296667</td></tr>
</tbody>
</table>

- `ppl('stacking', ...)`å¯ä»¥å¿«é€Ÿ**è‡ªåŠ¨åˆ›å»º**ä¸Šè¿°çš„å †å `Graph`

```r
ppl(
 'stacking',
 base_learners = lrns(
  c(
   'classif.rpart', 
   'classif.kknn',
   'classif.glmnet')
  ),
 super_learner = lrn('classif.log_reg')
)
```

### è°ƒä¼˜Graphs

- å¯ä»¥è¿›è¡Œ2æ–¹é¢çš„è°ƒä¼˜å·¥ä½œï¼š
  - ç”¨ç»™å®šçš„å­¦ä¹ å™¨è¿›è¡Œé¢„å¤„ç†ï¼Œé€šè¿‡å›ºå®šçš„ï¼Œé€šå¸¸ä¸ºé¡ºåºæ‰§è¡Œçš„ç®¡é“è¿›è¡Œè°ƒä¼˜
  - é™¤äº†å¯¹ç®¡é“çš„è¶…å‚æ•°è°ƒä¼˜ä»¥å¤–ï¼Œè¿˜è¦ç¡®å®šå…·ä½“åº”å°†å“ªäº›PipeOpåº”ç”¨äºæ•°æ®
    - ç»„åˆç®—æ³•é€‰æ‹©ä¸è¶…å‚æ•°ä¼˜åŒ–  
    ï¼ˆCombined Algorithm Selection and Hyperparameter optimizationï¼‰
    - é€šè¿‡åˆ›å»ºåˆ†æ”¯ï¼ˆbranchingï¼‰æˆ–ä»£ç†ï¼ˆproxyï¼‰ï¼Œ  
    å¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºè‡ªå·±çš„å¾®å‹è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ ç³»ç»Ÿï¼ˆmini AutoML systemsï¼‰ï¼Œ  
    ç”šè‡³å¯ä»¥é’ˆå¯¹ç‰¹å®šä»»åŠ¡è¿›è¡Œä¼˜åŒ–

#### è°ƒä¼˜Graphsè¶…å‚æ•°

- ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è¦åšçš„æ˜¯ï¼š
  - å…ˆæ„å»ºä¸€ä¸ªPCA -> KKNNçš„`GraphLearner`
  - å†åˆ†åˆ«å¯¹PCAçš„`rank.`è¶…å‚æ•°å’ŒKKNNçš„`k`è¶…å‚æ•°è¿›è¡Œè°ƒä¼˜

```r
# è®¾ç½®è°ƒä¼˜èŒƒå›´å¹¶æ„å»º`GraphLearner`
po_pca <- po('pca', rank. = to_tune(2, 20))
lrn_knn <- lrn('classif.kknn', k = to_tune(1, 32))
graph_learner <- as_learner(po_pca %>>% lrn_knn)

# ç®€å•ç¡®è®¤`GraphLearner`çš„å‚æ•°è®¾ç½®æƒ…å†µ
graph_learner$param_set$values
```

- å¯ä»¥çœ‹åˆ°è¢«æ ‡è®°çš„å¾…è°ƒä¼˜è¶…å‚æ•°

```js
$pca.rank.
Tuning over:
range [2, 20]


$classif.kknn.k
Tuning over:
range [1, 32]
```

- æ¥ä¸‹æ¥æ˜¯ç†Ÿæ‚‰çš„`auto_tuner()`æ„å»ºä¸€ä¸ªé¢„å¤‡è°ƒä¼˜çš„ç®¡é“å’Œä¸€ä¸ªä¸è°ƒä¼˜çš„ç®¡é“ï¼Œ  
  é€šè¿‡benchmarkæ¯”è¾ƒä¸¤è€…æ€§èƒ½çš„å·®å¼‚
  - æœ€åç»“æœå¯ä»¥çœ‹å‡ºè°ƒä¼˜çš„ç®¡é“æ€§èƒ½æ›´å¥½ï¼ˆæœ‰æ›´ä½çš„äº¤å‰ç†µï¼‰

```r
# è°ƒä¼˜ç®¡é“
glrn_tuned <- auto_tuner(
 tnr('random_search'), 
 graph_learner,
 rsmp('holdout'), 
 term_evals = 10
)
# ä¸è°ƒä¼˜ç®¡é“
glrn_untuned <- po('pca') %>>% lrn('classif.kknn')

# Benchmarkæ¯”è¾ƒ
design <- benchmark_grid(
 tsk('sonar'), 
 # æ³¨æ„ï¼š
 # è¿™é‡Œçš„`glrn_tuned`æ˜¯`autoTuner`å’Œ`Learner`ç±»
 # `glrn_untuned`åˆ™æ˜¯å•çº¯çš„`Graph`
 # ä¾ç„¶å¯ä»¥ä½œä¸º`Learner`ä¼ é€’
 c(glrn_tuned, glrn_untuned),
 rsmp('cv', folds = 5))
benchmark(design)$aggregate()[, .(learner_id, classif.ce)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 2 x 2</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>classif.ce</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>pca.classif.kknn.tuned</td><td>0.2062718</td></tr>
 <tr><td>pca.classif.kknn      </td><td>0.2307782</td></tr>
</tbody>
</table>

#### ä½¿ç”¨`po('branch')`è°ƒæ•´å¤‡é€‰è·¯å¾„

- å¦‚æœåªæ˜¯å•çº¯æ ¹æ®ä¸Šé¢çš„æµç¨‹å¯¹PCAå‚æ•°è¿›è¡Œè°ƒä¼˜ï¼Œ  
  æ˜¯æ²¡æœ‰è€ƒè™‘è°ƒä¼˜åçš„PCAæ˜¯å¦çœŸçš„æœ‰åˆ©äºæ„å»ºåç»­æ¨¡å‹
-

![image_15](./image_15.png)

```r
# åŠ è½½RåŒ…
# library(mlr3oml)

# ä¸‹è½½ä¾‹å­æ•°æ®
otsk_mnist <- otsk(id = 3573)
# åˆ›å»º`Task`ï¼Œé€šè¿‡å­é›†åŒ–å‡å°‘è¿è¡Œæœ¬ä¾‹å­çš„å·¥ä½œé‡
tsk_mnist <- as_task(otsk_mnist)$
 filter(sample(70000, 1000))$
 select(otsk_mnist$feature_names[sample(700, 100)])

# åˆ›å»º3ä¸ªé¢„å¤„ç†ç®¡é“åç§°ï¼š
# æ— æ“ä½œï¼ŒPCAï¼ŒYeo-Johnsonå˜æ¢
# æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯æŒ‡å®šåç§°è€Œå·²ï¼Œç±»ä¼¼äºid
# ä¹Ÿå¯ä»¥å«Aï¼ŒBï¼ŒC
paths <- c('nop', 'pca', 'yeojohnson')

# æ„å»ºä¸€ä¸ªåˆ†æ”¯ç®¡é“
graph <- po(
 'branch', # æŒ‡å®šä¸º'branch'
 paths, # ä¼ é€’éœ€è¦åˆ†æ”¯çš„ç®¡é“
 id = 'brnchPO' # è®¾ç½®ç®¡é“id
) %>>%
 # ä¼ é€’éœ€è¦å¹¶è”çš„ç®¡é“
 gunion(
  # è®°å¾—æŒ‰ç…§ä¸Šé¢åç§°çš„é¡ºåº
  list(
   # æ— æ“ä½œç®¡é“
      po('nop'),
      # PCAç®¡é“
      po('pca'),
      # Yeo-Johnsonå˜æ¢ç®¡é“
      po('removeconstants', id = 'rm_const') %>>%
       po('yeojohnson', id = 'YJ')
  )
) %>>% 
 # æ¥è§¦åˆ†æ”¯
 po('unbranch', paths, id = 'unbrnchPO')

# å¯¹`Graph`å¯è§†åŒ–è§‚å¯Ÿä¸€ä¸‹
graph$plot(horizontal = TRUE)
```

![image_16](./image_16.png)

- æŒ‡å®šé€‰å®šçš„ç®¡é“çš„è¯ï¼Œä¼ é€’é€‰ç”¨çš„ç®¡é“åç§°åˆ°  
  `Graph$param_set$values$brnchPO.selection`å³å¯
  - ä¸‹ä¾‹ä¸ºä½¿ç”¨PCAç®¡é“
  - å¯ä»¥çœ‹åˆ°ç»“æœæ˜¯ç»è¿‡PCAé™çº¬åçš„ç‰¹å¾å˜é‡äº†

```r
# æŒ‡å®šç®¡é“ä¸ºPCA
graph$
 param_set$
 values$
 brnchPO.selection <- 'pca'
# æŸ¥çœ‹é€‰æ‹©PCAåçš„`Graph`çš„è®­ç»ƒç»“æœ
head(graph$train(tsk_mnist)[[1]]$feature_names)
```

- ä½¿ç”¨`ppl('branch', ...)`å¯ä»¥å¿«é€Ÿç®€åŒ–ä¸Šé¢æµç¨‹

```r
ppl('branch', graphs = pos(c('nop', 'pca', 'yeojohnson')))
```

- æ„å»ºä¸€ä¸ªåç»­åŒ…å«å­¦ä¹ å™¨åˆ†æ”¯çš„`Graph`ï¼Œå¹¶å¯è§†åŒ–

```r
graph_learner <- graph %>>%
 ppl('branch', lrns(c('classif.rpart', 'classif.kknn')))

graph_learner$plot(horizontal = TRUE)
```

![image_17](./image_17.png)

- å¯ä»¥å°†`selection`çœ‹ä½œè¶…å‚æ•°ï¼Œç”¨æ¥é€‰æ‹©æœ€åˆé€‚çš„ç®¡é“

```r
# `Graph`å°†`GraphLearner`
graph_learner <- as_learner(graph_learner)

# è®¾ç½®å¾…è°ƒä¼˜çš„è¶…å‚æ•°
graph_learner$
 param_set$
 set_values(
  # ç¬¬ä¸€ä¸ªbranchï¼šé¢„å¤„ç†branch
  brnchPO.selection = to_tune(paths),
  # ç¬¬äºŒä¸ªbranchï¼šå­¦ä¹ å™¨branch
  branch.selection = to_tune(
    c('classif.rpart', 'classif.kknn')
  ),
  # å•ç‹¬è®¾ç½®æœ‰ä¾èµ–å…³ç³»çš„kknnçš„`k`
  # å› ä¸º`k`ä»…åœ¨é€‰æ‹©'classif.kknn'æ—¶ç”Ÿæ•ˆ
  classif.kknn.k = to_tune(
   p_int(
    1, 32,
    depends = branch.selection == 'classif.kknn'
   )
  )
 )

# è¿›è¡Œå®ä¾‹è°ƒä¼˜
instance <- tune(
 tnr('grid_search'), 
 tsk_mnist, 
 graph_learner,
 rsmp('repeated_cv', folds = 3, repeats = 3), 
 msr('classif.ce')
)

# æŸ¥çœ‹ç»“æœ
instance$archive$data[order(classif.ce)[1:5],
  .(brnchPO.selection, classif.kknn.k, branch.selection, classif.ce)]
```

<table class='dataframe'>
<caption>A data.table: 5 x 4</caption>
<thead>
 <tr><th scope=col>brnchPO.selection</th><th scope=col>classif.kknn.k</th><th scope=col>branch.selection</th><th scope=col>classif.ce</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>yeojohnson</td><td>11</td><td>classif.kknn</td><td>0.2533272</td></tr>
 <tr><td>yeojohnson</td><td>18</td><td>classif.kknn</td><td>0.2556648</td></tr>
 <tr><td>yeojohnson</td><td>15</td><td>classif.kknn</td><td>0.2556658</td></tr>
 <tr><td>yeojohnson</td><td> 8</td><td>classif.kknn</td><td>0.2563362</td></tr>
 <tr><td>yeojohnson</td><td>22</td><td>classif.kknn</td><td>0.2600015</td></tr>
</tbody>
</table>

```r
autoplot(instance)
```

![image_18](./image_18.png)

#### ä½¿ç”¨`po(â€œproxyâ€)`è¿›è¡Œè°ƒä¼˜

- `po('proxy')`
  - ä¸€ä¸ªå…ƒè¿ç®—ç¬¦ï¼Œå®ƒæ‰§è¡Œå­˜å‚¨åœ¨å…¶ `content` è¶…å‚æ•°ä¸­çš„æ“ä½œ
  - è¶…å‚æ•°å¯ä»¥æ˜¯å¦ä¸€ä¸ª `PipeOp` æˆ– `Graph`
  - å¯ç”¨äºè°ƒæ•´å’Œé€‰æ‹©å¯ä»¥ä¼ é€’ç»™æ­¤è¶…å‚æ•°çš„ä¸åŒ `PipeOp` æˆ– `Graph`

![image_19](./image_19.png)

- é¦–å…ˆè¦ç”¨`po()'proxy')`åˆ›å»ºå ä½ç¬¦ `PipeOpProxy` è¿ç®—ç¬¦

```r
graph_learner <- po('proxy', id = 'preproc') %>>%
 po('proxy', id = 'learner')
graph_learner <- as_learner(graph_learner)
```

- è¶…å‚æ•°`content`éœ€è¦ä¼ å…¥`p_fct()`
  å†…å®¹ä¸ºä¸€ç»„å¸¦è¯„ä¼°çš„ç¦»æ•£å…ƒç´ 
- å¯¹äºå¤æ‚çš„å­¦ä¹ å™¨è€Œè¨€ï¼Œ  ä¸èƒ½ç›´æ¥å¯¹ä»£ç†ç®¡é“çš„å†…éƒ¨çš„å­¦ä¹ å™¨è¶…å‚æ•°ç›´æ¥è°ƒä¼˜
  - éœ€è¦å¯¹å­¦ä¹ å™¨è¿›è¡Œè°ƒä¼˜ï¼Œå› æ­¤è¦åˆ›å»ºä¸€ä¸ªä¸Šå±‚çš„è¶…å‚æ•°è¿›è¡Œè°ƒä¼˜ï¼Œ  
   å†æŠŠè°ƒä¼˜è¿‡çš„ä¸Šå±‚è¶…å‚æ•°ä¼ é€’ç»™ä¸‹å±‚å­¦ä¹ å™¨é‡Œçš„è¶…å‚æ•°

```r
# -------é¢„å¤„ç†ç®¡é“
# `p_fct()`åˆ›å»º`content`
preproc.content <- p_fct(
 list(
  nop = po('nop'),
  pca = po('pca'),
  yeojohnson = po('removeconstants') %>>% po('yeojohnson')
 )
)

# -------å­¦ä¹ å™¨ç®¡é“
# `p_fct()`åˆ›å»º`content`
learner.content <- p_fct(
 list(
     classif.rpart = lrn('classif.rpart'),
     classif.kknn = lrn('classif.kknn')
 )
)
# åˆ›å»ºä¸Šå±‚çš„è¶…å‚æ•°ä¼ é€’è§„åˆ™
trafo <- function(x, param_set) {
 if (!is.null(x$classif.kknn.k)) {
  # `$clone(deep = TRUE)`å°±æ˜¯pythonçš„`.deepcopy()`
  # ä¸€å®šè¦ç”¨æ·±åº¦å¤åˆ¶ï¼Œä¸ç„¶ä¼šä¿®æ”¹æ‰åŸæœ‰`Learner`çš„è¶…å‚æ•°
  x$learner.content = x$learner.content$clone(deep = TRUE)
  # å°†`classif.kknn.k`ä¼ é€’ç»™åŸæœ¬KKNNå­¦ä¹ å™¨çš„`k`
  x$learner.content$param_set$values$k = x$classif.kknn.k
  # æ¸…ç©º`classif.kknn.k`
  x$classif.kknn.k = NULL
    }
    return(x)
}

# åˆ›å»ºæœç´¢ç©ºé—´å¹¶å°†ä¼ é€’è§„åˆ™åŒ…è£…è¿›å»
search_space <- ps(
 preproc.content = preproc.content,
 learner.content = learner.content,
 # tune KKNN parameter as normal
 classif.kknn.k = p_int(
  1, 32,
  depends = learner.content == 'classif.kknn'
 ),
 .extra_trafo = trafo
)
```

- å°†ä¸Šé¢çš„æ„å»ºç”¨`tune()`åŒ…è£…å¹¶è¿›è¡Œå®ä¾‹è°ƒä¼˜

```r
# å®ä¾‹è°ƒä¼˜
instance <- tune(
 tnr('grid_search'), 
 tsk_mnist, 
 graph_learner,
 rsmp('repeated_cv', folds = 3, repeats = 3), 
 msr('classif.ce'),
 search_space = search_space
)

# æŸ¥çœ‹ç»“æœ
as.data.table(instance$result)[,
 .(preproc.content,
 classif.kknn.k = x_domain[[1]]$learner.content$param_set$values$k,
 learner.content, classif.ce)
]
```

<table class='dataframe'>
<caption>A data.table: 1 x 4</caption>
<thead>
 <tr><th scope=col>preproc.content</th><th scope=col>classif.kknn.k</th><th scope=col>learner.content</th><th scope=col>classif.ce</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>yeojohnson</td><td>11</td><td>classif.kknn</td><td>0.2583492</td></tr>
</tbody>
</table>

- å…³äºè¿™é‡Œ`$clone(deep = TRUE)`çš„ç”¨æ³•ï¼Œå¯ä»¥ç®€å•çœ‹çœ‹è¿™ä¸ªä¾‹å­
  - ä¿®æ”¹`lrn.clone`çš„`param_set`ä¹Ÿä¼šå¯¼è‡´`lrn`è¢«ä¿®æ”¹
  - åŸå› å°±æ˜¯æµ…æ‹·è´äº†`lrn`è€Œæ²¡æœ‰å¤åˆ¶`lrn`å†…éƒ¨é•¶åµŒçš„æ•°æ®ï¼Œ  
   å¯¼è‡´è¡¨å±‚è™½ç„¶è¢«å¤åˆ¶ï¼Œå½“å†…éƒ¨é•¶åµŒçš„æ•°æ®ä¾ç„¶æŒ‡å‘`lrn`çš„å†…éƒ¨é•¶åµŒæ•°æ®
    - æ„å³ï¼š`lrn.clone`å†…éƒ¨é•¶åµŒçš„åœ°å€å’Œ`lrn`ç›¸åŒï¼Œ  
    å†…éƒ¨æ•°æ®**å¹¶éå¤åˆ¶**ï¼Œè€Œæ˜¯**å¼•ç”¨**

```r
lrn <- lrn('classif.rpart')
# Output 1
lrn$param_set

lrn.clone <- lrn$clone()
lrn.clone$param_set$set_values(cp = 0.5)

# Output 2
lrn.clone$param_set

# Output 3
lrn$param_set
```

```js
<ParamSet(10)>
                id    class lower upper nlevels        default  value
            <char>   <char> <num> <num>   <num>         <list> <list>
 1:             cp ParamDbl     0     1     Inf           0.01 [NULL]
 2:     keep_model ParamLgl    NA    NA       2          FALSE [NULL]
 3:     maxcompete ParamInt     0   Inf     Inf              4 [NULL]
 4:       maxdepth ParamInt     1    30      30             30 [NULL]
 5:   maxsurrogate ParamInt     0   Inf     Inf              5 [NULL]
 6:      minbucket ParamInt     1   Inf     Inf <NoDefault[0]> [NULL]
 7:       minsplit ParamInt     1   Inf     Inf             20 [NULL]
 8: surrogatestyle ParamInt     0     1       2              0 [NULL]
 9:   usesurrogate ParamInt     0     2       3              2 [NULL]
10:           xval ParamInt     0   Inf     Inf             10      

0<ParamSet(10)>
                id    class lower upper nlevels        default  value
            <char>   <char> <num> <num>   <num>         <list> <list>
 1:             cp ParamDbl     0     1     Inf           0.01    0.5
 2:     keep_model ParamLgl    NA    NA       2          FALSE [NULL]
 3:     maxcompete ParamInt     0   Inf     Inf              4 [NULL]
 4:       maxdepth ParamInt     1    30      30             30 [NULL]
 5:   maxsurrogate ParamInt     0   Inf     Inf              5 [NULL]
 6:      minbucket ParamInt     1   Inf     Inf <NoDefault[0]> [NULL]
 7:       minsplit ParamInt     1   Inf     Inf             20 [NULL]
 8: surrogatestyle ParamInt     0     1       2              0 [NULL]
 9:   usesurrogate ParamInt     0     2       3              2 [NULL]
10:           xval ParamInt     0   Inf     Inf             10      

0<ParamSet(10)>
                id    class lower upper nlevels        default  value
            <char>   <char> <num> <num>   <num>         <list> <list>
 1:             cp ParamDbl     0     1     Inf           0.01    0.5
 2:     keep_model ParamLgl    NA    NA       2          FALSE [NULL]
 3:     maxcompete ParamInt     0   Inf     Inf              4 [NULL]
 4:       maxdepth ParamInt     1    30      30             30 [NULL]
 5:   maxsurrogate ParamInt     0   Inf     Inf              5 [NULL]
 6:      minbucket ParamInt     1   Inf     Inf <NoDefault[0]> [NULL]
 7:       minsplit ParamInt     1   Inf     Inf             20 [NULL]
 8: surrogatestyle ParamInt     0     1       2              0 [NULL]
 9:   usesurrogate ParamInt     0     2       3              2 [NULL]
10:           xval ParamInt     0   Inf     Inf             10      0
```

#### å¸¦å­é‡‡æ ·çš„è¶…å¸¦ç®—æ³•

- æœ¬ä¾‹å­ä¸­ç”¨SVMæ¥å»ºæ¨¡

```r
# åŠ è½½RåŒ…
# library(mlr3tuning)

# æ„å»ºä¸€ä¸ªå¾…è°ƒä¼˜çš„SVMå­¦ä¹ å™¨
learner <- lrn(
 'classif.svm', 
 id = 'svm', 
 type = 'C-classification',
 kernel = 'radial', 
 cost  = to_tune(1e-5, 1e5, logscale = TRUE),
 gamma = to_tune(1e-5, 1e5, logscale = TRUE)
)

# æ„å»º`GraphLearner`
graph_learner <- as_learner(
 po(
  'subsample', 
  frac = to_tune(
   # `tags = 'budget'`æ˜¯ä¼ é€’ç»™è¶…å¸¦ç®—æ³•çš„æ ‡ç­¾
   # å‘Šè¯‰è¶…å¸¦ç®—æ³•`frac`æ˜¯ä¿çœŸåº¦å‚æ•°
   p_dbl(3^-3, 1, tags = 'budget')
  )
 ) %>>%
 learner
)

# å°è£…å‡½æ•°å¹¶è®¾ç«‹å›é€€å­¦ä¹ å™¨
graph_learner$encapsulate('evaluate', lrn('classif.featureless'))
graph_learner$timeout <- c(train = 30, predict = 30)

# å®ä¾‹è°ƒä¼˜
instance <- tune(
 tnr('hyperband', eta = 3), 
 tsk('sonar'), 
 graph_learner,
 rsmp('cv', folds = 3), 
 msr('classif.ce')
)

# æŸ¥çœ‹ç»“æœ
instance$result_x_domain
```

```js
$subsample.frac
[1] 1

$svm.cost
[1] 48971.58

$svm.gamma
[1] 0.004148232
```

#### ä½¿ç”¨è¿‡æ»¤ç®¡é“è¿›è¡Œç‰¹å¾é€‰æ‹©

- é€‰æ‹©3ä¸ªç‰¹å¾å˜é‡

```r
# åŠ è½½RåŒ…
# library(mlr3filters)
# library(mlr3fselect)

# åˆ›å»º`Task`
task_pen <- tsk('penguins')

# åˆ›å»ºè¿æ¥è¿‡æ»¤å™¨å’Œå­¦ä¹ å™¨çš„`Graph`
po_flt <- po(
 'filter', 
 filter = flt('information_gain'), 
 filter.nfeat = 3
)
graph <- po_flt %>>% po('learner', lrn('classif.rpart'))

# å…ˆç”¨`po_flt`è®­ç»ƒ`Task`ï¼Œç„¶åæ‰“å°é€‰æ‹©åçš„ç‰¹å¾å˜é‡å
po('filter', filter = flt('information_gain'), filter.nfeat = 3)$
  train(list(task_pen))[[1]]$feature_names
```

```js
'bill_depth''bill_length''flipper_length'
```

- å¯¹å˜é‡é€‰æ‹©çš„æ•°é‡è¿›è¡Œè°ƒä¼˜

```r
# å¯¹è¿‡æ»¤å™¨çš„ç‰¹å¾æ•°é‡æ ‡è®°è°ƒä¼˜
po_filter <- po(
 'filter', 
 filter = flt('information_gain'),
 filter.nfeat = to_tune(1, task_pen$ncol)
)

# åˆ›å»ºä¸€ä¸ª`GraphLearner`
graph <- as_learner(
 po_filter %>>% 
 po('learner', lrn('classif.rpart'))
)

# å®ä¾‹è°ƒä¼˜
instance <- tune(
 tnr('random_search'), 
 task_pen, graph,
 rsmp('cv', folds = 3), 
 term_evals = 10
)

# æŸ¥çœ‹ç»“æœ
instance$result
```

<table class='dataframe'>
<caption>A data.table: 1 x 4</caption>
<thead>
 <tr><th scope=col>information_gain.filter.nfeat</th><th scope=col>learner_param_vals</th><th scope=col>x_domain</th><th scope=col>classif.ce</th></tr>
 <tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>8</td><td>0, 8</td><td>8</td><td>0.06676837</td></tr>
</tbody>
</table>

- å¯è§†åŒ–æ¯æ¬¡è¿­ä»£çš„äº¤å‰ç†µ
  - è™½ç„¶äº¤å‰ç†µæœ€ä½çš„æ˜¯é€‰æ‹©8ä¸ªå˜é‡ï¼Œ  
   ä½†äº‹å®ä¸Šå˜é‡å°‘çš„æ¨¡å‹çš„äº¤å‰ç†µä¹Ÿä¸æ˜¯éå¸¸é«˜ï¼Œè€Œæ˜¯å‡ ä¹æ¥è¿‘
    - ä»æ˜“è§£é‡Šæ€§ä¸Šè€Œè¨€ï¼Œå¯ä»¥ä¸ä½¿ç”¨æœ€ä½³ç»“æœï¼Œ  
    è€Œæ˜¯æŒ‘é€‰æ›´å°‘çš„ç‰¹å¾å˜é‡æ¥å»ºæ¨¡

```r
autoplot(instance)
```

![image_20](./image_20.png)

## é¢„å¤„ç†

### ç¤ºä¾‹æ•°æ®

- ç¤ºä¾‹æ•°æ®ä¸º`ames_housing`

```r
ames <- mlr3data::ames_housing
```

```r
head(ames)
```

<table class='dataframe'>
<caption>A data.table: 6 x 82</caption>
<thead>
 <tr><th scope=col>Sale_Price</th><th scope=col>Alley</th><th scope=col>Bedroom_AbvGr</th><th scope=col>Bldg_Type</th><th scope=col>Bsmt_Cond</th><th scope=col>Bsmt_Exposure</th><th scope=col>Bsmt_Full_Bath</th><th scope=col>Bsmt_Half_Bath</th><th scope=col>Bsmt_Qual</th><th scope=col>Bsmt_Unf_SF</th><th scope=col>...</th><th scope=col>Second_Flr_SF</th><th scope=col>Street</th><th scope=col>Three_season_porch</th><th scope=col>Total_Bsmt_SF</th><th scope=col>TotRms_AbvGrd</th><th scope=col>Utilities</th><th scope=col>Wood_Deck_SF</th><th scope=col>Year_Built</th><th scope=col>Year_Remod_Add</th><th scope=col>Year_Sold</th></tr>
 <tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>...</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
 <tr><td>215000</td><td>NA</td><td>3</td><td>OneFam</td><td>Good   </td><td>Gd</td><td>1</td><td>0</td><td>Typical</td><td> 441</td><td>...</td><td>  0</td><td>Pave</td><td>0</td><td>1080</td><td>7</td><td>AllPub</td><td>210</td><td>1960</td><td>1960</td><td>2010</td></tr>
 <tr><td>105000</td><td>NA</td><td>2</td><td>OneFam</td><td>Typical</td><td>No</td><td>0</td><td>0</td><td>Typical</td><td> 270</td><td>...</td><td>  0</td><td>Pave</td><td>0</td><td> 882</td><td>5</td><td>AllPub</td><td>140</td><td>1961</td><td>1961</td><td>2010</td></tr>
 <tr><td>172000</td><td>NA</td><td>3</td><td>OneFam</td><td>Typical</td><td>No</td><td>0</td><td>0</td><td>Typical</td><td> 406</td><td>...</td><td>  0</td><td>Pave</td><td>0</td><td>1329</td><td>6</td><td>AllPub</td><td>393</td><td>1958</td><td>1958</td><td>2010</td></tr>
 <tr><td>244000</td><td>NA</td><td>3</td><td>OneFam</td><td>Typical</td><td>No</td><td>1</td><td>0</td><td>Typical</td><td>1045</td><td>...</td><td>  0</td><td>Pave</td><td>0</td><td>2110</td><td>8</td><td>AllPub</td><td>  0</td><td>1968</td><td>1968</td><td>2010</td></tr>
 <tr><td>189900</td><td>NA</td><td>3</td><td>OneFam</td><td>Typical</td><td>No</td><td>0</td><td>0</td><td>Good   </td><td> 137</td><td>...</td><td>701</td><td>Pave</td><td>0</td><td> 928</td><td>6</td><td>AllPub</td><td>212</td><td>1997</td><td>1998</td><td>2010</td></tr>
 <tr><td>195500</td><td>NA</td><td>3</td><td>OneFam</td><td>Typical</td><td>No</td><td>0</td><td>0</td><td>Typical</td><td> 324</td><td>...</td><td>678</td><td>Pave</td><td>0</td><td> 926</td><td>7</td><td>AllPub</td><td>360</td><td>1998</td><td>1998</td><td>2010</td></tr>
</tbody>
</table>

### æ•°æ®æ¸…æ´—

- é€šè¿‡ç®€å•æ£€æŸ¥æ•°æ®ï¼Œå¯ä»¥å‘ç°å‡ ä¸ªé—®é¢˜ï¼š

1. åˆ†ç±»ä»…ä¸€ç§ï¼ˆå¸¸é‡ç‰¹å¾ï¼‰

```r
summary(ames$Misc_Feature_2)
```

```js
Othr: 2930
```

2. æ•°æ®å®Œå…¨ä¸€è‡´

```r
identical(ames$Condition_2, ames$Condition_3)
```

```js
TRUE
```

3. å°ºåº¦ä¸Šæ•°æ®ç›¸åŒ

```r
cor(ames$Lot_Area, ames$Lot_Area_m2)
```

```js
1
```

- å¯¹äºä¸Šè¿°ç‰¹å¾ï¼Œæœ€å¥½çš„æ–¹æ³•å°±æ˜¯ç›´æ¥åˆ é™¤å®ƒä»¬
- å¯ä»¥ç®€å•å…ˆæ ‡è®°å‡ºæ¥

```r
to_remove <- c('Lot_Area_m2', 'Condition_3', 'Misc_Feature_2')
```

- é™¤æ­¤ä»¥å¤–è¿˜åº”è¯¥æ£€æŸ¥
  - æ˜¯å¦æœ‰**é‡å¤æ ·æœ¬**ï¼š`ID`åˆ—æ˜¯å¦å…¨éƒ¨çš„å€¼æ˜¯å”¯ä¸€çš„
  - æ˜¯å¦æœ‰**ç¼ºå¤±å€¼**ï¼š`NA`
  - æ˜¯å¦æœ‰**è¯­ä¹‰é”™è¯¯**ï¼šè´Ÿçš„`Lot_Area`
  - å¯¹äºæ— æ³•å¤„ç†æ•°å€¼ç‰¹å¾çš„å­¦ä¹ å™¨ï¼Œ  
   åº”è¯¥å°†æ•°å€¼ç‰¹å¾**ç¼–ç è½¬æ¢**ä¸ºåˆ†ç±»ç‰¹å¾

```r
# åˆ›å»º`Task`
tsk_ames <- as_task_regr(ames, target = 'Sale_Price', id = 'ames')
# åˆ é™¤ä¸Šè¿°æ ‡è®°çš„æœ‰é—®é¢˜çš„ç‰¹å¾å˜é‡
tsk_ames$select(setdiff(tsk_ames$feature_names, to_remove))

# åˆ›å»ºè¯„ä¼°å™¨
msr_mae <- msr('regr.mae')
# åˆ›å»ºé‡é‡‡æ ·å™¨
rsmp_cv3 <- rsmp('cv', folds = 3)
# å¯¹éœ€è¦é‡é‡‡æ ·çš„`Task`æ„å»ºé‡é‡‡æ ·å®ä¾‹
rsmp_cv3$instantiate(tsk_ames)

# åˆ›å»ºä¸€ä¸ªæ— ç‰¹å¾å›å½’å­¦ä¹ å™¨ï¼Œå¹¶å¯¹ä¸­ä½æ•°è¿›è¡Œé¢„æµ‹
lrn_baseline <- lrn('regr.featureless', robust = TRUE) 
# ä¿®æ”¹idåï¼Œä»¥åœ¨åç»­æµç¨‹ä¸­æ›´å®¹æ˜“è¯†åˆ«
lrn_baseline$id <- 'Baseline' 
# è¿›è¡Œé‡é‡‡æ ·
rr_baseline <- resample(tsk_ames, lrn_baseline, rsmp_cv3) 

# è·å–æ•´åˆç»“æœ
rr_baseline$aggregate(msr_mae)
```

```js
regr.mae: 56067.172671583
```

### å› å­ç¼–ç 

- åˆ†ç±»å˜é‡å¯ä»¥åŸºäºåŸºæ•°ï¼ˆcardinalityï¼‰è¿›è¡Œåˆ†ç»„ï¼š
  - äºŒå…ƒç‰¹å¾
    - ç‹¬çƒ­ç¼–ç 
  - ä½åŸºæ•°ç‰¹å¾
    - ç‹¬çƒ­ç¼–ç 
    - è™šæ‹Ÿç¼–ç 
      - å¹¿ä¹‰çº¿æ€§æ¨¡å‹ï¼ˆGLMï¼‰
      - åŠ æ³•æ¨¡å‹ï¼ˆGAMï¼‰
  - é«˜åŸºæ•°ç‰¹å¾
    - å½±å“ç¼–ç 
      - ä½¿ç”¨ç›®æ ‡ç‰¹å¾åœ¨åˆ†ç±»ç‰¹å¾å’Œä¸€ä¸ªæ•°å€¼ä¹‹é—´åˆ›å»ºæ˜ å°„ï¼Œ  
     è¯¥æ•°å€¼åæ˜ å…¶åœ¨é¢„æµ‹ç›®æ ‡ç‰¹å¾æ—¶çš„é‡è¦æ€§
      - æ­¥éª¤
        - æŒ‰åˆ†ç±»ç‰¹å¾å¯¹ç›®æ ‡å˜é‡è¿›è¡Œåˆ†ç»„
        - è®¡ç®—æ¯ä¸ªç»„ä¸­ç›®æ ‡å˜é‡çš„å‡å€¼
        - è®¡ç®—ç›®æ ‡å˜é‡çš„å…¨å±€å‡å€¼
        - è®¡ç®—æ¯ä¸ªç»„çš„å½±å“å¾—åˆ†ï¼Œ  
      å³è¯¥ç»„ç›®æ ‡å˜é‡çš„å‡å€¼ä¸ç›®æ ‡å˜é‡å…¨å±€å‡å€¼ä¹‹é—´çš„å·®å€¼
        - ç”¨å½±å“å¾—åˆ†æ›¿æ¢åˆ†ç±»ç‰¹å¾
      - ç”±äºä½¿ç”¨ç›®æ ‡ä¿¡æ¯æ¥è®¡ç®—å½±å“åˆ†æ•°ï¼Œ  
     ç¼–ç è¿‡ç¨‹å¿…é¡»åµŒå…¥åˆ°äº¤å‰éªŒè¯ä¸­ï¼Œ  
     ä»¥é¿å…è®­ç»ƒæ•°æ®å’Œæµ‹è¯•æ•°æ®ä¹‹é—´çš„ä¿¡æ¯æ³„éœ²
    - å»é™¤å¸¸é‡ç‰¹å¾
    - åˆå¹¶å°ç±»åˆ«
    - åˆ†å±‚
- é€šå¸¸è¶…è¿‡**10**ä¸ªåŸºæ•°çš„å¯ä»¥è¢«è§†ä¸º**é«˜åŸºæ•°ç‰¹å¾**

```r
# æ‰¾å‡ºé«˜åŸºæ•°ç‰¹å¾
names(which(lengths(tsk_ames$levels()) > 10))
# æ‰¾å‡ºäºŒå…ƒç‰¹å¾
names(which(lengths(tsk_ames$levels()) == 2))
```

```js
'Exterior_1st''Exterior_2nd''MS_SubClass''Neighborhood'

'Alley''Central_Air''Street'
```

- æ„å»ºä¸€ä¸ªé¢„å¤„ç†çš„`Graph`ï¼Œæ³¨æ„ä¸‹é¢é¡ºåº

```r
factor_pipeline <-
 # å»é™¤å¸¸é‡ç‰¹å¾
    po('removeconstants') %>>%
    # åˆå¹¶ç½•è§ç±»åˆ«
 po(
  # åˆå¹¶
  'collapsefactors', 
  # è®¾ç½®å¯¹é¢‘ç‡ä½äº1%çš„ç±»åˆ«è¿›è¡Œåˆå¹¶
  no_collapse_above_prevalence = 0.01
 ) %>>%
 # å¯¹é«˜åŸºæ•°ç‰¹å¾æ•°å€¼ç¼–ç 
 po(
  # å¯¹æ»¡è¶³æŒ‡å®šæ¡ä»¶çš„ç‰¹å¾è¿›è¡Œæ•°å€¼ç¼–ç 
  'encodeimpact',
  # æŒ‡å®šä½œç”¨äºåŸºæ•°>2çš„ç‰¹å¾
  affect_columns = selector_cardinality_greater_than(10),
  # è®¾ç½®è¯†åˆ«id
  id = 'high_card_enc'
 ) %>>%
 # ç‹¬çƒ­ç¼–ç 
 po(
  # æŒ‡å®šå¤„ç†ä¸ºå› å­ç¼–ç 
  'encode', 
  # æŒ‡å®šä¸ºç‹¬çƒ­ç¼–ç 
  method = 'one-hot',
  # æŒ‡å®šä½œç”¨äºåŸºæ•°>2çš„ç‰¹å¾
  affect_columns = selector_cardinality_greater_than(2),
  # è®¾ç½®è¯†åˆ«id
  id = 'low_card_enc'
 ) %>>%
 # å°†äºŒå…ƒç‰¹å¾å“‘å˜é‡å¤„ç†
 po(
  # æŒ‡å®šå¤„ç†ä¸ºå› å­ç¼–ç 
  'encode', 
  # çœç•¥å› å­ä¸­ç¬¬ä¸€ä¸ªçº§åˆ«çš„å˜é‡
  method = 'treatment',
  # æŒ‡å®šç±»å‹ä¸ºå› å­çš„ç‰¹å¾
  # åˆ°è¿™ä¸€æ­¥éƒ½å·²ç»è½¬åŒ–ä¸ºæ•°å€¼äº†ï¼Œ
  # æ‰€ä»¥ç›´æ¥ç­›é€‰å› å­å³å¯
  affect_columns = selector_type('factor'), 
  # è®¾ç½®è¯†åˆ«id
  id = 'binary_enc'
 )
```

- å°†ä¸Šè¿°é¢„å¤„ç†ä¸ä»…è¿›è¡Œç‹¬çƒ­ç¼–ç é¢„å¤„ç†ä¸¤ç§æ–¹å¼è¿›è¡Œbenchmarkæ¯”è¾ƒ
  - å¯è§ä¸Šè¿°é¢„å¤„ç†ç®¡é“çš„å¹³å‡ç»å¯¹è¯¯å·®æ¯”ä»…è¿›è¡Œç‹¬çƒ­ç¼–ç é¢„å¤„ç†æ›´å¥½ï¼Œ  
   å› ä¸ºå¹³å‡ç»å¯¹è¯¯å·®æ›´å°

```r
# æ„å»ºxgboostå­¦ä¹ å™¨
lrn_xgb <- lrn('regr.xgboost', nrounds = 100)

# å°†é¢„å¤„ç†ç®¡é“ä¸å­¦ä¹ å™¨è¿æ¥å¹¶æ„å»º`GraphLearner`
glrn_xgb_impact <- as_learner(factor_pipeline %>>% lrn_xgb)
# è®¾ç½®è¯†åˆ«id
glrn_xgb_impact$id <- 'XGB_enc_impact'

# å°†ä»…è¿›è¡Œç‹¬çƒ­ç¼–ç çš„ç®¡é“ä¸å­¦ä¹ å™¨è¿æ¥å¹¶æ„å»º`GraphLearner`
glrn_xgb_one_hot <- as_learner(po('encode') %>>% lrn_xgb)
# è®¾ç½®è¯†åˆ«id
glrn_xgb_one_hot$id <- 'XGB_enc_onehot'

# benchmarkæ¯”è¾ƒ
bmr <- benchmark(
 benchmark_grid(
  tsk_ames,
  c(lrn_baseline, glrn_xgb_impact, glrn_xgb_one_hot), 
  rsmp_cv3
 )
)

# æ‰“å°æ•´åˆç»“æœ
bmr$aggregate(measure = msr_mae)[, .(learner_id, regr.mae)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 3 x 2</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>regr.mae</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>Baseline      </td><td>56089.88</td></tr>
 <tr><td>XGB_enc_impact</td><td>15962.13</td></tr>
 <tr><td>XGB_enc_onehot</td><td>16500.48</td></tr>
</tbody>
</table>

### ç¼ºå¤±å€¼

- å‡ ç§æ’è¡¥æ–¹æ³•
  - `po('imputemean')`ï¼šå‡å€¼æ’è¡¥
  - `po('imputemedian')`ï¼šä¸­ä½æ•°æ’è¡¥
  - `po('imputemode')`ï¼šä¼—æ•°æ’è¡¥
  - `po('imputehist')`ï¼šé€šè¿‡ç›´æ–¹å›¾ä¼°ç®—æ•°å€¼ç‰¹å¾æ’è¡¥
  - `po('imputeoor')`ï¼š  
   `.MISSING`ï¼ŒèŒƒå›´å¤–æ’è¡¥ï¼ˆOut of Range Imputation ï¼‰  
   ç”¨ä½äºæœ€å°å€¼æˆ–é«˜äºæœ€å¤§å€¼çš„å¸¸æ•°å€¼å¡«è¡¥æ•°å€¼ç‰¹å¾

- ä¸‹å›¾ä¸ºå‡å€¼æ’è¡¥çš„ç¤ºä¾‹

![image_21](./image_21.png)

- æŸ¥çœ‹`Task`ä¸­åŒ…å«ç¼ºå¤±å€¼çš„ç‰¹å¾ï¼ˆï¼‰

```r
names(which(tsk_ames$missings() > 0))
```

```js
'Alley''BsmtFin_SF_1''BsmtFin_SF_2''BsmtFin_Type_1''BsmtFin_Type_2''Bsmt_Cond''Bsmt_Exposure''Bsmt_Full_Bath''Bsmt_Half_Bath''Bsmt_Qual''Bsmt_Unf_SF''Electrical''Fence''Fireplace_Qu''Garage_Area''Garage_Cars''Garage_Cond''Garage_Finish''Garage_Qual''Garage_Type''Garage_Yr_Blt''Lot_Frontage''Mas_Vnr_Area''Mas_Vnr_Type''Misc_Feature''Pool_QC''Total_Bsmt_SF'
```

```r
impute_hist <- list(
 # è·Ÿè¸ªç¼ºå¤±å€¼
 po(
  # å¯¹ç¼ºå¤±å€¼æ ‡è®°ä¸º1ï¼Œå¦åˆ™ä¸º0
  'missind', 
  # å¯¹æ•°æ®é‡Œçš„æ•´æ•°å‹å˜é‡ç”Ÿæˆç¼ºå¤±å€¼æŒ‡ç¤ºå˜é‡
  type = 'integer',
  # é€‰æ‹©æ•´æ•°åˆ—
  affect_columns = selector_type('integer')
 ),
 # ç›´æ–¹å›¾æ’è¡¥
 po(
  # é€‰æ‹©ä¸ºç›´æ–¹å›¾æ’è¡¥
  'imputehist', 
  # é€‰æ‹©æ•´æ•°åˆ—
  affect_columns = selector_type('integer')
 )
) %>>%
 # ç‰¹å¾åˆå¹¶
 po('featureunion') %>>%
 # èŒƒå›´å¤–æ’è¡¥
 po(
  # é€‰æ‹©èŒƒå›´å¤–æ’è¡¥
  'imputeoor', 
  # é€‰æ‹©å› å­åˆ—
  affect_columns = selector_type('factor')
 )

# å¯è§†åŒ–ä¸€ä¸‹`Graph`
impute_hist$plot(horizontal = TRUE)
```

![image_22](./image_22.png)

- é€šè¿‡benchmarkæ¯”è¾ƒä¸Šè¿°ç®¡é“å’Œçº¯imputeooræ–¹æ³•æ’è¡¥çš„æ¨¡å‹çš„æ€§èƒ½å·®å¼‚

```r
# ç”¨ä¸Šé¢çš„ç®¡é“è¿›è¡Œæ’è¡¥å¹¶è¿æ¥éšæœºæ£®æ—
glrn_rf_impute_hist <- as_learner(impute_hist %>>% lrn('regr.ranger'))
glrn_rf_impute_hist$id <- 'RF_imp_Hist'

# ä»…ç”¨imputeooræ–¹æ³•æ’è¡¥å¹¶è¿æ¥éšæœºæ£®æ—
glrn_rf_impute_oor <- as_learner(po('imputeoor') %>>% lrn('regr.ranger'))
glrn_rf_impute_oor$id <- 'RF_imp_OOR'

# è¿›è¡Œä¸¤è€…çš„benchmarkæ¯”è¾ƒ
design <- benchmark_grid(
 tsk_ames,
 c(glrn_rf_impute_hist, glrn_rf_impute_oor), 
 rsmp_cv3
)

# è¿™é‡Œä»£ç æœ‰é—®é¢˜ï¼Œä¼šæŠ¥é”™
# ä»¥ä¸‹ä¸ºå®˜ç½‘ç»™å‡ºçš„ç»“æœ
bmr_new <- benchmark(design)

# æŸ¥çœ‹ç»“æœ
bmr$combine(bmr_new)
bmr$aggregate(measure = msr_mae)[, .(learner_id, regr.mae)]
```

```js
       learner_id regr.mae
1:       Baseline    56056
2: XGB_enc_impact    16068
3: XGB_enc_onehot    16098
4:    RF_imp_Hist    16400
5:     RF_imp_OOR    16395
```

### ç®¡é“ç¨³å¥åŒ–

- `ppl('robustify')`åŒ…å«ä»¥ä¸‹çš„å†…å®¹ï¼š
  - `po('removeconstants')`ï¼š  
   ç§»é™¤å¸¸é‡ç‰¹å¾
  - `po('colapply')`ï¼š  
   å­—ç¬¦å’Œåºå·ç‰¹å¾ç¼–ç ä¸ºåˆ†ç±»ç‰¹å¾ï¼Œ  
   æ—¥æœŸ/æ—¶é—´ç‰¹å¾ç¼–ç ä¸ºæ•°å€¼ç‰¹å¾
  - `po('imputehist')`ï¼š  
   æ•°å€¼ç‰¹å¾é€šè¿‡ç›´æ–¹å›¾é‡‡æ ·è¿›è¡Œæ’è¡¥
  - `po('imputesample')`ï¼š  
   é€»è¾‘ç‰¹å¾é€šè¿‡ä»ç»éªŒåˆ†å¸ƒä¸­é‡‡æ ·è¿›è¡Œæ’è¡¥ï¼Œ  
   è¿™ä»…å½±å“Â `$predict()`Â æ­¥éª¤
  - `po('missind')`ï¼š  
   ä¸ºä¼°ç®—çš„æ•°å€¼å˜é‡å’Œé€»è¾‘å˜é‡æ·»åŠ ç¼ºå¤±æ•°æ®æŒ‡ç¤ºç¬¦
  - `po('imputeoor')`ï¼š  
   åˆ†ç±»ç‰¹å¾çš„ç¼ºå¤±å€¼ç”¨ä¸€ä¸ªæ–°çš„ç±»åˆ«è¿›è¡Œç¼–ç 
  - `po('fixfactors')`ï¼š  
   ä¿®æ­£åˆ†ç±»ç‰¹å¾çš„æ°´å¹³ï¼Œ  
   ä»¥ä¾¿åœ¨é¢„æµ‹å’Œè®­ç»ƒæœŸé—´å…·æœ‰ç›¸åŒçš„æ°´å¹³ï¼ˆè¿™å¯èƒ½æ¶‰åŠåˆ é™¤ç©ºå› å­æ°´å¹³ï¼‰
  - `po('imputesample')`ï¼š  
   ä¸Šä¸€æ­¥ä¸­å› åˆ é™¤ç±»åˆ«è€Œåœ¨åˆ†ç±»ç‰¹å¾ä¸­å¼•å…¥çš„ç¼ºå¤±å€¼ï¼Œ  
   é€šè¿‡ä»ç»éªŒåˆ†å¸ƒä¸­é‡‡æ ·æ¥è¿›è¡Œæ’è¡¥
  - `po('collapsefactors')`ï¼š  
   åˆ†ç±»ç‰¹å¾çš„æ°´å¹³ä¼šè¢«åˆå¹¶ï¼ˆä»è®­ç»ƒæ•°æ®ä¸­æœ€ç½•è§çš„å› ç´ å¼€å§‹ï¼‰ï¼Œ  
   ç›´åˆ°æ°´å¹³æ•°é‡å°‘äºæŸä¸ªç‰¹å®šæ•°é‡ï¼Œ
   è¯¥æ•°é‡ç”±Â `max_cardinality`Â å‚æ•°æ§åˆ¶ï¼ˆä¿å®ˆé»˜è®¤å€¼ä¸ºÂ `1000`ï¼‰
  - `po('encode')`ï¼š  
   åˆ†ç±»ç‰¹å¾è¿›è¡Œç‹¬çƒ­ç¼–ç 
  - `po('removeconstants')`ï¼š  
   ç§»é™¤å¯èƒ½åœ¨å…ˆå‰æ­¥éª¤ä¸­åˆ›å»ºçš„å¸¸é‡ç‰¹å¾
- `ppl('robustify')`Â æœ‰å¯é€‰å‚æ•°Â `task`Â å’ŒÂ `learner`
  - å¦‚æœæä¾›äº†è¿™äº›å‚æ•°ï¼Œ  
   é‚£ä¹ˆç”Ÿæˆçš„ç®¡é“å°†è¢«è®¾ç½®ä¸ºä¸“é—¨å¤„ç†ç»™å®šçš„ä»»åŠ¡å’Œå­¦ä¹ å™¨
  - ä¾‹å¦‚ï¼Œå¦‚æœå­¦ä¹ å™¨å…·æœ‰Â `'missings'`Â å±æ€§ï¼Œ  
   æˆ–è€…å¦‚æœä»»åŠ¡ä¸­ä¸€å¼€å§‹å°±æ²¡æœ‰ç¼ºå¤±å€¼ï¼Œ  
   å®ƒå°†ä¸ä¼šæ’è¡¥ç¼ºå¤±å€¼

- è¿™é‡Œç”¨çº¿æ€§å›å½’ä¸ºä¾‹å­

```r
# æ„å»ºä¸€ä¸ª`GraphLearner`å¹¶å‘½åid
glrn_lm_robust <- as_learner(ppl('robustify') %>>% lrn('regr.lm'))
glrn_lm_robust$id <- 'lm_robust'

# benchmarkæ¯”è¾ƒ
bmr_new <- benchmark(
 benchmark_grid(
  tsk_ames, 
  glrn_lm_robust,  
  rsmp_cv3
 )
)
# æ–°ç®¡é“ç»“æœä¸ä¹‹å‰çš„bmrç»“æœåˆå¹¶
bmr$combine(bmr_new)
# è·å–æ•´åˆç»“æœ
bmr$aggregate(measure = msr_mae)[, .(learner_id, regr.mae)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 4 x 2</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>regr.mae</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>Baseline      </td><td>56159.11</td></tr>
 <tr><td>XGB_enc_impact</td><td>15959.01</td></tr>
 <tr><td>XGB_enc_onehot</td><td>16374.55</td></tr>
 <tr><td>lm_robust     </td><td>16139.08</td></tr>
</tbody>
</table>

### è½¬æ¢ç‰¹å¾å’Œç›®æ ‡

- å¯¹ç‰¹å¾å’Œç›®æ ‡è¿›è¡Œç®€å•çš„å˜æ¢ï¼Œå¯¹äºæŸäº›å­¦ä¹ å™¨å¯èƒ½æ˜¯æœ‰ç›Šçš„
  - å¯¹ç›®æ ‡è¿›è¡Œå¯¹æ•°å˜æ¢æœ‰åŠ©äºä½¿åˆ†å¸ƒæ›´åŠ å¯¹ç§°ï¼Œå¹¶æœ‰åŠ©äºå‡å°‘å¼‚å¸¸å€¼çš„å½±å“
  - å¯¹æœ‰åæ€çš„ç‰¹å¾è¿›è¡Œå¯¹æ•°å˜æ¢ä¹Ÿæœ‰åŠ©äºé™ä½å¼‚å¸¸å€¼çš„å½±å“
- ä¸‹é¢ä»£ç ç»˜åˆ¶äº†amesæ•°æ®é›†ä¸­ç›®æ ‡çš„åˆ†å¸ƒï¼Œç„¶åç»˜åˆ¶äº†ç»è¿‡å¯¹æ•°å˜æ¢åçš„ç›®æ ‡åˆ†å¸ƒ
 å¯¹å˜é‡å–å¯¹æ•°ä½¿åˆ†å¸ƒæ›´åŠ å¯¹ç§°ï¼Œå¼‚å¸¸å€¼ä¹Ÿæ›´å°‘ã€‚

```r
# åŠ è½½åˆå¹¶plotçš„RåŒ…
# library(patchwork)

# åˆ›å»ºä¸€ä¸ªç”¨äºå¯¹æ•°è½¬æ¢çš„
log_ames <- ames
# å¯¹`Sale_Price`è¿›è¡Œå¯¹æ•°è½¬æ¢
log_ames[, logSalePrice := log(Sale_Price)]
# ç»˜å›¾
autoplot(as_task_regr(log_ames, target = 'Sale_Price')) +
 autoplot(as_task_regr(log_ames, target = 'logSalePrice'))
```

![image_23](./image_23.png)

- æ‰‹åŠ¨è¿›è¡Œç®€å•çš„å¯¹æ•°è½¬æ¢

```r
# ç”¨éšæœºæ•°åˆ›å»ºç¤ºä¾‹æ•°æ®
df <- data.table(x = runif(5), y = runif(5, 10, 20))
df

# å¯¹yè¿›è¡Œå¯¹æ•°è½¬æ¢
df[, y := log(y)]
df$y

# ç”¨å›å½’æ¨¡å‹æ‹Ÿåˆæ•°æ®åè¿›è¡Œé¢„æµ‹
yhat = predict(lm(y ~ x, df), df)
yhat

exp(yhat)
```

<table class='dataframe'>
<caption>A data.table: 5 x 2</caption>
<thead>
 <tr><th scope=col>x</th><th scope=col>y</th></tr>
 <tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>0.16287878</td><td>16.01323</td></tr>
 <tr><td>0.17030617</td><td>13.71607</td></tr>
 <tr><td>0.03883123</td><td>19.62250</td></tr>
 <tr><td>0.23552246</td><td>10.14073</td></tr>
 <tr><td>0.67070117</td><td>13.95870</td></tr>
</tbody>
</table>

```js
       1        2        3        4        5 
2.695238 2.692759 2.736655 2.670984 2.525687 

       1        2        3        4        5 
14.80905 14.77237 15.43527 14.45419 12.49948 
```

- ç®¡é“`ppl('targettrafo')`å¯ä»¥åœ¨é‡é‡‡æ ·å’Œbenchmarkæ¯”è¾ƒæ—¶ï¼Œ  
  ç®€å•åœ°å°†æ•°æ®è½¬æ¢åµŒå…¥è¿›å»
  - åªéœ€è¦æŒ‡å®š2ä¸ªå‚æ•°å³å¯
    - `targetmutate.trafo`ï¼š  
    ç”¨äºåœ¨è®­ç»ƒæœŸé—´å¯¹ç›®æ ‡åº”ç”¨å˜æ¢
    - `targetmutate.inverter`ï¼š  
    ç”¨äºåœ¨é¢„æµ‹æœŸé—´åº”ç”¨å˜æ¢ä»¥åè½¬åŸå§‹å˜æ¢
- ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è®­ç»ƒå’Œé¢„æµ‹æ—¶éƒ½ç”¨è½¬æ¢åçš„æ•°æ®ï¼Œ  
  ä½†æ˜¯åœ¨è¿”å›ç»“æœçš„æ—¶å€™æ˜¯å°†æ•°æ®åè½¬å›æ¥çš„

```r
glrn_log_lm_robust <- as_learner(
 ppl(
  'targettrafo',
  graph = glrn_lm_robust,
  targetmutate.trafo = function(x) log(x),
  targetmutate.inverter = function(x){
   list(response = exp(x$response))
  }
 )
)
glrn_log_lm_robust$id <- 'lm_robust_logtrafo'

bmr_new <- benchmark(
 benchmark_grid(
  tsk_ames, 
  glrn_log_lm_robust,
  rsmp_cv3
 )
)

bmr$combine(bmr_new)
bmr$aggregate(measure = msr_mae)[, .(learner_id, regr.mae)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 5 x 2</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>regr.mae</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>Baseline          </td><td>56159.11</td></tr>
 <tr><td>XGB_enc_impact    </td><td>15959.01</td></tr>
 <tr><td>XGB_enc_onehot    </td><td>16374.55</td></tr>
 <tr><td>lm_robust         </td><td>16139.41</td></tr>
 <tr><td>lm_robust_logtrafo</td><td>15501.52</td></tr>
</tbody>
</table>

### å‡½æ•°ç‰¹å¾æå–

- æœ¬èŠ‚å…³æ³¨ç›¸äº’ä¾èµ–çš„ç‰¹å¾
  - å› ä¸ºè¿™äº›ç‰¹å¾å•ç‹¬å­˜åœ¨æ²¡æœ‰ç”¨å¤„ï¼Œ  
   ä½†ç»„åˆèµ·æ¥ä¼šæä¾›æœ‰ç”¨ä¿¡æ¯
- ä¸‹å›¾ä¸­
  - å˜é‡x1ã€x2ã€x3æ˜¯å¸¸è§„ç‰¹å¾
  - å˜é‡xt1ï¼Œâ€¦ï¼Œxt365æ˜¯å‡½æ•°ç‰¹å¾

![image_24](./image_24.png)

- æœ¬èŠ‚çš„ç¤ºä¾‹æ•°æ®
  - åœ¨è¿™ä¸ªæ•°æ®é›†ä¸­ï¼Œæ¯ä¸€è¡Œä»£è¡¨ä¸€æ ‹æˆ¿å±‹ï¼Œ  
   æ¯ä¸ªç‰¹å¾æ˜¯ç»™å®šæ—¶é—´å¨æˆ¿ç”µå™¨çš„æ€»è€—ç”µé‡
  - è€—ç”µé‡ä»¥2åˆ†é’Ÿä¸ºé—´éš”è¿›è¡Œæµ‹é‡ï¼Œå› æ­¤äº§ç”Ÿäº†720ä¸ªç‰¹å¾

```r
energy_data <- mlr3data::energy_usage
head(energy_data)
```

<table class='dataframe'>
<caption>A data.table: 6 x 720</caption>
<thead>
 <tr><th scope=col>att1</th><th scope=col>att2</th><th scope=col>att3</th><th scope=col>att4</th><th scope=col>att5</th><th scope=col>att6</th><th scope=col>att7</th><th scope=col>att8</th><th scope=col>att9</th><th scope=col>att10</th><th scope=col>...</th><th scope=col>att711</th><th scope=col>att712</th><th scope=col>att713</th><th scope=col>att714</th><th scope=col>att715</th><th scope=col>att716</th><th scope=col>att717</th><th scope=col>att718</th><th scope=col>att719</th><th scope=col>att720</th></tr>
 <tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>...</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>0.7152669</td><td>0.7152669</td><td>0.7152669</td><td>0.7152669</td><td>0.7152669</td><td>0.7152669</td><td>0.7152669</td><td>0.7152669</td><td>0.7152669</td><td>0.7152669</td><td>...</td><td>0.5711418</td><td>0.5051663</td><td>0.5011082</td><td>0.5711418</td><td>0.5051663</td><td> 0.5011082</td><td> 0.5711418</td><td> 0.5751999</td><td> 0.7112089</td><td> 0.7112089</td></tr>
 <tr><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td>...</td><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td>0.2670886</td><td> 0.2670886</td><td> 0.2670886</td><td> 0.2670886</td><td> 0.2670886</td><td> 0.2670886</td></tr>
 <tr><td>0.4635391</td><td>0.4635391</td><td>0.4796599</td><td>0.4635391</td><td>0.4635391</td><td>0.4635391</td><td>0.4796599</td><td>0.4635391</td><td>0.4635391</td><td>0.4796599</td><td>...</td><td>0.4796599</td><td>0.4635391</td><td>0.4635391</td><td>0.4635391</td><td>0.4796599</td><td> 0.4635391</td><td> 0.4635391</td><td> 0.4635391</td><td> 0.4796599</td><td> 0.4635391</td></tr>
 <tr><td>0.5989330</td><td>0.5989330</td><td>0.5989330</td><td>0.5026779</td><td>0.5989330</td><td>0.5989330</td><td>0.5989330</td><td>0.5026779</td><td>0.5989330</td><td>0.5989330</td><td>...</td><td>0.5989330</td><td>0.5989330</td><td>0.5026779</td><td>0.5989330</td><td>0.5989330</td><td> 0.5989330</td><td> 0.5026779</td><td> 0.5989330</td><td> 0.5989330</td><td> 0.5989330</td></tr>
 <tr><td>0.3445082</td><td>0.3445082</td><td>0.2493033</td><td>0.3445082</td><td>0.3445082</td><td>0.3445082</td><td>0.3445082</td><td>0.2493033</td><td>0.3445082</td><td>0.3445082</td><td>...</td><td>0.3445082</td><td>0.3445082</td><td>0.3445082</td><td>0.3445082</td><td>5.9254138</td><td>10.8020196</td><td>13.1427906</td><td>10.8020196</td><td>11.3593466</td><td>10.5233566</td></tr>
 <tr><td>0.3728099</td><td>0.2765897</td><td>0.2287661</td><td>0.2765897</td><td>0.3728099</td><td>0.2765897</td><td>0.2765897</td><td>0.3246998</td><td>0.2287661</td><td>0.2765897</td><td>...</td><td>0.3770731</td><td>0.3070396</td><td>0.3070396</td><td>0.3292495</td><td>0.3070396</td><td> 0.3070396</td><td> 0.3770731</td><td> 0.3770731</td><td> 0.4693166</td><td> 0.5171402</td></tr>
</tbody>
</table>

- ä¸ºäº†ç¡®è®¤å“ªäº›ç‰¹å¾æ˜¯æœ‰ç”¨çš„ï¼Œ  
  å…ˆå¯¹ç¬¬ä¸€ä¸ªæ ·æœ¬å°†2åˆ†é’Ÿé—´éš”çš„è¿ç»­æ—¶é—´ç‚¹ä¸Šçš„ç”µåŠ›æ¶ˆè´¹é‡åšå›¾
- ç”±äºæ¯ä¸ªå•ç‹¬çš„ç‰¹å¾æ— æ³•æä¾›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œ  
  ä¸å¯èƒ½å°†720ä¸ªç‰¹å¾éƒ½ç”¨æ¥å»ºæ¨¡ï¼Œ  
  ä¹Ÿæ— æ³•é€‰æ‹©æœ€ä½³çš„ç‰¹å¾å˜é‡å­é›†
- å¯ä»¥æå–æ›²çº¿ä¸­æœ‰ç”¨çš„ä¿¡æ¯ï¼š
  - æœ€å¤§ä½¿ç”¨åŠŸç‡
  - æ€»ä½¿ç”¨åŠŸç‡
  - å³°å€¼æ•°é‡
  - å…¶ä»–æ›²çº¿ä¸­çš„æœ‰ç”¨ç‰¹å¾

```r
# åŠ è½½ç»˜å›¾åŒ…
# library(ggplot2)

# å¯¹2åˆ†é’Ÿé—´éš”çš„è¿ç»­æ—¶é—´ç‚¹ä¸Šçš„ç”µåŠ›æ¶ˆè´¹é‡åšå›¾
ggplot(
 data.frame(y = as.numeric(energy_data[1, ])),
    aes(y = y, x = 1:720)
) +
  geom_line() + 
  theme_minimal() +
  labs(x = '2-Minute Interval', y = 'Power Consumption')
```

![image_28](./image_28.png)

- ç¼–å†™ä¸€ä¸ªR6ç±»çš„å‡½æ•°ç”¨äºæå–  
  æå–åŠŸè€—çš„å‡å€¼ã€æœ€å°å€¼ã€æœ€å¤§å€¼å’Œæ–¹å·®ï¼Œ  
  ç„¶ååˆ é™¤åŸæœ‰çš„ç‰¹å¾å˜é‡
-

```r
PipeOpFuncExtract <- R6::R6Class(
 # å®šä¹‰ä¸€ä¸ªæ–°ç±»`PipeOpFuncExtract`
 'PipeOpFuncExtract',
 # é€‰æ‹©ç»§æ‰¿è‡ª`PipeOpTaskPreprocSimple`
 inherit = mlr3pipelines::PipeOpTaskPreprocSimple,
 # å®šä¹‰ä¸€ä¸ªç§æœ‰æ–¹æ³•
 private = list(
  # å®šä¹‰å‡½æ•°ç”¨æ¥å˜é‡æå–
  .transform_dt = function(dt, levels) {
   # é€‰æ‹©æ‰€æœ‰'att'å¼€å¤´çš„ç‰¹å¾å˜é‡
   ffeat_names <- paste0('att', 1:720)
   # 
   ffeats <- dt[, ..ffeat_names]
   # æå–åŠŸè€—å‡å€¼ï¼Œæœ€å°å€¼ï¼Œæœ€å¤§å€¼ï¼Œåå·®
   dt[, energy_means := apply(ffeats, 1, mean)]
   dt[, energy_mins := apply(ffeats, 1, min)]
   dt[, energy_maxs := apply(ffeats, 1, max)]
   dt[, energy_vars := apply(ffeats, 1, var)]
   # åˆ é™¤åŸæœ‰çš„ç‰¹å¾å˜é‡
   dt[, (ffeat_names) := NULL]
   # è¿”å›æ•°æ®é›†
   return(dt)
  }
 )
)
```

- æµ‹è¯•`PipeOp`æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ

```r
# åˆå¹¶æˆ¿å±‹å’ŒåŠŸè€—æ•°æ®é›†ï¼ˆåŸæœ¬æ˜¯åŒä¸€æ‰¹æ ·æœ¬ï¼‰
tsk_ames_ext <- cbind(ames, energy_data)
# åˆ›å»º`Task`ï¼Œå¹¶æ›´æ”¹id
tsk_ames_ext <- as_task_regr(tsk_ames_ext, 'Sale_Price', 'ames_ext')
# ç§»é™¤é‚£äº›æœ‰é—®é¢˜çš„ç‰¹å¾ï¼ˆæœ¬ç« å¼€å¤´ç­›é€‰å‡ºæ¥çš„ï¼‰
tsk_ames_ext$select(setdiff(tsk_ames_ext$feature_names, to_remove))

# åˆ›å»º`PipeOpFuncExtract`ç±»çš„å®ä¾‹å¹¶å‘½åid
func_extractor <- PipeOpFuncExtract$new('energy_extract')
# ç”¨åˆ›é€ çš„å®ä¾‹å¤„ç†`tsk_ames_ext`
tsk_ames_ext <- func_extractor$train(list(tsk_ames_ext))[[1]]

# æŸ¥çœ‹ç¬¬ä¸€ä¸ªæ ·æœ¬çš„
tsk_ames_ext$data(
 1,
 c('energy_means', 'energy_mins', 'energy_maxs', 'energy_vars')
)
```

<table class='dataframe'>
<caption>A data.table: 1 x 4</caption>
<thead>
 <tr><th scope=col>energy_means</th><th scope=col>energy_mins</th><th scope=col>energy_maxs</th><th scope=col>energy_vars</th></tr>
 <tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>1.061558</td><td>0.01426834</td><td>21.97755</td><td>3.708473</td></tr>
</tbody>
</table>

- æ¥ä¸‹æ¥ç”¨benchmarkæ¯”è¾ƒè¿™äº›ç®¡é“çš„æ¨¡å‹æ•ˆæœ
  - é€šè¿‡æ·»åŠ åˆå¹¶åçš„ç”µåŠ›æ¶ˆè€—ä¿¡æ¯å¯ä»¥è®©æ¨¡å‹æ‹Ÿåˆçš„æ›´å¥½

```r
learners <- list(
 lrn_baseline, 
 lrn('regr.rpart'), 
 glrn_xgb_impact,
 # è¿™ä¸ªæ˜¯ä¹‹å‰æ„å»ºå¤±è´¥çš„ï¼Œè¿™é‡Œå°±æ²¡ç”¨å®ƒäº†
    # glrn_rf_impute_oor, 
    glrn_lm_robust, 
    glrn_log_lm_robust
)

bmr_final <- benchmark(
 benchmark_grid(
 c(tsk_ames_ext, tsk_ames), 
 learners,
 rsmp_cv3)
)

# æ•´åˆç»“æœ
perf <- bmr_final$aggregate(measure = msr_mae)
# å¯¹æ•´åˆçš„ç»“æœæ’åºåæ‰“å°
perf[order(learner_id, task_id), .(task_id, learner_id, regr.mae)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 10 x 3</caption>
<thead>
 <tr><th scope=col>task_id</th><th scope=col>learner_id</th><th scope=col>regr.mae</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>ames    </td><td>Baseline          </td><td>56159.11</td></tr>
 <tr><td>ames_ext</td><td>Baseline          </td><td>56159.11</td></tr>
 <tr><td>ames    </td><td>XGB_enc_impact    </td><td>15959.01</td></tr>
 <tr><td>ames_ext</td><td>XGB_enc_impact    </td><td>14537.98</td></tr>
 <tr><td>ames    </td><td>lm_robust         </td><td>16123.83</td></tr>
 <tr><td>ames_ext</td><td>lm_robust         </td><td>14969.29</td></tr>
 <tr><td>ames    </td><td>lm_robust_logtrafo</td><td>15510.96</td></tr>
 <tr><td>ames_ext</td><td>lm_robust_logtrafo</td><td>13903.53</td></tr>
 <tr><td>ames    </td><td>regr.rpart        </td><td>27979.09</td></tr>
 <tr><td>ames_ext</td><td>regr.rpart        </td><td>27689.78</td></tr>
</tbody>
</table>

## å¹¶è¡ŒåŒ–

### ç®€ä»‹

- ä½¿ç”¨`parallel`åŒ…æ¼”ç¤ºç®€å•çš„å¹¶è¡ŒåŒ–
  - `chunk.size`ï¼šå¤„ç†åŒºå—

```r
# åŠ è½½RåŒ…å¹¶è®¾ç½®å¹¶è¡ŒåŒ–å‚æ•°
# library(parallel)
cores <- 4
cl <- makeCluster(cores)

# åˆ›å»ºä¸€ä¸ªç®€å•çš„å‡½æ•°
x = 1:10000
f = function(y) sqrt(y + 1)

# å•ä¸ªè¿è¡Œ
system.time({parSapply(cl, x, f, chunk.size = 1)})
# ä¸€ä¸ªåŒºå—2500ä¸ªæ•°æ®è¿è¡Œ
system.time({parSapply(cl, x, f, chunk.size = 2500)})
```

```js
   user  system elapsed 
  0.392   0.187   1.605 

   user  system elapsed 
  0.002   0.000   0.016 
```

### å­¦ä¹ å™¨çš„å¹¶è¡ŒåŒ–

- æ„å»ºä¸€ä¸ªéšæœºæ£®æ—å­¦ä¹ å™¨
  - æŸ¥çœ‹é»˜è®¤çº¿ç¨‹æ•°å¯çŸ¥ä¸º1ä¸ªï¼ˆæ— å¹¶è¡ŒåŒ–ï¼‰

```r
# æ„å»ºå­¦ä¹ å™¨å­¦ä¹ å™¨
lrn_ranger <- lrn('classif.ranger')
lrn_ranger$param_set$ids(tags = 'threads')

# æŸ¥çœ‹åˆå§‹é»˜è®¤çº¿ç¨‹æ•°
lrn_ranger$param_set$values$num.threads
```

```js
1
```

- è®¾ç½®æŒ‡å®šçš„çº¿ç¨‹æ•°

```r
set_threads(lrn_ranger, n = 4)
lrn_ranger$param_set$values$num.threads
```

```js
4
```

- æŸ¥çœ‹å¯ç”¨çš„çº¿ç¨‹æ•°

```r
availableCores()
```

```js
8
```

- è‡ªåŠ¨æ£€æµ‹å¹¶è®¾å®šæœ€å¤§å¯ç”¨çº¿ç¨‹æ•°

```r
set_threads(lrn_ranger)
lrn_ranger$param_set$values$num.threads
```

```js
8
```

- å¦‚æœè¦æ§åˆ¶é»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡ï¼Œ  
  å¯åœ¨`.Rprofile`æ–‡ä»¶ä¸­å¦‚ä¸‹è®¾ç½®

```r
# è®¾ç½®æœ€å¤§4ä¸ª
options(mc.cores = 4)
```

### é‡é‡‡æ ·å’Œbenchmarkçš„å¹¶è¡ŒåŒ–

- mlr3 åˆ©ç”¨ `future` å®ç°ä½¿ç”¨å¹¶è¡Œåç«¯å¯¹é‡é‡‡æ ·è¿­ä»£è¿›è¡Œå¹¶è¡ŒåŒ–
  - å¯é€šè¿‡ `plan()` å‡½æ•°å¯¹æ­¤è¿›è¡Œé…ç½®
  - é»˜è®¤æƒ…å†µä¸‹ï¼Œé™¤éåœ¨Â `future::plan()`Â ä¸­æŒ‡å®šå‚æ•°Â `workers`ï¼Œ  
   å¦åˆ™ä¼šä½¿ç”¨æœºå™¨çš„æ‰€æœ‰ CPU

```r
# åŠ è½½RåŒ…
# library(future)

# è®¡åˆ’ä¸ºå¤šæ ¸æ¨¡å¼
future::plan('multisession')

# é‡é‡‡æ ·
tsk_sonar <- tsk('sonar')
lrn_rpart <- lrn('classif.rpart')
rsmp_cv3 <- rsmp('cv', folds = 3)
system.time({resample(tsk_sonar, lrn_rpart, rsmp_cv3)})
```

```js
   user  system elapsed 
  0.471   0.053   1.926 
```

- ä¸€èˆ¬æ¥è¯´ï¼Œå»ºè®®**ä»…å¯¹æ¯æ¬¡è¿­ä»£è‡³å°‘è¿è¡Œå‡ ç§’**çš„é‡é‡‡æ ·è€ƒè™‘å¹¶è¡ŒåŒ–
- æœ‰ä¸¤ä¸ªÂ `mlr3`Â é€‰é¡¹å¯ç”¨äºæ§åˆ¶æ‰§è¡Œå’Œç²’åº¦ï¼š
  - å¦‚æœ`mlr3.exec_random`è®¾ç½®ä¸º`TRUE`ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œ
   åˆ™åœ¨é‡æŠ½æ ·å’ŒåŸºå‡†æµ‹è¯•ä¸­ï¼Œ  
   ä»»åŠ¡çš„é¡ºåºå°†è¢«éšæœºåŒ–ï¼›  
   é€‚ç”¨äºåœ¨è¿è¡ŒåŸºå‡†æµ‹è¯•æˆ–è°ƒå‚æ—¶é‡åˆ°è¿è¡Œæ—¶é—´å·®å¼‚è¾ƒå¤§çš„æƒ…å†µ
  - é€‰é¡¹Â `mlr3.exec_chunk_size`Â å¯ç”¨äº  
   æ§åˆ¶å°†å¤šå°‘ä¸ªä»»åŠ¡æ˜ å°„åˆ°å•ä¸ªÂ `future`ï¼Œ  
   é»˜è®¤å€¼ä¸ºÂ `1`ï¼›  
   æ­¤é€‰é¡¹çš„å€¼ä¼šä¼ é€’ç»™Â `future_mapply()`ï¼Œ  
   å¹¶ä¸”Â `future.scheduling`Â å§‹ç»ˆè®¾ç½®ä¸ºÂ `TRUE`
- è°ƒæ•´å—å¤§å°åœ¨æŸäº›ç½•è§æƒ…å†µä¸‹æœ‰åŠ©äºå‡å°‘å¹¶è¡ŒåŒ–å¼€é”€ï¼Œ  
  ä½†åœ¨è¾ƒå¤§é—®é¢˜æˆ–è¾ƒé•¿è¿è¡Œæ—¶é—´çš„æƒ…å†µä¸‹ä¸å¤ªå¯èƒ½æœ‰ç”¨

- ä¸‹å›¾å±•ç¤ºä¸Šé¢3æŠ˜CVçš„é‡é‡‡æ ·å¹¶è¡ŒåŒ–æµç¨‹ï¼š
  - ä¸»è¿›ç¨‹è°ƒç”¨`resample()`å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯åŠ¨å¹¶è¡ŒåŒ–è¿‡ç¨‹ï¼Œ  
   å¹¶å°†è®¡ç®—ä»»åŠ¡åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ç”¨äºä¸‰æŠ˜äº¤å‰éªŒè¯
  - è¿™äº›æŠ˜è¢«ä¼ é€’ç»™ä¸‰ä¸ªworkerï¼Œ  
   æ¯ä¸ªworkeråœ¨ä»»åŠ¡çš„ç›¸åº”å­é›†ä¸Šæ‹Ÿåˆæ¨¡å‹ï¼Œ  
   å¹¶å¯¹ç•™å‡ºçš„è§‚æµ‹å€¼è¿›è¡Œé¢„æµ‹
  - é¢„æµ‹ç»“æœï¼ˆå’Œè®­ç»ƒå¥½çš„æ¨¡å‹ï¼‰è¢«ä¼ å›ä¸»è¿›ç¨‹ï¼Œ  
   ä¸»è¿›ç¨‹å°†å®ƒä»¬åˆå¹¶ä¸ºä¸€ä¸ª`ResampleResult`

![image_25](./image_25.png)

- åŸºå‡†æµ‹è¯•å¯ä»¥çœ‹ä½œæ˜¯å¤šä¸ªç‹¬ç«‹é‡é‡‡æ ·çš„é›†åˆï¼Œ  
  å…¶ä¸­ä»»åŠ¡ã€å­¦ä¹ å™¨å’Œé‡é‡‡æ ·ç­–ç•¥çš„ç»„åˆå®šä¹‰äº†è¦æ‰§è¡Œçš„ä¸€æ¬¡é‡é‡‡æ ·
- å¯ä»¥é€‰æ‹©ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€ï¼š
  - å¯¹æ‰€æœ‰é‡é‡‡æ ·è¿›è¡Œå¹¶è¡Œå¤„ç†ï¼Œå¹¶æŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªé‡é‡‡æ ·ï¼ˆå¹¶è¡ŒåŒ–å¤–å±‚å¾ªç¯ï¼‰
  - éå†æ‰€æœ‰é‡é‡‡æ ·ï¼Œå¹¶å¹¶è¡Œæ‰§è¡Œæ¯ä¸ªé‡é‡‡æ ·ï¼ˆå¹¶è¡ŒåŒ–å†…å¾ªç¯ï¼‰

```pseudocode
foreach combination of (task, learner, resampling strategy) {
    foreach resampling iteration {
        execute(resampling, j)
    }
}
```

- `mlr3`Â é€šè¿‡å°†æ‰€æœ‰å®éªŒå±•å¹³åˆ°åŒä¸€çº§åˆ«ï¼Œ  
  å³Â `benchmark()` ä¼šéå†å¤–å±‚å’Œå†…å±‚å¾ªç¯è¿­ä»£çš„ç¬›å¡å°”ç§¯ä¸­çš„å…ƒç´ 
  - å› æ­¤ï¼Œæ— éœ€å†³å®šæ˜¯è¦å¹¶è¡ŒåŒ–è°ƒå‚è¿˜æ˜¯é‡é‡‡æ ·ï¼Œå› ä¸ºå§‹ç»ˆå¯¹ä¸¤è€…éƒ½è¿›è¡Œå¹¶è¡ŒåŒ–
  - è¿™ç§æ–¹æ³•ä½¿è®¡ç®—æ›´åŠ ç²¾ç»†ï¼Œ  
   å¹¶å…è®¸Â `future`Â åç«¯å°†ä»»åŠ¡åˆ†ç»„ä¸ºåˆé€‚å¤§å°çš„å—ï¼ˆå–å†³äºå·¥ä½œçº¿ç¨‹æ•°ï¼‰ï¼Œ  
   è¿˜ä½¿è¯¥è¿‡ç¨‹ä¸å¹¶è¡ŒåŒ–é‡é‡‡æ ·å®Œå…¨ç›¸åŒ

```r
# åˆ›å»ºbenchmarkè®¾è®¡
design <- benchmark_grid(
 tsks(c('sonar', 'penguins')),
 lrns(c('classif.featureless', 'classif.rpart')), 
 rsmp_cv3
)

# è®¾ç½®å¹¶è¡ŒåŒ–è®¡ç®—
future::plan('multisession')

# æ‰§è¡Œå¹¶è¡ŒåŒ–çš„benchmarkæ¯”è¾ƒ
bmr <- benchmark(design)
```

### è°ƒä¼˜çš„å¹¶è¡ŒåŒ–

- è°ƒä¼˜ä¸€èˆ¬æ˜¯è¿­ä»£çš„è¿‡ç¨‹
  - æ¯æ¬¡è¿­ä»£åï¼Œ  
   å¤§å¤šæ•°è°ƒä¼˜å™¨ä¼šæ ¹æ®è·å¾—çš„æ€§èƒ½å€¼ä»¥æŸç§æ–¹å¼è¿›è¡Œè‡ªæˆ‘è°ƒæ•´
  - éšæœºæœç´¢å’Œç½‘æ ¼æœç´¢æ˜¯ä¾‹å¤–
    - å®ƒä»¬å¹¶ä¸æ ¹æ®è¿‡å¾€ç»“æœé€‰æ‹©é…ç½®
    - å¯¹äºè¿™äº›è°ƒä¼˜å™¨è€Œè¨€ï¼Œæ‰€æœ‰è¯„ä¼°éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„
    - åŸåˆ™ä¸Šå¯ä»¥å®Œå…¨å¹¶è¡ŒåŒ–ã€‚
- åœ¨`mlr3`ä¸­ä½œä¸ºè¿­ä»£benchmarkæµ‹è¯•æ¥å®ç°
  - `Tuner`æå‡ºä¸€æ‰¹å­¦ä¹ å™¨ï¼Œ  
   æ¯ä¸ªå­¦ä¹ å™¨çš„ param_set$values`å…·æœ‰ä¸åŒçš„é…ç½®ï¼Œ  
   å…¶ä¸­æ‰¹æ¬¡å¤§å°é€šå¸¸å¯ä»¥é€šè¿‡batch_sizeé…ç½®å‚æ•°è¿›è¡Œæ§åˆ¶
  - è¯¥æ‰¹æ¬¡ä¼šè¿åŒè°ƒä¼˜å®ä¾‹çš„é‡é‡‡æ ·ç­–ç•¥ä¸€èµ·ä¼ é€’ç»™`benchmark()`
- ç”±äºæ¯æ¬¡å¯¹Â `benchmark()`Â çš„è°ƒç”¨éƒ½ä¾èµ–äºå…ˆå‰çš„ç»“æœï¼Œ  
  å› æ­¤é€šå¸¸æ— æ³•åœ¨æ¯”å•ä¸ªåŸºå‡†æµ‹è¯•æ›´é«˜çš„çº§åˆ«ä¸Šå¹¶è¡ŒåŒ–è°ƒä¼˜
  - ç›¸åï¼Œå•ä¸ªÂ `benchmark()`Â è¯„ä¼°ç”±Â `mlr3`Â å¹¶è¡ŒåŒ–ï¼Œ  
   å°±å¥½åƒå®ƒä»¬æ˜¯æ— éœ€è°ƒä¼˜çš„å®éªŒä¸€æ ·
  - è¿™æ„å‘³ç€æ¯ä¸ªè¯„ä¼°é…ç½®çš„å•ä¸ªé‡é‡‡æ ·è¿­ä»£éƒ½åŒæ—¶è¢«å¹¶è¡ŒåŒ–
- ä¸ºç¡®ä¿å®Œå…¨å¹¶è¡ŒåŒ–ï¼Œåº”ç¡®ä¿Â `batch_size`Â ä¹˜ä»¥é‡é‡‡æ ·è¿­ä»£æ¬¡æ•°è‡³å°‘ç­‰äºå¯ç”¨å·¥ä½œçº¿ç¨‹æ•°
  - å¦‚æœæœŸæœ›è¿è¡Œæ—¶æ˜¯å‡åŒ€çš„ï¼Œ  
   å³å¯¹å•ä¸ªå­¦ä¹ å™¨æˆ–ç®¡é“è¿›è¡Œè°ƒä¼˜ï¼Œä¸”æ²¡æœ‰ä»»ä½•å¯¹è¿è¡Œæ—¶æœ‰é‡å¤§å½±å“çš„è¶…å‚æ•°
    - é‚£ä¹ˆç›®æ ‡æ˜¯å·¥ä½œçº¿ç¨‹æ•°çš„å€æ•°
- ä¸€èˆ¬æ¥è¯´ï¼Œæ‰¹æ¬¡è¶Šå¤§ï¼Œå¹¶è¡ŒåŒ–ç¨‹åº¦è¶Šé«˜ï¼Œè€Œæ‰¹æ¬¡è¶Šå°ï¼Œåˆ™æ„å‘³ç€æ›´é¢‘ç¹åœ°æ£€æŸ¥ç»ˆæ­¢æ¡ä»¶
- æ— è®ºæ˜¯å¦ä½¿ç”¨å¹¶è¡ŒåŒ–ï¼Œç»ˆæ­¢æ¡ä»¶ä»…åœ¨æ‰¹æ¬¡è¯„ä¼°ä¹‹é—´è¿›è¡Œæ£€æŸ¥ã€‚
- ä»¥ä¸‹ä»£ç å±•ç¤ºäº†éšæœºæœç´¢çš„å¹¶è¡Œæ‰§è¡Œ
  - ç»ˆæ­¢æ¡ä»¶è®¾ç½®ä¸º20æ¬¡è¿­ä»£
  - é‡‡ç”¨ä¸­ç­‰æ‰¹é‡å¤§å°ï¼Œ  
   å…¶ä¸­36ä¸ªé‡é‡‡æ ·åˆ†å‰²ï¼ˆæ¯ä¸ªåˆ†å‰²æœ‰12ç§é…ç½®ï¼Œå…±3ç§åˆ†å‰²ï¼‰åœ¨4ä¸ªworkerä¸Šå¹¶è¡Œè¯„ä¼°
  - æ‰¹é‡å¤§å°è®¾ç½®ä¸ºworkerçš„å€æ•°ï¼Œä»¥ç¡®ä¿æœ‰æ•ˆåˆ©ç”¨å¯ç”¨èµ„æº
- æ³¨æ„ï¼šè°ƒä¼˜ä»…åœ¨ç»™å®šæ‰¹é‡å¤§å°çš„å€æ•°ä¹‹åæ‰ä¼šç»ˆæ­¢
  - åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¯åœ¨24æ¬¡è¯„ä¼°ä¹‹å

```r
future::plan('multisession', workers = 4)

instance <- tune(
 tnr('random_search', batch_size = 12),
 tsk('penguins'),
 lrn('classif.rpart', minsplit = to_tune(2, 128)),
 rsmp('cv', folds = 3),
 term_evals = 20
)

instance$archive$n_evals
```

```js
24
```

- ç»“æœçš„`24`æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ
  - `batch_size = 12`è¡¨ç¤ºæµ‹è¯•12ç»„è¶…å‚æ•°
  - æ¯ä¸€ç»„æ˜¯ä¸å¯æ‹†åˆ†çš„ï¼Œå½“`term_evals=20`æ—¶
    - 1ç»„ä¸º12ï¼Œæ²¡æœ‰è¶…è¿‡20
    - 2æŠ˜åˆ™æœ‰24ç»„ï¼Œè¶…è¿‡äº†20
  - å½“è¶…è¿‡20çš„æ—¶å€™ï¼Œä¸ä¼šè¿›è¡Œä¸‹ä¸€æŠ˜çš„è®¡ç®—ï¼Œ  
   ä½†æ˜¯æ¯ç»„ä¸­çš„è¶…å‚æ•°éƒ½ä¼šè¢«æµ‹è¯•
  - æ›´æ”¹`batch_size = 11`ï¼Œç»“æœä¸º`22`
    - $11 \times 2 = 22 > 20$
  - æ›´æ”¹`term_evals = 37`ï¼Œç»“æœä¸º`48`
    - $12 \times 3 =36 < 37$ï¼Œæ•…æµ‹è¯•ç»„ $(3+1) \times 12 = 48$
- çº¿ç¨‹æ•°çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
  - æ¯ä¸€ç»„çš„12ä¸ªè¶…å‚æ•°å¹³å‡åˆ†é…åˆ°çº¿ç¨‹æ•°ï¼ˆ4ï¼‰ä¸ªï¼Œ  
   æ¯ä¸€ä¸ªworkerå¤„ç†3ä¸ªè¶…å‚æ•°
- CVçš„æŠ˜æ•°æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ
  - æ— è®ºæ˜¯3æŠ˜è¿˜æ˜¯30æŠ˜ï¼Œé‡é‡‡æ ·éƒ½ç”±ç›¸åŒçš„workerè¿›è¡Œ

- è™½ç„¶è¿™é‡Œ`term_evals`è¢«è®¾ç½®ä¸º20ï¼Œä½†æ˜¯æœ‰æ—¶å¹¶ä¸é€‚ç”¨äºå…¶ä»–æƒ…å†µ
  - ä¾‹å¦‚`trm('perf_reached')`ï¼š  
   å³ä½¿è¯¥æ‰¹æ¬¡çš„ç¬¬ä¸€ä¸ªé…ç½®äº§ç”Ÿçš„æ€§èƒ½ä¼˜äºç»™å®šé˜ˆå€¼ï¼Œ  
   å…¶ä½™11ä¸ªé…ç½®ä»ä¼šè¿›è¡Œä¸å¿…è¦çš„è¯„ä¼°

### åµŒå¥—é‡é‡‡æ ·å¹¶è¡ŒåŒ–

- åµŒå¥—é‡é‡‡æ ·åœ¨æ¦‚å¿µä¸Šå¯ä»¥åœ¨ä¸‰ä¸ªä¸åŒå±‚æ¬¡ä¸Šå¹¶è¡ŒåŒ–ï¼Œæ¯ä¸ªå±‚æ¬¡å¯¹åº”ä¸åŒç²’åº¦çš„ä»»åŠ¡ï¼š
  - **å¤–éƒ¨é‡é‡‡æ ·çš„å¹¶è¡ŒåŒ–**
    - ä¸€é¡¹ä»»åŠ¡å°±æ˜¯åœ¨å¤–éƒ¨é‡é‡‡æ ·åˆ†å‰²çš„ç›¸åº”è®­ç»ƒé›†ä¸Šå¯¹å­¦ä¹ å™¨è¿›è¡Œè°ƒä¼˜
  - **åœ¨ä¸€æ¬¡è°ƒä¼˜è¿­ä»£ä¸­å¯¹æ‰€æå‡ºçš„ä¸€æ‰¹è¶…å‚æ•°é…ç½®è¿›è¡Œå¹¶è¡Œè¯„ä¼°**
    - ä¸€é¡¹ä»»åŠ¡å¯èƒ½æ˜¯å¯¹è¿™æ ·ä¸€ç§é…ç½®è¿›è¡Œäº¤å‰éªŒè¯
  - **è°ƒä¼˜ä¸­å†…éƒ¨é‡é‡‡æ ·çš„å¹¶è¡ŒåŒ–**
    - ä¸€é¡¹ä»»åŠ¡å³ä¸ºå•ä¸ªé…ç½®çš„è®­ç»ƒ-é¢„æµ‹-è¯„åˆ†æ­¥éª¤

- ä¸‹é¢æ˜¯åµŒå¥—é‡é‡‡æ ·å¹¶è¡ŒåŒ–çš„ä¼ªä»£ç çš„ç®€åŒ–ç‰ˆ
  - ç¬¬äºŒå±‚ä¸­åˆ©ç”¨äº†`benchmark()`çš„åŠŸèƒ½ï¼š
    - ä¸ºæ¯ä¸ªæè®®çš„è¶…å‚æ•°é…ç½®åˆ›å»ºä¸€ä¸ª`Learner`å¯¹è±¡ï¼Œ  
    å¹¶ä¸”åœ¨æœ€å†…å±‚çš„forå¾ªç¯ä¸­ï¼Œ  
    æ‰€æœ‰å­¦ä¹ å™¨éƒ½åœ¨ä¸€ä¸ªåŸºå‡†å®éªŒä¸­è¿›è¡Œé‡é‡‡æ ·ï¼Œ  
    ä»è€Œæœ‰æ•ˆåœ°åœ¨æ›´ç»†çš„ç²’åº¦ä¸Š  
    ï¼ˆæè®®ç‚¹æ•°ä¹˜ä»¥å†…éƒ¨é‡é‡‡æ ·è¿­ä»£æ¬¡æ•°ï¼‰  
    åŒæ—¶æ‰§è¡Œç¬¬äºŒå±‚å’Œç¬¬ä¸‰å±‚
  - å› æ­¤ï¼Œå½“åœ¨`mlr3`ä¸­å¯¹åµŒå¥—é‡é‡‡æ ·è¿›è¡Œå¹¶è¡ŒåŒ–æ—¶ï¼Œ  
   åªéœ€è¦åœ¨ä¸¤ä¸ªé€‰é¡¹ä¸­åšå‡ºé€‰æ‹©ï¼š
    - å¯¹å¤–éƒ¨é‡é‡‡æ ·è¿›è¡Œå¹¶è¡ŒåŒ–
    - è¿˜æ˜¯å¯¹å†…éƒ¨åŸºå‡†æµ‹è¯•è¿›è¡Œå¹¶è¡ŒåŒ–ã€‚

```pseudocode
# outer resampling, level 1:
for (i in seq_len(n_outer_splits)) {
 # tuning instance, in this example mainly represents the archive
 tuning_inst = ti(...)
 inner_task = get_training_task(task, outer_splits[[i]])
 # tuning loop, the details of which depend on the tuner being used
 # This does not correspond to a level:
 while (!tuning_inst$is_terminated) {
  proposed_points = propose_points(tuning_inst$archive, batch_size)
  # Evaluation of configurations, level 2:
  for (hp_configuration in proposed_points) {
   split_performances = numeric()
   # Inner resampling, level 3:
   for (j in seq_len(n_inner_splits)) {
   split_performances[j] = evaluate_performance(
    learner, 
    hp_configuration, 
    inner_task, 
    inner_splits[[j]]
   )
  }
   performance = aggregate(split_performances)
   update_archive(
    tuning_inst$archive, 
    configuration, 
    performance
   )
  }
  }
   evaluate_performance(
   learner, 
   tuning_inst$result, 
   task, outer_splits[[i]]
  )
}
```

- ä¸‹é¢ç”¨å•ç¨‹è®¡ç®—è¿›é‡é‡‡æ ·

```r
# åŠ è½½RåŒ…
#library(mlr3tuning)
# è®¾ç½®ä¸ºå•ç¨‹è®¡ç®—
future::plan('sequential')

# æ„å»ºå­¦ä¹ å™¨ï¼Œæ ‡è®°`minsplit`æ ‡è®°
lrn_rpart <- lrn(
 'classif.rpart',
 minsplit  = to_tune(2, 128)
)

lrn_rpart_tuned <- auto_tuner(
 tnr('random_search', batch_size = 2),
 lrn_rpart, 
 rsmp('holdout'), 
 msr('classif.ce'), 
 2
)

rr <- resample(
 tsk('penguins'), 
 lrn_rpart_tuned, 
 rsmp('cv', folds = 5)
)
```

- å¯¹äºæ˜¯å¦å¹¶è¡Œä¹Ÿå¯ä»¥é€‰æ‹©ä¸åŒçš„æ–¹æ³•

```r
# ä»…å¯¹å¤–å±‚é‡é‡‡æ ·è¿›è¡Œå¹¶è¡Œè¿ç®—
# ç¬¬äºŒä¸ªå’Œç¬¬ä¸€ä¸ªæ˜¯ä¸€æ ·çš„
# å› ä¸ºå¦‚æœä¸æŒ‡å®šä¸º'multisession'éƒ½é»˜è®¤ä¸º'sequential'
future::plan(list('multisession', 'sequential'))
future::plan('multisession')

# ä»…å¯¹å†…å±‚é‡é‡‡æ ·è¿›è¡Œå¹¶è¡Œè¿ç®—
future::plan(list('sequential', 'multisession'))
```

- åœ¨å¤–éƒ¨5é‡äº¤å‰éªŒè¯ä¸­å¹¶è¡ŒåŒ–å†…éƒ¨é¡ºåº2é‡äº¤å‰éªŒè¯æ—¶å››ä¸ªCPUçš„åˆ©ç”¨ç‡
  - ä»»åŠ¡æ ‡è®°ä¸º\[å¤–éƒ¨è¿­ä»£æ¬¡æ•°\]-\[å†…éƒ¨è¿­ä»£æ¬¡æ•°\]

![image_26](./image_26.png)

- åœ¨å¤–éƒ¨ä½¿ç”¨é¡ºåº5æŠ˜äº¤å‰éªŒè¯å¯¹å†…éƒ¨åŸºå‡†æµ‹è¯•ï¼ˆç”±2æ¬¡ç•™å‡ºè¯„ä¼°ç»„æˆï¼‰è¿›è¡Œå¹¶è¡ŒåŒ–æ—¶ï¼Œ  
  å››ä¸ªæ ¸å¿ƒçš„CPUåˆ©ç”¨ç‡
  - ä»»åŠ¡æ ‡è®°ä¸º\[å¤–éƒ¨è¿­ä»£æ¬¡æ•°\]-\[å†…éƒ¨è¿­ä»£æ¬¡æ•°\]

![image_27](./image_27.png)

- åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œä¸¤ç§å¹¶è¡ŒåŒ–æ–¹å¼éƒ½æ²¡æœ‰å……åˆ†å‘æŒ¥å››ä¸ªæ ¸å¿ƒçš„å…¨éƒ¨æ½œåŠ›
  - é€šè¿‡å¯¹å¤–å¾ªç¯è¿›è¡Œå¹¶è¡ŒåŒ–ï¼Œæ‰€æœ‰ç»“æœåœ¨16ç§’åè®¡ç®—å®Œæˆ
  - å¦‚æœå¯¹å†…å¾ªç¯è¿›è¡Œå¹¶è¡ŒåŒ–ï¼Œåˆ™åœ¨20ç§’åå¾—åˆ°ç»“æœ
  - åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œè‡³å°‘åœ¨æŸäº›æ—¶é—´æ®µå†…ï¼Œéƒ¨åˆ†CPUæ ¸å¿ƒå¤„äºç©ºé—²çŠ¶æ€

- `mlr3`å’Œ`future`ä½¿å¾—åµŒå¥—å¹¶è¡ŒåŒ–çš„ä¸¤ä¸ªå¾ªç¯éƒ½èƒ½å¤Ÿå®ç°å¹¶è¡ŒåŒ–ï¼Œ  
  å³ä½¿åœ¨ä¸åŒçš„å¹¶è¡ŒåŒ–åç«¯ä¸Šä¹Ÿå¯ä»¥ï¼Œ  
  è¿™åœ¨ä¸€äº›åˆ†å¸ƒå¼è®¡ç®—è®¾ç½®ä¸­å¯èƒ½ä¼šå¾ˆæœ‰ç”¨
   å¯¹äºè¿™ç§åµŒå¥—å¹¶è¡ŒåŒ–ï¼Œå¯ç”¨æ ¸å¿ƒçš„æ£€æµ‹ä¸èµ·ä½œç”¨ï¼Œ  
   å¿…é¡»æ‰‹åŠ¨è®¾ç½®å·¥ä½œçº¿ç¨‹æ•°
  - è¿™ä¸ªç¤ºä¾‹å°†åœ¨æœ¬åœ°æœºå™¨ä¸Šæœ€å¤šä½¿ç”¨å››ä¸ªæ ¸å¿ƒè¿è¡Œï¼š
    - é¦–å…ˆï¼Œä¸ºå¤–éƒ¨å¾ªç¯ç”Ÿæˆä¸¤ä¸ªæ–°ä¼šè¯
    - ç„¶åï¼Œè¿™ä¸¤ä¸ªæ–°ä¼šè¯å„è‡ªå†ç”Ÿæˆä¸¤ä¸ªé¢å¤–çš„ä¼šè¯ï¼Œ  
     ä»¥è¯„ä¼°å†…éƒ¨åŸºå‡†æµ‹è¯•
    - å°½ç®¡åœ¨ç¬¬5æ¬¡å¤–éƒ¨é‡é‡‡æ ·è¿­ä»£è¿è¡Œæ—¶ä»æœ‰2ä¸ªæ ¸å¿ƒå¤„äºç©ºé—²çŠ¶æ€ï¼Œ  
     ä½†è¿™ç§æ–¹æ³•å°†æ€»è¿è¡Œæ—¶é—´ç¼©çŸ­è‡³12ç§’ï¼Œ  
     åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­è¿™æ˜¯æœ€ä¼˜çš„

```r
future::plan(list(
  tweak('multisession', workers = 2),
  tweak('multisession', workers = 2)
))
```

### é¢„æµ‹çš„å¹¶è¡ŒåŒ–

- ç”±äºå¤šä¸ªè§‚æµ‹å€¼çš„é¢„æµ‹ç›¸äº’ç‹¬ç«‹ï¼Œå•ä¸ªå­¦ä¹ å™¨çš„é¢„æµ‹å¯ä»¥å¹¶è¡ŒåŒ–
- å½“æµ‹è¯•æ•°æ®é›†éå¸¸å¤§æ—¶ï¼Œé¢„æµ‹å¹¶è¡ŒåŒ–å¯ä»¥ç¼©çŸ­æ—¶é—´

```r
# æ„å»ºä»»åŠ¡ï¼Œå­¦ä¹ å™¨å¹¶è®­ç»ƒæ¨¡å‹
tsk_sonar <- tsk('sonar')
lrn_rpart <- lrn('classif.rpart')
lrn_rpart$train(tsk_sonar)

# è®¾ç½®å¹¶è¡ŒåŒ–çº¿ç¨‹æ•°
future::plan('multisession', workers = 4)
# å¯åŠ¨é¢„æµ‹å¹¶è¡ŒåŒ–ï¼Œåªéœ€è¦è®¾ç½®`Learner$parallel_predict = TRUE`å³å¯
lrn_rpart$parallel_predict = TRUE

# é¢„æµ‹
prediction <- lrn_rpart$predict(tsk_sonar)
```

## é”™è¯¯å¤„ç†

### ç®€ä»‹

- å®é™…æ„å»ºæ¨¡å‹ä¸­ä¼šå‡ºç°å¾ˆå¤šéš¾ä»¥é¢„æ–™çš„é—®é¢˜ï¼š
  - å­¦ä¹ å™¨æ— æ³•å¤„ç†ç¼ºå¤±å€¼è€ŒæŠ¥é”™
  - å­˜åœ¨æ— æ³•å¤„ç†çš„è§‚æµ‹å€¼
  - å­¦ä¹ å™¨æ— æ³•æ”¶æ•›

- `lrn('classif.debug')`å¯ä»¥æ¨¡æ‹Ÿæœºå™¨å­¦ä¹ ä¸­ç»å¸¸é‡åˆ°çš„é—®é¢˜

```r
# åˆ›å»ºä»»åŠ¡
tsk_penguins <- tsk('penguins')
# åˆ›å»ºæ¨¡æ‹Ÿdebugå­¦ä¹ å™¨
lrn_debug <- lrn('classif.debug')
lrn_debug
```

```js
[36m--[39m [1m[34m<LearnerClassifDebug>[39m (classif.debug): Debug Learner for Classification[22m [36m-----[39m
* Model: -
* Parameters: list()
* Validate: [34m<NULL>[39m
* Packages: [34mmlr3[39m
* Predict Types: [response] and prob
* Feature Types: logical, integer, numeric, character, factor, and ordered
* Encapsulation: none (fallback: -)
* Properties: hotstart_forward, internal_tuning, marshal, missings, multiclass,
twoclass, validation, and weights
* Other settings: use_weights = 'use'
```

- é»˜è®¤è®¾ç½®ä¸‹ï¼Œå­¦ä¹ è€…ä¼šè®°ä½ä¸€ä¸ªéšæœºæ ‡ç­¾ï¼Œ  
  å¹¶åœ¨ä¸å‘å‡ºä»»ä½•æ¡ä»¶ä¿¡å·çš„æƒ…å†µä¸‹æŒç»­é¢„æµ‹è¯¥æ ‡ç­¾
  - åœ¨ä»¥ä¸‹ä»£ç ä¸­ï¼Œè®©å­¦ä¹ è€…åœ¨è®­ç»ƒæ­¥éª¤ä¸­å‘å‡ºé”™è¯¯ä¿¡å·
  - `lrn('classif.debug')`ä¹Ÿå¯ä»¥ç”¨äºæµ‹è¯•æµç¨‹ä¸­å¦‚æœå‘ç”Ÿé”™è¯¯æ—¶ï¼Œ  
   å°è£…å’Œå›é€€å­¦ä¹ å™¨æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ

```R
# å°†å‘å‡ºé”™è¯¯ä¿¡å·çš„æ¦‚ç‡è®¾ç½®ä¸º`1`
lrn_debug$param_set$values$error_train <- 1
lrn_debug$train(tsk_penguins)
```

```js
Error in get_private(learner)$.train(task): Error from classif.debug->train()
```

### å°è£…ï¼ˆEncapsulationï¼‰

- å°è£…å¯ç¡®ä¿æˆªè·ä¿¡å·æ¡ä»¶ï¼ˆä¾‹å¦‚æ¶ˆæ¯ã€è­¦å‘Šå’Œé”™è¯¯ï¼‰ï¼Œ  
  å¹¶å°†è®­ç»ƒæˆ–é¢„æµ‹æ­¥éª¤ä¸­å¼•å‘çš„æ‰€æœ‰æ¡ä»¶è®°å½•åˆ°å­¦ä¹ å™¨ä¸­ï¼Œ  
  è€Œä¸ä¼šä¸­æ–­ç¨‹åºæµç¨‹
  - è¿™æ„å‘³ç€æ¨¡å‹å¯ç”¨äºæ‹Ÿåˆå’Œé¢„æµ‹ï¼Œ  
   å¹¶ä¸”ä»»ä½•æ¡ä»¶éƒ½å¯ä»¥äº‹ååˆ†æ
  - ä½†æ˜¯ï¼Œæ ¹æ®é”™è¯¯å‘ç”Ÿçš„ä½ç½®ï¼Œå®éªŒç»“æœ**å¯èƒ½ä¼šç¼ºå°‘æ¨¡å‹å’Œ/æˆ–é¢„æµ‹**
- æ¯ä¸ª`Learner`éƒ½æœ‰æ–¹æ³•`Learner$encapsulate()`æ¥æ§åˆ¶è®­ç»ƒæˆ–é¢„æµ‹æ­¥éª¤çš„å°è£…æ–¹å¼
- ç¬¬ä¸€ç§å°è£…æ‰§è¡Œçš„æ–¹å¼ç”±`evaluate`åŒ…æä¾›
  - è¯¥åŒ…è®¡ç®—Rè¡¨è¾¾å¼å¹¶æ•è·å’Œè·Ÿè¸ªæ¡ä»¶ï¼ˆè¾“å‡ºã€æ¶ˆæ¯ã€è­¦å‘Šæˆ–é”™è¯¯ï¼‰
  - ä¸ä¼šè®©å®ƒä»¬åœæ­¢è¿›ç¨‹

```r
# `warning_train = 1`ï¼šå°†è®­ç»ƒæ—¶è§¦å‘è­¦å‘Šçš„æ¦‚ç‡è®¾ç½®ä¸º100%
# `error_train = 1`ï¼šå°†è®­ç»ƒæ—¶è§¦å‘é”™è¯¯çš„æ¦‚ç‡è®¾ç½®ä¸º100%
lrn_debug <- lrn('classif.debug', warning_train = 1, error_train = 1)

# è®¾ç½®å°è£…æ–¹æ³•å’Œå›é€€å­¦ä¹ å™¨
lrn_debug$encapsulate('evaluate', fallback = lrn('classif.featureless'))

# è®­ç»ƒæ¨¡å‹
lrn_debug$train(tsk_penguins)
```

```js
WARN  [17:30:10.822] [mlr3] train: Warning from classif.debug->train()
ERROR [17:30:10.829] [mlr3] train: Error from classif.debug->train()
INFO  [17:30:10.836] [mlr3] Learner 'classif.debug' on task 'penguins' failed to train a model {learner: <LearnerClassifDebug/LearnerClassif/Learner/R6>, messages: (Warning from classif.debug->train(), Error from classif.debug->train())}
INFO  [17:30:10.841] [mlr3] Calling train method of fallback 'classif.featureless' on task 'penguins' with 344 observations {learner: <LearnerClassifFeatureless/LearnerClassif/Learner/R6>}
```

- æŸ¥çœ‹è­¦å‘Šå’Œé”™è¯¯çš„è®°å½•

```r
lrn_debug$log
lrn_debug$warnings
lrn_debug$errors
```

<table class='dataframe'>
<caption>A data.table: 2 x 3</caption>
<thead>
 <tr><th scope=col>stage</th><th scope=col>class</th><th scope=col>msg</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;ord&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
 <tr><td>train</td><td>warning</td><td>Warning from classif.debug-&gt;train()</td></tr>
 <tr><td>train</td><td><span style=white-space:pre-wrap>error  </span></td><td><span style=white-space:pre-wrap>Error from classif.debug-&gt;train()  </span></td></tr>
</tbody>
</table>

```js
'Warning from classif.debug->train()'

'Error from classif.debug->train()'
```

- å¦ä¸€ç§å°è£…æ–¹æ³•åœ¨`callr`åŒ…ä¸­å®ç°
- ä¸`evaluate`ä¸åŒï¼Œè®¡ç®—åœ¨ä¸€ä¸ªå•ç‹¬çš„Rè¿›ç¨‹ä¸­å¤„ç†
  - è¿™å¯ä»¥ä¿æŠ¤è°ƒç”¨ä¼šè¯å…å—æ®µé”™è¯¯çš„å½±å“ï¼Œ  
   å¦åˆ™æ®µé”™è¯¯ä¼šç»ˆæ­¢æ•´ä¸ªä¸»Rä¼šè¯
- ä¸åˆ©çš„ä¸€é¢æ˜¯ï¼Œå¯åŠ¨æ–°è¿›ç¨‹ä¼šå¸¦æ¥ç›¸å¯¹æ›´å¤šçš„è®¡ç®—å¼€é”€

```r
# è®¾ç½®å°è£…æ–¹æ³•ä¸º'callr'ä»¥åŠå›é€€å­¦ä¹ å™¨
lrn_debug$encapsulate('callr', fallback = lrn('classif.featureless'))
# å°†é”™è¯¯ç±»å‹ä¿®æ”¹ä¸ºæ®µé”™è¯¯
lrn_debug$param_set$values <- list(segfault_train = 1)
# è®­ç»ƒæ¨¡å‹å¹¶æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
lrn_debug$train(task = tsk_penguins)$errors
```

```js
ERROR [19:23:25.504] [mlr3] train: reached elapsed time limit
INFO  [19:23:25.509] [mlr3] Learner 'classif.debug' on task 'penguins' failed to train a model {learner: <LearnerClassifDebug/LearnerClassif/Learner/R6>, messages: `reached elapsed time limit`}
INFO  [19:23:25.513] [mlr3] Calling train method of fallback 'classif.featureless' on task 'penguins' with 344 observations {learner: <LearnerClassifFeatureless/LearnerClassif/Learner/R6>}
'reached elapsed time limit'
```

- é™¤äº†æ•è·é”™è¯¯ï¼Œè¿˜å¯ä»¥è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰
  - è¿™æ ·å­¦ä¹ å™¨å°±ä¸ä¼šæ— é™æœŸè¿è¡Œï¼ˆä¾‹å¦‚ï¼Œç”±äºæ— æ³•æ”¶æ•›ï¼‰ï¼Œ  
   è€Œæ˜¯åœ¨æŒ‡å®šæ—¶é—´åç»ˆæ­¢
- åœ¨ä½¿ç”¨Â `callr`Â å°è£…æ—¶ï¼Œè¿™ç§æ–¹æ³•æœ€ä¸ºå¯é 
  - å› ä¸ºå¦‚æœå­¦ä¹ å™¨é™·å…¥å¤–éƒ¨ç¼–è¯‘ä»£ç ä¸­ï¼Œ  
   `evaluate`Â æ–¹æ³•æœ‰æ—¶æ— æ³•ä¸­æ–­å­¦ä¹ å™¨
  - å¦‚æœå­¦ä¹ å™¨è¢«ä¸­æ–­ï¼Œé‚£ä¹ˆå°è£…è¿‡ç¨‹ä¼šå°†å…¶è®°å½•ä¸ºé”™è¯¯
  - åŒæ ·ï¼Œè¶…æ—¶æ—¶é—´å¯ä»¥é’ˆå¯¹è®­ç»ƒå’Œé¢„æµ‹åˆ†åˆ«è®¾ç½®ï¼š

```r
lrn_debug$timeout <- c(train = 1e-5, predict = Inf)
lrn_debug$train(task = tsk_penguins)$errors
```

```r
WARN  [19:19:47.270] [mlr3] train: Warning from classif.debug->train()
ERROR [19:19:47.281] [mlr3] train: Error from classif.debug->train()
INFO  [19:19:47.289] [mlr3] Learner 'classif.debug' on task 'penguins' failed to train a model {learner: <LearnerClassifDebug/LearnerClassif/Learner/R6>, messages: (Warning from classif.debug->train(), Error from classif.debug->train())}
INFO  [19:19:47.295] [mlr3] Calling train method of fallback 'classif.featureless' on task 'penguins' with 344 observations {learner: <LearnerClassifFeatureless/LearnerClassif/Learner/R6>}
'Error from classif.debug->train()'
```

- å¦‚æœåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆå°†æ²¡æœ‰è®­ç»ƒå¥½çš„æ¨¡å‹å¯ä¾›æŸ¥è¯¢
- æˆ–è€…å¦‚æœåœ¨é¢„æµ‹è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆå°†æ²¡æœ‰é¢„æµ‹ç»“æœå¯ä¾›åˆ†æ

```r
# è¿™é‡Œæ¨¡æ‹Ÿè®­ç»ƒè¿‡ç¨‹ä¸­å‡ºé”™æ—¶ï¼Œæ²¡æœ‰æ¨¡å‹è¢«å‚¨å­˜çš„æƒ…å†µ
lrn('classif.debug', error_train = 1)$train(tsk_penguins)$model
```

```js
Error in get_private(learner)$.train(task): Error from classif.debug->train()
```

-

```r
# è¿™é‡Œæ¨¡æ‹Ÿé¢„æµ‹è¿‡ç¨‹ä¸­å‡ºé”™æ—¶ï¼Œæœ‰æ¨¡å‹è¢«å‚¨å­˜çš„æƒ…å†µ
lrn_debug <- lrn('classif.debug', error_predict = 1)$train(tsk_penguins)
lrn_debug$model

# ä½†é¢„æµ‹æ˜¯ä¸èƒ½å®Œæˆçš„
lrn_debug$predict(tsk_penguins)
```

```js
$response
[1] 'Adelie'

$pid
[1] 5913

$id
[1] '4461f9b7-8390-4e69-a17f-7db817b5b336'

$random_number
[1] 2403

$iter
[1] 1

attr(,'class')
[1] 'classif.debug_model'


Error in get_private(learner)$.predict(task): Error from classif.debug->predict()
```

### å›é€€å­¦ä¹ å™¨ï¼ˆFallback Learnersï¼‰

- å‡è®¾åœ¨é‡é‡‡æ ·è¿‡ç¨‹ä¸­ï¼Œ  
  æ¨¡å‹è®­ç»ƒçš„ä¸€æ¬¡æˆ–å¤šæ¬¡è¿­ä»£ä¸­å‡ºç°äº†é”™è¯¯ï¼Œ  
  æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥ç»§ç»­å®éªŒï¼š
  - å¿½ç•¥å‡ºç°å¤±è´¥çš„è¿­ä»£
    - è¿™å¯èƒ½æ˜¯å®è·µä¸­æœ€å¸¸ç”¨çš„æ–¹æ³•ï¼Œä½†ä»ç»Ÿè®¡å­¦è§’åº¦æ¥çœ‹å¹¶ä¸åˆç†
    - å‡è®¾åœ¨è¯•å›¾è¯„ä¼°ä¸€ä¸ªæ¨¡å‹çš„æ€§èƒ½æ—¶ï¼Œ  
    åœ¨æŸäº›é‡é‡‡æ ·åˆ’åˆ†ä¸­ï¼Œ  
    å¦‚æœé¢„æµ‹æ—¶å‡ºç°è®­ç»ƒæœŸé—´æœªè§è¿‡çš„å› å­æ°´å¹³ï¼Œ  
    è¯¥æ¨¡å‹å¯èƒ½ä¼šå‡ºé”™ï¼Œ  
    ä»è€Œå¯¼è‡´æ¨¡å‹æ— æ³•å¤„ç†è¿™äº›æƒ…å†µå¹¶æŠ¥é”™ï¼›  
    å¦‚æœä¸¢å¼ƒå¤±è´¥çš„è¿­ä»£ï¼Œå°½ç®¡æ¨¡å‹æ— æ³•å¯¹ä¸€æ•´ç±»ç‰¹å¾è¿›è¡Œé¢„æµ‹ï¼Œ  
    ä½†å®ƒçœ‹èµ·æ¥ä»ä¼šè¡¨ç°è‰¯å¥½
  - æƒ©ç½šå¤±è´¥çš„å­¦ä¹ å™¨
    - ä¸å¿½ç•¥å¤±è´¥çš„è¿­ä»£ï¼Œ  
    è€Œæ˜¯ä¼°ç®—å‡ºæœ€å·®çš„åˆ†æ•°ï¼ˆç”±ç»™å®šçš„`Measure`å®šä¹‰ï¼‰ï¼Œ  
    ä»è€Œå¯¹å¤±è´¥çš„å­¦ä¹ å™¨è¿›è¡Œä¸¥å‰æƒ©ç½š
    - ç„¶è€Œï¼Œå¯¹äºè®¸å¤šé—®é¢˜æ¥è¯´è¿‡äºè‹›åˆ»
    - è€Œä¸”å¯¹äºæŸäº›åº¦é‡ï¼Œæ²¡æœ‰åˆç†çš„æ•°å€¼å¯ä¾›ä¼°ç®—
  - ä½¿ç”¨å›é€€å­¦ä¹ å™¨è¿›è¡Œè®­ç»ƒå’Œé¢„æµ‹
    - è®­ç»ƒä¸€ä¸ªåŸºçº¿å­¦ä¹ å™¨ï¼Œå¹¶æ ¹æ®è¯¥æ¨¡å‹è¿›è¡Œé¢„æµ‹ï¼Œ  
    è€Œä¸æ˜¯ç”¨æœ€å·®çš„åˆ†æ•°è¿›è¡Œæ’è¡¥
- æ¨èä½¿ç”¨`lrn('classif.featureless')`æˆ–  
  `lrn('classif.featureless')`ä½œä¸ºå›é€€å­¦ä¹ å™¨

```r
# è®¾ç½®æ¨¡æ‹Ÿdebugå­¦ä¹ å™¨ä¸ºè®­ç»ƒæœŸé—´å‘ç”Ÿé”™è¯¯
lrn_debug <- lrn('classif.debug', error_train = 1)
# ä½¿ç”¨'evaluate'æ–¹æ³•å¹¶è®¾ç½®æ— ç‰¹å¾åˆ†ç±»å­¦ä¹ å™¨
lrn_debug$encapsulate('evaluate', fallback = lrn('classif.featureless'))
# è®­ç»ƒ`Task`
lrn_debug$train(tsk_penguins)
```

```js
ERROR [20:27:27.572] [mlr3] train: Error from classif.debug->train()
INFO  [20:27:27.576] [mlr3] Learner 'classif.debug' on task 'penguins' failed to train a model {learner: <LearnerClassifDebug/LearnerClassif/Learner/R6>, messages: `Error from classif.debug->train()`}
INFO  [20:27:27.579] [mlr3] Calling train method of fallback 'classif.featureless' on task 'penguins' with 344 observations {learner: <LearnerClassifFeatureless/LearnerClassif/Learner/R6>}
```

- æŸ¥çœ‹è®­ç»ƒç»“æœ
  - ç”±äºè®­ç»ƒå‘ç”Ÿäº†é”™è¯¯ï¼Œå› æ­¤æ²¡æœ‰ä»»ä½•æ¨¡å‹è¢«å‚¨å­˜

```r
lrn_debug
lrn_debug$log
lrn_debug$model
```

```js
[36m--[39m [1m[34m<LearnerClassifDebug>[39m (classif.debug): Debug Learner for Classification[22m [36m-----[39m
* Model: -
* Parameters: error_train=1
* Validate: [34m<NULL>[39m
* Packages: [34mmlr3[39m
* Predict Types: [response] and prob
* Feature Types: logical, integer, numeric, character, factor, and ordered
* Encapsulation: evaluate (fallback: LearnerClassifFeatureless)
* Properties: hotstart_forward, internal_tuning, marshal, missings, multiclass,
twoclass, validation, and weights
* Other settings: use_weights = 'use'
[31mx[39m Errors: Error from classif.debug->train()
```

<table class='dataframe'>
<caption>A data.table: 1 x 3</caption>
<thead>
 <tr><th scope=col>stage</th><th scope=col>class</th><th scope=col>msg</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;ord&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
 <tr><td>train</td><td>error</td><td>Error from classif.debug-&gt;train()</td></tr>
</tbody>
</table>

```js
NULL
```

- æ²¡æœ‰æ¨¡å‹å‚¨å­˜çš„è¯ï¼Œç†åº”æ˜¯æ— æ³•é¢„æµ‹æ‰å¯¹
- ä½†æ˜¯é€šè¿‡è®¾ç½®äº†å›é€€å­¦ä¹ å™¨ï¼Œé¢„æµ‹ä¾ç„¶å¯ä»¥é€šè¿‡`lrn('classif.featureless')æ‰§è¡Œ

```r
prediction <- lrn_debug$predict(tsk_penguins)
prediction$score()
```

```js
classif.ce: 0.558139534883721
```

- è¿™æ¬¡å°†é”™è¯¯å‘ç”Ÿå‡ ç‡é™ä½åˆ°0.5

```r
# è®¾ç½®æ¨¡æ‹Ÿdebugå­¦ä¹ å™¨ï¼Œé”™è¯¯å‡ ç‡0.5
lrn_debug <- lrn('classif.debug', error_train = 0.5)
# ç”¨`evaluate`æ–¹æ³•å°è£…ä¿¡æ¯ï¼Œå¹¶è®¾ç½®å›é€€å­¦ä¹ å™¨
lrn_debug$encapsulate('evaluate', fallback = lrn('classif.featureless'))

# benchmarkæ¯”è¾ƒä¸¤ç§æ–¹æ³•
aggr <- benchmark(
 benchmark_grid(
  tsk_penguins,
  list(lrn_debug, lrn('classif.rpart')),
  rsmp('cv', folds = 20)
 )
)$aggregate(conditions = TRUE)

# æŸ¥çœ‹æ•´åˆç»“æœ
aggr[, .(learner_id, warnings, errors, classif.ce)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 2 x 4</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>warnings</th><th scope=col>errors</th><th scope=col>classif.ce</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>classif.debug</td><td>0</td><td>13</td><td>0.55866013</td></tr>
 <tr><td>classif.rpart</td><td>0</td><td> 0</td><td>0.05228758</td></tr>
</tbody>
</table>

- å¦‚æœåªæ˜¯æŸ¥çœ‹æŸä¸€ä¸ªå­¦ä¹ å™¨çš„è¿­ä»£ä¸­å‘ç”Ÿé”™è¯¯çš„ç»“æœï¼Œ  
  å¯ä»¥è¿›è¡Œå¦‚ä¸‹æ“ä½œ

```r
rr <- aggr[learner_id == 'classif.debug']$resample_result[[1L]]
# åªçœ‹
rr$errors
```

<table class='dataframe'>
<caption>A data.table: 13 x 2</caption>
<thead>
 <tr><th scope=col>iteration</th><th scope=col>msg</th></tr>
 <tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
 <tr><td> 1</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td> 2</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td> 3</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td> 5</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td> 7</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td> 8</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td>10</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td>13</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td>14</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td>16</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td>18</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td>19</td><td>Error from classif.debug-&gt;train()</td></tr>
 <tr><td>20</td><td>Error from classif.debug-&gt;train()</td></tr>
</tbody>
</table>

## æ—¥å¿—è®°å½•ï¼ˆLoggingï¼‰

- `mlr3`ä¸­ä½¿ç”¨`lgr`åŒ…æ§åˆ¶è¾“å‡ºçš„è¯¦ç»†ç¨‹åº¦
  - `â€œwarnâ€`ï¼šä»…è®°å½•ä¸ä¼šä¸­æ–­ç¨‹åºçš„è­¦å‘Š
  - `â€œinfoâ€`ï¼šè®°å½•æ¨¡å‹è¿è¡Œæ—¶é—´ç­‰ä¿¡æ¯ä»¥åŠè­¦å‘Šä¿¡æ¯
  - `â€œdebugâ€`ï¼šç”¨äºè°ƒè¯•çš„è¯¦ç»†æ¶ˆæ¯ï¼Œä»¥åŠä¿¡æ¯å’Œè­¦å‘Š
- `mlr3`ä¸­é»˜è®¤logçº§åˆ«ä¸ºÂ `"info"`ï¼Œ  
  è¿™æ„å‘³ç€ä»…æ˜¾ç¤ºæä¾›ä¿¡æ¯æˆ–æ›´ä¸¥é‡çº§åˆ«çš„æ¶ˆæ¯ï¼Œ  
  å³Â `"info"`Â å’ŒÂ `"warn"`

```r
lgr::get_logger('mlr3')$set_threshold('debug')
lgr::get_logger('mlr3')$set_threshold('warn')
lgr::get_logger('mlr3')$set_threshold('info')
```

- ä¹Ÿå¯ä»¥é’ˆå¯¹ç‰¹å®šRåŒ…è¿›è¡Œè®¾ç½®

```r
lgr::get_logger('bbotk')$set_threshold('info')
```

- å°†logè¾“å‡ºåˆ°å…¶ä»–æ ¼å¼æ–‡ä»¶ä¸­
  - ä»¥ä¸‹ä»¥JSONæ–‡ä»¶ä¸ºä¾‹

```r
# ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ä¸´æ—¶æ–‡ä»¶è·¯å¾„
# å‰ç¼€ä¸º"mlr3log_"ï¼Œæ‰©å±•åå›ºå®šä¸ºâ€œ.jsonâ€
tf <- tempfile('mlr3log_', fileext = '.json')

# è·å– mlr3 çš„log
logger <- lgr::get_logger('mlr3')

# æ·»åŠ JSONæ ¼å¼çš„logè¾“å‡ºå™¨
logger$add_appender(lgr::AppenderJson$new(tf), name = 'json')

# è§¦å‘è­¦å‘Šlog
logger$warn('this is a warning from mlr3')
```

```js
WARN  [22:44:09.578] this is a warning from mlr3
```

```r
# è¯»å–æ—¥å¿—æ–‡ä»¶å†…å®¹
x <- readLines(tf)
# æ‰“å°
cat(paste0(substr(x, 1, 71), '\n', substr(x, 72, nchar(x))))
```

```js
{"level":300,"timestamp":"2025-07-08 22:44:09","logger":"mlr3","caller"
:"eval","msg":"this is a warning from mlr3"}
```

```r
# ç§»é™¤appenderé¿å…åç»­ç»§ç»­å†™å…¥
logger$remove_appender('json')
```

- **æ³¨æ„ï¼š**
  - åœ¨ä½¿ç”¨å¹¶è¡ŒåŒ–å’Œ/æˆ–å°è£…æ—¶ï¼Œ  
   æ—¥å¿—å¯èƒ½ä¼šå»¶è¿Ÿã€é¡ºåºé”™ä¹±ï¼Œ  
   æˆ–è€…åœ¨å‡ºç°æŸäº›é”™è¯¯æ—¶æ ¹æœ¬ä¸å­˜åœ¨
- å½“éœ€è¦ç«‹å³è®¿é—®æ—¥å¿—æ¶ˆæ¯æ—¶ï¼Œä¾‹å¦‚åœ¨è°ƒè¯•æ—¶ï¼Œå¯ä»¥é€‰æ‹©ç¦ç”¨Â `future`Â å’Œå°è£…
- è¦å¯ç”¨ è°ƒè¯•æ¨¡å¼ï¼Œè®¾ç½®Â `options(mlr3.debug = TRUE)`Â å¹¶ç¡®ä¿å­¦ä¹ å™¨çš„Â `Learner$encapsulate`Â æ’æ§½è®¾ç½®ä¸ºÂ `"none"`ï¼ˆé»˜è®¤å€¼ï¼‰æˆ–Â `"evaluate"`
- è°ƒè¯•æ¨¡å¼åº”**ä»…åœ¨è°ƒè¯•æœŸé—´å¯ç”¨**ï¼Œè€Œä¸åº”åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œ  
  å› ä¸ºå®ƒä¼šç¦ç”¨å¹¶è¡ŒåŒ–å¹¶å¯¼è‡´æ„å¤–çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼ˆRNGï¼‰è¡Œä¸ºï¼Œ  
  ä»è€Œæ— æ³•å®ç°å¯é‡å¤æ€§

## >-------------

## æ•°æ®åç«¯ï¼ˆData Backendsï¼‰

### ç®€ä»‹

- `Task`å¯¹è±¡å°†å…¶æ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªæŠ½è±¡æ•°æ®å¯¹è±¡ï¼Œå³ `DataBackend` ä¸­
- æ•°æ®åç«¯æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„APIï¼Œç”¨äºæ£€ç´¢æ•°æ®å­é›†æˆ–æŸ¥è¯¢æœ‰å…³æ•°æ®çš„ä¿¡æ¯
  - æ— è®ºæ•°æ®åœ¨ç³»ç»Ÿä¸­æ˜¯å¦‚ä½•å­˜å‚¨çš„
  - é»˜è®¤åç«¯é€šè¿‡ `DataBackendDataTable` ç±»ä½¿ç”¨ `data.table`ï¼Œ  
   ä½œä¸ºä¸€ä¸ªéå¸¸å¿«é€Ÿé«˜æ•ˆçš„å†…å­˜æ•°æ®åº“
- è™½ç„¶å°†ä»»åŠ¡æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­å¯¹äºæ¨¡å‹æ‹Ÿåˆæ—¶è®¿é—®æ•°æ®æ¥è¯´æ•ˆç‡æœ€é«˜ï¼Œ  
  ä½†å­˜åœ¨ä¸¤ä¸ªä¸»è¦ç¼ºç‚¹ï¼š
  - å³ä½¿åªéœ€è¦ä¸€å°éƒ¨åˆ†æ•°æ®ï¼Œä¾‹å¦‚åœ¨è¿›è¡Œå­é‡‡æ ·æ—¶ï¼Œå®Œæ•´çš„æ•°æ®é›†ä¹Ÿä¼šå ç”¨å†…å­˜  
  - åŒæ—¶å¤„ç†å¤§å‹ä»»åŠ¡æˆ–å¤šä¸ªä»»åŠ¡ï¼Œä¾‹å¦‚è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œè¿™å°±ä¼šæˆä¸ºä¸€ä¸ªç‰¹åˆ«ä¸¥é‡çš„é—®é¢˜
  - åœ¨å¹¶è¡ŒåŒ–è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å°†å®Œæ•´çš„æ•°æ®ä¼ è¾“ç»™å·¥ä½œèŠ‚ç‚¹ï¼Œè¿™å¯èƒ½ä¼šå¢åŠ å¼€é”€
- å¤„ç†çš„æ–¹æ³•æœ‰ï¼š
  - `DataBackendDplyr`ï¼š  
   ä¸ºRåŒ…`dbplyr`æä¾›æ¥å£ï¼Œæ‰©å±•äº†`dplyr`ï¼Œ  
   ä½¿å…¶èƒ½å¤Ÿåœ¨è®¸å¤šæµè¡Œçš„SQLæ•°æ®åº“ï¼ˆå¦‚MariaDBã€PostgresSQLæˆ–SQLiteï¼‰ä¸Šè¿è¡Œ
  - `DataBackendDuckDB`ï¼š  
   ç”¨äºé€šè¿‡ `duckdb` è¿æ¥çš„ DuckDB æ•°æ®åº“ï¼Œ  
   å®ƒæ˜¯ SQLite çš„ä¸€ç§å¿«é€Ÿã€é›¶é…ç½®æ›¿ä»£æ–¹æ¡ˆã€‚
  - `DataBackendDuckDB`ï¼š  
   ç”¨äºParquetæ–‡ä»¶ï¼Œ  
   è¿™æ„å‘³ç€æ•°æ®æ— éœ€è½¬æ¢ä¸º`DuckDB`çš„åŸç”Ÿå­˜å‚¨æ ¼å¼ï¼Œ  
   è€Œæ˜¯å¯ä»¥ç›´æ¥å¤„ç†åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä»¥æµè¡Œçš„`Parquet`æ ¼å¼å­˜å‚¨çš„æ–‡ä»¶çš„ç›®å½•
- **ç”±äºä¸æ˜¯é‡ç‚¹ï¼Œæœ¬ç« ç•¥**

### ä½¿ç”¨`DataBackendDplyr`çš„æ•°æ®åº“

```r
# load data
requireNamespace('DBI')
requireNamespace('RSQLite')
requireNamespace('nycflights13')
data('flights', package = 'nycflights13')
dim(flights)
```

```r
# add column of unique row ids
flights$row_id = seq(nrow(flights))

# create sqlite database in temporary file
path = tempfile('flights', fileext = '.sqlite')
con = DBI::dbConnect(RSQLite::SQLite(), path)
tbl = DBI::dbWriteTable(con, 'flights', as.data.frame(flights))
DBI::dbDisconnect(con)

# remove in-memory data
rm(flights)
```

```r
# establish connection
con = DBI::dbConnect(RSQLite::SQLite(), path)

# select the 'flights' table
library(dplyr)
library(dbplyr)
tbl = tbl(con, 'flights')
```

```r
# 1. subset columns
keep = c('row_id', 'year', 'month', 'day', 'hour', 'minute', 'dep_time',
  'arr_time', 'carrier', 'flight', 'air_time', 'distance', 'arr_delay')
tbl = select(tbl, all_of(keep))

# 2. filter by missing
tbl = filter(tbl, !is.na(arr_delay))

# 3. select every other row
tbl = filter(tbl, row_id %% 2 == 0)

# 4. merge infrequent carriers
infrequent = c('OO', 'HA', 'YV', 'F9', 'AS', 'FL', 'VX', 'WN')
tbl = mutate(tbl, carrier = case_when(
  carrier %in% infrequent ~ 'other',
  TRUE ~ carrier))
```

```r
library(mlr3db)
backend_flights = as_data_backend(tbl, primary_key = 'row_id')
c(nrow = backend_flights$nrow, ncol = backend_flights$ncol)
```

```r
backend_flights$head()
```

```r
tsk_flights = as_task_regr(backend_flights, id = 'flights_sqlite',
  target = 'arr_delay')
rsmp_sub002 = rsmp('subsampling', ratio = 0.02, repeats = 3)
```

```r
rr = resample(tsk_flights, lrn('regr.rpart'), rsmp_sub002)
```

```r
measures = msrs(c('regr.rmse', 'time_train', 'time_predict'))
rr$aggregate(measures)
```

```r
measures = msrs(c('regr.rmse', 'time_train', 'time_predict'))
rr$aggregate(measures)
```

```r
rm(tbl)
DBI::dbDisconnect(con)
```

### ä½¿ç”¨`DataBackendDuckDB`çš„`Parquet`æ–‡ä»¶

```r
path = system.file(file.path('extdata', 'spam.parquet'),
  package = 'mlr3db')
backend = as_duckdb_backend(path)
as_task_classif(backend, target = 'type')
```

### æ‰©å±•`mlr3`å¹¶å®šä¹‰æ–°çš„`Measure`

- è¿‡ç¨‹
  - æ‰¾åˆ°è¦ç»§æ‰¿çš„æ­£ç¡®ç±»
  - ä½¿ç”¨æ­£ç¡®çš„å±æ€§åˆå§‹åŒ–å¯¹è±¡ï¼ˆ`$initialize()`ï¼‰
  - å®ç°æ‰§è¡Œå®é™…è®¡ç®—çš„å…¬å…±å’Œç§æœ‰æ–¹æ³•
    - ä¸‹ä¾‹ä¸­ä¸ºç§æœ‰æ–¹æ³•Â `$.score()`
- ä¸‹é¢å®šä¹‰ä¸€ä¸ªè¯„ä¼°å™¨
  - è‹¥çœŸå®å€¼ä¸é¢„æµ‹å€¼ä¹‹é—´çš„å·®å¼‚å°äºçœŸå®å€¼çš„ä¸€ä¸ªæ ‡å‡†å·®ï¼Œ  
   åˆ™å°†é¢„æµ‹è¯„åˆ†ä¸ºÂ `1`ï¼Œå¦åˆ™å°†é¢„æµ‹è¯„åˆ†ä¸ºÂ `0`
  - $f(y, \hat{y}) = \frac{1}{n} \sum_{i=1}^n \mathbb{I}(|y_i - \hat{y}_i| < \sigma_y)$
    - $\sigma_y$ï¼šçœŸå®å€¼çš„æ ‡å‡†å·®
    - $\mathbb{I}$ï¼šæŒ‡ç¤ºå‡½æ•°
- å¯ä»¥ç”¨ä¸‹é¢å‡½æ•°è¡¨ç¤º

```r
# è‡ªå®šä¹‰çš„å‡½æ•°
threshold_acc <- function(truth, response) {
 mean(ifelse(abs(truth - response) < sd(truth), 1, 0))
}

# ç”¨éšæ„çš„ä¸¤ç»„æ•°æ®æµ‹è¯•ä¸€ä¸‹
threshold_acc(c(100, 0, 1), c(1, 11, 6))
```

```js
0.666666666666667
```

- å¦‚æœè¦åœ¨`mlr3`ä¸­ä½¿ç”¨çš„è¯ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„`R6Class`ï¼Œå¹¶ä¸”ç»§æ‰¿äº`Measure`
  - ç”±äºä¸Šé¢ä¾‹å­é€‚ç”¨äºå›å½’ä»»åŠ¡ï¼Œæ‰€ä»¥ç»§æ‰¿äº`MeasureRegr`
  - åœ¨å¤´ä¸¤è¡Œå‘½åäº†ç±» `MeasureRegrThresholdAcc`ï¼Œ  
   ç„¶åå£°æ˜è¿™æ˜¯ä¸€ä¸ªå›å½’åº¦é‡ï¼Œå®ƒç»§æ‰¿è‡ª `MeasureRegr`
  - é€šè¿‡å£°æ˜å…¶å”¯ä¸€IDä¸º`"thresh_acc"`ï¼Œ  
   ä¸éœ€è¦ä»»ä½•å¤–éƒ¨åŒ…ï¼ˆ`packages = character()`ï¼‰ï¼Œ  
   ä»¥åŠæ²¡æœ‰ç‰¹æ®Šå±æ€§ï¼ˆ`properties = character()`ï¼‰  
   æ¥åˆå§‹åŒ–è¯¥ç±»
  - ä¼ é€’æŸå¤±å‡½æ•°çš„å…·ä½“ç»†èŠ‚ï¼Œå³ï¼š  
   å®ƒè¡¡é‡â€œå“åº”â€ç±»å‹é¢„æµ‹çš„è´¨é‡ï¼Œå…¶å€¼ä»‹äº(0, 1)ä¹‹é—´ï¼Œ  
   å¹¶ä¸”è¯¥æŸå¤±å‡½æ•°ä»¥å…¶æœ€å¤§å€¼ä¸ºä¼˜åŒ–ç›®æ ‡ï¼ˆ`minimize = FALSE`ï¼‰
  - å°†åˆ†æ•°æœ¬èº«å®šä¹‰ä¸ºä¸€ä¸ªåä¸ºÂ `.score`Â çš„ç§æœ‰æ–¹æ³•ï¼Œ  
   åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå°†é¢„æµ‹ç»“æœä¼ é€’ç»™åˆšåˆšå®šä¹‰çš„æŸå¤±å‡½æ•°

```r
MeasureRegrThresholdAcc <- R6::R6Class('MeasureRegrThresholdAcc',
 # ç»§æ‰¿`MeasureRegr`
 inherit = mlr3::MeasureRegr, 
 # å…¬å…±æ–¹æ³•
 public = list(
  initialize = function() { # initialize class
  super$initialize(
   # å®šä¹‰é»˜è®¤ç”¨äºè¯†åˆ«çš„ID
   id = 'thresh_acc', 
   # ä¾èµ–åŒ…ï¼šæ— 
   packages = character(), 
   # å±æ€§ï¼šæ— 
   properties = character(),
   # é¢„æµ‹çš„ç§ç±»ï¼šå“åº”å€¼'response'
   predict_type = 'response', 
   # èŒƒå›´ï¼š0â€“1
   range = c(0, 1), 
   # è¶Šå¤§è¶Šå¥½ï¼Œæ— éœ€æœ€å°åŒ–
   minimize = FALSE 
  )
 }
),
 # ç§æœ‰æ–¹æ³•
 private = list(
  # å®šä¹‰è¯„ä¼°æ–¹æ³•
  .score = function(prediction, ...) {
   # å†…å®¹å°±æ˜¯ä¸Šè¿°çš„å‡½æ•°
   threshold_acc = function(truth, response) {
    mean(ifelse(abs(truth - response) < sd(truth), 1, 0))
    }
   # è®¾ç½®è¿”å›å€¼
   return(threshold_acc(prediction$truth, prediction$response))
  }
 )
)
```

- å°†ä¸Šé¢å®šä¹‰çš„`Measure`å®æ“

```r
tsk_mtcars <- tsk('mtcars')
split <- partition(tsk_mtcars)
lrn_featureless <- lrn('regr.featureless')$train(tsk_mtcars, split$train)
prediction <- lrn_featureless$predict(tsk_mtcars, split$test)
prediction$score(MeasureRegrThresholdAcc$new())
```

```js
thresh_acc: 0.727272727272727
```

```r
# ä¹Ÿå¯ä»¥ç›´æ¥æŠŠæ”¾åˆ°`mlr_measures`é€šè¿‡å‘½å`id`ç›´æ¥è°ƒç”¨
mlr3::mlr_measures$add('regr.thresh_acc', MeasureRegrThresholdAcc)
prediction$score(msr('regr.thresh_acc'))
```

## æ‰©å±•`mlr3`å¹¶å®šä¹‰æ–°çš„`Learner`

- [Creating a new Learner](https://mlr3extralearners.mlr-org.com/articles/extending.html)

```r
# åŠ è½½RåŒ…
# library(mlr3)
# library(paradox)
# library(R6)
# library(mlr3misc)

LearnerRegrRpartSimple <- R6Class("LearnerRegrRpartSimple",
  inherit = LearnerRegr,
  public = list(
    initialize = function() {
      param_set = ps(
        cp             = p_dbl(0, 1, default = 0.01, tags = "train"),
        maxcompete     = p_int(0L, default = 4L, tags = "train"),
        maxdepth       = p_int(1L, 30L, default = 30L, tags = "train"),
        maxsurrogate   = p_int(0L, default = 5L, tags = "train"),
        minbucket      = p_int(1L, tags = "train"),
        minsplit       = p_int(1L, default = 20L, tags = "train"),
        surrogatestyle = p_int(0L, 1L, default = 0L, tags = "train"),
        usesurrogate   = p_int(0L, 2L, default = 2L, tags = "train"),
        xval           = p_int(0L, default = 10L, tags = "train")
      )
      param_set$set_values(xval = 10L)
      super$initialize(
        id = "regr.rpart_simple",
        feature_types = c("logical", "integer", "numeric", "factor", "ordered"),
        predict_types = "response",
        packages = "rpart",
        param_set = param_set,
        properties = c("weights", "missings", "importance"),
        label = "Regression Tree",
        man = "mlr3::mlr_learners_regr.rpart"
      )
    },
    importance = function() {
      if (is.null(self$model)) {
        stopf("No model stored")
      }
      # importance is only present if there is at least on split
      if (is.null(self$model$variable.importance)) {
        set_names(numeric())
      } else {
        sort(self$model$variable.importance, decreasing = TRUE)
      }
    }
  ),
  private = list(
    .train = function(task) {
      pv = self$param_set$get_values(tags = "train")
      pv$weights = private$.get_weights(task)
      
      invoke(
        rpart::rpart,
        formula = task$formula(),
        data = task$data(),
        .args = pv
      )
    },
    .predict = function(task) {
      pv = self$param_set$get_values(tags = "predict")

      # ensure same column order in train and predict
      newdata = mlr3extralearners:::ordered_features(task, self)
      response = invoke(predict, self$model, newdata = newdata, .args = pv)
      list(response = unname(response))
    }
  )
)
```

## `openML`ï¼šç”¨äºå¤§è§„æ¨¡benchmarking

### ç®€ä»‹

- å¤§è§„æ¨¡ï¼ˆlarge-scaleï¼‰
  - æ„å‘³ç€å®ƒä»¬å¯èƒ½ä¼šä½¿ç”¨è®¸å¤šæ•°æ®é›†ã€åº¦é‡æ ‡å‡†å’Œå­¦ä¹ å™¨
  - æ•°æ®é›†å¿…é¡»æ¶µç›–å¹¿æ³›çš„é¢†åŸŸå’Œé—®é¢˜ç±»å‹ï¼Œ  
   å› ä¸ºåªèƒ½é’ˆå¯¹åŸºå‡†ç ”ç©¶ä¸­æ‰€ä½¿ç”¨çš„æ•°æ®é›†ç±»å‹å¾—å‡ºç»“è®º
- `mlr3oml`
  - ä¸º`mlr3`å’ŒOpenMLæä¾›ä¸€ä¸ªå€Ÿå£
    - OpenMLï¼šç”¨äºä¸Šä¼ å’Œä¸‹è½½æ•°æ®é›†çš„å¸¸ç”¨å·¥å…·
- `mlr3batchmark`
  - å°†`mlr3`å’Œ`batchtools`è¿æ¥èµ·æ¥
    - `batchtools`ï¼šæä¾›äº†é«˜æ€§èƒ½è®¡ç®—ç¾¤é›†ä¸Šç®¡ç†å’Œæ‰§è¡Œå®éªŒçš„æ–¹æ³•

- é¦–å…ˆå…ˆè¿›è¡Œç®€å•çš„benchmarkæ¯”è¾ƒ
  - é™¤äº†`german_credit`æ•°æ®é›†ï¼Œ  
   å…¶ä»–ä¸¤ä¸ªæ•°æ®é›†ä¸Šéšæœºæ£®æ—çš„è¡¨ç°æ›´ä¼˜

```r
# ----------æ„å»ºå­¦ä¹ å™¨
# æ— ç‰¹å¾å€¼åŸºçº¿å­¦ä¹ å™¨
lrn_baseline <- lrn("classif.featureless", id = "featureless")

# æ„å»ºé€»è¾‘å›å½’å­¦ä¹ å™¨
lrn_lr <- lrn("classif.log_reg")
# æ„å»ºç”¨äºé€»è¾‘å›å½’çš„`GraphLearner`
# ppl("robustify", learner = lrn_lr)è¡¨ç¤ºç”¨äºé€»è¾‘å›å½’çš„ç®¡é“
lrn_lr <- as_learner(ppl("robustify", learner = lrn_lr) %>>% lrn_lr)
# è¯†åˆ«id
lrn_lr$id <- "logreg"
# å°è£…åŠå›é€€å­¦ä¹ å™¨
lrn_lr$encapsulate("try", fallback = lrn_baseline)

# æ„å»ºéšæœºæ£®æ—å­¦ä¹ å™¨
lrn_rf <- lrn("classif.ranger")
# æ„å»ºç”¨äºéšæœºæ£®æ—çš„`GraphLearner`
lrn_rf <- as_learner(ppl("robustify", learner = lrn_rf) %>>% lrn_rf)
# è¯†åˆ«id
lrn_rf$id <- "ranger"
# å°è£…åŠå›é€€å­¦ä¹ å™¨
lrn_rf$encapsulate("try", fallback = lrn_baseline)

# æ”¾åˆ°ä¸€ä¸ª`list`é‡Œ
learners <- list(lrn_lr, lrn_rf, lrn_baseline)

# ----------benchmarkæ¯”è¾ƒ
# benchmarkæ¯”è¾ƒçš„å®éªŒè®¾è®¡
design <- benchmark_grid(
 tsks(c("german_credit", "sonar", "pima")),
 learners, 
 rsmp("cv", folds = 10)
)
# æ‰§è¡Œbenchmarkæ¯”è¾ƒ
bmr <- benchmark(design)
# æŸ¥çœ‹ç»“æœ
bmr$aggregate(msr("classif.acc"))[, .(task_id, learner_id, classif.acc)]
```

<table class="dataframe">
<caption>A bmr_aggregate: 9 x 3</caption>
<thead>
 <tr><th scope=col>task_id</th><th scope=col>learner_id</th><th scope=col>classif.acc</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>german_credit</td><td>logreg     </td><td>0.7510000</td></tr>
 <tr><td>german_credit</td><td>ranger     </td><td>0.7670000</td></tr>
 <tr><td>german_credit</td><td>featureless</td><td>0.7000000</td></tr>
 <tr><td>sonar        </td><td>logreg     </td><td>0.7345238</td></tr>
 <tr><td>sonar        </td><td>ranger     </td><td>0.8076190</td></tr>
 <tr><td>sonar        </td><td>featureless</td><td>0.5333333</td></tr>
 <tr><td>pima         </td><td>logreg     </td><td>0.7708134</td></tr>
 <tr><td>pima         </td><td>ranger     </td><td>0.7708647</td></tr>
 <tr><td>pima         </td><td>featureless</td><td>0.6510253</td></tr>
</tbody>
</table>

### ä½¿ç”¨OpenMLè·å–æ•°æ®

#### æ•°æ®é›†

- å¯ä»¥é€šè¿‡ç½‘ç«™æˆ–å…¶REST APIï¼ˆ`mlr3oml`æ¥å£ï¼‰ä»OpenMLä¸­æŸ¥æ‰¾æ•°æ®
- `list_oml_data()` å¯ç”¨äºæ ¹æ®ç‰¹å®šå±æ€§ç­›é€‰æ•°æ®é›†ï¼Œ  
  ä¾‹å¦‚æ ¹æ®ç‰¹å¾æ•°é‡ã€è¡Œæ•°æˆ–åˆ†ç±»é—®é¢˜ä¸­çš„ç±»åˆ«æ•°é‡è¿›è¡Œç­›é€‰

```r
# åŠ è½½RåŒ…
# library(mlr3oml)

# ç­›é€‰æ•°æ®mm
odatasets <- list_oml_data(
 # ç‰¹å¾é‡åœ¨10â€“20é—´
 number_features = c(10, 20),
 # æ ·æœ¬æ•°é‡åœ¨45000â€“50000é—´
 number_instances = c(45000, 50000),
 # åˆ†ç±»çº§åˆ«ä¸º2ä¸ª
 number_classes = 2
)

# æ‰“å°ç­›é€‰å‡ºæ¥çš„æ•°æ®é›†
odatasets[
 NumberOfFeatures < 16,
 c(
  "data_id", 
  "name", 
  "NumberOfFeatures", 
  "NumberOfInstances"
 )
]
```

<table class="dataframe">
<caption>A data.table: 12 x 4</caption>
<thead>
 <tr><th scope=col>data_id</th><th scope=col>name</th><th scope=col>NumberOfFeatures</th><th scope=col>NumberOfInstances</th></tr>
 <tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
 <tr><td>  179</td><td>adult                                   </td><td>15</td><td>48842</td></tr>
 <tr><td> 1590</td><td>adult                                   </td><td>15</td><td>48842</td></tr>
 <tr><td>43898</td><td>adult                                   </td><td>15</td><td>48790</td></tr>
 <tr><td>45051</td><td>adult-test                              </td><td>15</td><td>48842</td></tr>
 <tr><td>45068</td><td>adult                                   </td><td>15</td><td>48842</td></tr>
 <tr><td>46468</td><td>Give-Me-Some-Credit-Sampled             </td><td>11</td><td>45000</td></tr>
 <tr><td>46518</td><td>Give-Me-Some-Credit-Sampled-Preprocessed</td><td>11</td><td>45000</td></tr>
 <tr><td>46553</td><td>Loan_Status                             </td><td>14</td><td>45000</td></tr>
 <tr><td>46554</td><td>Loan_Status                             </td><td>14</td><td>45000</td></tr>
 <tr><td>46563</td><td>Loan_Approval_Status_Classification     </td><td>14</td><td>45000</td></tr>
 <tr><td>46565</td><td>Loan_Approval_Status                    </td><td>14</td><td>45000</td></tr>
 <tr><td>46910</td><td>bank-marketing                          </td><td>14</td><td>45211</td></tr>
</tbody>
</table>

- `OMLData`å¯¹è±¡åŒ…å«æœ‰å…³æ•°æ®é›†çš„å…ƒæ•°æ®ï¼Œä¸åŒ…å«æ•°æ®æœ¬èº«
  - è¿™æ„å‘³ç€ï¼Œæ— éœ€å°†æ•´ä¸ªæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­å°±å¯ä»¥æŸ¥è¯¢æœ‰å…³æ•°æ®é›†çš„ä¿¡æ¯  
  - ä¾‹å¦‚ï¼Œæ•°æ®çš„è®¸å¯åè®®å’Œç»´åº¦
- å¦‚æœæƒ³å¤„ç†å®é™…æ•°æ®ï¼Œé‚£ä¹ˆè®¿é—®`$data` å­—æ®µå°†ä¸‹è½½æ•°æ®ï¼Œ  
  ç„¶åå°† `data.table` å­˜å‚¨åœ¨ `OMLData`
  - ç¼“å­˜ï¼š  
   åœ¨é¦–æ¬¡è°ƒç”¨ `$data` ä¹‹åï¼Œ  
   æ‰€æœ‰åç»­å¯¹ `$data` çš„è°ƒç”¨å°†è¢«é€æ˜åœ°é‡å®šå‘åˆ°å†…å­˜ä¸­çš„ data.frame
  - é€šè¿‡å°†é€‰é¡¹ `mlr3oml.cache` è®¾ç½®ä¸º `TRUE` æˆ–è®¾ç½®ä¸ºç”¨ä½œç¼“å­˜æ–‡ä»¶å¤¹çš„ç‰¹å®šè·¯å¾„ï¼Œ  
   è®¸å¤šå¯¹è±¡å¯ä»¥æ°¸ä¹…ç¼“å­˜åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Š
- æŸ¥çœ‹`id`ä¸º`1590`çš„æ•°æ®é›†

```r
# é€‰æ‹©æ•°æ®é›†
odata <- odt(id = 1590)
odata

# è®¸å¯åè®®
odata$license

# çº¬åº¦
c(nrow = odata$nrow, ncol = odata$ncol)

# ä¸‹è½½éƒ¨åˆ†åˆ‡ç‰‡
odata$data[1:5, 1:5]
```

```js
'Public'
nrow48842ncol15
INFO  [23:34:36.779] Retrieving ARFF {url: `https://api.openml.org/data/v1/download/1595261/adult.arff`, authenticated: `FALSE`}
```

<table class="dataframe">
<caption>A data.table: 5 x 5</caption>
<thead>
 <tr><th scope=col>age</th><th scope=col>workclass</th><th scope=col>fnlwgt</th><th scope=col>education</th><th scope=col>education.num</th></tr>
 <tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
 <tr><td>25</td><td>Private  </td><td>226802</td><td>11th        </td><td> 7</td></tr>
 <tr><td>38</td><td>Private  </td><td> 89814</td><td>HS-grad     </td><td> 9</td></tr>
 <tr><td>28</td><td>Local-gov</td><td>336951</td><td>Assoc-acdm  </td><td>12</td></tr>
 <tr><td>44</td><td>Private  </td><td>160323</td><td>Some-college</td><td>10</td></tr>
 <tr><td>18</td><td>NA       </td><td>103497</td><td>Some-college</td><td>10</td></tr>
</tbody>
</table>

- å¯ä»¥ä½¿ç”¨ `as_data_backend()` å‡½æ•°è½¬æ¢ä¸º `mlr3` åç«¯ï¼Œç„¶åå†è½¬æ¢ä¸ºä»»åŠ¡

```r
# è½¬æ¢åç«¯
backend <- as_data_backend(odata)
# åˆ›å»º`Task`
tsk_adult <- as_task_classif(backend, target = "class")
# æŸ¥çœ‹`Task`
tsk_adult
```

```js

[36m--[39m [1m[34m<TaskClassif>[39m (48842x15)[22m [36m----------------------------------------------------[39m
* Target: class
* Target classes: >50K (positive class, 24%), <=50K (76%)
* Properties: twoclass
* Features (14):
  * fct (8): education, marital.status, native.country, occupation, race,
  relationship, sex, workclass
  * int (6): age, capital.gain, capital.loss, education.num, fnlwgt,
  hours.per.week
```

- OpenMLä¸Šçš„ä¸€äº›æ•°æ®é›†åŒ…å«æ—¢ä¸åº”ç”¨ä½œç‰¹å¾ä¹Ÿä¸åº”ç”¨ä½œç›®æ ‡çš„åˆ—
- é€šå¸¸ä½œä¸ºç‰¹å¾åŒ…å«çš„åˆ—åå¯é€šè¿‡å­—æ®µÂ `$feature_names`Â è®¿é—®ï¼Œ  
  å¯ä»¥ç›¸åº”åœ°å°†å®ƒä»¬åˆ†é…ç»™Â `mlr3`Â ä»»åŠ¡
- è™½ç„¶å¯¹äºå½“å‰çš„æ•°æ®é›†è€Œè¨€éå¿…è¦æ“ä½œï¼Œ  
  å› ä¸ºæ‰€æœ‰éç›®æ ‡åˆ—éƒ½å°†è¢«è§†ä¸ºé¢„æµ‹å˜é‡ï¼Œ  
  ä½†ä¸ºæ¸…æ™°èµ·è§ï¼Œè¿˜æ˜¯å°†å…¶åŒ…å«åœ¨å†…

```r
tsk_adult$col_roles$feature <- odata$feature_names
tsk_adult
```

```js
[36m--[39m [1m[34m<TaskClassif>[39m (48842x15)[22m [36m----------------------------------------------------[39m
* Target: class
* Target classes: >50K (positive class, 24%), <=50K (76%)
* Properties: twoclass
* Features (14):
  * fct (8): education, marital.status, native.country, occupation, race,
  relationship, sex, workclass
  * int (6): age, capital.gain, capital.loss, education.num, fnlwgt,
  hours.per.week
```

#### ä»»åŠ¡

- OpenMLä»»åŠ¡æ„å»ºåœ¨OpenMLæ•°æ®é›†ä¹‹ä¸Š
  - é¢å¤–æŒ‡å®šç›®æ ‡å˜é‡ï¼Œç”¨äºé‡é‡‡æ ·çš„è®­ç»ƒ-æµ‹è¯•åˆ†å‰²ç­‰
- OpenMLä»»åŠ¡ä¸`mlr3`Â `Task`å¯¹è±¡ä¸åŒï¼Œ  
  **åè€…ä¸åŒ…å«æœ‰å…³é‡é‡‡æ ·è¿‡ç¨‹çš„ä¿¡æ¯**
- ä¸`mlr3`ç±»ä¼¼ï¼ŒOpenMLæœ‰ä¸åŒç±»å‹çš„ä»»åŠ¡ï¼Œå¦‚å›å½’å’Œåˆ†ç±»
- ä¸ç­›é€‰æ•°æ®é›†ç±»ä¼¼ï¼Œä»»åŠ¡å¯ä»¥ä½¿ç”¨`list_oml_tasks()`è¿›è¡Œç­›é€‰

- ä¾‹å­è¿˜æ˜¯åˆšåˆš`id = 1590`çš„æ•°æ®é›†

```r
# å°†åˆšåˆšçš„æ•°æ®é›†idä¼ é€’ç»™`data_id`å‚æ•°ä»¥ä¾¿äºè¯†åˆ«
adult_tasks <- list_oml_tasks(data_id = 1590)
```

- ç”±æ•°æ®é›†åˆ›å»ºçš„ä»»åŠ¡æœ‰å¾ˆå¤š
  - è¿™é‡Œé€‰æ‹©`'Supervised Classification'`çš„ä»»åŠ¡

```r
adult_tasks[task_type == "Supervised Classification", task_id]
```

```js
1. 7592
2. 14947
3. 126025
4. 146154
5. 146598
6. 168878
7. 233099
8. 359983
9. 361515
10. 362136
```

- `otsk()`åŠ è½½å¯¹è±¡æ•°æ®é›†ï¼Œè¿”å›ä¸€ä¸ª`OMLTask`å¯¹è±¡

```r
# é€‰æ‹©ä»»åŠ¡
otask <- otsk(id = 359983)

# æŸ¥çœ‹ä»»åŠ¡
otask

# æŸ¥çœ‹å®Œæ•´æ•°æ®
otask$data

# æŸ¥çœ‹æ•°æ®é›†çš„åˆ’åˆ†
otask$task_splits %>% head()
```

```js
<OMLTask:359983>
 * Type: Supervised Classification
 * Data: adult (id: 1590; dim: 48842x15)
 * Target: class
 * Estimation: crossvalidation (id: 1; repeats: 1, folds: 10)


<OMLData:1590:adult> (48842x15)
 * Default target: class
```

<table class="dataframe">
<caption>A data.table: 6 x 4</caption>
<thead>
 <tr><th scope=col>type</th><th scope=col>rowid</th><th scope=col>repeat.</th><th scope=col>fold</th></tr>
 <tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
 <tr><td>TRAIN</td><td>32427</td><td>0</td><td>0</td></tr>
 <tr><td>TRAIN</td><td>13077</td><td>0</td><td>0</td></tr>
 <tr><td>TRAIN</td><td>15902</td><td>0</td><td>0</td></tr>
 <tr><td>TRAIN</td><td>17703</td><td>0</td><td>0</td></tr>
 <tr><td>TRAIN</td><td>35511</td><td>0</td><td>0</td></tr>
 <tr><td>TRAIN</td><td>44497</td><td>0</td><td>0</td></tr>
</tbody>
</table>

- ä»`OMLTask`å¯¹è±¡**æå–**`Task`

```r
tsk_adult <- as_task(otask)
tsk_adult
```

```r
[36m--[39m [1m[34m<TaskClassif>[39m (48842x15)[22m [36m----------------------------------------------------[39m
* Target: class
* Target classes: >50K (positive class, 24%), <=50K (76%)
* Properties: twoclass
* Features (14):
  * fct (8): education, marital.status, native.country, occupation, race,
  relationship, sex, workclass
  * int (6): age, capital.gain, capital.loss, education.num, fnlwgt,
  hours.per.week
```

- ä»`OMLTask`é‡Œ**æå–**`Resampling`

```r
resampling <- as_resampling(otask)
resampling
```

```js
[36m--[39m [1m[34m<ResamplingCustom>[39m : Custom Splits[22m [36m------------------------------------------[39m
* Iterations: [34m10[39m
* Instantiated: [34mTRUE[39m
* Parameters: list()
```

- `tsk()`å¯ä»¥å…è®¸ä¸Šé¢ä¸¤ä¸ªæ­¥éª¤ä¸€æ­¥åˆ°ä½

```r
tsk("oml", task_id = 359983)
```

```js
[36m--[39m [1m[34m<TaskClassif>[39m (48842x15)[22m [36m----------------------------------------------------[39m
* Target: class
* Target classes: >50K (positive class, 24%), <=50K (76%)
* Properties: twoclass
* Features (14):
  * fct (8): education, marital.status, native.country, occupation, race,
  relationship, sex, workclass
  * int (6): age, capital.gain, capital.loss, education.num, fnlwgt,
  hours.per.week
```

#### ä»»åŠ¡é›†åˆ

- OpenMLä»»åŠ¡é›†åˆæ˜¯ä¸€ä¸ªæ†ç»‘ç°æœ‰ä»»åŠ¡çš„å®¹å™¨å¯¹è±¡
  - è¿™ä½¿å¾—å¯ä»¥åˆ›å»ºbenchmarkæµ‹è¯•å¥—ä»¶ï¼Œ  
   å³æ»¡è¶³ç‰¹å®šè´¨é‡æ ‡å‡†çš„æŒ‡å®šä»»åŠ¡é›†åˆ
- `OMLCollection`å¯¹è±¡é€šè¿‡`ocl()`åŠ è½½

```r
otask_collection <- ocl(id = 99)
otask_collection
```

```r
INFO  [01:38:51.539] Retrieving JSON [90m{[39m[38;5;169murl[39m[90m: [39m`https://www.openml.org/api/v1/json/study/99`[90m, [39m[38;5;169mauthenticated[39m[90m: [39m`FALSE`[90m}[39m
<OMLCollection: 99> OpenML-CC18 Curated Class[...]
 * data:  72
 * tasks: 72
```

- æŸ¥çœ‹å‰äº”ä¸ªä»»åŠ¡

```r
otask_collection$task_ids[1:5] 
```

```js
[1]  3  6 11 12 14
```

- ä»»åŠ¡é›†åˆå¯ç”¨äºåœ¨Â `mlr3`Â ä¸­å¿«é€Ÿå®šä¹‰åŸºå‡†å®éªŒ
- ä½¿ç”¨Â `as_tasks()`å’ŒÂ `as_resamplings()`  
  è½»æ¾æ„å»ºåŸºå‡†æµ‹è¯•å¥—ä»¶ä¸­çš„æ‰€æœ‰ä»»åŠ¡å’Œé‡é‡‡æ ·

```r
tasks <- as_tasks(otask_collection)
resamplings <- as_resamplings(otask_collection)
```

- è¿›ä¸€æ­¥ç­›é€‰æ•°æ®
  - è¿›è¡Œä¸€ä¸ªåŒ…å«å…­é¡¹ä»»åŠ¡çš„äºŒåˆ†ç±»å®éªŒï¼Œ  
   æˆ‘ä»¬å¯ä»¥å°†CC - 18æ•°æ®é›†ä¸­çš„ä»»åŠ¡IDä½œä¸ºå‚æ•°`task_id`æ¥è¿è¡Œ`list_oml_tasks()`
  - æ—¢å¯ä»¥ä½¿ç”¨`list_oml_tasks()`çš„å‚æ•°ï¼Œ  
   è¦æ±‚ç±»åˆ«æ•°é‡ä¸º`2`
  - å¯ä»¥é€šè¿‡`list_oml_tasks()`çš„è¿”å›ç»“æœæ˜¯`data.table`ï¼Œ  
   ä»è€Œå¯¹ç”Ÿæˆçš„è¡¨æ ¼è¿›è¡Œå­é›†åŒ–å¤„ç†

```r
binary_cc18 <- list_oml_tasks(
  # ä¸Šé™6ä¸ªä»»åŠ¡
  limit = 6,
  # ç”¨idé€‰æ‹©ä»»åŠ¡
  task_id = otask_collection$task_ids,
  # ç­›é€‰äºŒå…ƒåˆ†ç±»çš„å˜é‡
  number_classes = 2
)
```

- å°†é€‰å®šçš„ä»»åŠ¡è½¬æ¢ä¸º`OMLTask`å¹¶æå–`Task`å’Œ`Resampling`

```r
# æ‰¹é‡ä¼ é€’é€‰æ‹©çš„idç»™`otsk()`
otasks <- lapply(binary_cc18$task_id, otsk)

# æå–`Task`å’Œ`Resampling`
tasks <- as_tasks(otasks)
resamplings <- as_resamplings(otasks)
```

- è®¾è®¡benchmarkæµ‹è¯•

```r
# ----------è¿™é‡Œæ˜¯æœ€å¼€å§‹çš„å­¦ä¹ å™¨ç®¡é“
# æ— ç‰¹å¾å€¼åŸºçº¿å­¦ä¹ å™¨
lrn_baseline <- lrn("classif.featureless", id = "featureless")

# æ„å»ºé€»è¾‘å›å½’å­¦ä¹ å™¨
lrn_lr <- lrn("classif.log_reg")
# æ„å»ºç”¨äºé€»è¾‘å›å½’çš„`GraphLearner`
# ppl("robustify", learner = lrn_lr)è¡¨ç¤ºç”¨äºé€»è¾‘å›å½’çš„ç®¡é“
lrn_lr <- as_learner(ppl("robustify", learner = lrn_lr) %>>% lrn_lr)
# è¯†åˆ«id
lrn_lr$id <- "logreg"
# å°è£…åŠå›é€€å­¦ä¹ å™¨
lrn_lr$encapsulate("try", fallback = lrn_baseline)

# æ„å»ºéšæœºæ£®æ—å­¦ä¹ å™¨
lrn_rf <- lrn("classif.ranger")
# æ„å»ºç”¨äºéšæœºæ£®æ—çš„`GraphLearner`
lrn_rf <- as_learner(ppl("robustify", learner = lrn_rf) %>>% lrn_rf)
# è¯†åˆ«id
lrn_rf$id <- "ranger"
# å°è£…åŠå›é€€å­¦ä¹ å™¨
lrn_rf$encapsulate("try", fallback = lrn_baseline)

# æ”¾åˆ°ä¸€ä¸ª`list`é‡Œ
learners <- list(lrn_lr, lrn_rf, lrn_baseline)


# benchmarkè®¾è®¡
large_design <- benchmark_grid(
 tasks, 
 learners, 
 resamplings,
 paired = TRUE
)
# æŸ¥çœ‹å‰å…­ä¸ªå®éªŒ
large_design[1:6] 
```

```js
       task     learner resampling
     <char>      <char>     <char>
1: kr-vs-kp      logreg     custom
2: kr-vs-kp      ranger     custom
3: kr-vs-kp featureless     custom
4: breast-w      logreg     custom
5: breast-w      ranger     custom
6: breast-w featureless     custom
```

## é«˜æ€§èƒ½è®¡ç®—é›†ç¾¤ä¸Šçš„benchmarkæµ‹è¯•

### ç®€ä»‹

- `batchtools` æä¾›äº†ä¸€ä¸ªæ¡†æ¶ï¼Œ  
  ç”¨äºç®€åŒ–åœ¨è¿™ç±»ç«™ç‚¹ä¸Šä»Rè¯­è¨€å¹¶è¡Œè¿è¡Œå¤§é‡è®¡ç®—å®éªŒçš„è¿‡ç¨‹
  - å®ƒå…·æœ‰é«˜åº¦çš„çµæ´»æ€§ï¼Œé€‚ç”¨äºå„ç§è®¡ç®—å®éªŒï¼Œ  
   åŒ…æ‹¬æœºå™¨å­¦ä¹ ã€ä¼˜åŒ–ã€æ¨¡æ‹Ÿç­‰

![image_29](./image_29.png)

### å®éªŒæ³¨å†Œè¡¨è®¾ç½®

```r
library(batchtools)

# create registry
reg = makeExperimentRegistry(
  file.dir = "./experiments",
  seed = 1,
  packages = "mlr3verse"
)
```

```r
library(mlr3batchmark)
batchmark(large_design, reg = reg)
```

```r
reg
```

```r
job_table = getJobTable(reg = reg)
job_table = unwrap(job_table)
job_table = job_table[,
  .(job.id, learner_id, task_id, resampling_id, repl)
]

job_table
```

### ä½œä¸šå·¥ä½œ

```r
result = testJob(1, external = TRUE, reg = reg)
```

```r
cf = makeClusterFunctionsSlurm(template = "slurm-simple")
```

```r
reg$cluster.functions = cf
saveRegistry(reg = reg)
```

```r
ids = job_table$job.id
chunks = data.table(
  job.id = ids, chunk = chunk(ids, chunk.size = 5, shuffle = FALSE)
)
chunks[1:6] # first 6 jobs
```

```r
resources = list(ncpus = 1, walltime = 3600, memory = 8000)
```

```r
submitJobs(ids = chunks, resources = resources, reg = reg)

# wait for all jobs to terminate
waitForJobs(reg = reg)
```

### å·¥ä½œç›‘æ§ã€é”™è¯¯å¤„ç†ä¸ç»“æœæ”¶é›†

```r
getStatus(reg = reg)
```

```r
extra_design = benchmark_grid(tasks,
  lrn("classif.debug", error_train = 0.5), resamplings, paired = TRUE)

batchmark(extra_design, reg = reg)
```

```r
ids = findNotSubmitted(reg = reg)
submitJobs(ids, reg = reg)
```

```r
getStatus(reg = reg)
```

```r
error_ids = findErrors(reg = reg)
summarizeExperiments(error_ids, by = c("task_id", "learner_id"),
  reg = reg)
```

```r
ids = findExperiments(algo.pars = learner_id != "classif.debug",
  reg = reg)
bmr = reduceResultsBatchmark(ids, reg = reg)
bmr$aggregate()[1:5]
```

### ä½¿ç”¨batchtoolsè¿›è¡Œè‡ªå®šä¹‰å®éªŒ

```r
reg = makeExperimentRegistry(
  file.dir = "./experiments-custom",
  seed = 1,
  packages = "mlr3verse"
)
```

```pseudocode
for (i in seq_along(tasks)) {
  addProblem(
    name = tasks[[i]]$id,
    data = list(task = tasks[[i]], resampling = resamplings[[i]]),
    fun = function(data, job, ...) data,
    reg = reg
  )
}
```

![image_30](./image_30.png)

```r
addAlgorithm(
  "run_learner",
  fun = function(instance, learner, job, ...) {
    resample(instance$task, learner, instance$resampling)
  },
  reg = reg
)
```

```r
alg_des = list(run_learner = data.table(learner = learners))
addExperiments(algo.designs = alg_des, reg = reg)
summarizeExperiments()
```

```r
submitJobs(reg = reg)
```

```r
rr = loadResult(1, reg = reg)
as.data.table(rr)[1:5]
```

```r
bmr = reduceResults(c, reg = reg)
bmr$aggregate()[1:5]
```

### ç»Ÿè®¡åˆ†æ

```r
library(mlr3benchmark)
bma = as_benchmark_aggr(bmr, measures = msr("classif.ce"))
bma$friedman_posthoc()
```

```r
autoplot(bma, type = "cd", ratio = 1/5)
```
