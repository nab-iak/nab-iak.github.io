---
title: 'ã€mlr3ã€‘8.é¢„æµ‹é›†ï¼ŒéªŒè¯åŠå†…éƒ¨è°ƒä¼˜(+)'
published: 2025-07-15
image: './p17_cover.png'
description: 'mlr3é¢„æµ‹é›†ï¼ŒéªŒè¯åŠå†…éƒ¨è°ƒä¼˜(+)'
category: 'Machine Learning'
tags: [mlr3,R,ZH-CN]
draft: false 
lang: 'en'
---
> - Cover Pic by [@ç°è‰²ç°çƒ¬GREYASH](https://www.pixiv.net/artworks/131467447)  

> [Applied Machine Learning Using mlr3 in R](https://mlr3book.mlr-org.com/)

## é¢„æµ‹é›†ä¸è®­ç»ƒè¯¯å·®ä¼°è®¡

- è¯„ä¼°ä¸€ä¸ªå®Œå…¨è®­ç»ƒå¥½çš„æ¨¡å‹é€šå¸¸éœ€è¦å¯¹æœªè§è¿‡çš„æµ‹è¯•æ ·æœ¬è¿›è¡Œé¢„æµ‹
- å½“ç›´æ¥ä½¿ç”¨è®­ç»ƒå¥½çš„å­¦ä¹ å™¨è¿›è¡Œé¢„æµ‹æ—¶ï¼Œ  
  æˆ‘ä»¬å¯ä»¥æ˜ç¡®æ§åˆ¶ä½¿ç”¨å“ªäº›æ ·æœ¬

```r
# ä»»åŠ¡
tsk_sonar <- tsk('sonar')
# å­¦ä¹ å™¨
lrn_rf <- lrn('classif.ranger')
# è®­ç»ƒæ¨¡å‹
lrn_rf$train(tsk_sonar, row_ids = 4:208)

# é¢„æµ‹(ä¸¤ç§æ–¹æ³•)
pred1 <- lrn_rf$predict(tsk_sonar, row_ids = 1:3)
pred2 <- lrn_rf$predict_newdata(tsk_sonar$data(1:3))
```

- ä½†æ˜¯ï¼Œå½“ä½¿ç”¨`resample()` æˆ– `benchmark()` æ—¶ï¼Œ  
  é»˜è®¤è¡Œä¸ºæ˜¯å¯¹é‡é‡‡æ ·çš„**æµ‹è¯•é›†**è¿›è¡Œé¢„æµ‹
- ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®å­¦ä¹ å™¨çš„ `$predict_sets`ï¼Œ  
  å¯¹ä»»åŠ¡å’Œæ•°æ®çš„å…¶ä»–ç‰¹å®šå­é›†ï¼ˆå³ **è®­ç»ƒ** å’Œ **å†…éƒ¨éªŒè¯** æ•°æ®ï¼‰è¿›è¡Œé¢„æµ‹
- æ¥ä¸‹æ¥çœ‹çœ‹æ›´å¤æ‚çš„ **å†…éƒ¨éªŒè¯** é€‰é¡¹

```r
# é»˜è®¤çš„ç”¨äºé¢„æµ‹çš„æ•°æ®é›†
lrn_rf$predict_sets
# è®¾ç½®ä¸ºè®­ç»ƒæµ‹è¯•éƒ½ç»™ç”¨ä¸Š
lrn_rf$predict_sets <- c('train', 'test')
# å†çœ‹çœ‹å½“å‰ç”¨äºé¢„æµ‹çš„æ•°æ®é›†
lrn_rf$predict_sets

# æ‰§è¡Œé‡é‡‡æ ·
rr <- resample(tsk_sonar, lrn_rf, rsmp('cv', folds = 3))
```

```js
'test'
'train''test'
```

- åœ¨é‡é‡‡æ ·è¿‡ç¨‹ä¸­ï¼Œå­¦ä¹ å™¨åœ¨å®Œæˆå½“å‰è¿­ä»£çš„è®­ç»ƒåï¼Œ  
  å°†å¯¹æ‰€æœ‰è¯·æ±‚çš„æ•°æ®é›†ç”Ÿæˆé¢„æµ‹
  - ä¸ºäº†è·å–è¿™äº›é¢„æµ‹
    - æ—¢å¯ä»¥è¯·æ±‚ä¸€ä¸ªåŒ…å«3ä¸ªé¢„æµ‹å¯¹è±¡çš„åˆ—è¡¨ï¼ˆæ¯ä¸ªäº¤å‰éªŒè¯æŠ˜å¯¹åº”ä¸€ä¸ªå¯¹è±¡ï¼‰
    - ä¹Ÿå¯ä»¥è¯·æ±‚ä¸€ä¸ªé’ˆå¯¹æ•´ä¸ªäº¤å‰éªŒè¯çš„ç»„åˆé¢„æµ‹å¯¹è±¡â€”â€”  
    åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥å¯¹è±¡åŒ…å«çš„é¢„æµ‹è¡Œæ•°ä¸ä»»åŠ¡ä¸­çš„è§‚æµ‹å€¼æ•°é‡ç›¸åŒ

```r
# è¯·æ±‚åˆ—è¡¨
str(rr$predictions('test'))
str(rr$predictions('train'))

# è·å–
rr$prediction('test') 
rr$prediction('train')
```

```js
List of 3
 $ :Classes 'PredictionClassif', 'Prediction', 'R6' <PredictionClassif> 
 $ :Classes 'PredictionClassif', 'Prediction', 'R6' <PredictionClassif> 
 $ :Classes 'PredictionClassif', 'Prediction', 'R6' <PredictionClassif> 

List of 3
 $ :Classes 'PredictionClassif', 'Prediction', 'R6' <PredictionClassif> 
 $ :Classes 'PredictionClassif', 'Prediction', 'R6' <PredictionClassif> 
 $ :Classes 'PredictionClassif', 'Prediction', 'R6' <PredictionClassif> 

[36m--[39m [1m[34m<PredictionClassif>[39m for [34m208[39m observations:[22m [36m-----------------------------------[39m
 row_ids truth response
       3     R        M
       4     R        R
       6     R        R
     ---   ---      ---
     200     M        M
     206     M        M
     207     M        M

[36m--[39m [1m[34m<PredictionClassif>[39m for [34m416[39m observations:[22m [36m-----------------------------------[39m
 row_ids truth response
       1     R        R
       2     R        R
      10     R        R
     ---   ---      ---
     202     M        M
     204     M        M
     205     M        M
```

- è¿˜å¯ä»¥å°†æ€§èƒ½åº¦é‡åº”ç”¨äºé‡é‡‡æ ·ç»“æœçš„ç‰¹å®šæ•°æ®é›†
- å¯¹äºä¸€é¡¹æŒ‡æ ‡ï¼Œé»˜è®¤çš„é¢„æµ‹æ•°æ®é›†é€šå¸¸æ˜¯æµ‹è¯•é›†ï¼Œ  
  ä½†ä¹Ÿå¯ä»¥åœ¨æ­¤è¯·æ±‚å…¶ä»–æ•°æ®é›†
  - å¦‚æœä¸ºè¯¥æŒ‡æ ‡è¯·æ±‚äº†å¤šä¸ªé¢„æµ‹æ•°æ®é›†ï¼Œ  
   é‚£ä¹ˆåœ¨å°†å…¶ä¼ å…¥è¯¥æŒ‡æ ‡ä¹‹å‰ï¼Œä¼šå…ˆå°†è¿™äº›æ•°æ®é›†çš„é¢„æµ‹ç»“æœåˆå¹¶ï¼Œ  
   ç„¶åè¯¥æŒ‡æ ‡é€šå¸¸ä¼šå¯¹æ•°æ®é›†ä¸­æ‰€æœ‰é¢„æµ‹è¡Œè®¡ç®—ä¸€ä¸ªèšåˆåˆ†æ•°
- åœ¨æœ¬ä¾‹ä¸­ï¼Œä¸å‡ºæ‰€æ–™è®­ç»ƒè¯¯å·®ä½äºæµ‹è¯•è¯¯å·®

```r
rr$aggregate(list(
  msr('classif.ce', predict_sets = 'train', id = 'ce_train'),
  msr('classif.ce', predict_sets = 'test', id = 'ce_test')
))
```

```js
 ce_train   ce_test 
0.0000000 0.2020014 
```

- å¦‚æœæˆ‘ä»¬åªæƒ³è·å–è®­ç»ƒæœŸé—´è®¡ç®—å‡ºçš„ä¿¡æ¯ï¼Œ  
  ç”šè‡³å¯ä»¥å°†å­¦ä¹ å™¨é…ç½®ä¸ºå®Œå…¨ä¸è¿›è¡Œä»»ä½•é¢„æµ‹
  - ä¾‹å¦‚å¯¹äºé‚£äº›å·²ç»ï¼ˆåœ¨å…¶åº•å±‚å®ç°ä¸­ï¼‰åœ¨è®­ç»ƒæœŸé—´äº§ç”Ÿæ³›åŒ–è¯¯å·®ä¼°è®¡çš„å­¦ä¹ å™¨å¾ˆæœ‰ç”¨
    - æ¯”å¦‚ä½¿ç”¨è¢‹å¤–è¯¯å·®ä¼°è®¡æˆ–éªŒè¯åˆ†æ•°
      - å‰è€…ä»…é€‚ç”¨äºå…·æœ‰`'oob_error'`å±æ€§çš„å­¦ä¹ å™¨ï¼Œ  
     å¯ä»¥é€šè¿‡ `MeasureOOBError` æ¥è®¿é—®
      - åè€…é€‚ç”¨äºå…·æœ‰`'validation'`å±æ€§çš„å­¦ä¹ å™¨ï¼Œ  
     å¹¶å®ç°ä¸º `MeasureInternalValidScore`
- ä¸‹é¢ä½¿ç”¨éšæœºæ£®æ—çš„è¢‹å¤–è¯¯å·®å¯¹å…¶è¿›è¡Œè¯„ä¼°
  - ç”±äºä¸éœ€è¦ä»»ä½•é¢„æµ‹é›†ï¼Œ  
   å› æ­¤å¯ä»¥ä½¿ç”¨ `ResamplingInsample`
    - å®ƒå°†ä½¿ç”¨æ•´ä¸ªæ•°æ®é›†è¿›è¡Œè®­ç»ƒ

```r
lrn_rf$predict_sets <- NULL
rsmp_in <- rsmp('insample')
rr <- resample(
 tsk_sonar, 
 lrn_rf, 
 rsmp_in, 
 store_models = TRUE
)
msr_oob <- msr('oob_error')
rr$aggregate(msr_oob)
```

```js
oob_error 
0.1586538 
```

- æ‰€æœ‰è¿™äº›å¯¹äºbenchmarkæµ‹è¯•ï¼Œè°ƒä¼˜ï¼ŒåµŒå¥—é‡é‡‡æ ·ï¼Œ  
  ä»¥åŠä»»ä½•å…¶ä»–å†…éƒ¨æ¶‰åŠé‡é‡‡æ ·çš„è¿‡ç¨‹éƒ½ä»¥å®Œå…¨ç›¸åŒçš„æ–¹å¼å·¥ä½œï¼Œ  
  å¹¶ä¸”è¦ä¹ˆç”Ÿæˆé¢„æµ‹ç»“æœï¼Œè¦ä¹ˆè¯„ä¼°åº”ç”¨æ€§èƒ½æŒ‡æ ‡

- ä¸‹é¢é€šè¿‡è°ƒä¼˜éšæœºæ£®æ—çš„ `mtry.ratio` å‚æ•°  
  ï¼ˆä½¿ç”¨ç®€å•çš„ç½‘æ ¼æœç´¢ï¼‰æ¥è¯´æ˜è¿™ä¸€ç‚¹
  - ä¸æ˜¯åœ¨æŸäº›æµ‹è¯•æ•°æ®ä¸Šæ˜¾å¼åœ°è¿›è¡Œé¢„æµ‹å¹¶è¯„ä¼°å®ƒä»¬ï¼Œ  
   è€Œæ˜¯ä½¿ç”¨è¢‹å¤–ï¼ˆOOBï¼‰è¯¯å·®æ¥è¯„ä¼° `mtry.ratio`
    - è¿™å¯ä»¥æ˜¾è‘—åŠ å¿«è°ƒä¼˜è¿‡ç¨‹ï¼Œ  
    å› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹åªæ‹Ÿåˆä¸€ä¸ªéšæœºæ£®æ—ï¼ˆä»…è¿›è¡Œè®­ç»ƒï¼‰ï¼Œ  
    å¹¶ä¸”æˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªå•ä¸€æ¨¡å‹ä¸­è·å–è¢‹å¤–è¯¯å·®ï¼Œ  
    è€Œæ— éœ€æ‹Ÿåˆå¤šä¸ªæ¨¡å‹
  - ç”±äºåœ¨é›†æˆä¸­æ¯æ£µæ ‘çš„è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œ  
   è¢‹å¤–è§‚æµ‹å€¼æœªè¢«è§¦åŠï¼Œ  
   æ‰€ä»¥ä»ç„¶èƒ½äº§ç”Ÿæœ‰æ•ˆçš„æ€§èƒ½ä¼°è®¡

```r
# è®¾ç½®å¸¦è°ƒä¼˜çš„è¶…å‚æ•°
lrn_rf$
 param_set$
 set_values(
  mtry.ratio = to_tune(0.1, 1)
)

# è¿›è¡Œå®ä¾‹è°ƒä¼˜
ti <- tune(
  task = tsk_sonar,
  tuner = tnr('grid_search'),
  learner = lrn_rf,
  resampling = rsmp_in,
  measure = msr_oob,
  term_evals = 10,
  store_models = TRUE
)

# æŸ¥çœ‹ç»“æœ
ti$result
```

<table class='dataframe'>
<caption>A data.table: 1 x 4</caption>
<thead>
 <tr><th scope=col>mtry.ratio</th><th scope=col>learner_param_vals</th><th scope=col>x_domain</th><th scope=col>oob_error</th></tr>
 <tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>0.3</td><td>1.0, 0.3</td><td>0.3</td><td>0.1442308</td></tr>
</tbody>
</table>

## éªŒè¯

- å¯¹äºè¿­ä»£è®­ç»ƒï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è·Ÿè¸ªæ¨¡å‹åœ¨éªŒè¯æ•°æ®ä¸Šçš„æ€§èƒ½è¡¨ç°å¯èƒ½å¾ˆæœ‰æ„ä¹‰
  - å¯ä»¥å°†å…¶ç”¨äºç®€å•çš„è®°å½•æˆ–äº‹ååˆ†æï¼Œ  
   ä½†ä¸»è¦çš„åº”ç”¨åœºæ™¯æ˜¯æå‰åœæ­¢è®­ç»ƒ
  - å¦‚æœæ¨¡å‹åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„æ€§èƒ½æŒç»­æå‡ï¼Œ  
   ä½†åœ¨éªŒè¯æ•°æ®ä¸Šçš„æ€§èƒ½è¶‹äºå¹³ç¨³æˆ–ä¸‹é™ï¼Œ  
   è¿™å°±è¡¨æ˜å‡ºç°äº†è¿‡æ‹Ÿåˆ
    - æ­¤æ—¶æˆ‘ä»¬åº”è¯¥åœæ­¢è¿­ä»£è®­ç»ƒ
  - åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä»¥åœ¨çº¿æ–¹å¼å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œ  
   è¦æ¯”é€šè¿‡ä¼ ç»Ÿçš„ç¦»çº¿è¶…å‚æ•°è°ƒæ•´ä»å¤–éƒ¨é…ç½®è¿­ä»£æ¬¡æ•°é«˜æ•ˆå¾—å¤š
- åœ¨ä¼ ç»Ÿæ–¹æ³•ä¸­ï¼Œéœ€è¦åå¤ä½¿ç”¨ä¸åŒçš„è¿­ä»£æ¬¡æ•°æ¥æ‹Ÿåˆæ¨¡å‹  
  ï¼ˆå¹¶ä¸”æ— æ³•åˆ©ç”¨æœ‰å…³è¿ç»­è¿›å±•çš„ä»»ä½•ä¿¡æ¯ï¼‰

- åœ¨`mlr3`ä¸­ï¼Œ  
  å­¦ä¹ å™¨å¯ä»¥å…·æœ‰  
  `'validation'`ï¼ˆéªŒè¯ï¼‰å’Œ  
  `'internal_tuning'`ï¼ˆå†…éƒ¨è°ƒä¼˜ï¼‰å±æ€§ï¼Œ  
  ä»¥è¡¨æ˜å®ƒä»¬æ˜¯å¦å¯ä»¥ä½¿ç”¨éªŒè¯é›†ï¼Œ  
  ä»¥åŠæ˜¯å¦å¯ä»¥åœ¨å†…éƒ¨ä¼˜åŒ–è¶…å‚æ•°ï¼Œä¾‹å¦‚é€šè¿‡æå‰åœæ­¢
  - è¦æ£€æŸ¥ç»™å®šçš„å­¦ä¹ å™¨æ˜¯å¦æ”¯æŒæ­¤åŠŸèƒ½ï¼Œ  
   åªéœ€è®¿é—®å…¶`$properties`å­—æ®µã€‚
  - è¿™ç±»å­¦ä¹ å™¨çš„åŒ…æ‹¬XGBoostï¼ŒLightGBMæˆ–CatBoostç­‰æå‡ç®—æ³•ï¼Œ  
   ä»¥åŠæ¥è‡ª`mlr3torch`çš„æ·±åº¦å­¦ä¹ æ¨¡å‹

- æœ¬èŠ‚ä¸­åœ¨å£°çº³æ•°æ®é›†ä¸Šè®­ç»ƒXGBoostï¼Œ  
  å¹¶è·Ÿè¸ªå…¶åœ¨éªŒè¯é›†ä¸Šçš„æ€§èƒ½
- ä¸ºå¯ç”¨éªŒè¯ï¼Œéœ€è¦é…ç½®éªŒè¯æ•°æ®çš„æ„å»ºæ–¹å¼
  - XGBoostæœ‰ä¸€ä¸ªç‰¹æ®Šçš„`watchlist`å‚æ•°
  - ä½†`mlr3`ä¹Ÿé€šè¿‡å­¦ä¹ å™¨çš„`$validate`å­—æ®µ  
   æä¾›äº†ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¥å£ï¼Œè¯¥å­—æ®µå¯ä»¥è®¾ç½®ä¸ºï¼š
    - `NULL`ï¼š  
    ä¸ä½¿ç”¨éªŒè¯æ•°æ®ï¼ˆé»˜è®¤è®¾ç½®ï¼‰
    - `'predefined'`ï¼š  
    ç”¨äºä½¿ç”¨ä»»åŠ¡ä¸­æŒ‡å®šçš„éªŒè¯æ•°æ®
    - `'test'`ï¼š  
    å°†æµ‹è¯•é›†ç”¨ä½œéªŒè¯æ•°æ®ï¼Œ  
    è¿™ä»…åœ¨ä¸é‡é‡‡æ ·å’Œè°ƒä¼˜ç»“åˆä½¿ç”¨æ—¶æœ‰æ•ˆ
  - å¦‚æœå°†`$validate`å­—æ®µè®¾ç½®ä¸º`'test'`ï¼Œ  
   å°†åœ¨è®­ç»ƒæœŸé—´æ³„éœ²é‡é‡‡æ ·æµ‹è¯•é›†
    - å¦‚æœä½¿ç”¨éªŒè¯åˆ†æ•°è¿›è¡Œæå‰åœæ­¢ï¼Œè¿™å°†å¯¼è‡´æœ‰åå·®çš„æ€§èƒ½ä¼°è®¡
    - æ˜¯å¦å¯å–å–å†³äºå…·ä½“æƒ…å†µï¼š
      - å¦‚æœæµ‹è¯•é›†ç”¨äºåœ¨è¶…å‚æ•°ä¼˜åŒ–æœŸé—´è¯„ä¼°å‚æ•°é…ç½®ï¼ˆå³å®ƒå……å½“éªŒè¯é›†ï¼‰ï¼Œ  
     é‚£ä¹ˆè¿™é€šå¸¸æ˜¯å¯ä»¥çš„
     å¦‚æœæµ‹è¯•é›†çš„ç›®çš„æ˜¯æä¾›æ— åå·®çš„æ€§èƒ½ä¼°è®¡ï¼Œ  
     ä¾‹å¦‚æ¯”è¾ƒä¸åŒçš„å­¦ä¹ å™¨ï¼Œé‚£ä¹ˆè¿™æ˜¯ä¸å¯å–çš„

```r
tsk_sonar <- tsk('sonar')
lrn_xgb <- lrn('classif.xgboost')
lrn_xgb
```

```js
[36m--[39m [1m[34m<LearnerClassifXgboost>[39m (classif.xgboost): Extreme Gradient Boosting[22m [36m--------[39m
* Model: -
* Parameters: nrounds=1000, nthread=1, verbose=0
* Validate: NULL
* Packages: [34mmlr3[39m, [34mmlr3learners[39m, and [34mxgboost[39m
* Predict Types: [response] and prob
* Feature Types: logical, integer, and numeric
* Encapsulation: none (fallback: -)
* Properties: hotstart_forward, importance, internal_tuning, missings,
multiclass, offset, twoclass, validation, and weights
* Other settings: use_weights = 'use'
```

- ä¸‹é¢å°†XGBoostå­¦ä¹ å™¨é…ç½®ä¸ºä½¿ç”¨å…¶è®­ç»ƒæ•°æ®çš„1/3è¿›è¡ŒéªŒè¯

```r
lrn_xgb$validate <- 1/3
```

- æ¥ä¸‹æ¥è®¾ç½®è¿­ä»£æ¬¡æ•°ï¼ˆ`nrounds`ï¼‰å’Œè¦è·Ÿè¸ªçš„æŒ‡æ ‡ï¼ˆ`eval_metric`ï¼‰ï¼Œå¹¶è®­ç»ƒå­¦ä¹ å™¨
  - è®­ç»ƒä»»åŠ¡ä¸­Â 1/3Â çš„è§‚æµ‹å€¼å°†ä»…ç”¨äºéªŒè¯ï¼Œ  
   å…¶ä½™Â 2/3Â ç”¨äºè®­ç»ƒ
  - å¦‚æœåœ¨ä»»åŠ¡ä¸­å¯ç”¨äº†åˆ†å±‚æˆ–åˆ†ç»„ï¼Œä¹Ÿä¼šè¢«ç»§æ‰¿

```r
lrn_xgb$param_set$set_values(
  nrounds = 100,
  eval_metric = 'logloss'
)
lrn_xgb$train(tsk_sonar)
```

- XGBoostå­¦ä¹ å™¨èƒ½å¤Ÿè®°å½•éªŒè¯æ€§èƒ½æ—¥å¿—
  - å¯ä»¥é€šè¿‡`$model`æ’æ§½è®¿é—®è¯¥æ—¥å¿—
  - æ­¤ä¿¡æ¯åœ¨æ¨¡å‹ä¸­çš„å…·ä½“å­˜å‚¨ä½ç½®å–å†³äºç‰¹å®šçš„å­¦ä¹ ç®—æ³•
    - å¯¹äºXGBoostï¼Œ  
    è¯¥å†å²è®°å½•å­˜å‚¨åœ¨`$evaluation_log`ä¸­

```r
tail(lrn_xgb$model$evaluation_log)
```

<table class='dataframe'>
<caption>A data.table: 6 x 2</caption>
<thead>
 <tr><th scope=col>iter</th><th scope=col>test_logloss</th></tr>
 <tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td> 95</td><td>0.4774655</td></tr>
 <tr><td> 96</td><td>0.4785149</td></tr>
 <tr><td> 97</td><td>0.4804244</td></tr>
 <tr><td> 98</td><td>0.4785063</td></tr>
 <tr><td> 99</td><td>0.4797440</td></tr>
 <tr><td>100</td><td>0.4802833</td></tr>
</tbody>
</table>

- å¯¹è¿­ä»£æ¬¡æ•°åŠéªŒè¯å¯¹æ•°æŸå¤±å¯è§†åŒ–

```r
lrn_xgb$model$evaluation_log %>%
    ggplot(aes(x = iter, y = test_logloss)) + 
    geom_line() +
    theme_minimal()
```

![image_1](./image_1.png)

- å¯ä»¥é€šè¿‡Â `$internal_valid_scores`Â å­—æ®µè®¿é—®æ­¤æ€§èƒ½
  - è¯¥å­—æ®µæ˜¯ä¸€ä¸ªå‘½ååˆ—è¡¨ï¼Œå¯åŒ…å«å¤šä¸ªéªŒè¯æŒ‡æ ‡

```r
lrn_xgb$internal_valid_scores
```

```js
$logloss = 0.480283279483969
```

- å°†Â `validate`Â å­—æ®µè®¾ç½®ä¸ºÂ `'predefined'`ï¼Œ  
  å¯ä»¥å¯¹éªŒè¯æ•°æ®è¿›è¡Œå¦‚æ­¤ç²¾ç»†çš„æ§åˆ¶

```r
lrn_xgb$validate = 'predefined'
```

- è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨è®­ç»ƒä»»åŠ¡ä¸­å®šä¹‰çš„ `$internal_valid_task`
- ä¸‹é¢å°†éªŒè¯ä»»åŠ¡è®¾ç½®ä¸ºä½¿ç”¨60ä¸ªéšæœºé‡‡æ ·çš„IDï¼Œ  
  å¹¶å°†å®ƒä»¬ä»ä¸»è¦ä»»åŠ¡ä¸­ç§»é™¤

```r
# éšæœºé‡‡æ ·60ä¸ª
valid_ids <- sample(tsk_sonar$nrow, 60)
# æ–°å»ºç§»é™¤è¿‡è¿™60ä¸ªæ ·æœ¬çš„éªŒè¯ä»»åŠ¡
tsk_valid <- tsk_sonar$clone(deep = TRUE)
tsk_valid$filter(valid_ids)
tsk_sonar$filter(setdiff(tsk_sonar$row_ids, valid_ids))
# å®šä¹‰ç”¨äºå†…éƒ¨éªŒè¯çš„æ ·æœ¬
tsk_sonar$internal_valid_task <- tsk_valid
```

- å¯ä»¥æŸ¥çœ‹ç”¨äºå†…éƒ¨éªŒè¯çš„æ ·æœ¬å’Œè®­ç»ƒç”¨æ ·æœ¬çš„ä¸ªæ•°

```r
c(tsk_sonar$internal_valid_task$nrow, tsk_sonar$nrow)
```

```js
[1]  60 148
```

- è®­ç»ƒæ¨¡å‹
  - å­¦ä¹ å™¨å°†åœ¨æŒ‡å®šçš„é¢å¤–ä»»åŠ¡ä¸Šè¿›è¡Œè‡ªæˆ‘éªŒè¯
  - `$internal_valid_task`Â æ’æ§½å§‹ç»ˆåœ¨å†…éƒ¨ä½¿ç”¨ï¼Œ  
   å³ä½¿åœ¨Â `learner$validate`Â ä¸­è®¾ç½®äº†ä¸€ä¸ªæ¯”ç‡å€¼ï¼Œ  
   å®ƒä¹Ÿåªæ˜¯è‡ªåŠ¨æ„å»ºï¼ˆç„¶åä¼ é€’ä¸‹å»ï¼‰

```r
lrn_xgb$train(tsk_sonar)
```

- éªŒè¯ä¹Ÿèƒ½åœ¨`GraphLearner`ä¸­è¿›è¡Œï¼Œ  
  å› ä¸ºé¢„å¤„ç†`PipeOp`ä¹Ÿå¤„ç†éªŒè¯ä»»åŠ¡
- è™½ç„¶`PipeOp`çš„è®­ç»ƒé€»è¾‘åº”ç”¨äºä¸»è¦ä»»åŠ¡ï¼Œ  
  ä½†é¢„æµ‹é€»è¾‘åº”ç”¨äºéªŒè¯æ•°æ®
  - è¿™ç¡®ä¿äº†åœ¨XGBoostå­¦ä¹ å™¨åœ¨éªŒè¯æ•°æ®ä¸Š  
   è¯„ä¼°å…¶æ€§èƒ½æ—¶ä¸ä¼šå‡ºç°æ•°æ®æ³„éœ²

- ä¸‹ä¾‹ä¸­æ„å»º`PipeOpPCA`å¹¶å°†å…¶åº”ç”¨äºå¸¦æœ‰éªŒè¯ä»»åŠ¡çš„`tsk('sonar')`

```r
po_pca <- po('pca')
taskout <- po_pca$train(list(tsk_sonar))[[1]]
taskout$internal_valid_task
```

```js
[36m--[39m [1m[34m<TaskClassif>[39m (60x61): Sonar: Mines vs. Rocks[22m [36m-------------------------------[39m
* Target: Class
* Target classes: M (positive class, 60%), R (40%)
* Properties: twoclass
* Features (60):
  * dbl (60): PC1, PC10, PC11, PC12, PC13, PC14, PC15, PC16, PC17, PC18, PC19,
  PC2, PC20, PC21, PC22, PC23, PC24, PC25, PC26, PC27, PC28, PC29, PC3, PC30,
  PC31, PC32, PC33, PC34, PC35, PC36, PC37, PC38, PC39, PC4, PC40, PC41, PC42,
  PC43, PC44, PC45, PC46, PC47, PC48, PC49, PC5, PC50, PC51, PC52, PC53, PC54,
  PC55, PC56, PC57, PC58, PC59, PC6, PC60, PC7, PC8, PC9
```

- åœ¨`$train()`æœŸé—´åº”ç”¨äº`$internal_valid_task`çš„é¢„å¤„ç†ï¼Œ  
  ç­‰åŒäºå¯¹å…¶è¿›è¡Œé¢„æµ‹

```r
po_pca$predict(list(tsk_sonar$internal_valid_task))[[1L]]
```

```js
[36m--[39m [1m[34m<TaskClassif>[39m (60x61): Sonar: Mines vs. Rocks[22m [36m-------------------------------[39m
* Target: Class
* Target classes: M (positive class, 60%), R (40%)
* Properties: twoclass
* Features (60):
  * dbl (60): PC1, PC10, PC11, PC12, PC13, PC14, PC15, PC16, PC17, PC18, PC19,
  PC2, PC20, PC21, PC22, PC23, PC24, PC25, PC26, PC27, PC28, PC29, PC3, PC30,
  PC31, PC32, PC33, PC34, PC35, PC36, PC37, PC38, PC39, PC4, PC40, PC41, PC42,
  PC43, PC44, PC45, PC46, PC47, PC48, PC49, PC5, PC50, PC51, PC52, PC53, PC54,
  PC55, PC56, PC57, PC58, PC59, PC6, PC60, PC7, PC8, PC9
```

- è¿™æ„å‘³ç€ï¼Œå³ä½¿åœ¨å¤æ‚çš„å›¾å­¦ä¹ å™¨ä¸­ï¼Œè·Ÿè¸ªéªŒè¯æ€§èƒ½ä¹Ÿèƒ½å‘æŒ¥ä½œç”¨ï¼Œ  
  è€Œå¦‚æœåªæ˜¯ç®€å•è®¾ç½®XGBoostçš„`watchlist`å‚æ•°æ˜¯ä¸å¯èƒ½å®ç°çš„
- ä¸‹é¢å°†PCAç®—å­ä¸XGBoostè¡”æ¥èµ·æ¥ï¼Œ  
  å¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ª`GraphLearner`

```r
glrn <- as_learner(po_pca %>>% lrn_xgb)
```

- è™½ç„¶è¿™æ ·å‡ ä¹å°±èƒ½å¥æ•ˆï¼Œä½†ç°åœ¨éœ€è¦åœ¨ä¸¤ä¸ªå±‚é¢ä¸ŠæŒ‡å®š $validate å­—æ®µï¼š
- å¯¹äº`GraphLearner`æœ¬èº«ï¼Œ  
  å³åœ¨`Task`è¿›å…¥`Graph`ä¹‹å‰ï¼ŒéªŒè¯æ•°æ®æ˜¯å¦‚ä½•åˆ›å»ºçš„
- å“ªäº›å…·æœ‰`â€œvalidationâ€`å±æ€§çš„`PipeOp`å®é™…ä¸Šåº”è¯¥ä½¿ç”¨å®ƒ

- é€šè¿‡ä½¿ç”¨Â `set_validate()`Â å¯ä»¥ç®€åŒ–æ­¤é…ç½®ã€‚å½“åº”ç”¨äºÂ `GraphLearner`Â æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå‚æ•°Â `validate`ï¼Œå®ƒå†³å®šäº†**å¦‚ä½•**åˆ›å»ºéªŒè¯æ•°æ®ï¼Œè¿˜å¯ä»¥é€‰æ‹©æ€§åœ°æŒ‡å®šå‚æ•°Â `ids`ï¼Œå®ƒæŒ‡å®šäº†**å“ªäº›**Â `PipeOp`Â åº”è¯¥ä½¿ç”¨è¯¥æ•°æ®
- é»˜è®¤æƒ…å†µä¸‹ï¼Œåè€…è®¾ç½®ä¸º  
  `Graph`Â çš„Â `$base_learner()`ï¼Œ  
  å³æœ€åä¸€ä¸ªå­¦ä¹ å™¨
  - è¿™æ„å‘³ç€ä»¥ä¸‹ä¸¤ä¸ªè°ƒç”¨æ˜¯ç­‰æ•ˆçš„ï¼š

```r
set_validate(glrn, validate = 'predefined')
set_validate(glrn, validate = 'predefined', ids = 'classif.xgboost')
```

- ç°åœ¨å¯ä»¥åƒä¹‹å‰ä¸€æ ·è®­ç»ƒ`GraphLearner`ï¼Œ  
  å¹¶æ£€æŸ¥æœ€ç»ˆçš„éªŒè¯æŒ‡æ ‡
  - è¯¥æŒ‡æ ‡ç°åœ¨ä¼šåŠ ä¸Šç›¸åº”`PipeOp`çš„IDä½œä¸ºå‰ç¼€

```r
glrn$validate = 'predefined'
glrn$train(tsk_sonar)
glrn$internal_valid_scores
```

```js
$classif.xgboost.logloss = 0.427817946910121
```

- **æ³¨æ„**ï¼š
  - ç”±äºå•ä¸ª`PipeOp`æ— æ³•æ§åˆ¶éªŒè¯æ•°æ®çš„ç”Ÿæˆæ–¹å¼ï¼Œ  
   åªèƒ½æ§åˆ¶æ˜¯å¦ä½¿ç”¨éªŒè¯æ•°æ®ï¼Œ  
   å› æ­¤å…¶`$validate`å­—æ®µåªèƒ½è®¾ç½®ä¸º`NULL`æˆ–`'predefined'`
  - è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨è¿è¡Œ  
   `as_pipeop(lrn('classif.xgboost', validate = 0.3))`æ—¶ä¼šå‡ºé”™
  - åœ¨`GraphLearner`ä¸­ä½¿ç”¨éªŒè¯æ—¶ï¼Œ  
   **æœ€å¥½å…ˆæ„å»ºä¸æŒ‡å®šéªŒè¯æ•°æ®çš„å­¦ä¹ å™¨**ï¼Œ  
   ç„¶åä½¿ç”¨`set_validate()`ã€‚

## å†…éƒ¨è°ƒä¼˜

- XGBoostä¸ä»…å¯ä»¥è®°å½•å…¶éªŒè¯æ€§èƒ½ï¼Œè¿˜å¯ä»¥å¯¹å…¶è¿›è¡Œç›‘æ§ï¼Œ  
  ä»¥ä¾¿æå‰åœæ­¢è®­ç»ƒ
  - å³åœ¨è®­ç»ƒæœŸé—´å¯¹`nrounds`è¶…å‚æ•°è¿›è¡Œå†…éƒ¨è°ƒæ•´
- è¿™ç”±`'internal_tuning'`å±æ€§æ ‡è®°ï¼š

```r
'internal_tuning' %in% lrn_xgb$properties
```

```js
TRUE
```

- XGBoostå¯ä»¥é€šè¿‡æŒ‡å®š`early_stopping_rounds`å‚æ•°æ¥  
  å¯ç”¨æå‰åœæ­¢
  - è¿™ä¹Ÿè¢«ç§°ä¸º**è€å¿ƒå€¼**ï¼Œ  
   å®ƒæŒ‡å®šäº†åœ¨è®­ç»ƒç»ˆæ­¢å‰ï¼Œ  
   éªŒè¯æŸå¤±åœ¨å¤šå°‘è½®è¿­ä»£ä¸­æ²¡æœ‰æ”¹å–„
- ç”¨äºæå‰åœæ­¢çš„æŒ‡æ ‡æ˜¯ä¼ é€’ç»™`eval_metric`çš„ç¬¬ä¸€ä¸ªå€¼ï¼Œ  
  å³å¯¹æ•°æŸå¤±

```r
lrn_xgb$param_set$set_values(
  early_stopping_rounds = 10,
  nrounds = 100
)
```

- å½“è®­ç»ƒå­¦ä¹ å™¨æ—¶ï¼Œ  
  å¯é€šè¿‡Â `$internal_tuned_values`Â å­—æ®µ  
  è®¿é—®å†…éƒ¨ä¼˜åŒ–çš„Â `nrounds`

```r
lrn_xgb$train(tsk_sonar)
lrn_xgb$internal_tuned_values
```

```js
$nrounds = 17
```

- é€šè¿‡ä½¿ç”¨æå‰åœæ­¢ç­–ç•¥ï¼Œåœ¨20æ¬¡è¿­ä»£åå°±èƒ½å¤Ÿç»ˆæ­¢è®­ç»ƒ
- å°†éªŒè¯æŸå¤±éšæ—¶é—´çš„å˜åŒ–è¿›è¡Œå¯è§†åŒ–ï¼Œæœ€ä¼˜çš„è½®æ•°ç”¨çº¢è‰²æ ‡è®°
  - ç”±äºè€å¿ƒå€¼çš„è®¾ç½®ï¼Œè®­ç»ƒåœ¨ä¹‹åä»æŒç»­äº†ä¸€æ®µæ—¶é—´

```r
lrn_xgb$model$evaluation_log %>%
    ggplot(aes(x = iter, y = test_logloss)) + 
    geom_line() +
    # lrn_xgb$model$evaluation_log[17]
    geom_point(
     aes(x = 17, y = 0.3503711), 
     color = 'red'
 ) + 
    theme_minimal()
```

![image_2](./image_2.png)

- ç›®å‰ä¸ºæ­¢ä»…ä½¿ç”¨äº†XGBoostçš„æå‰åœæ­¢å®ç°æ¥ä¼˜åŒ–`nrounds`ï¼Œ  
  å°šæœªè°ƒæ•´ä»»ä½•å…¶ä»–è¶…å‚æ•°
  - è¿™å°±æ˜¯`mlr3`å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ï¼Œ  
   å› ä¸ºå®ƒå…è®¸æˆ‘ä»¬å°†å­¦ä¹ å™¨çš„å†…éƒ¨è°ƒæ•´ä¸  
   é€šè¿‡`mlr3tuning`è¿›è¡Œçš„ï¼ˆéå†…éƒ¨ï¼‰è¶…å‚æ•°è°ƒæ•´ç›¸ç»“åˆ
- å°†ä¸¤ä¸ªå‚æ•°éƒ½æ ‡è®°ä¸º`to_tune()`ï¼Œ  
  ä½†å°†`nrounds`æ ‡è®°ä¸ºè¿›è¡Œå†…éƒ¨è°ƒæ•´

```r
lrn_xgb$
 param_set$
 set_values(
  eta = to_tune(0.001, 0.1, logscale = TRUE),
  nrounds = to_tune(upper = 500, internal = TRUE)
)
```

- é€šå¸¸å¯èƒ½å¸Œæœ›ä½¿ç”¨ç›¸åŒçš„éªŒè¯æ•°æ®æ¥ä¼˜åŒ–`eta`å’Œ`nrounds`
  - é€šè¿‡æŒ‡å®š`validate`å­—æ®µä¸º`'test'`é€‰é¡¹å¯ä»¥å®ç°
  - è¿™æ„å‘³ç€åœ¨æ¯æ¬¡é‡é‡‡æ ·è¿­ä»£ä¸­ï¼Œ  
   éªŒè¯æ•°æ®å°†è®¾ç½®ä¸ºæµ‹è¯•é›†ï¼Œ  
   åŒæ ·ä¹Ÿå°†ç”¨äºè¯„ä¼°å‚æ•°é…ç½®ï¼ˆä»¥è°ƒæ•´`eta`ï¼‰çš„æ•°æ®

```r
lrn_xgb$validate = 'test'
```

- å°†ç»§ç»­ä½¿ç”¨ç®€å•çš„ç½‘æ ¼æœç´¢æ¥è°ƒæ•´XGBoostï¼Œ  
  è¿›è¡Œ10æ¬¡è¯„ä¼°ï¼Œå¹¶é‡‡ç”¨3æŠ˜äº¤å‰éªŒè¯è¿›è¡Œå†…éƒ¨é‡é‡‡æ ·
- åœ¨å†…éƒ¨ï¼Œè¿™å°†ä½¿ç”¨10ä¸ªä¸åŒçš„Â `eta`Â å€¼æ¥è®­ç»ƒXGBoostï¼Œ  
  åŒæ—¶å°†Â `nrounds`Â å‚æ•°å›ºå®šä¸º500ï¼Œå³ä¸Šè¿°çš„ä¸Šé™
- å¯¹äºæ¯ä¸ªÂ `eta`Â å€¼ï¼Œå°†æ‰§è¡Œå¸¦æœ‰æ—©åœæ³•çš„3æŠ˜äº¤å‰éªŒè¯ï¼Œ  
  ä»è€Œä¸ºæ¯ä¸ªÂ `eta`Â å€¼ç”Ÿæˆ3ä¸ªï¼ˆå¯èƒ½ä¸åŒçš„ï¼‰æ—©åœçš„Â `nrounds`Â å€¼
  - è¿™äº›å€¼ä¼šæ ¹æ®èšåˆè§„åˆ™åˆå¹¶ä¸ºå•ä¸ªå€¼
  - é»˜è®¤æƒ…å†µä¸‹è®¾ç½®ä¸ºå–å¹³å‡å€¼ï¼Œ  
   ä½†åœ¨åˆ›å»ºå†…éƒ¨è°ƒä¼˜ä»¤ç‰Œæ—¶å¯ä»¥è¦†ç›–è¯¥è§„åˆ™

- å½“é€šè¿‡`mlr3tuning`å°†å†…éƒ¨è°ƒä¼˜ä¸è¶…å‚æ•°ä¼˜åŒ–ç›¸ç»“åˆæ—¶ï¼Œ  
  éœ€è¦æŒ‡å®šä¸¤ä¸ªæ€§èƒ½æŒ‡æ ‡ï¼š
  - ä¸€ä¸ªç”¨äºå†…éƒ¨è°ƒä¼˜
  - å¦ä¸€ä¸ªç”¨äº`Tuner`
- å› æ­¤ï¼Œå³ä½¿å­˜åœ¨é»˜è®¤å€¼ï¼Œ  
  `mlr3`è¦æ±‚æ˜¾å¼è®¾ç½®å†…éƒ¨è°ƒä¼˜æŒ‡æ ‡

- æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åœ¨ä¸¤ç§ç±»å‹çš„è¶…å‚æ•°ä¼˜åŒ–ä¸­ä½¿ç”¨ç›¸åŒçš„æŒ‡æ ‡ï¼š
  - `msr('internal_valid_scores', select = <id>)`
    - æœ€ç»ˆéªŒè¯åˆ†æ•°
    - ç”±äºä¸€ä¸ªå­¦ä¹ å™¨å¯èƒ½æœ‰å¤šä¸ªå†…éƒ¨éªŒè¯åˆ†æ•°ï¼Œ  
    è¯¥æŒ‡æ ‡å…è®¸é€šè¿‡æŒ‡å®š`select`å‚æ•°æ¥é€‰æ‹©å…¶ä¸­ä¸€ä¸ª
    - å¦‚æœæœªæŒ‡å®šæ­¤å‚æ•°ï¼Œå°†ä½¿ç”¨ç¬¬ä¸€ä¸ªéªŒè¯æŒ‡æ ‡
    - æˆ‘ä»¬è¿˜éœ€è¦æŒ‡å®šè¯¥æŒ‡æ ‡æ˜¯å¦åº”æœ€å°åŒ–
  - å°†`eval_metric`å’Œè°ƒä¼˜åº¦é‡éƒ½è®¾ç½®ä¸ºåŒä¸€æŒ‡æ ‡
    - ä¾‹å¦‚ï¼Œ`eval_metric = 'error'`ä¸”  
    `measure = msr('classif.ce')`
    - æœ‰äº›å­¦ä¹ å™¨ç”šè‡³å…è®¸å°†  
    éªŒè¯æŒ‡æ ‡è®¾ç½®ä¸ºä¸€ä¸ª`mlr3::Measure`
    - å¯ä»¥é€šè¿‡æŸ¥çœ‹ç›¸åº”çš„æ–‡æ¡£æ¥äº†è§£å“ªäº›å­¦ä¹ å™¨æ”¯æŒæ­¤åŠŸèƒ½
- ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰é¡¹çš„ä¼˜åŠ¿åœ¨äºå¯ä»¥è·³è¿‡é¢„æµ‹æ­¥éª¤ï¼Œ  
  å› ä¸ºå†…éƒ¨éªŒè¯åˆ†æ•°åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å·²ç»è®¡ç®—å¥½äº†
- **æ³¨æ„**ï¼š
  - ä½¿ç”¨Â `GraphLearner`Â æ—¶ï¼Œ  
   å†…éƒ¨éªŒè¯åˆ†æ•°çš„åç§°ä¼šä»¥ç›¸åº”Â `PipeOp`Â çš„ ID ä¸ºå‰ç¼€
  - å› æ­¤Â `select`Â å‚æ•°éœ€è¦è®¾ç½®ä¸º  
   Â `'<pipeop id>.<measure id>'`

```r
tsk_sonar <- tsk('sonar')
lrn_xgb$predict_sets = NULL

ti <- tune(
 tuner = tnr('grid_search'),
 learner = lrn_xgb,
 task = tsk_sonar,
 resampling = rsmp('cv', folds = 3),
 measure = msr('internal_valid_score',
    select = 'logloss', minimize = TRUE),
 term_evals = 10L
)
```

- è°ƒä¼˜ç»“æœåŒ…å«ä¸ºÂ `eta`Â å’ŒÂ `nrounds`Â æ‰¾åˆ°çš„æœ€ä½³é…ç½®

```r
ti$result_learner_param_vals[c('eta', 'nrounds')]
```

```js
$eta
[1] 0.1

$nrounds
[1] 66
```

- ä¸‹é¢å±•ç¤ºå¦‚ä½•ä»è°ƒä¼˜å­˜æ¡£ä¸­æå–ä¸åŒçš„å‚æ•°é…ç½®
  - æ‰€æœ‰å†…éƒ¨è°ƒä¼˜çš„å‚æ•°éƒ½å¯ä»¥é€šè¿‡  
   Â `$internal_tuned_values`Â è®¿é—®
  - è¿™æ˜¯ä¸€ä¸ªåˆ—è¡¨åˆ—ï¼Œ  
   å› ä¸ºåœ¨å†…éƒ¨æœ‰å¯èƒ½å¯¹å¤šä¸ªå‚æ•°è¿›è¡Œè°ƒä¼˜
    - ä¾‹å¦‚åœ¨Â `GraphLearner`Â ä¸­
  - æå–Â `eta`Â çš„å€¼ï¼ˆä»å¯¹æ•°å°ºåº¦è½¬æ¢å›åŸå€¼ï¼‰ã€`nrounds`ï¼ˆå†…éƒ¨è°ƒä¼˜ï¼‰å’Œå¯¹æ•°æŸå¤±
  - åè€…æ˜¯åœ¨å†…éƒ¨éªŒè¯ä»»åŠ¡ä¸Šè¯„ä¼°çš„ï¼Œ  
   æ­£å¦‚æŒ‡å®šÂ `validate = "test"`Â æ—¶ï¼Œ  
   è¿™äº›ä»»åŠ¡å¯¹åº”äºÂ `Resampling`Â çš„æµ‹è¯•é›†
- é€šè¿‡å¯è§†åŒ–ç»“æœï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªè°ƒä¼˜å‚æ•°ä¹‹é—´çš„åæ¯”å…³ç³»ï¼š  
  è¾ƒå°çš„æ­¥é•¿ï¼ˆ`eta`ï¼‰éœ€è¦æ›´å¤šçš„æå‡è¿­ä»£æ¬¡æ•°ï¼ˆ`nrounds`ï¼‰

```r
d <- ti$archive$data

d <- data.table(
  eta = exp(d$eta),
  nrounds = unlist(d$internal_tuned_values),
  logloss = d$logloss
)

ggplot(data = d, aes(x = eta, y = nrounds, color = logloss)) +
  geom_point() + theme_minimal()
```

![image_3](./image_3.png)

- è¿™åŒæ ·é€‚ç”¨äº `AutoTuner`
  - å®ƒå°†åœ¨æœ€ç»ˆæ¨¡å‹æ‹Ÿåˆæ—¶ä½¿ç”¨å†…éƒ¨ä¼˜åŒ–çš„`nrounds`ä»¥åŠ  
   ç¦»çº¿è°ƒä¼˜çš„`eta`
  - è¿™æ„å‘³ç€åœ¨è®­ç»ƒæœ€ç»ˆæ¨¡å‹æ—¶  
   ä¸è¿›è¡ŒéªŒè¯æˆ–æå‰åœæ­¢ï¼Œä¼šä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„æ•°æ®

```r
at <- auto_tuner(
 tuner = tnr('grid_search'),
 learner = lrn_xgb,
 resampling = rsmp('cv', folds = 3),
 measure = msr('internal_valid_score',
 select = 'logloss', minimize = TRUE),
 term_evals = 10L
)

at$train(tsk_sonar)
```

- åœ¨ä½¿ç”¨é‡é‡‡æ ·çš„æµ‹è¯•é›†è¿›è¡ŒéªŒè¯æ—¶å¿…é¡»è°¨æ…
  - è¿™æ ·åšæ˜¯å¦å¯è¡Œå–å†³äºé‡é‡‡æ ·çš„èƒŒæ™¯å’Œç›®çš„
  - å¦‚æœé‡é‡‡æ ·çš„ç›®çš„æ˜¯ä¸ºäº†è·å¾—ç®—æ³•çš„æ— åæ€§èƒ½ä¼°è®¡ï¼Œ  
   è€Œå…¶ä¸­ä¸€äº›ç®—æ³•ä¼šæå‰åœæ­¢ï¼Œå¦ä¸€äº›åˆ™ä¸ä¼šï¼Œ  
   **é‚£ä¹ˆè¿™æ ·åšæ˜¯ä¸è¡Œçš„**
  - åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‰è€…ç›¸å¯¹äºåè€…ä¼šæœ‰ä¸å…¬å¹³çš„ä¼˜åŠ¿
- ä¸‹é¢çš„ä¾‹å­è¯´æ˜äº†è¿™æ ·ä¸€ç§æƒ…å†µï¼Œ  
  å³ä¸¤ä¸ªå­¦ä¹ å™¨ä¹‹é—´çš„æ¯”è¾ƒå¹¶ä¸å…¬å¹³ã€‚

```r
lrn_xgb$
 param_set$
 set_values(
  eta = 0.1, 
  nrounds = 500, 
  early_stopping_rounds = 10
)
lrn_xgb$predict_sets = 'test'

design <- benchmark_grid(
 tsk_sonar, 
 list(lrn_xgb, lrn('classif.rpart')), 
 rsmp('cv', folds = 3)
)
bmr <- benchmark(design)

bmr$aggregate(msr('classif.ce'))
```

<table class='dataframe'>
<caption>A bmr_aggregate: 2 x 7</caption>
<thead>
 <tr><th scope=col>nr</th><th scope=col>resample_result</th><th scope=col>task_id</th><th scope=col>learner_id</th><th scope=col>resampling_id</th><th scope=col>iters</th><th scope=col>classif.ce</th></tr>
 <tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>1</td><td>&lt;environment: 0x30f88fee8&gt;</td><td>sonar</td><td>classif.xgboost</td><td>cv</td><td>3</td><td>0.1828847</td></tr>
 <tr><td>2</td><td>&lt;environment: 0x30f86d388&gt;</td><td>sonar</td><td><span style=white-space:pre-wrap>classif.rpart  </span></td><td>cv</td><td>3</td><td>0.3124224</td></tr>
</tbody>
</table>

- ä½¿ç”¨Â `to_tune()`Â è™½ç„¶æ›´æ–¹ä¾¿ï¼Œ  
  ä½†æ‰‹åŠ¨å®šä¹‰æœç´¢ç©ºé—´åœ¨å‚æ•°è½¬æ¢æ–¹é¢èƒ½æä¾›æ›´å¤§çš„çµæ´»æ€§
  - ä½¿ç”¨Â `ps()`Â å‡½æ•°æ‰‹åŠ¨æŒ‡å®šæœç´¢ç©ºé—´æ—¶å¯ç”¨å†…éƒ¨è°ƒä¼˜
  - å°†å†…éƒ¨è°ƒä¼˜å‚æ•°åŒ…å«åœ¨Â `search_space`Â ä¸­ï¼Œ  
   ä½†éœ€è¦æŒ‡å®šä¸€ä¸ªèšåˆå‡½æ•°å¹¶ç”¨  
   Â `'internal_tuning'`Â æ ‡è®°å®ƒä»¬

```r
search_space <- ps(
 eta = p_dbl(0.001, 0.1, logscale = TRUE),
 nrounds = p_int(
  upper = 500, 
  tags = 'internal_tuning',
  aggr = function(x) as.integer(mean(unlist(x)))
 )
)
```

- è¿™ä¸ªæœç´¢ç©ºé—´å¯ä»¥ä¼ é€’ç»™`AutoTuner`ï¼Œ  
  ç„¶åä¼˜åŒ–å°†åƒä»¥å‰ä¸€æ ·ç»§ç»­è¿›è¡Œ

```r
at <- auto_tuner(
 tuner = tnr('grid_search'),
 learner = lrn_xgb,
 resampling = rsmp('cv', folds = 3),
 measure = msr('internal_valid_score',
 select = 'logloss', minimize = TRUE),
 search_space = search_space,
 term_evals = 10L
)

at$train(tsk_sonar)
```
