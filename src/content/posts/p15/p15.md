---
title: 'ã€mlr3ã€‘6.å›å½’ä¸åˆ†ç±»ä»¥å¤–é—®é¢˜'
published: 2025-07-17
image: './p15_cover.jpg'
description: 'mlr3å›å½’ä¸åˆ†ç±»ä»¥å¤–é—®é¢˜'
category: 'Machine Learning'
tags: [mlr3,R,ZH-CN]
draft: false 
lang: 'en'
---
> - Cover Pic by [@bybao](https://www.pixiv.net/artworks/132241477)  

> [Applied Machine Learning Using mlr3 in R](https://mlr3book.mlr-org.com/)

## ç®€ä»‹

- `mlr3`ä¸­ä¸»è¦çš„åŒ…å«4ä¸ª**æ„å»ºå—**ï¼ˆbuilding blockï¼‰
  - `Task`
  - `Learner`
  - `Prediction`
  - `Measure`

- éƒ¨åˆ†å¯ä¸`mlr3`æ¡†æ¶é…åˆä½¿ç”¨çš„æ‰©å±•ä»»åŠ¡è¡¨

| Task                                      | Package                              | Description                                                                                             |
| ----------------------------------------- | ------------------------------------ | ------------------------------------------------------------------------------------------------------- |
| Deterministic regression                  | `mlr3`                               | Point prediction of a continuous variable.                                                              |
| Deterministic single-label classification | `mlr3`                               | Prediction of a single class for each observation.                                                      |
| Probabilistic single-label classification | `mlr3`                               | Prediction of the probability of an observation falling into one or more mutually exclusive categories. |
| Cost-sensitive classification             | `mlr3`Â andÂ `mlr3pipelines`           | Classification predictions with unequal costs associated with misclassifications.                       |
| Survival analysis                         | `mlr3proba`                          | Time-to-event predictions with possible â€˜censoringâ€™.                                                    |
| Density estimation                        | `mlr3proba`                          | Unsupervised estimation of probability density functions.                                               |
| Spatiotemporal analysis                   | `mlr3spatiotempcv`Â andÂ `mlr3spatial` | Supervised prediction of data with spatial (e.g., coordinates) and/or temporal outcomes.                |
| Cluster analysis                          | `mlr3cluster`                        | Unsupervised estimation of homogeneous clusters of data points.                                         |

## ä»£ä»·æ•æ„Ÿåˆ†ç±»ï¼ˆCost-Sensitive Classificationï¼‰

- ä»£ä»·æ•æ„Ÿåˆ†ç±»çš„ç›®æ ‡æ˜¯ä½¿é¢„æœŸä»£ä»·æœ€å°åŒ–
- ç¤ºä¾‹ä»»åŠ¡ï¼š`tsk('german_credit')`
- èƒŒæ™¯ï¼š  å‡è®¾è¯•å›¾è®¡ç®—å€Ÿç»™æŸäºº5000ç¾å…ƒï¼Œ  
  ä¸€å¹´åæ˜¯å¦èƒ½ç›ˆåˆ©ï¼Œå‰ææ˜¯é¢„è®¡ä»–ä»¬ä¼šå¿è¿˜6000ç¾å…ƒ
- ä¸ºäº†è¿›è¡Œè¿™ä¸ªè®¡ç®—ï¼Œä½ éœ€è¦é¢„æµ‹è¿™ä¸ªäººæ˜¯å¦æœ‰è‰¯å¥½çš„ä¿¡ç”¨
  - è¿™æ˜¯ä¸€ä¸ªç¡®å®šæ€§åˆ†ç±»é—®é¢˜ï¼Œéœ€è¦é¢„æµ‹æŸäººå±äº'å¥½'æˆ–'å'ç±»åˆ«
  - ç°åœ¨è®©è€ƒè™‘ä¸æ¯ä¸ªé¢„æµ‹å’Œæœ€ç»ˆç»“æœç›¸å…³çš„ä¸€äº›æ½œåœ¨æˆæœ¬
    - ç”±äºæˆæœ¬æ•æ„Ÿåˆ†ç±»æ˜¯ä¸€ä¸ªæœ€å°åŒ–é—®é¢˜ï¼Œ  
    å‡è®¾æˆæœ¬è¶Šä½ï¼Œåˆ©æ¶¦/ç§¯æç»“æœå°±è¶Šé«˜ï¼Œ  
    å› æ­¤å°†åˆ©æ¶¦è®°ä¸ºè´Ÿå€¼ï¼ŒæŸå¤±è®°ä¸ºæ­£å€¼

```r
costs <- matrix(
 c(
  # é¢„æµ‹å®ˆä¿¡ä¸”çœŸå®ˆä¿¡
  -1, # èµš1000
  # é¢„æµ‹å¤±ä¿¡ä½†å®ˆä¿¡
  0, # æ— å¾—å¤±ï¼Œå› ä¸ºä¸ä¼šå€Ÿ
  # é¢„æµ‹å®ˆä¿¡ä½†å¤±ä¿¡
  5, # æ‰“æ°´é£˜ï¼Œäº5000
  # é¢„æµ‹å¤±ä¿¡ä¸”çœŸå¤±ä¿¡
  0 # æ— å¾—å¤±ï¼Œå› ä¸ºä¸ä¼šå€Ÿ
 ), 
 nrow = 2, 
 dimnames = list(
  'Predicted Credit' = c('good', 'bad'),
  Truth = c('good', 'bad')
 )
)

costs
```

```js
                Truth
Predicted Credit good bad
            good -1   5  
            bad   0   0  
```

### æˆæœ¬æ•æ„Ÿåº¦é‡

- `msr('classif.costs')`
  - `cost`ä¼ é€’æˆæœ¬è®¡ç®—çŸ©é˜µ

```r
# åŠ è½½RåŒ…
# library(mlr3verse)

# ä»»åŠ¡
tsk_german <- tsk('german_credit')
# è¯„ä¼°å™¨
msr_costs <- msr('classif.costs', costs = costs)
# æŸ¥çœ‹è¯„ä¼°å™¨
msr_costs
```

```js
[36m--[39m [1m[34m<MeasureClassifCosts>[39m (classif.costs): Cost-sensitive Classification[22m [36m--------[39m
* Packages: [34mmlr3[39m
* Range: [-Inf, Inf]
* Minimize: [34mTRUE[39m
* Average: macro
* Parameters: normalize=TRUE
* Properties: weights
* Predict type: response
* Predict sets: test
* Aggregator: mean()
```

- ä½¿ç”¨3ç§ç®—æ³•çš„å­¦ä¹ å™¨è¿›è¡Œbenchmarkæ¯”è¾ƒ
  - å¯ä»¥çœ‹åˆ°é€»è¾‘å›å½’å­¦ä¹ å™¨è¡¨ç°æœ€å¥½ï¼Œ  
   å› ä¸ºæœ‰æœ€ä½çš„æˆæœ¬

```r
learners <- lrns(
 c(
 'classif.log_reg', 
 'classif.featureless',
 'classif.ranger'
 )
)
bmr <- benchmark(
 benchmark_grid(
  tsk_german, 
  learners,
  rsmp('cv', folds = 3)
 )
)
bmr$aggregate(msr_costs)[, c(4, 7)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 3 x 2</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>classif.costs</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>classif.log_reg    </td><td>0.1608225</td></tr>
 <tr><td>classif.featureless</td><td>0.7999317</td></tr>
 <tr><td>classif.ranger     </td><td>0.2218926</td></tr>
</tbody>
</table>

### é˜ˆå€¼è°ƒæ•´

- ä¸‹å›¾ä¸ºä¸åŒæ¦‚ç‡åˆ¤æ–­é˜ˆå€¼æ—¶ï¼Œæˆæœ¬çš„æ›²çº¿å˜åŒ–
  - è™½ç„¶é»˜è®¤çš„é˜ˆå€¼æ˜¯`0.5`ï¼Œ  
   ä½†å¾ˆæ˜¾ç„¶ï¼Œé€šè¿‡æé«˜é˜ˆå€¼å¯ä»¥é™ä½æˆæœ¬

```r
prediction <- lrn(
 'classif.log_reg',
 predict_type ='prob'
)$train(tsk_german)$predict(tsk_german)

autoplot(
 prediction, 
 type = 'threshold', 
 measure = msr_costs
)
```

![image_1](./image_1.png)

- å¯¹`po('tunethreshold')`è¿›è¡Œè°ƒä¼˜ï¼Œ  
  ä»¥è‡ªåŠ¨ç¡®å®šæœ€ä¼˜é˜ˆå€¼
  - è¿‡ä½¿ç”¨`po('learner_cv')`è¿›è¡Œå†…éƒ¨é‡é‡‡æ ·ï¼Œ  
   å¹¶ä½¿ç”¨`po('tunethreshold')`æ¥å¯»æ‰¾æœ€ä½³é˜ˆå€¼ï¼Œ  
   æ˜¾è‘—æé«˜äº†æ¨¡å‹æ€§èƒ½ï¼Œç”šè‡³æœ‰æœ›å®ç°ç›ˆåˆ©

```r
po_cv <- po(
 'learner_cv', 
 lrn(
  'classif.log_reg', 
  predict_type = 'prob'
 )
)
graph <- po_cv %>>% po('tunethreshold', measure = msr_costs)

learners <- list(as_learner(graph), lrn('classif.log_reg'))
bmr <- benchmark(
 benchmark_grid(
  tsk_german, 
  learners,
  rsmp('cv', folds = 3)
 )
)

bmr$aggregate(msr_costs)[, c(4, 7)]
```

<table class='dataframe'>
<caption>A bmr_aggregate: 2 x 2</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>classif.costs</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>classif.log_reg.tunethreshold</td><td>-0.1270222</td></tr>
 <tr><td>classif.log_reg              </td><td> 0.1069962</td></tr>
</tbody>
</table>

## ç”Ÿå­˜åˆ†æï¼ˆSurvival Analysisï¼‰

### ç®€ä»‹

- ç”Ÿå­˜åˆ†æå»ºæ¨¡çš„å…³é”®åœ¨äºï¼Œå‡è®¾å­˜åœ¨ä¸€ä¸ªå‡è®¾æ—¶é—´ï¼Œ  
  å³å¦‚æœé©¬æ‹‰æ¾è¿åŠ¨å‘˜æ²¡æœ‰è¢«åˆ å¤±ï¼Œä»–ä»¬æœ¬åº”å®Œæˆæ¯”èµ›çš„æ—¶é—´
  - ç”Ÿå­˜åˆ†æå­¦ä¹ å™¨çš„ä»»åŠ¡å°±æ˜¯ä¼°è®¡ç±»ä¼¼è¿åŠ¨å‘˜åœ¨**æœªè¢«**åˆ å¤±çš„æƒ…å†µä¸‹çš„  
   çœŸå®ç”Ÿå­˜æ—¶é—´
- ä»æ•°å­¦è§’åº¦æ¥çœ‹ï¼Œå‡è®¾ç”¨äº‹ä»¶æ—¶é—´$Y$ï¼Œ  
  å‡è®¾åˆ å¤±æ—¶é—´$C$ï¼Œ  
  è§‚å¯Ÿåˆ°çš„ç»“æœæ—¶é—´$T=min(Y,C)$ï¼Œ
  äº‹ä»¶æŒ‡ç¤ºç¬¦$Î”:=(T=Y)$ä»¥åŠé€šå¸¸çš„ä¸€äº›ç‰¹å¾Xæ¥è¡¨ç¤º
- å­¦ä¹ å™¨åŸºäº$(T,Î”)$è¿›è¡Œè®­ç»ƒï¼Œ  
  ä½†å…³é”®çš„æ˜¯ï¼Œè¦æ ¹æ®ä¹‹å‰**æœªè§è¿‡çš„ç‰¹å¾**å¯¹Yè¿›è¡Œé¢„æµ‹
- è¿™æ„å‘³ç€ä¸åˆ†ç±»å’Œå›å½’ä¸åŒï¼Œå­¦ä¹ å™¨åŸºäº**ä¸¤ä¸ªå˜é‡**$(T,Î”)$è¿›è¡Œè®­ç»ƒ
  - åœ¨Rè¯­è¨€ä¸­ï¼Œè¿™é€šå¸¸ç”¨ä¸€ä¸ª`Surv`å¯¹è±¡æ¥è¡¨ç¤º
- Â `mlr3`Â åªèƒ½è®¨è®º**å³åˆ å¤±é—®é¢˜**

![image_2](./image_2.png)

- æœ¬ä¾‹ä¸­ï¼Œéšæœºç”Ÿæˆå…­ä¸ªç”Ÿå­˜æ—¶é—´å’Œå…­ä¸ªäº‹ä»¶æŒ‡ç¤ºç¬¦ï¼Œ  
  ç»“æœä¸­å¸¦æœ‰`+`è¡¨ç¤ºè¯¥ç»“æœè¢«åˆ å¤±ï¼Œ  
  å¦åˆ™è¡¨ç¤ºå‘ç”Ÿäº†æ„Ÿå…´è¶£çš„äº‹ä»¶

```r
# åŠ è½½RåŒ…
# library(survival)

# éšæœºç”Ÿæˆæ•°æ®ï¼Œç”¨`Surv`åŒ…è£…
Surv(runif(6), rbinom(6, 1, 0.5))
```

```js
[1] 0.33865314  0.82852654+ 0.20506836  0.05573181+ 0.48054274  0.44972267 
```

### TaskSurv

- ä½¿ç”¨ `as_task_surv()` åˆ›å»ºç”Ÿå­˜ä»»åŠ¡ï¼Œ  
  å¹¶æœ‰é¢å¤–å‚æ•°ï¼š
  - `time`ï¼šæ—¶é—´
  - `event`ï¼šäº‹ä»¶
  - `type`ï¼šç›®å‰åªèƒ½ä¸º`'right'`ä¸”é»˜è®¤

```r
# åŠ è½½RåŒ…
# library(mlr3verse)
# library(mlr3proba)
# library(survival)

tsk_rats <- as_task_surv(
 survival::rats, 
 time = 'time',
 event = 'status', 
 type = 'right', 
 id = 'rats'
)

tsk_rats$head()
```

<table class='dataframe'>
<caption>A data.table: 6 x 5</caption>
<thead>
 <tr><th scope=col>time</th><th scope=col>status</th><th scope=col>litter</th><th scope=col>rx</th><th scope=col>sex</th></tr>
 <tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
 <tr><td>101</td><td>0</td><td>1</td><td>1</td><td>f</td></tr>
 <tr><td> 49</td><td>1</td><td>1</td><td>0</td><td>f</td></tr>
 <tr><td>104</td><td>0</td><td>1</td><td>0</td><td>f</td></tr>
 <tr><td> 91</td><td>0</td><td>2</td><td>1</td><td>m</td></tr>
 <tr><td>104</td><td>0</td><td>2</td><td>0</td><td>m</td></tr>
 <tr><td>102</td><td>0</td><td>2</td><td>0</td><td>m</td></tr>
</tbody>
</table>

- ç»˜åˆ¶ Kaplan-Meier å›¾
  - è¯¥å›¾æ˜¯è®­ç»ƒé›†ä¸­å¹³å‡è§‚æµ‹å€¼ç”Ÿå­˜æ¦‚ç‡çš„éå‚æ•°ä¼°è®¡

```r
autoplot(tsk_rats)
```

![image_3](./image_3.png)

- åŠ è½½å…¶ä»–ç”¨äºç»ƒä¹ çš„ä»»åŠ¡

```r
as.data.table(mlr_tasks)[task_type == 'surv']
```

<table class='dataframe'>
<caption>A data.table: 10 x 15</caption>
<thead>
 <tr><th scope=col>key</th><th scope=col>label</th><th scope=col>task_type</th><th scope=col>nrow</th><th scope=col>ncol</th><th scope=col>properties</th><th scope=col>lgl</th><th scope=col>int</th><th scope=col>dbl</th><th scope=col>chr</th><th scope=col>fct</th><th scope=col>ord</th><th scope=col>pxc</th><th scope=col>dte</th><th scope=col>lt</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;list&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
 <tr><td>actg   </td><td>ACTG 320                   </td><td>surv</td><td>1151</td><td>13</td><td></td><td>0</td><td>3</td><td>4</td><td>0</td><td>4</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
 <tr><td>gbcs   </td><td>German Breast Cancer       </td><td>surv</td><td> 686</td><td>10</td><td></td><td>0</td><td>4</td><td>4</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
 <tr><td>gbsg   </td><td>German Breast Cancer       </td><td>surv</td><td> 686</td><td>10</td><td></td><td>0</td><td>5</td><td>0</td><td>0</td><td>3</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
 <tr><td>grace  </td><td>GRACE 1000                 </td><td>surv</td><td>1000</td><td> 8</td><td></td><td>0</td><td>2</td><td>4</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
 <tr><td>lung   </td><td>Lung Cancer                </td><td>surv</td><td> 168</td><td> 9</td><td></td><td>0</td><td>6</td><td>0</td><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
 <tr><td>mgus   </td><td>MGUS                       </td><td>surv</td><td> 176</td><td> 9</td><td></td><td>0</td><td>0</td><td>6</td><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
 <tr><td>pbc    </td><td>Primary Biliary Cholangitis</td><td>surv</td><td> 276</td><td>19</td><td></td><td>0</td><td>5</td><td>5</td><td>0</td><td>7</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
 <tr><td>rats   </td><td>Rats                       </td><td>surv</td><td> 300</td><td> 5</td><td></td><td>0</td><td>2</td><td>0</td><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
 <tr><td>veteran</td><td>Veteran                    </td><td>surv</td><td> 137</td><td> 8</td><td></td><td>0</td><td>3</td><td>0</td><td>0</td><td>3</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
 <tr><td>whas   </td><td>Worcester Heart Attack     </td><td>surv</td><td> 481</td><td>11</td><td></td><td>0</td><td>4</td><td>3</td><td>0</td><td>2</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
</tbody>
</table>

### `LearnerSurv`ï¼Œ`PredictionSurv` ä»¥åŠé¢„æµ‹ç±»å‹

- `mlr3proba`ä¸`mlr3`çš„é¢„æµ‹æ¥å£ä¸åŒ
  - å¯¹äºæ‰€æœ‰ç”Ÿå­˜æ¨¡å‹ï¼Œåªè¦æœ‰å¯èƒ½ï¼Œ  
   å°±ä¼šè¿”å›æ‰€æœ‰å¯èƒ½çš„é¢„æµ‹ç±»å‹
  - å¦‚æœä¸€ä¸ªæ¨¡å‹èƒ½å¤Ÿè®¡ç®—å‡ºç‰¹å®šçš„é¢„æµ‹ç±»å‹ï¼Œ  
   å®ƒå°±ä¼šåœ¨`PredictionSurv`ä¸­è¿”å›
  - åšå‡ºè¿™ç§è®¾è®¡å†³ç­–çš„åŸå› æ˜¯ï¼Œ  
   æ‰€æœ‰è¿™äº›é¢„æµ‹ç±»å‹éƒ½å¯ä»¥ç›¸äº’è½¬æ¢
    - å› æ­¤ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰ç±»å‹åœ¨è®¡ç®—ä¸Šæ¯”  
    é‡æ–°è¿è¡Œæ¨¡å‹ä»¥æ›´æ”¹é¢„æµ‹ç±»å‹æ›´ç®€å•
- å¯é¢„æµ‹çš„ç±»å‹
  - `response`ï¼šé¢„æµ‹çš„ç”Ÿå­˜æ—¶é—´
  - `distr`ï¼šé¢„æµ‹çš„ç”Ÿå­˜åˆ†å¸ƒï¼Œç¦»æ•£æˆ–è¿ç»­åˆ†å¸ƒå‡å¯
  - `lp`ï¼šé€šè¿‡å°†æ‹Ÿåˆç³»æ•°ä¸æµ‹è¯•æ•°æ®ç›¸ä¹˜è®¡ç®—å¾—å‡ºçš„çº¿æ€§é¢„æµ‹å€¼
  - `crank`ï¼šè¿ç»­é£é™©æ’å

```r
tsk_rats <- tsk('rats')
split <- partition(tsk_rats)
prediction_cph <- lrn('surv.coxph')$
 train(tsk_rats,split$train)$
 predict(tsk_rats, split$test)
prediction_cph
```

```js
[36m--[39m [1m[34m<PredictionSurv>[39m for [34m99[39m observations:[22m [36m---------------------------------------[39m
 row_ids time status      crank         lp     distr
       2   49   TRUE -0.5700703 -0.5700703 <list[1]>
       9  104  FALSE -0.5470661 -0.5470661 <list[1]>
      10   91  FALSE -2.1443968 -2.1443968 <list[1]>
     ---  ---    ---        ---        ---       ---
     286  104  FALSE -1.0862016 -1.0862016 <list[1]>
     295  104  FALSE  1.4477346  1.4477346 <list[1]>
     296  104  FALSE  0.5571376  0.5571376 <list[1]>
```

#### `predict_type = 'response'`

- ä»é¢„æµ‹çš„ç»“æœçœ‹å‡ºï¼Œ  
  é¢„æµ‹çš„ç»“æœå¹¶ä¸å‡†ç¡®
  - ç”±äºæ¯ä¸ªçœŸå®å€¼éƒ½æ˜¯åˆ å¤±æ—¶é—´ï¼Œ  
   é¢„æµ‹ç»“æœæ˜¯ç•¥æœ‰åå·®è¿˜æ˜¯ç³Ÿç³•é€é¡¶æ— æ³•å¾—çŸ¥
  - ç”±äºæ²¡æœ‰åˆ‡å®å¯è¡Œçš„æ–¹æ³•æ¥è¯„ä¼°è¿™äº›æ¨¡å‹ï¼Œ  
   ç”Ÿå­˜æ—¶é—´é¢„æµ‹çš„å®é™…ç”¨å¤„ä¸å¤§

```r
# åŠ è½½RåŒ…
# library(mlr3extralearners)

# é€‰æ‹©æ”¯æŒå‘é‡æœº
prediction_svm <- lrn(
 # ç”Ÿå­˜é—®é¢˜çš„æ”¯æŒå‘é‡æœº
 'surv.svm', 
 # `type = 'regression'`Â ä¼˜åŒ–ç”Ÿå­˜æ—¶é—´é¢„æµ‹çš„ç®—æ³•
 type = 'regression', 
 # é€šå¸¸åº”è¯¥å…ˆè°ƒä¼˜
 gamma = 1e-3
)$
 # è®­ç»ƒ
 train(tsk_rats, split$train)$
 # é¢„æµ‹
 predict(tsk_rats, split$test)

# æŸ¥çœ‹ç»“æœ
data.frame(
 pred = prediction_svm$response[1:3],
 truth = prediction_svm$truth[1:3]
)
```

<table class='dataframe'>
<caption>A data.frame: 3 x 2</caption>
<thead>
 <tr><th scope=col>pred</th><th scope=col>truth</th></tr>
 <tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;Surv&gt;</th></tr>
</thead>
<tbody>
 <tr><td>93.52197</td><td> 49, 1</td></tr>
 <tr><td>93.11679</td><td>104, 0</td></tr>
 <tr><td>92.91621</td><td> 91, 0</td></tr>
</tbody>
</table>
#### `predict_type = 'distr'`

- ä¸å›å½’ä¸­æœ€å¸¸è§çš„ç¡®å®šæ€§/ç‚¹é¢„æµ‹ä¸åŒï¼Œ  
  ç”Ÿå­˜åˆ†æä¸­ï¼Œåˆ†å¸ƒé¢„æµ‹æ›´ä¸ºå¸¸è§
- Â `mlr3proba`Â ä¸­çš„å¤§å¤šæ•°ç”Ÿå­˜æ¨¡å‹é»˜è®¤ä¼šè¿›è¡Œåˆ†å¸ƒé¢„æµ‹
  - è¿™äº›é¢„æµ‹æ˜¯ä½¿ç”¨Â `distr6`Â åŒ…å®ç°çš„ï¼Œ  
   è¯¥åŒ…æ”¯æŒå¯¹ç”Ÿå­˜æ›²çº¿ï¼ˆå®šä¹‰ä¸ºÂ $1âˆ’Â ç´¯ç§¯åˆ†å¸ƒå‡½æ•°$ï¼‰è¿›è¡Œå¯è§†åŒ–å’Œè¯„ä¼°

- ä¸‹é¢ç¤ºä¾‹ä¸­æå–å‰ä¸‰ä¸ªÂ `$distr`Â é¢„æµ‹ï¼Œ  
  å¹¶è®¡ç®—åœ¨Â $t=77$Â æ—¶çš„ç”Ÿå­˜æ¦‚ç‡
  - é¢„æµ‹çš„å‰ä¸‰åªè€é¼ åœ¨ $t=77$ æ—¶å­˜æ´»çš„æ¦‚ç‡åˆ†åˆ«ä¸º  
   97.1%ï¼Œ97.0%å’Œ99.4%

```r
prediction_cph$distr[1:3]$survival(77)
```

```js
A matrix: 1 x 3 of type dbl
77 0.9708998 0.9702328 0.9939012
```

#### `predict_type = 'lp'`

- çº¿æ€§é¢„æµ‹å€¼ï¼ˆlpï¼‰ï¼Œåœ¨å­¦æœ¯å†™ä½œä¸­å¸¸å†™ä¸º$Î·$ï¼Œ  
  åœ¨è®¡ç®—ä¸Šæ˜¯æœ€ç®€å•çš„é¢„æµ‹æ–¹å¼ï¼Œ  
  å¹¶ä¸”åœ¨å›å½’å»ºæ¨¡ä¸­æœ‰è‡ªç„¶çš„ç±»ä¼¼å½¢å¼
- åœ¨æ‹Ÿåˆç®€å•çº¿æ€§å›å½’æ¨¡å‹$Y = XÎ²$æ—¶ï¼Œæˆ‘ä»¬åœ¨ä¼°è®¡$Î²$çš„å€¼ï¼Œ  
  ç„¶åä¼°è®¡å‡ºçš„çº¿æ€§é¢„æµ‹å€¼ä¸º$X\hat{Î²}$
  - å…¶ä¸­$\hat{Î²}$æ˜¯ä¼°è®¡å‡ºçš„ç³»æ•°
- åœ¨ç®€å•ç”Ÿå­˜æ¨¡å‹ä¸­ï¼Œçº¿æ€§é¢„æµ‹å€¼æ˜¯ç›¸åŒçš„é‡ï¼ˆä½†ä¼°è®¡æ–¹å¼ç•¥ä¸ºå¤æ‚ï¼‰
- `mlr3proba`ä¸­çš„å­¦ä¹ å™¨å®ç°ä¸»è¦èšç„¦äºæœºå™¨å­¦ä¹ ï¼Œ  
  è¿™äº›æ¨¡å‹ä¸­å¾ˆå°‘æœ‰ç®€å•çš„çº¿æ€§å½¢å¼ï¼Œ  
  è¿™æ„å‘³ç€å¯¹äºå¤§å¤šæ•°æ­¤ç±»æ¨¡å‹æ— æ³•è®¡ç®—çº¿æ€§é¢„æµ‹å€¼
- åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå½“ç”¨äºé¢„æµ‹æ—¶ï¼Œ  
  çº¿æ€§é¢„æµ‹å€¼æ˜¯ç›¸å¯¹é£é™©/è¿ç»­æ’åºé¢„æµ‹çš„æ›¿ä»£

#### `predict_type = 'crank'`

- åœ¨ç”Ÿå­˜åˆ†æä¸­æœ€ä¸ºå¸¸è§ï¼Œä¹Ÿæ˜¯æœ€å®¹æ˜“æ··æ·†çš„
  - å­¦æœ¯æ–‡çŒ®åœ¨ç”Ÿå­˜åˆ†æä¸­å¸¸å¸¸æåˆ° **é£é™©** é¢„æµ‹  
   ï¼ˆç”Ÿå­˜æ¨¡å‹å¸¸è¢«ç§°ä¸º *é£é™©é¢„æµ‹æ¨¡å‹*ï¼‰ï¼Œ  
   å´æ²¡æœ‰å®šä¹‰é£é™©çš„å«ä¹‰
    - é€šå¸¸ï¼Œé£é™©è¢«å®šä¹‰ä¸º $expâ¡(Î·)$ï¼Œ  
    å› ä¸ºè¿™æ˜¯ç®€å•çº¿æ€§ç”Ÿå­˜æ¨¡å‹ä¸­å¸¸è§çš„é‡
    - æœ‰æ—¶é£é™©è¢«å®šä¹‰ä¸ºÂ $expâ¡(âˆ’Î·)$
    - æœ‰æ—¶å®ƒå¯èƒ½æ˜¯ä¸€ä¸ªæ²¡æœ‰æ˜ç¡®æ„ä¹‰çš„ä»»æ„é‡
  - åœ¨Â `mlr3proba`Â ä¸ºäº†é¿å…æ··æ·†è€Œå®šä¹‰äº†é¢„æµ‹ç±»å‹Â `crank`
    - å®ƒä»£è¡¨Â **c**ontinuousï¼ˆè¿ç»­çš„ï¼‰**rank**ingï¼ˆæ’åºï¼‰

- ä¸‹æ–¹è¾“å‡ºçš„ç»“æœä¸­ï¼š
  - ç¬¬3åªè€é¼ çš„æ­»äº¡é£é™©æœ€ä½ï¼ˆæ•°å€¼è¶Šå°ä»£è¡¨é£é™©è¶Šä½ï¼‰ï¼Œ  
   è€Œç¬¬2åªè€é¼ çš„æ­»äº¡é£é™©æœ€é«˜
  - é¢„æµ‹å€¼ä¹‹é—´çš„å·®è·è¿˜è¡¨æ˜ï¼Œ  
   ç¬¬1åªå’Œç¬¬2åªè€é¼ ä¹‹é—´çš„é£é™©å·®å¼‚  
   å°äºç¬¬2åªå’Œç¬¬3åªè€é¼ ä¹‹é—´çš„å·®å¼‚
  - å®é™…æ•°å€¼æœ¬èº«å¹¶æ— æ„ä¹‰ï¼Œ  
   å› æ­¤æ¯”è¾ƒæ ·æœ¬ï¼ˆæˆ–è®ºæ–‡æˆ–å®éªŒï¼‰  
   ä¹‹é—´çš„Â `crank`Â å€¼å¹¶æ— æ„ä¹‰ã€‚

```r
prediction_cph$crank[1:3]
```

```js
         1          2          3 
-0.5700703 -0.5470661 -2.1443968 
```

- **æ³¨æ„**ï¼š
  - å¯¹äºç”Ÿå­˜é¢„æµ‹ä¸­'é£é™©'çš„è§£é‡Šï¼Œä¸åŒçš„RåŒ…ä¹‹é—´å­˜åœ¨å·®å¼‚ï¼Œ  
   æœ‰æ—¶ç”šè‡³åŒä¸€åŒ…ä¸­çš„ä¸åŒæ¨¡å‹ä¹‹é—´ä¹Ÿæœ‰å·®å¼‚
  - åœ¨`mlr3proba`ä¸­ï¼Œå¯¹crankæœ‰ä¸€ä¸ªç»Ÿä¸€çš„è§£é‡Šï¼š  
   å€¼è¶Šä½ï¼Œäº‹ä»¶å‘ç”Ÿçš„é£é™©è¶Šä½ï¼›å€¼è¶Šé«˜ï¼Œäº‹ä»¶å‘ç”Ÿçš„é£é™©è¶Šé«˜

#### `MeasureSurv`

- ä½¿ç”¨`MeasureSurv`å¯¹è±¡è¿›è¡Œè¯„ä¼°
  - è¿™äº›å¯¹è±¡é€šè¿‡`msr()`ä»¥å¸¸è§„æ–¹å¼æ„å»º
- ç”Ÿå­˜åº¦é‡å¯åˆ†ä¸º
  - åˆ¤åˆ«æªæ–½ï¼š  
   é‡åŒ–æ¨¡å‹æ˜¯å¦èƒ½æ­£ç¡®è¯†åˆ«  
   ä¸€ä¸ªè§‚å¯Ÿç»“æœçš„é£é™©æ˜¯å¦é«˜äºå¦ä¸€ä¸ªï¼›  
   è¯„ä¼°crankå’Œ/æˆ–lpé¢„æµ‹
  - æ ¡å‡†åº¦é‡ï¼š  
   é‡åŒ–å¹³å‡é¢„æµ‹æ˜¯å¦æ¥è¿‘çœŸå®æƒ…å†µ  
   ï¼ˆé—æ†¾çš„æ˜¯ï¼Œåœ¨ç”Ÿå­˜èƒŒæ™¯ä¸‹ï¼Œæ‰€æœ‰æ ¡å‡†å®šä¹‰éƒ½ä¸æ˜ç¡®ï¼‰ï¼›  
   è¯„ä¼°`crank`å’Œ/æˆ–`lp`é¢„æµ‹
  - è¯„åˆ†è§„åˆ™ï¼š  
   é‡åŒ–æ¦‚ç‡é¢„æµ‹æ˜¯å¦æ¥è¿‘çœŸå®å€¼ï¼›  
   è¯„ä¼°`distr`é¢„æµ‹
- å»ºè®®çš„è¯„ä¼°æ–¹æ³•
  - `distr`é¢„æµ‹çš„è´¨é‡ï¼š  
   ç»¼åˆç”Ÿå­˜å¸ƒèµ–å°”åˆ†æ•°ï¼ˆISBSï¼‰ï¼ˆ`msr('surv.graf')`ï¼‰
  - æ¨¡å‹çš„åŒºåˆ†åº¦ï¼š  
   ä½¿ç”¨ä¸€è‡´æ€§æŒ‡æ•°ï¼ˆ`msr('surv.cindex')`ï¼‰
  - æ¨¡å‹çš„æ ¡å‡†åº¦ï¼š  
   ä½¿ç”¨Dæ ¡å‡†ï¼ˆ`msr('surv.dcalib')`ï¼‰
- å…¨éƒ¨ç”¨äºç”Ÿå­˜ä»»åŠ¡çš„è¯„ä¼°å™¨

```r
as.data.table(mlr_measures)[
  task_type == 'surv', c('key', 'predict_type')]
```

<table class='dataframe'>
<caption>A data.table: 25 x 2</caption>
<thead>
 <tr><th scope=col>key</th><th scope=col>predict_type</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th></tr>
</thead>
<tbody>
 <tr><td>surv.brier        </td><td>distr   </td></tr>
 <tr><td>surv.calib_alpha  </td><td>distr   </td></tr>
 <tr><td>surv.calib_beta   </td><td>lp      </td></tr>
 <tr><td>surv.calib_index  </td><td>distr   </td></tr>
 <tr><td>surv.chambless_auc</td><td>lp      </td></tr>
 <tr><td>surv.cindex       </td><td>crank   </td></tr>
 <tr><td>surv.dcalib       </td><td>distr   </td></tr>
 <tr><td>surv.graf         </td><td>distr   </td></tr>
 <tr><td>surv.hung_auc     </td><td>lp      </td></tr>
 <tr><td>surv.intlogloss   </td><td>distr   </td></tr>
 <tr><td>surv.logloss      </td><td>distr   </td></tr>
 <tr><td>surv.mae          </td><td>response</td></tr>
 <tr><td>surv.mse          </td><td>response</td></tr>
 <tr><td>surv.nagelk_r2    </td><td>lp      </td></tr>
 <tr><td>surv.oquigley_r2  </td><td>lp      </td></tr>
 <tr><td>surv.rcll         </td><td>distr   </td></tr>
 <tr><td>surv.rmse         </td><td>response</td></tr>
 <tr><td>surv.schmid       </td><td>distr   </td></tr>
 <tr><td>surv.song_auc     </td><td>lp      </td></tr>
 <tr><td>surv.song_tnr     </td><td>lp      </td></tr>
 <tr><td>surv.song_tpr     </td><td>lp      </td></tr>
 <tr><td>surv.uno_auc      </td><td>lp      </td></tr>
 <tr><td>surv.uno_tnr      </td><td>lp      </td></tr>
 <tr><td>surv.uno_tpr      </td><td>lp      </td></tr>
 <tr><td>surv.xu_r2        </td><td>lp      </td></tr>
</tbody>
</table>

- è¯„ä¼°é¢„æµ‹çš„ç»“æœ
  - CæŒ‡æ•°>0.5ï¼ŒISBSè¾ƒä½
  - ä½†æ˜¯DCalibè¾ƒé«˜
- ç„¶è€Œï¼Œå¦‚æœä¸ä¸æŸäº›åŸºçº¿  
  ï¼ˆé€šå¸¸æ˜¯Kaplan-Meieræ³•ï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œ  
  å°±å¾ˆéš¾ç¡®å®šä»»ä½•ç”Ÿå­˜æ¨¡å‹çš„æ€§èƒ½

```r
prediction_cph$score(msrs(c('surv.graf', 'surv.cindex', 'surv.dcalib')))
```

```js
  surv.graf surv.cindex surv.dcalib 
 0.07465018  0.79166669  2.19975256 
```

### åˆæˆï¼ˆCompositionï¼‰

#### ç®€ä»‹

- åŸç”Ÿï¼ˆnativeï¼‰ï¼šæœªç»ä»»ä½•åå¤„ç†çš„æƒ…å†µä¸‹åšå‡ºçš„é¢„æµ‹
- åˆæˆï¼ˆcomposedï¼‰ï¼šåœ¨åå¤„ç†åè¿”å›çš„é¢„æµ‹

#### å†…éƒ¨åˆæˆï¼ˆInternal Compositionï¼‰

- `mlr3proba`Â åœ¨å†…éƒ¨ä½¿ç”¨åˆæˆæ–¹å¼ï¼Œ  
  ä¸ºæ¯ä¸ªå­¦ä¹ å™¨è¿”å›ä¸€ä¸ª`'crank'`é¢„æµ‹
  - è¿™æ˜¯ä¸ºäº†ç¡®ä¿è‡³å°‘èƒ½ä¾æ®ä¸€ä¸ªæ ‡å‡†ï¼ˆåŒºåˆ†æ€§èƒ½ï¼‰  
   å¯¹æ‰€æœ‰æ¨¡å‹è¿›è¡Œæœ‰æ„ä¹‰çš„benchmarkæµ‹è¯•
- `mlr3proba`ä½¿ç”¨ä»¥ä¸‹è§„åˆ™æ¥åˆ›å»º`"crank"`é¢„æµ‹
  - å¦‚æœä¸€ä¸ªæ¨¡å‹è¿”å›ä¸€ä¸ª`'risk'`é¢„æµ‹ï¼Œ  
   é‚£ä¹ˆ`crank = risk`ï¼ˆæˆ‘ä»¬å¯èƒ½ä¼šå°†å…¶ä¹˜ä»¥ï¼Œä»¥ç¡®ä¿â€œä½æ•°å€¼ä½é£é™©â€çš„è§£é‡Šï¼‰
  - å¦‚æœæ¨¡å‹è¿”å›ä¸€ä¸ª`response`é¢„æµ‹å€¼ï¼Œé‚£ä¹ˆÂ `crank = -response`
  - å¦‚æœä¸€ä¸ªæ¨¡å‹è¿”å›ä¸€ä¸ª`lp`é¢„æµ‹å€¼ï¼Œé‚£ä¹ˆÂ `crank = lp`  
   ï¼ˆå¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥Â `crank = -lp`ï¼‰
  - å¦‚æœä¸€ä¸ªæ¨¡å‹è¿”å›ä¸€ä¸ª`distr`é¢„æµ‹ï¼Œé‚£ä¹ˆ`crank`è®¾ç½®ä¸ºç´¯ç§¯é£é™©å‡½æ•°çš„æ€»å’Œ

#### æ˜¾å¼åˆæˆï¼ˆExplicit Compositionï¼‰ä¸ç®¡é“

- é¢„æµ‹ç±»å‹çš„è½¬æ¢ç®¡é“
  - `pipeline_crankcompositor()`ï¼š  
   å°†`"distr"`é¢„æµ‹è½¬æ¢ä¸º`"crank"`
    - æ¯å½“ç”Ÿå­˜æ¨¡å‹è¿”å›é¢„æµ‹ç»“æœæ—¶ï¼Œ  
    å†…éƒ¨ä¼šä½¿ç”¨è¯¥ç®¡é“çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œ  
    è¿™æ ·æ¯ä¸ªæ¨¡å‹éƒ½æœ‰ä¸€ä¸ª`"crank"`é¢„æµ‹ç±»å‹â€”â€”  
    æ‰€ä»¥åªä½¿ç”¨è¯¥ç®¡é“æ¥è¦†ç›–è¿™äº›æ’åé¢„æµ‹
  - `pipeline_distrcompositor()`ï¼š  
   å°† `"lp"` é¢„æµ‹è½¬æ¢ä¸º `"distr"`
    - åœ¨å®è·µä¸­è¯¥ç®¡é“æ›´å¸¸è§ï¼Œ  
    å› ä¸ºCoxæˆ–åŠ é€Ÿå¤±æ•ˆæ—¶é—´ï¼ˆAFTï¼‰ç±»å‹çš„æ¨¡å‹  
    æ€»æ˜¯è¿”å›ä¸€ä¸ªçº¿æ€§é¢„æµ‹å€¼ï¼ˆ`"lp"`ï¼‰ï¼Œ  
    ä½†æœ‰æ—¶å†…éƒ¨çš„`predict()`å‡½æ•°  
    å¹¶ä¸æä¾›è½¬æ¢ä¸ºç”Ÿå­˜åˆ†å¸ƒé¢„æµ‹ï¼ˆ`"distr"`ï¼‰çš„åŠŸèƒ½
  - `pipeline_responsecompositor()`ï¼š  
   å°† `"distr"` é¢„æµ‹è½¬æ¢ä¸º `"response"`ï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰
    - å°†é¢„æµ‹çš„ç”Ÿå­˜æ›²çº¿æ±‡æ€»ä¸ºä¸€ä¸ªå•ä¸€æ•°å­—ï¼ˆé¢„æœŸç”Ÿå­˜æ—¶é—´ï¼‰
    - å¦‚å‰æ‰€è¿°ï¼Œè¿™å¯¹äºè¯„ä¼°ç”Ÿå­˜æœºå™¨å­¦ä¹ æ¨¡å‹çš„æ€§èƒ½å¾ˆå°‘æœ‰ç”¨

- åœ¨æœ¬ç¤ºä¾‹ä¸­
  - åŠ è½½`rats`æ•°æ®é›†
  - åˆ é™¤å› å­åˆ—
  - å°†æ•°æ®åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†
  - å›´ç»•ç”Ÿå­˜XGBooståŠ é€Ÿå¤±æ•ˆæ—¶é—´ï¼ˆAFTï¼‰å­¦ä¹ å™¨  
   ï¼ˆ`lrn("surv.xgboost.aft")`ï¼‰  
   æ„å»º`distrcompositor`ç®¡é“
    - è¯¥å­¦ä¹ å™¨é»˜è®¤å¯¹`"lp"`ã€`"crank"`å’Œ`"response"`è¿›è¡Œé¢„æµ‹
- ç®¡é“ä¸­
  - æŒ‡å®šå°†ä½¿ç”¨Kaplan - Meierä¼°è®¡å™¨ï¼ˆ`estimator = "kaplan"`ï¼‰ä¼°è®¡åŸºçº¿åˆ†å¸ƒï¼Œ  
   å¹¶å‡è®¾æˆ‘ä»¬ä¼°è®¡çš„åˆ†å¸ƒé‡‡ç”¨AFTå½¢å¼ï¼ˆ`form = "aft"`ï¼‰
  - ä»¥é€šå¸¸çš„æ–¹å¼è¿›è¡Œè®­ç»ƒå’Œé¢„æµ‹
  - åœ¨è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°`distr`é¢„æµ‹

```r
# åŠ è½½RåŒ…
# library(mlr3verse)
# library(mlr3extralearners)

# æ•°æ®é¢„å¤„ç†
tsk_rats <- tsk('rats')$select(c('litter', 'rx'))
split <- partition(tsk_rats)

# å­¦ä¹ å™¨
learner <- lrn('surv.xgboost.aft', nrounds = 10)
# è®­ç»ƒå’Œé¢„æµ‹
learner$
 train(tsk_rats, split$train)$
 predict(tsk_rats, split$test)

# `GraphLearner`ï¼š`lp` -> `distr`
graph_learner <- ppl(
 'distrcompositor',
 learner = learner,
 estimator = 'kaplan',
 form = 'aft',
 graph_learner = TRUE
)
# è®­ç»ƒå’Œé¢„æµ‹
graph_learner$
 train(tsk_rats, split$train)$
 predict(tsk_rats, split$test)
```

```js
[36m--[39m [1m[34m<PredictionSurv>[39m for [34m99[39m observations:[22m [36m---------------------------------------[39m
 row_ids time status     crank        lp response
       2   49   TRUE -5.671391 -5.671391 290.4381
       3  104  FALSE -5.671391 -5.671391 290.4381
       5  104  FALSE -5.671391 -5.671391 290.4381
     ---  ---    ---       ---       ---      ---
     295  104  FALSE -4.918093 -4.918093 136.7416
     298   92  FALSE -4.918093 -4.918093 136.7416
     299  104  FALSE -4.918093 -4.918093 136.7416



[36m--[39m [1m[34m<PredictionSurv>[39m for [34m99[39m observations:[22m [36m---------------------------------------[39m
 row_ids time status     crank        lp response     distr
       2   49   TRUE -5.671391 -5.671391 290.4381 <list[1]>
       3  104  FALSE -5.671391 -5.671391 290.4381 <list[1]>
       5  104  FALSE -5.671391 -5.671391 290.4381 <list[1]>
     ---  ---    ---       ---       ---      ---       ---
     295  104  FALSE -4.918093 -4.918093 136.7416 <list[1]>
     298   92  FALSE -4.918093 -4.918093 136.7416 <list[1]>
     299  104  FALSE -4.918093 -4.918093 136.7416 <list[1]>
```

- ä»æ•°å­¦è§’åº¦æ¥çœ‹ï¼Œä¸Šè¿°çš„è½¬æ¢è¿‡ç¨‹ä¸º
  - å‡è®¾æˆ‘ä»¬ä¼°è®¡çš„åˆ†å¸ƒå½¢å¼ä¸ºÂ $S(t) = S_0(\frac{t}{\exp(\eta)})$
    - Â $S$ï¼šç”Ÿå­˜å‡½æ•°
    - $S_0$ï¼šåŸºçº¿ç”Ÿå­˜å‡½æ•°
    - $\eta$ï¼šæ˜¯çº¿æ€§é¢„æµ‹å€¼
  - ä½¿ç”¨XGBoostä¼°è®¡ $\eta$ é¢„æµ‹å€¼ $\hat{\eta}$
  - ä½¿ç”¨ Kaplan-Meier ä¼°è®¡å™¨ä¼°è®¡ $\hat{S}_0(t)$
  - å°†è¿™äº›æ•´åˆä¸º$S(t) = \hat{S}_0(\frac{t}{\exp(\hat{\eta})})$

### æ€»æ½æµç¨‹

- ä¸‹é¢æ˜¯æ•´ä½“æµç¨‹
  - ç”¨ISBSï¼ŒDæ ¡å‡†å’ŒCæŒ‡æ•°æ¥è¯„ä¼°é¢„æµ‹ç»“æœ
  - ç»“æœ
    - XGBoost-AFTå’ŒCox PHå…·æœ‰æœ€ä½³çš„åŒºåˆ†åº¦
    - Kaplan-MeieråŸºçº¿å…·æœ‰æœ€ä½³çš„æ ¡å‡†åº¦
    - Cox PHå…·æœ‰æœ€ä½³çš„æ•´ä½“é¢„æµ‹å‡†ç¡®åº¦ï¼ˆISBSæœ€ä½ï¼‰

```r
# è®¾ç½®éšæœºæ•°ç§å­
# set.seed(42)
# åŠ è½½RåŒ…
# library(mlr3extralearners)

# åŠ è½½ä»»åŠ¡
tsk_grace <- tsk('grace')
# éšæœºæŒ‘é€‰500ä¸ªæ ·æœ¬ä»¥å‡å°‘æ¼”ç¤ºä¾‹å­è€—æ—¶
tsk_grace$
 filter(
  sample(
   tsk_grace$nrow, 
   500
  )
 )
# æŒ‘é€‰è¯„ä¼°å™¨
msr_txt = c("surv.graf", "surv.cindex", "surv.dcalib")
measures <- msrs(msr_txt)

# æ„å»º`GraphLearner`
graph_learner <- ppl(
  'distrcompositor',
  learner = lrn('surv.xgboost.aft', nrounds = 10),
  estimator = 'kaplan',
  form = 'aft',
  graph_learner = TRUE,
  scale_lp = TRUE
)
# ä¿®æ”¹è¯†åˆ«id
graph_learner$id = 'XGBoost-AFT'


bmr <- benchmark(
 benchmark_grid(
  tsk_grace, 
  # benchmarkæ¯”è¾ƒç®¡é“å’Œ2ç§åŸºç¡€å­¦ä¹ å™¨
  c(
   lrns(c('surv.coxph', 'surv.kaplan')), 
   graph_learner
  ),
  rsmp('cv', folds = 3)
 )
)
# æ•´åˆç»“æœ
bmr$aggregate(measures)[, c('learner_id', ..msr_txt)]
```

<table class="dataframe">
<caption>A bmr_aggregate: 3 x 4</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>surv.graf</th><th scope=col>surv.cindex</th><th scope=col>surv.dcalib</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>surv.coxph </td><td>0.09897859</td><td>0.8421613</td><td>5.328825</td></tr>
 <tr><td>surv.kaplan</td><td>0.20225391</td><td>0.5000000</td><td>4.148996</td></tr>
 <tr><td>XGBoost-AFT</td><td>0.21336577</td><td>0.8371936</td><td>5.789641</td></tr>
</tbody>
</table>

## å¯†åº¦ä¼°è®¡ï¼ˆDensity Estimationï¼‰

- å¯†åº¦ä¼°è®¡æ—¨åœ¨ä¼°è®¡ç”Ÿæˆå•å˜é‡æ•°æ®é›†çš„æœªçŸ¥åˆ†å¸ƒ
  - æ›´ç®€å•åœ°è¯´ï¼Œä¼°è®¡å•ä¸ªå˜é‡çš„æ¦‚ç‡å¯†åº¦ï¼ˆæˆ–è´¨é‡ï¼‰å‡½æ•°
- ä¸ç”Ÿå­˜åˆ†æä¸€æ ·ï¼Œå¯†åº¦ä¼°è®¡åœ¨`mlr3proba`ä¸­å®ç°
  - å› ä¸ºä¸¤è€…éƒ½å¯ä»¥è¿›è¡Œæ¦‚ç‡åˆ†å¸ƒé¢„æµ‹ï¼ˆå› æ­¤å¾—åâ€œ**mlr3proba**bilisticâ€ï¼‰
- æ— æ¡ä»¶å¯†åº¦ä¼°è®¡ï¼ˆå³ä¸ä½¿ç”¨ä»»ä½•åå˜é‡ä¼°è®¡ç›®æ ‡ï¼‰è¢«è§†ä¸ºæ— ç›‘ç£ä»»åŠ¡ï¼Œ  
  è¿™æ„å‘³ç€çœŸå®æƒ…å†µæ°¸è¿œæ˜¯**æœªçŸ¥**çš„

- `mlr3proba`åŒ…ä½¿ç”¨ä»¥ä¸‹ç”¨äºå¯†åº¦ä¼°è®¡çš„å¯¹è±¡å¯¹`mlr3`è¿›è¡Œäº†æ‰©å±•
  - `TaskDens`ï¼šå¯†åº¦é—®é¢˜ä»»åŠ¡
  - `LearnerDens`ï¼šå¯†åº¦å­¦ä¹ å™¨
  - `PredictionDens`ï¼šå¯†åº¦é¢„æµ‹
  - `MeasureDens`ï¼šå¯†åº¦æ€§èƒ½è¯„ä¼°å™¨

### `TaskDens`

- `as_task_dens()` æ„å»ºå¯†åº¦ä¼°è®¡ä»»åŠ¡

```r
tsk_dens <- as_task_dens(data.table(x = rnorm(1000)))
tsk_dens
```

```js
[36m--[39m [1m[34m<TaskDens>[39m (1000x1)[22m [36m---------------------------------------------------------[39m
* Target:
* Properties: -
* Features (1):
  * dbl (1): x
```

- æŸ¥çœ‹è‡ªå¸¦çš„ä¸€äº›å¯†åº¦ä¼°è®¡ä»»åŠ¡

```r
as.data.table(mlr_tasks)[task_type == 'dens', c(1:2, 4:5)]
```

<table class="dataframe">
<caption>A data.table: 2 x 4</caption>
<thead>
 <tr><th scope=col>key</th><th scope=col>label</th><th scope=col>nrow</th><th scope=col>ncol</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
 <tr><td>faithful</td><td>Old Faithful Eruptions</td><td>272</td><td>1</td></tr>
 <tr><td>precip  </td><td>Annual Precipitation  </td><td> 70</td><td>1</td></tr>
</tbody>
</table>

### `LearnerDens` å’Œ `PredictionDens`

- å¯†åº¦å­¦ä¹ å™¨å¯èƒ½è¿”å›ä»¥ä¸‹é¢„æµ‹ç±»å‹ï¼š
  - `distr`ï¼šæ¦‚ç‡åˆ†å¸ƒ
  - `pdf`ï¼šæ¦‚ç‡å¯†åº¦å‡½æ•°
  - `cdf`ï¼šç´¯ç§¯åˆ†å¸ƒå‡½æ•°
- æ‰€æœ‰çš„å­¦ä¹ å™¨éƒ½ä¼šè¿”å›ä¸€ä¸ª`distr`å’Œ`pdf`é¢„æµ‹ï¼Œ  
  ä½†åªæœ‰éƒ¨åˆ†å­¦ä¹ å™¨èƒ½å¤Ÿè¿›è¡Œ`cdf`é¢„æµ‹

```r
# ç›´æ–¹å›¾å­¦ä¹ å™¨
lrn_hist <- lrn('dens.hist')
# è®­ç»ƒå’Œé¢„æµ‹
prediction <- lrn_hist$
 train(tsk_dens, 1:900)$
 predict(tsk_dens, 901:1000)
# è®¾ç½®åŒºé—´
x <- seq.int(-2, 2, 0.01)
# åˆ›å»ºåŒºé—´å†…æ¯ä¸ªç‚¹çš„æ¦‚ç‡å¯†åº¦dataframe
df <- data.frame(
 x = x, 
 y = prediction$distr$pdf(x)
)
# å¯è§†åŒ–
ggplot(df, aes(x = x, y = y)) + 
 geom_line() + 
 theme_minimal()
```

![image_4](./image_4.png)

- `pdf`å’Œ`cdf`é¢„æµ‹ç±»å‹åˆ†åˆ«åªæ˜¯å›´ç»•`distr$pdf`å’Œ`distr$cdf`çš„ç®€å•åŒ…è£…å™¨
- è¿™é‡Œå¯ä»¥å‘ç°
  - `pdf`å’Œ`cdf`éƒ½å‚¨å­˜åœ¨`prediction`é‡Œ
  - ä¹Ÿå¯ä»`Prediction$distr$pdf()`å’Œ  
   `Prediction$distr$cdf()`è°ƒç”¨å­¦ä¹ å™¨é‡æ–°è®¡ç®—
    - ç»“æœæ˜¯ä¸€è‡´çš„

```r
prediction <- lrn_hist$
 train(tsk_dens, 1:10)$
 predict(tsk_dens, 11:13)
prediction
```

```js
[36m--[39m [1m[34m<PredictionDens>[39m for [34m3[39m observations:[22m [36m----------------------------------------[39m
 row_ids pdf       cdf
      11 0.0 1.0000000
      12 0.6 0.7617717
      13 0.4 0.4279775
```

```r
cbind(
 prediction$
  distr$
  cdf(tsk_dens$data()$x[11:13]),
 prediction$cdf[1:3]
)
```

<table class="dataframe">
<caption>A matrix: 3 x 2 of type dbl</caption>
<tbody>
 <tr><td>1.0000000</td><td>1.0000000</td></tr>
 <tr><td>0.7617717</td><td>0.7617717</td></tr>
 <tr><td>0.4279775</td><td>0.4279775</td></tr>
</tbody>
</table>

### `MeasureDens` å’Œæ€»æ½ä¸Šè¿°æµç¨‹

- `mlr3proba`Â ä¸­ç”¨äºå¯†åº¦ä¼°è®¡çš„å”¯ä¸€å·²å®æ–½åº¦é‡æ˜¯å¯¹æ•°æŸå¤±ï¼ˆloglossï¼‰
  - å…¶å®šä¹‰æ–¹å¼ä¸åˆ†ç±»ä¸­çš„å®šä¹‰ç›¸åŒï¼Œ  
   å³Â $L(y) = -\log(\hat{f}_Y(y))$
    - Â $\hat{f}_Y$ï¼šä¼°è®¡çš„æ¦‚ç‡å¯†åº¦å‡½æ•°

- åˆ›å»ºå¯†åº¦è¯„ä¼°é—®é¢˜çš„è¯„ä¼°å™¨

```r
msr_logloss <- msr('dens.logloss')
msr_logloss
```

```js
[36m--[39m [1m[34m<MeasureDensLogloss>[39m (dens.logloss): Log Loss[22m [36m-------------------------------[39m
* Packages: [34mmlr3[39m and [34mmlr3proba[39m
* Range: [0, Inf]
* Minimize: [34mTRUE[39m
* Average: macro
* Parameters: eps=1e-15
* Properties: -
* Predict type: pdf
* Predict sets: test
* Aggregator: mean()
```

- æ ‡å‡†çš„è¯„ä¼°å™¨ä¼ é€’

```r
prediction$score(msr_logloss)
```

```js
dens.logloss: 11.9886309168503
```

- benchmarkæ¯”è¾ƒä¸åŒå¯†åº¦è¯„ä¼°å­¦ä¹ å™¨

```r
# åŠ è½½RåŒ…
# library(mlr3extralearners)

# ä»»åŠ¡
tsk_faithful <- tsk('faithful')
# å­¦ä¹ å™¨
learners <- lrns(c('dens.hist', 'dens.pen', 'dens.kde'))
# è¯„ä¼°å™¨
measure <- msr('dens.logloss')

# benchmarkæ¯”è¾ƒ
bmr <- benchmark(
 benchmark_grid(
  tsk_faithful, 
  learners,
  rsmp('cv', folds = 3)
 )
)

# ç»“æœæ•´åˆ
bmr$aggregate(measure)
```

```js
      nr  task_id learner_id resampling_id iters dens.logloss
   <int>   <char>     <char>        <char> <int>        <num>
1:     1 faithful  dens.hist            cv     3     1.115927
2:     2 faithful   dens.pen            cv     3     1.377325
3:     3 faithful   dens.kde            cv     3     1.026440
Hidden columns: resample_result
```

- å¯è§†åŒ–3ç§å­¦ä¹ å™¨çš„æ€§èƒ½
  - å¤æ‚çš„æƒ©ç½šå¯†åº¦ä¼°è®¡å™¨çš„è¡¨ç°å¹¶ä¸ä¼˜äºåŸºçº¿ç›´æ–¹å›¾ï¼Œ  
   ä½†æ ¸å¯†åº¦ä¼°è®¡å™¨è‡³å°‘åœ¨å¯¹æ•°æŸå¤±ç»“æœä¸Šæ›´å¥½

```r
autoplot(bmr, measure = measure)
```

![image_5](./image_5.png)

## èšç±»åˆ†æï¼ˆCluster Analysisï¼‰

### ç®€ä»‹

- `mlr3cluster`ä½¿ç”¨ä»¥ä¸‹ç”¨äºèšç±»åˆ†æçš„å¯¹è±¡å¯¹`mlr3`è¿›è¡Œäº†æ‰©å±•ï¼š
  - `TaskClust`ï¼šèšç±»ä»»åŠ¡
  - `LearnerClust`ï¼šèšç±»å­¦ä¹ å™¨çš„åŸºç±»
  - `PredictionClust`ï¼šèšç±»é¢„æµ‹ç»“æœçš„`Prediction`å¯¹è±¡çš„ç‰¹å®šç±»
  - `MeasureClust`ï¼šèšç±»æ€§èƒ½è¯„ä¼°å™¨

### `TaskClust`

- ä»¥`cluster`åŒ…è‡ªå¸¦çš„æ•°æ®é›†`ruspini`ä¸ºä¾‹

```r
# åŠ è½½RåŒ…
# library(mlr3verse)
# library(cluster)

# åˆ›å»ºèšç±»ä»»åŠ¡
tsk_ruspini <- as_task_clust(ruspini)
tsk_ruspini
```

```js
[36m--[39m [1m[34m<TaskClust>[39m (75x2)[22m [36m----------------------------------------------------------[39m
* Target:
* Properties: -
* Features (2):
  * int (2): x, y
```

```r
tsk_ruspini$data(1:3) 
```

<table class="dataframe">
<caption>A data.table: 3 x 2</caption>
<thead>
 <tr><th scope=col>x</th><th scope=col>y</th></tr>
 <tr><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
 <tr><td> 4</td><td>53</td></tr>
 <tr><td> 5</td><td>63</td></tr>
 <tr><td>10</td><td>59</td></tr>
</tbody>
</table>

- é²è¥¿å°¼ï¼ˆRuspiniï¼‰æ•°æ®é›†çš„åˆ†å¸ƒæƒ…å†µ

```r
autoplot(tsk_ruspini)
```

![image_6](./image_6.png)

- æŸ¥çœ‹æ‰€æœ‰è‡ªå¸¦çš„èšç±»ä»»åŠ¡

```r
as.data.table(mlr_tasks)[task_type == 'clust', c(1:2, 4:5)]
```

<table class="dataframe">
<caption>A data.table: 2 x 4</caption>
<thead>
 <tr><th scope=col>key</th><th scope=col>label</th><th scope=col>nrow</th><th scope=col>ncol</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th></tr>
</thead>
<tbody>
 <tr><td>ruspini  </td><td>Ruspini   </td><td>75</td><td>2</td></tr>
 <tr><td>usarrests</td><td>US Arrests</td><td>50</td><td>4</td></tr>
</tbody>
</table>

### `LearnerClust` å’Œ `PredictionClust`

- èšç±»å­¦ä¹ å™¨æœ‰ä¸¤ç§`predict_types`
  - `'partition'`ï¼šå¯¹è§‚æµ‹å€¼æ‰€å±èšç±»çš„ä¼°è®¡
  - `'prob'`ï¼šä¸€ä¸ªè§‚æµ‹å€¼å±äºæ¯ä¸ªèšç±»çš„æ¦‚ç‡
- ä¸åˆ†ç±»ç±»ä¼¼ï¼Œ  
  èšç±»å­¦ä¹ å™¨çš„é¢„æµ‹ç±»å‹è¦ä¹ˆæ˜¯ç¡®å®šæ€§çš„ï¼ˆ`"partition"`ï¼‰ï¼Œ  
  è¦ä¹ˆæ˜¯æ¦‚ç‡æ€§çš„ï¼ˆ`"prob"`ï¼‰

- ä¸‹ä¾‹ä¸­æ„å»ºä¸€ä¸ªé¢„æµ‹ç±»å‹ä¸ºÂ `"prob"`Â ï¼Œ  
  ä¸”æœ‰3ä¸ªèšç±»ï¼ˆ`centers = 3`ï¼‰çš„Cå‡å€¼èšç±»å­¦ä¹ å™¨ï¼Œ  
  åœ¨Â `ruspini`Â æ•°æ®é›†ä¸Šå¯¹å…¶è¿›è¡Œè®­ç»ƒï¼Œ  
  ç„¶åè¿”å›å…­ä¸ªéšæœºè§‚æµ‹å€¼çš„èšç±»åˆ†é…ï¼ˆ`$assignments`ï¼‰

```r
lrn_cmeans <- lrn(
 'clust.cmeans', 
 predict_type = 'prob', 
 centers = 3
)
lrn_cmeans
```

```js
[36m--[39m [1m[34m<LearnerClustCMeans>[39m (clust.cmeans): Fuzzy C-Means Clustering Learner[22m [36m-------[39m
* Model: -
* Parameters: centers=3
* Packages: [34mmlr3[39m, [34mmlr3cluster[39m, and [34me1071[39m
* Predict Types: partition and [prob]
* Feature Types: logical, integer, and numeric
* Encapsulation: none (fallback: -)
* Properties: complete, fuzzy, and partitional
* Other settings: use_weights = 'error'
```

```r
lrn_cmeans$train(tsk_ruspini)
lrn_cmeans$assignments[sample(tsk_ruspini$nrow, 6)]
```

```js
[1] 2 1 1 1 3 2
```

- ç”±äºèšç±»æ˜¯æ— ç›‘ç£çš„ï¼Œ  
  å¯¹æ–°æ•°æ®ä½¿ç”¨`predict`é€šå¸¸**æ²¡æœ‰æ„ä¹‰**ï¼Œ  
  ä¸è¿‡ä½¿ç”¨`mlr3`æ¥å£ä»æœ‰å¯èƒ½å®ç°

```r
lrn_cmeans$
 train(tsk_ruspini, 1:30)$
 predict(tsk_ruspini, 31:32)
```

```js

[36m--[39m [1m[34m<PredictionClust>[39m for [34m2[39m observations:[22m [36m---------------------------------------[39m
 row_ids partition     prob.1     prob.2    prob.3
      31         3 0.01814044 0.01552007 0.9663395
      32         3 0.01177598 0.01002160 0.9782024
```

- å¯¹æ•´ä¸ªæ•°æ®é›†è¿›è¡Œèšç±»ï¼Œå¹¶ä¸”å¯è§†åŒ–èšç±»ç»“æœçš„åˆ†å¸ƒ

```r
prediction <- lrn_cmeans$
 train(tsk_ruspini)$
 predict(tsk_ruspini)
autoplot(prediction, tsk_ruspini)
```

![image_7](./image_7.png)

- è™½ç„¶æœ‰ä¸¤ç§å¯èƒ½çš„é¢„æµ‹ç±»å‹ï¼Œä½†æœ‰äº›å­¦ä¹ å™¨çš„â€œé¢„æµ‹â€æ°¸è¿œæ²¡æœ‰æ„ä¹‰
  - ä¾‹å¦‚åœ¨å±‚æ¬¡èšç±»ä¸­
- åœ¨å±‚æ¬¡èšç±»ä¸­ï¼Œç›®æ ‡æ˜¯é€šè¿‡å°†å¤§çš„ç°‡åˆ†è£‚æˆè¾ƒå°çš„ç°‡ï¼Œ  
  æˆ–å°†è¾ƒå°çš„ç°‡åˆå¹¶æˆè¾ƒå¤§çš„ç°‡ï¼Œ  
  æ¥æ„å»ºä¸€ä¸ªåµŒå¥—ç°‡çš„å±‚æ¬¡ç»“æ„
  - æœ€ç»ˆç»“æœæ˜¯ä¸€æ£µæ ‘æˆ–æ ‘å½¢å›¾ï¼Œ  
   å¦‚æœæ·»åŠ æ–°çš„æ•°æ®ç‚¹ï¼Œ  
   è¯¥æ ‘æˆ–æ ‘å½¢å›¾å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–
- ä¸ºä¿æŒä¸€è‡´æ€§ï¼Œ`mlr3cluster`Â ä¸ºå±‚æ¬¡èšç±»æä¾›äº†  
  ä¸€ä¸ªÂ `predict`Â æ–¹æ³•ï¼Œä½†ä¼šç»™å‡ºä¸€ä¸ªè­¦å‘Šï¼š

```r
lrn_hclust <- lrn('clust.hclust', k = 2)
lrn_hclust$
 train(tsk_ruspini)$
 predict(tsk_ruspini)
```

```js
Warning message in warn_prediction_useless(self$id): "Learner 'clust.hclust' doesn't predict on new data and predictions may not make sense on new data."

[36m--[39m [1m[34m<PredictionClust>[39m for [34m75[39m observations:[22m [36m--------------------------------------[39m
 row_ids partition
       1         1
       2         1
       3         1
     ---       ---
      73         1
      74         1
      75         1
```

- æŸ¥çœ‹èšç±»ç»“æœå›¾
  - `ruspini`æ•°æ®é›†å±‚æ¬¡èšç±»çš„æ ‘å½¢å›¾
  - yè½´æ˜¯ç‚¹çš„ç›¸ä¼¼åº¦
  - xè½´ä¸Šç›¸è¿çš„è§‚æµ‹å€¼è¶Šä½ï¼Œ  
   å®ƒä»¬çš„ç›¸ä¼¼åº¦å°±è¶Šé«˜
  - é¡¶éƒ¨çš„åˆ’åˆ†ä»£è¡¨ä¸¤ä¸ªç°‡çš„åˆ†ç¦»

```r
autoplot(lrn_hclust) + 
 theme(axis.text = element_text(size = 5.5))
```

![image_8](./image_8.png)

### `MeasureClust`

- æ— ç›‘ç£ä»»åŠ¡åœ¨æ¨¡å‹è¯„ä¼°ä¸­æ²¡æœ‰å¯ç”¨äºå¯¹æ¯”çš„çœŸå®æ•°æ®
  - ä»ç„¶å¯ä»¥é€šè¿‡é‡åŒ–åŒä¸€ç°‡å†…å¯¹è±¡çš„ç›¸å…³ç¨‹åº¦ï¼ˆç°‡å†…èšæ€§ï¼‰  
   ä»¥åŠä¸åŒç°‡ä¹‹é—´çš„å·®å¼‚ç¨‹åº¦ï¼ˆç°‡åˆ†ç¦»æ€§ï¼‰æ¥è¡¡é‡ç°‡åˆ†é…çš„è´¨é‡
- ä¸¤ç§å¸¸è§çš„åº¦é‡æŒ‡æ ‡
  - ç»„å†…å¹³æ–¹å’Œï¼ˆWSSï¼‰åº¦é‡ï¼ˆ`msr("clust.wss")`ï¼‰
    - è®¡ç®—è§‚æµ‹å€¼ä¸è´¨å¿ƒä¹‹é—´çš„å¹³æ–¹å·®ä¹‹å’Œï¼Œ  
    è¿™æ˜¯å¯¹èšç±»å‡èšæ€§çš„ä¸€ç§é‡åŒ–ï¼ˆå€¼è¶Šå°è¡¨æ˜èšç±»è¶Šç´§å¯†ï¼‰
    - è½®å»“ç³»æ•°é‡åŒ–äº†æ¯ä¸ªç‚¹å±äºå…¶åˆ†é…çš„èšç±»ç›¸å¯¹äºç›¸é‚»èšç±»çš„ç¨‹åº¦ï¼Œ  
    å¾—åˆ†è¶Šæ¥è¿‘ **1 è¡¨æ˜èšç±»æ•ˆæœè‰¯å¥½**ï¼Œå¾—åˆ†è¶Šæ¥è¿‘ **-1 è¡¨æ˜èšç±»æ•ˆæœä¸ä½³**
  - è½®å»“ç³»æ•°ï¼ˆ`msr("clust.silhouette")`ï¼‰
    - è¿”å›æ‰€æœ‰è§‚æµ‹å€¼çš„å¹³å‡è½®å»“å¾—åˆ†
    - å½“åªæœ‰å•ä¸ªèšç±»æ—¶ï¼Œè¯¥åº¦é‡ç®€å•åœ°è¾“å‡º0

- ä¸‹é¢æ˜¯å¯¹èšç±»ç»“æœçš„è¯„ä¼°
  - æé«˜çš„åŠ æƒå¹³æ–¹å’Œï¼ˆWSSï¼‰ä»¥åŠä¸­ç­‰çš„å¹³å‡è½®å»“ç³»æ•°è¡¨æ˜ï¼Œ  
   èšç±»è¿˜æœ‰æ›´å¤šå·¥ä½œè¦åš

```r
measures <- msrs(c('clust.wss', 'clust.silhouette'))

prediction$score(measures, task = tsk_ruspini)
```

```js
       clust.wss clust.silhouette 
    5.115541e+04     6.413923e-01 
```

- é€šå¸¸å°†æ— ç›‘ç£ä»»åŠ¡ç®€åŒ–ä¸ºå®šé‡æŒ‡æ ‡å¯èƒ½**å¹¶æ— ç›Šå¤„**ï¼ˆå› ä¸ºä¸å­˜åœ¨çœŸå®å€¼ï¼‰
- å¯è§†åŒ–å¯èƒ½æ˜¯è¯„ä¼°èšç±»è´¨é‡æ›´æœ‰æ•ˆçš„å·¥å…·

### å¯è§†åŒ–

#### èšç±»å¯è§†åŒ–

- ç”±äºèšç±»æ˜¯ä¸€é¡¹æ— ç›‘ç£ä»»åŠ¡ï¼Œ  
  å¯è§†åŒ–ä¸ä»…å¯¹äºè¯„ä¼°æ¨¡å‹è‡³å…³é‡è¦ï¼Œ  
  å¯¹äºç¡®å®šå­¦ä¹ å™¨æ˜¯å¦æŒ‰é¢„æœŸå®Œæˆä»»åŠ¡ä¹Ÿå¿…ä¸å¯å°‘

- å¾ˆå®¹æ˜“ä¾èµ–èšç±»åº¦é‡æ¥è¯„ä¼°èšç±»çš„è´¨é‡ï¼Œ  
  ä½†åº”è¯¥ä¿æŒè°¨æ…
  - å› ä¸ºåœ¨æ¨¡å‹ä¹‹é—´è¿›è¡Œé€‰æ‹©å¯èƒ½å–å†³äºå…¶ä»–å› ç´ ï¼Œ  
   æ¯”å¦‚èšç±»æ˜¯å¦‚ä½•å½¢æˆçš„
- ä¸‹ä¾‹ä¸­ç”¨ `mlbench.spirals` ç”Ÿæˆä¸¤æ¡ç›¸äº’ç¼ ç»•çš„èºæ—‹çº¿çš„æ•°æ®

```r
# ç”Ÿæˆæ•°æ®
spirals <- mlbench::mlbench.spirals(
 n = 300, 
 sd = 0.01
)
# æ„å»ºä»»åŠ¡
tsk_spirals <- as_task_clust(
 as.data.frame(spirals$x)
)
# å¯è§†åŒ–æ•°æ®
autoplot(tsk_spirals)
```

![image_9](./image_9.png)

- æ‹Ÿåˆæ¨¡å‹å¹¶æŸ¥çœ‹ç»“æœ
  - Kå‡å€¼èšç±»ç»™å‡ºäº†æ›´é«˜çš„å¹³å‡è½®å»“ç³»æ•°ï¼Œ  
   å› æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œ  
   å…·æœ‰ä¸¤ä¸ªè´¨å¿ƒçš„Kå‡å€¼å­¦ä¹ å™¨æ¯”DBSCANæ–¹æ³•æ˜¯æ›´å¥½çš„é€‰æ‹©

```r
# å­¦ä¹ å™¨
learners <- list(
  lrn('clust.kmeans'),
  lrn('clust.dbscan', eps = 0.1)
)

# benchmarkæ¯”è¾ƒ
bmr <- benchmark(
 benchmark_grid(
  tsk_spirals, 
  learners, 
  rsmp('insample')
 )
)

# æ•´åˆç»“æœ
bmr$aggregate(msr('clust.silhouette'))[, c(4, 7)]
```

```js
  learner_id   clust.silhouette
1 clust.kmeans 0.37244247      
2 clust.dbscan 0.02929844      
```

- é€šè¿‡å¯¹èšç±»ç»“æœçš„å¯è§†åŒ–ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ç§èšç±»çš„å·®åˆ«
  - Kå‡å€¼èšç±»åƒå¯¹å›¾åƒåˆ‡äº†ä¸€åŠ
  - DBSCANåˆ™æŒ‰æ›²çº¿è¿›è¡Œäº†åŒºåˆ†
- **åº”è¯¥æ ¹æ®ä»»åŠ¡çš„éœ€æ±‚ç»“åˆå¯è§†åŒ–é€‰æ‹©åˆé€‚çš„èšç±»æ–¹æ³•ï¼Œ**  
  **è€Œå¹¶å•çº¯éä¾èµ–äºè¯„ä¼°å™¨ç»™å‡ºçš„ç»“æœ**

```r
# åŠ è½½RåŒ…
# library(patchwork)

# æå–Kå‡å€¼èšç±»å’ŒDBSCANä¸¤ç§èšç±»çš„ç»“æœ
# è½¬æ¢æˆå› å­
pred_kmeans <- as.factor(
 bmr$
  resample_result(1)$
  prediction()$
  partition
 )
pred_dbscan <- as.factor(
 bmr$
  resample_result(2)$
  prediction()$
  partition
)
# ç»˜å›¾
df_kmeans <- cbind(
 tsk_spirals$data(), 
 clust = pred_kmeans
)
df_dbscan <- cbind(
 tsk_spirals$data(), 
 clust = pred_dbscan
)
map <- aes(x = V1, y = V2, color = clust)
p_kmeans <- ggplot(df_kmeans, map) + 
 ggtitle('K-means')
p_dbscan <- ggplot(df_dbscan, map) + 
 ggtitle('DBSCAN')

p_kmeans + 
 p_dbscan + 
 plot_layout(guides = 'collect') & 
 geom_point() &
 theme_minimal() & 
 ggplot2::scale_colour_viridis_d(end = 0.8)
```

![image_10](./image_10.png)

#### ä¸»æˆåˆ†åˆ†æä¸è½®å»“ç³»æ•°å›¾ï¼ˆSilhouette Plotï¼‰

- åœ¨`mlr3viz`ä¸­å®ç°çš„ç”¨äºæ”¯æŒèšç±»å­¦ä¹ å™¨è¯„ä¼°çš„ä¸¤ä¸ªæœ€é‡è¦çš„å›¾
  - ä¸»æˆåˆ†åˆ†æï¼ˆPCAï¼‰å›¾
    - æœºå™¨å­¦ä¹ ä¸­å¸¸ç”¨çš„ä¸€ç§é™ç»´æ–¹æ³•
    - ç”¨äºå‡å°‘æ•°æ®é›†ä¸­çš„å˜é‡æ•°é‡ï¼Œ  
    æˆ–å¯è§†åŒ–æœ€é‡è¦çš„**æˆåˆ†**
      - æˆåˆ†æ˜¯æ•°æ®é›†ç‰¹å¾çš„çº¿æ€§å˜æ¢
      - æ–¹å·®è¶Šå¤§ï¼ˆå› æ­¤é¢„æµ‹èƒ½åŠ›è¶Šå¼ºï¼‰çš„æˆåˆ†è¢«è®¤ä¸ºè¶Šé‡è¦
    - åœ¨èšç±»çš„èƒŒæ™¯ä¸‹ï¼Œé€šè¿‡å°†è§‚æµ‹å€¼ç›¸å¯¹äºå‰ä¸¤ä¸ªæˆåˆ†è¿›è¡Œç»˜å›¾ï¼Œ  
    ç„¶åæŒ‰èšç±»è¿›è¡Œç€è‰²ï¼Œå¯ä»¥å¯è§†åŒ–é«˜ç»´æ•°æ®é›†ï¼Œ  
    å¹¶ä¸”é¢„æœŸä¼šçœ‹åˆ°è§‚æµ‹å€¼åˆ†å±äºä¸åŒçš„ç»„
  - è½®å»“ç³»æ•°å›¾
    - é€šè¿‡å¯è§†åŒ–ä¸€ä¸ªç°‡ä¸­çš„è§‚æµ‹å€¼åœ¨ä¸ªä½“å’Œç¾¤ä½“å±‚é¢ä¸Šæ˜¯å¦åˆ†å¸ƒåˆç†ï¼Œ  
    ä»è€Œç›´è§‚åœ°è¯„ä¼°ä¼°è®¡ç°‡çš„è´¨é‡
    - è¿™äº›å›¾åŒ…å«ä¸€æ¡è™šçº¿
      - è¯¥è™šçº¿è¡¨ç¤ºæ‰€æœ‰æ•°æ®ç‚¹çš„å¹³å‡è½®å»“ç³»æ•°ï¼Œ  
     æ¯ä¸ªæ•°æ®ç‚¹çš„è½®å»“å€¼ç”±ä¸€ä¸ªæŒ‰å…¶åˆ†é…ç°‡ç€è‰²çš„æ¡å½¢è¡¨ç¤º
    - å¦‚æœç»™å®šç°‡çš„å¹³å‡è½®å»“å€¼ä½äºå¹³å‡è½®å»“ç³»æ•°çº¿ï¼Œ  
    åˆ™æ„å‘³ç€è¯¥ç°‡å®šä¹‰ä¸æ˜ç¡®

- ä¸‹ä¾‹çš„å¯è§†åŒ–ç»“æœä¸­
  - PCAå›¾
    - æ¨¡å‹é€šè¿‡å‰ä¸¤ä¸ªä¸»æˆåˆ†å°†è§‚æµ‹æ•°æ®å¾ˆå¥½åœ°åˆ†æˆäº†ä¸¤ä¸ªç°‡
  - è½®å»“ç³»æ•°å›¾
    - å¾ˆå¤šè§‚æµ‹å€¼éƒ½åœ¨å¹³å‡çº¿ä»¥ä¸‹ä¸”æ¥è¿‘é›¶ï¼Œ  
    è¯´æ˜èšç±»åˆ†é…è´¨é‡ä¸æ˜¯å¾ˆå¥½ï¼Œ  
    è¿™æ„å‘³ç€è®¸å¤šè§‚æµ‹å€¼å¾ˆå¯èƒ½è¢«åˆ†é…åˆ°äº†é”™è¯¯çš„èšç±»ä¸­

```r
# ä»»åŠ¡
tsk_usarrests <- tsk('usarrests')
# å­¦ä¹ å™¨
prediction <- lrn('clust.kmeans')$
 train(tsk_usarrests)$
 predict(tsk_usarrests)

# PCA
autoplot(
 prediction, 
 tsk_usarrests, 
 type = 'pca'
)

# è½®å»“ç³»æ•°
autoplot(
 prediction, 
 tsk_usarrests, 
 type = 'sil'
)
```

![image_11](./image_11.png)
![image_12](./image_12.png)

### æ€»æ½ä¸Šè¿°æµç¨‹

- ä¸‹é¢ç»“æœä¸­
  - Cå‡å€¼ç®—æ³•å’ŒKå‡å€¼ç®—æ³•éƒ½æ˜æ˜¾ä¼˜äºæ— ç‰¹å¾çš„åŸºçº¿ç®—æ³•ï¼Œ  
   ä½†è‹¥è¦ç¡®å®šè¿™ä¸¤ç§ç®—æ³•ä¸­å“ªä¸€ç§æ›´é€‚åˆï¼Œ  
   è¿˜éœ€è¦ç»“åˆå¯è§†åŒ–çš„è¿›ä¸€æ­¥åˆ†æ

```r
# ä»»åŠ¡
tsk_usarrests <- tsk('usarrests')
# å­¦ä¹ å™¨
learners <- list(
  lrn('clust.featureless'),
  lrn('clust.kmeans', centers = 4L),
  lrn('clust.cmeans', centers = 3L)
)
# è¯„ä¼°å™¨
measures <- list(
 msr('clust.wss'), 
 msr('clust.silhouette')
)
# benchmarkæ¯”è¾ƒ
bmr <- benchmark(
 benchmark_grid(
  tsk_usarrests, 
  learners,
  rsmp('insample')
 )
)
# ç»“æœæ•´åˆ
bmr$aggregate(measures)[, c(4, 7, 8)]
```

```js
Superclass MeasureClust has cloneable=FALSE, but subclass MeasureClustFPC has cloneable=TRUE. A subclass cannot be cloneable when its superclass is not cloneable, so cloning will be disabled for MeasureClustFPC.

Superclass MeasureClust has cloneable=FALSE, but subclass MeasureClustSil has cloneable=TRUE. A subclass cannot be cloneable when its superclass is not cloneable, so cloning will be disabled for MeasureClustSil.

INFO  [23:38:54.167] [mlr3] Running benchmark with 3 resampling iterations
INFO  [23:38:54.220] [mlr3] Applying learner 'clust.featureless' on task 'usarrests' (iter 1/1)
INFO  [23:38:54.254] [mlr3] Applying learner 'clust.kmeans' on task 'usarrests' (iter 1/1)
INFO  [23:38:54.289] [mlr3] Applying learner 'clust.cmeans' on task 'usarrests' (iter 1/1)
INFO  [23:38:54.331] [mlr3] Finished benchmark
```

<table class="dataframe">
<caption>A bmr_aggregate: 3 x 3</caption>
<thead>
 <tr><th scope=col>learner_id</th><th scope=col>clust.wss</th><th scope=col>clust.silhouette</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>clust.featureless</td><td>355807.82</td><td>0.0000000</td></tr>
 <tr><td>clust.kmeans     </td><td> 34728.63</td><td>0.5012332</td></tr>
 <tr><td>clust.cmeans     </td><td> 47964.27</td><td>0.5319024</td></tr>
</tbody>
</table>

## ç©ºé—´åˆ†æï¼ˆSpatial Analysisï¼‰

### ç®€ä»‹

- ç©ºé—´åˆ†æ
  - å¯ä»¥æ˜¯ä»»ä½•å…¶ä»–æœºå™¨å­¦ä¹ ä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼Œå›å½’æˆ–åˆ†ç±»ï¼‰çš„ä¸€ä¸ªå­é›†
  - å…¶å®šä¹‰æ˜¯æ•°æ®é›†ä¸­å­˜åœ¨ç©ºé—´ä¿¡æ¯
    - è¿™äº›ä¿¡æ¯é€šå¸¸å­˜å‚¨ä¸ºåæ ‡
    - é€šå¸¸å‘½åä¸º`'x'`å’Œ`'y'`ï¼Œ  
    æˆ–è€…`'lat'`å’Œ`'lon'`  
    ï¼ˆåˆ†åˆ«ä»£è¡¨â€œçº¬åº¦â€å’Œâ€œç»åº¦â€ï¼‰
- ç©ºé—´åˆ†ææ˜¯ä¸€é¡¹ç‹¬ç‰¹çš„ä»»åŠ¡
  - ç”±äº **è‡ªç›¸å…³æ€§** çš„å¤æ‚æ€§ï¼Œç©ºé—´æ•°æ®å¿…é¡»è°¨æ…å¤„ç†
  - è‡ªç›¸å…³å­˜åœ¨äºç©ºé—´æ•°æ®ä¸­ï¼Œ  
   å› ä¸ºåæ ‡ä¸­ç¼–ç äº†éšå«ä¿¡æ¯
    - ä¾‹å¦‚ä¸¤ä¸ªè§‚æµ‹å€¼ï¼ˆå¦‚åŸå¸‚ã€å›½å®¶ã€å¤§æ´²ï¼‰æ˜¯ç›¸è·è¾ƒè¿‘è¿˜æ˜¯è¾ƒè¿œ
    - ä¾‹å¦‚ï¼Œå‡è®¾è¦é¢„æµ‹å¾·å›½ç–¾ç—…çˆ†å‘ä¸¤ä¸ªæœˆåçš„ç—…ä¾‹æ•°
      - ç–«æƒ…ä»éœ‡ä¸­å‘å¤–è¾å°„ï¼Œå› æ­¤ç¦»å¾·å›½è¾ƒè¿‘çš„å›½å®¶ç—…ä¾‹æ•°ä¼šè¾ƒå¤šï¼Œ  
     è€Œè¾ƒè¿œçš„å›½å®¶ç—…ä¾‹æ•°ä¼šè¾ƒå°‘
      - ä»ç©ºé—´è§’åº¦æŸ¥çœ‹æ•°æ®ï¼Œ  
     å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°é™„è¿‘è§‚æµ‹å€¼ä¹‹é—´å­˜åœ¨è‡ªç›¸å…³çš„è¿¹è±¡
    - åœ¨è¿™ä¸ªä¾‹å­ä¸­è‡ªç›¸å…³æ˜¯å‘ˆè¾å°„çŠ¶çš„ï¼Œ  
    ä½†åœ¨å®é™…æƒ…å†µä¸­**å¹¶éæ€»æ˜¯å¦‚æ­¤**

![image_13](./image_13.png)

- `mlr3spatiotempcv` ä¸­æä¾›äº†é¢å¤–çš„é‡é‡‡æ ·æ–¹æ³•ï¼Œ  
  ä»¥è§£å†³ç”±äºæ—¶ç©ºè‡ªç›¸å…³å¯¼è‡´çš„é‡é‡‡æ ·è¿‡ç¨‹ä¸­è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„ç›¸ä¼¼æ€§é—®é¢˜

### `TaskClassifST` å’Œ `TaskRegrST`

- `TaskClassifST` å’Œ `TaskRegrST`ä¸º  
  æ—¶ç©ºä»»åŠ¡çš„åˆ†ç±»ä¸å›å½’ä»»åŠ¡
  - `coordinate_names`ï¼šåæ ‡çš„ç‰¹å¾å
  - `crs`ï¼šCoordinate Reference System

```r
# åŠ è½½RåŒ…
# library(mlr3spatial)
# library(mlr3spatiotempcv)

# ä»`data.frame`åˆ›å»ºä»»åŠ¡å¯¹è±¡
tsk_ecuador <- as_task_classif_st(
 ecuador, 
 id = 'ecuador_task',
 target = 'slides', 
 positive = 'TRUE',
 coordinate_names = c('x', 'y'), 
 crs = '32717'
)

# ä»`sf`åˆ›å»ºä»»åŠ¡å¯¹è±¡
data_sf <- sf::st_as_sf(
 ecuador, 
 coords = c('x', 'y'), 
 crs = '32717'
)
tsk_ecuador <- as_task_classif_st(
 data_sf, 
 target = 'slides',
 positive = 'TRUE'
)

tsk_ecuador
```

```js
[36m--[39m [1m[34m<TaskClassifST>[39m (751x11)[22m [36m----------------------------------------------------[39m
* Target: slides
* Properties: twoclass
* Features (10):
  * dbl (10): carea, cslope, dem, distdeforest, distroad, distslidespast,
  hcurv, log.carea, slope, vcurv
* Coordinates:
            X       Y
        <num>   <num>
  1: 712882.5 9560002
  2: 715232.5 9559582
  3: 715392.5 9560172
  4: 715042.5 9559312
  5: 715382.5 9560142
 ---                 
747: 714472.5 9558482
748: 713142.5 9560992
749: 713322.5 9560562
750: 715392.5 9557932
751: 713802.5 9560862
```

- å¯ä»¥ç”¨æ­£å¸¸çš„å­¦ä¹ å™¨è¿›è¡Œå»ºæ¨¡åˆ†æ

```r
lrn('classif.rpart')$
 train(tsk_ecuador)$
 predict(tsk_ecuador)
```

```js
[36m--[39m [1m[34m<PredictionClassif>[39m for [34m751[39m observations:[22m [36m-----------------------------------[39m
 row_ids truth response
       1  TRUE     TRUE
       2  TRUE     TRUE
       3  TRUE     TRUE
     ---   ---      ---
     749 FALSE    FALSE
     750 FALSE    FALSE
     751 FALSE     TRUE
```

### æ—¶ç©ºäº¤å‰éªŒè¯ï¼ˆSpatiotemporal Cross-Validationï¼‰

- å¦‚æœå°†éç©ºé—´é‡é‡‡æ ·æ–¹æ³•ç”¨äºç©ºé—´æ•°æ®å¯èƒ½ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Œæœ¬ä¾‹ä¸­ï¼š
  - `'NSpCV'`ï¼ˆéç©ºé—´äº¤å‰éªŒè¯ï¼‰
    - æ˜¯æ¥è‡ª`mlr3`çš„éç©ºé—´é‡é‡‡æ ·æ–¹æ³•
  - `'SpCV'`ï¼ˆç©ºé—´äº¤å‰éªŒè¯ï¼‰
    - æ¥è‡ª`mlr3spatiotempcv`
    - é’ˆå¯¹ç©ºé—´æ•°æ®è¿›è¡Œä¼˜åŒ–çš„
- ç»“æœå±•ç¤º`'NSpCV'`ä½¿å†³ç­–æ ‘çœ‹èµ·æ¥æ¯”å®é™…è¡¨ç°æ›´å¥½ï¼Œå…¶ä¼°è®¡æ€§èƒ½æ˜æ˜¾æ›´é«˜
  - ç„¶è€Œï¼Œè¿™æ˜¯ç”±äºæ•°æ®ä¸­çš„è‡ªç›¸å…³æ€§å¯¼è‡´çš„è¿‡åº¦è‡ªä¿¡é¢„æµ‹

```r
# å­¦ä¹ å™¨
lrn_rpart <- lrn(
 'classif.rpart', 
 predict_type = 'prob'
)
# æ™®é€šçš„é‡é‡‡æ ·
rsmp_nsp <- rsmp(
 'repeated_cv', 
 folds = 3, 
 repeats = 2, 
 id = 'NSpCV'
)
# ç©ºé—´äº¤å‰éªŒè¯é‡é‡‡æ ·
rsmp_sp <- rsmp(
 'repeated_spcv_coords', 
 folds = 3, 
 repeats = 2,
 id = 'SpCV'
)

# benchmarkæ¯”è¾ƒ
design <- benchmark_grid(
 tsk_ecuador, 
 lrn_rpart, 
 c(rsmp_nsp, rsmp_sp)
)
bmr <- benchmark(design)

# ç»“æœæ•´åˆ
bmr$aggregate(msr('classif.acc'))[, c(5, 7)]
```

<table class="dataframe">
<caption>A bmr_aggregate: 2 x 2</caption>
<thead>
 <tr><th scope=col>resampling_id</th><th scope=col>classif.acc</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>NSpCV</td><td>0.676409</td></tr>
 <tr><td>SpCV </td><td>0.584237</td></tr>
</tbody>
</table>

- ç”±äºæ½œåœ¨çš„ç©ºé—´è‡ªç›¸å…³æ€§ï¼Œ  
  åº”ç”¨éç©ºé—´é‡é‡‡æ ·**ä¼šå¯¼è‡´è®­ç»ƒé›†å’Œæµ‹è¯•é›†éå¸¸ç›¸ä¼¼**
  - å› æ­¤ï¼Œåœ¨æ¨¡å‹è®­ç»ƒæ‰€ç”¨çš„ç›¸åŒæ•°æ®ä¸Šè¿›è¡Œæµ‹è¯•ï¼Œç»“æœä¸ä¼šæœ‰å¤ªå¤§å·®å¼‚
  - ä¸ºäº†å¾—åˆ°çœŸå®çš„æ€§èƒ½ç»“æœï¼Œåº”é¿å…è¿™ç§æƒ…å†µ
- ç©ºé—´æ–¹æ³•è€ƒè™‘äº†è‡ªç›¸å…³æ€§ï¼Œ  
  æµ‹è¯•æ•°æ®ä¸è®­ç»ƒæ•°æ®çš„ç›¸å…³æ€§è¾ƒä½ï¼ˆå°½ç®¡ä»ä¼šå­˜åœ¨ä¸€äº›å…³è”ï¼‰

- ä¸‹å›¾ä¸­ï¼Œé€šè¿‡ `autoplot()` æ–¹æ³•å¯ä»¥ç›´è§‚åœ°çœ‹åˆ°ï¼š
  - ç©ºé—´é‡é‡‡æ ·æ–¹æ³•ï¼Œå·¦å›¾
    - å„ä¸ªåˆ†åŒºåœ¨ç©ºé—´ä¸Šæœ‰æ˜æ˜¾çš„åˆ†éš”
  - éç©ºé—´é‡é‡‡æ ·æ–¹æ³•ï¼Œå³å›¾
    - è®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„åˆ’åˆ†é‡å è¾ƒå¤šï¼ˆå› æ­¤ç›¸å…³æ€§æ›´å¼ºï¼‰

```r
# åŠ è½½RåŒ…
# library(patchwork)

# å¯¹é‡é‡‡æ ·ç»“æœå¯è§†åŒ–
(autoplot(rsmp_sp, tsk_ecuador, fold_id = 1, size = 0.7) +
  ggtitle('Spatial Resampling') +
  autoplot(rsmp_nsp, tsk_ecuador, fold_id = 1, size = 0.7) +
  ggtitle('Non-spatial Resampling')) +
  plot_layout(guides = 'collect') &
  theme_minimal() &
  theme(axis.text = element_text(size = 4), legend.position = 'bottom')
```

![image_14](./image_14.png)

### `mlr3spatiotempcv`ä¸­å…¶ä»–é‡é‡‡æ ·æ–¹æ³•

- **Blocking**ï¼š  
  åœ¨äºŒç»´æˆ–ä¸‰ç»´ç©ºé—´ä¸­åˆ›å»ºçŸ©å½¢å—
- **Buffering**ï¼š  
  åˆ›å»ºç¼“å†²åŒºï¼Œå»é™¤è®­ç»ƒé›†å’Œæµ‹è¯•é›†ä¹‹é—´çš„è§‚æµ‹æ•°æ®
- **Spatiotemporal clustering**ï¼š  
  æ—¶ç©ºèšç±» - åŸºäºåæ ‡ï¼ˆå’Œ/æˆ–æ—¶é—´ç‚¹ï¼‰çš„èšç±»
- **Feature space clustering**ï¼š  
  åŸºäºç‰¹å¾ç©ºé—´è¿›è¡Œèšç±»ï¼Œä¸ä¸€å®šåŸºäºæ—¶ç©ºã€‚
- **Custom (partitioning)**ï¼š  
  æŒ‰å› å­å˜é‡åˆ†ç»„

- `mlr3spatiotempcv`ä¹Ÿå¯ä»¥è®¨è®º**æ—¶ç©ºé—®é¢˜**

### ç©ºé—´é¢„æµ‹ï¼ˆSpatial Predictionï¼‰

- è¿›è¡Œæ—¶ç©ºé¢„æµ‹ï¼Œç›®æ ‡æ˜¯åœ¨åƒç´ çº§åˆ«è¿›è¡Œåˆ†ç±»æˆ–å›å½’é¢„æµ‹ï¼Œ  
  å³å¯¹ç”±æ …æ ¼å›¾åƒçš„å‡ ä½•åˆ†è¾¨ç‡å®šä¹‰çš„ä¸€ä¸ªåŒºåŸŸè¿›è¡Œé¢„æµ‹
- ä½¿ç”¨ `predict_spatial()`
  å¯ä»¥å¯¹ä»¥ä¸‹ä»»ä½•ç©ºé—´æ•°æ®ç±»è¿›è¡Œç©ºé—´é¢„æµ‹ï¼š
  - `stars`ï¼ˆæ¥è‡ª `stars` åŒ…ï¼‰
  - `SpatRaster`ï¼ˆæ¥è‡ª `terra` åŒ…ï¼‰
  - `RasterLayer`ï¼ˆæ¥è‡ª `raster` åŒ…ï¼‰
  - `RasterStack`ï¼ˆæ¥è‡ª `raster` åŒ…ï¼‰

- ä¸‹ä¾‹ä¸­
  - åŠ è½½ `leipzig_points` æ•°æ®é›†è¿›è¡Œè®­ç»ƒï¼Œ  
  - å¹¶ä½¿ç”¨ `as_task_classif_st()` å°†å…¶è½¬æ¢ä¸ºæ—¶ç©ºä»»åŠ¡ï¼Œ
  - åŒæ—¶åŠ è½½ `leipzig_raster` æ …æ ¼æ•°æ®
  - è¿™ä¸¤ä¸ªæ–‡ä»¶å‡ä½œä¸ºç¤ºä¾‹æ•°æ®åŒ…å«åœ¨ `mlr3spatial` ä¸­
  - æŒ‡å®šåˆ›å»ºä¸€ä¸ªÂ `terra`Â å¯¹è±¡ï¼Œ  
   è¯¥å¯¹è±¡å¯ä»¥ä½¿ç”¨å†…ç½®ç»˜å›¾æ–¹æ³•è¿›è¡Œå¯è§†åŒ–

```r
# library(mlr3spatial)
# library(sf)
# library(terra, exclude = 'resample')

# è¯»å–éœ€è¦åˆ†æçš„ç¤ºä¾‹æ•°æ®
leipzig_vector <- sf::read_sf(
 system.file(
  'extdata',
  'leipzig_points.gpkg', 
  package = 'mlr3spatial'
 ),
 stringsAsFactors = TRUE
)

# æ„å»ºä»»åŠ¡
tsk_leipzig <- as_task_classif_st(
 leipzig_vector, 
 target = 'land_cover'
)

# è¯»å–ç¤ºä¾‹çš„æ …æ ¼æ•°æ®
leipzig_raster <- terra::rast(
 system.file(
  'extdata', 
  'leipzig_raster.tif',
  package = 'mlr3spatial'
 )
)

# æ„å»ºå­¦ä¹ å™¨
lrn_ranger <- lrn('classif.ranger')$
 train(tsk_leipzig)

# é¢„æµ‹ï¼Œä½†æ˜¯ä½¿ç”¨`predict_spatial()`
prediction <- predict_spatial(
 leipzig_raster, 
 lrn_ranger,
 format = 'terra'
)

# æŸ¥çœ‹é¢„æµ‹ç»“æœ
prediction
```

```js
class       : SpatRaster 
size        : 206, 154, 1  (nrow, ncol, nlyr)
resolution  : 10, 10  (x, y)
extent      : 731810, 733350, 5692030, 5694090  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 32N (EPSG:32632) 
source      : file48064a40f583.tif 
categories  : categories 
name        : land_cover 
min value   :     forest 
max value   :      water 
```

- å¯è§†åŒ–é¢„æµ‹çš„ç»“æœ
  - æ£®æ—ï¼ˆç´«è‰²ï¼‰ã€ç‰§åœºï¼ˆè“è‰²ï¼‰ã€åŸå¸‚ï¼ˆç»¿è‰²ï¼‰å’Œæ°´åŸŸï¼ˆé»„è‰²ï¼‰

```r
plot(
 prediction, 
 col = c(
 '#440154FF', 
 '#443A83FF', 
 '#31688EFF',
 '#21908CFF', 
 '#35B779FF', 
 '#8FD744FF', 
 '#FDE725FF'
 )
)
```

![image_15](./image_15.png)
