
---

title: '快速变量编码转换函数'
published: 2025-08-11
image: './p24_cover.jpg'
description: '原始数据+转换规则矩阵即可轻松搞定编码转换'
category: 'MISC'
tags: [Data Cleaning,ZH-CN]
draft: false
lang: 'en'
---
>
> - Cover Pic by [@MOJE末杰](https://www.pixiv.net/artworks/133295244)

## 简介

- 对于一些问卷调查的结果，大概率原始的编码给的都不是你想要的样子
  - 比如有无的1/0编码可能被弄成1/2
  - 有序变量的顺序也可能与实际分析的顺序相反
- 本函数通过传递一个转换规则矩阵，可以实现一键变量编码转换

## `autoTx`：一键转换变量编码

- 函数功能：一键转换变量编码
- 函数参数：
  - `x`：待转换的数据集
  - `t`：转换规则矩阵
  - `var`：`x`中需要转换的变量的列名
  - `valOld`：变量的旧编码
  - `valNew`：变量转换后的新编码
- 函数返回值：转换后的数据集

- 原始函数

```r
autoTx <- function(x, t, var, valOld, valNew) {
  require(dplyr)
  require(tidyr)
  require(tibble)
  require(rlang)

  var_sym <- sym(var)
  valOld_sym <- sym(valOld)
  valNew_sym <- sym(valNew)

  tt <- t %>% fill(!!var_sym, .direction = 'down')

  for (v in unique(tt[[var]])) {
    recode_map <- tt %>%
      filter(!!var_sym == v) %>%
      select(!!valOld_sym, !!valNew_sym) %>%
      deframe()

    if (length(recode_map) == 0) {
      warning(glue::glue("No mapping found for variable '{v}', skipping."))
      next
    }

    if (!(v %in% names(x))) {
      warning(glue::glue("Variable '{v}' not in x, skipping."))
      next
    }

    x[[v]] <- recode(x[[v]], !!!recode_map)
  }

  return(x)
}
```

## 示例

- `x`是待转换的数据
- `trans`是转换规则矩阵

```r
x <- data.frame(
    a = c(1, 2, 1, 2, 1, 3, 0),
    b = c(10, 20, 5, 10, 100, 20, 10)
)

trans <- data.frame(
    vars = c("a", NA, "b", NA, NA),
    val_old = c(1, 2, 5, 10 ,20),
    val_new = c(1, 0, 1 ,2, 3)
)

x; trans
```

<table class="dataframe">
<caption>A data.frame: 7 x 2</caption>
<thead>
 <tr><th scope=col>a</th><th scope=col>b</th></tr>
 <tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>1</td><td> 10</td></tr>
 <tr><td>2</td><td> 20</td></tr>
 <tr><td>1</td><td>  5</td></tr>
 <tr><td>2</td><td> 10</td></tr>
 <tr><td>1</td><td>100</td></tr>
 <tr><td>3</td><td> 20</td></tr>
 <tr><td>0</td><td> 10</td></tr>
</tbody>
</table>

<table class="dataframe">
<caption>A data.frame: 5 x 3</caption>
<thead>
 <tr><th scope=col>vars</th><th scope=col>val_old</th><th scope=col>val_new</th></tr>
 <tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>a </td><td> 1</td><td>1</td></tr>
 <tr><td>NA</td><td> 2</td><td>0</td></tr>
 <tr><td>b </td><td> 5</td><td>1</td></tr>
 <tr><td>NA</td><td>10</td><td>2</td></tr>
 <tr><td>NA</td><td>20</td><td>3</td></tr>
</tbody>
</table>

```r
autoTx(
    x, 
    trans, 
    var = "vars", 
    valOld = "val_old", 
    valNew = "val_new"
)
```

<table class="dataframe">
<caption>A data.frame: 7 x 2</caption>
<thead>
 <tr><th scope=col>a</th><th scope=col>b</th></tr>
 <tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
 <tr><td>1</td><td>  2</td></tr>
 <tr><td>0</td><td>  3</td></tr>
 <tr><td>1</td><td>  1</td></tr>
 <tr><td>0</td><td>  2</td></tr>
 <tr><td>1</td><td>100</td></tr>
 <tr><td>3</td><td>  3</td></tr>
 <tr><td>0</td><td>  2</td></tr>
</tbody>
</table>

- 在规则转换矩阵里的变量以及旧编码会被转换，  
不存在的会直接保留原样
